============================================================
srpmixによるソースコードの展開とそのディレクトリ構造について
============================================================

:著者: 大和 正武
:メールアドレス: yamato@redhat.com
:ディレクトリフォーマット: 3.0.0


背景
----

社内の業務上ソースコードの調査が必要となることは少なくありません。ソー
スコードの読解が業務の主要な作業となる人すらいます。ソースコードを読み
解くのに必要となる技術というのは背景知識や経験、根性など属人的です。し
かしそういった技術を発揮する以前に、ソースコードを手元に閲覧できる形で
取り寄せる手間があり、ソースコード読解の作業を煩わしいものにしています。
2年間業務としてソースコードの読解に取り込んだ結果、この煩わしさはまったく
無視できないものであるばかりか、業務遂行の根源的な支障であると考え解決
に取り込んできました。

「前もって読む可能性のある全てのソフトウェアをソースコードを手元に閲覧
できる形で取り寄せておいてしまう」、というのが思い至った方法です。力技
的であり品性に欠けますが、業務を通してこの方法を試し、煩わしさの低下に
よる利益は絶大であることがわかりました。そこでその方法をパッケージ化し、
どこでもディスク容量さえあれば再現できるようにしたのが本ソフトウェアで
す。

srpmixというソフトウェアにより、src.rpmを含むisoイメージやsrc.rpm の集
合を形式立ててディレクトリに展開できます。このディレクトリをNFS経由でエ
クスポートすることで複数のユーザの手元にソースコードを配置することがで
きます。本文章では展開の手順と形式(ディレクトリ構造)を説明します。

形式的に配置することで、その配置位置を仮定したツールを作ることもできます。


ローカルにソースコードを展開する方法
-------------------------------------

NFSでエクスポートすることなくローカルのディスクにソースコードを
展開するだけであれば、どのディレクトリで展開しても、問題はありま
せん。以下のようにして展開して下さい::

 ./srpmix -f -s ROOTDIR [IMAGE.ISO|SRC.RPM]+

ROOTDIR以下にisoイメージ中のSRC.RPMやコマンドラインに直接指定して
SRC.RPMファイルが展開されます。展開の結果ROOTDIR以下がどのようなディレ
クトリ構成になるかは、後ほど説明します。

ISOイメージを指定した場合、それをループバックマウントします。ルート権限
で実行していれば、マウントできますが、そうでない場合、マウントできず
srpmixの実行が失敗してしまいます。-s オプションを付けるとsudoの元でマウ
ントを試みます。一般ユーザ権限で実行するsrpmixでISOイメージを利用するに
は/etc/sudoersを適切に設定して下さい。

-fはROOTDIR以下のファイルの上書きを許すかどうかを制御します。また
ROOTDIRが存在しない場合、そのディレクトリを作成します。

上書きをして欲くない場合、-fを外します。しかしその場合、ROOTDIR以下のディ
レクトリが準備されていなければ、srpmixは動作しません。


NFSでエクスポートするディレクトリへソースコードの展開
----------------------------------------------------------

複数の人がソースコードを閲覧できるように、ディレクトリをNFSでエクスポー
トする場合、サーバ側のディレクトリとクライアント側のディレクトリのパス
が一致している必要があります。ソースコードを展開するときにシンボリック
リンクを使っているためです。例えば/srv/sourcesで展開しておいて、それを
/srv/sources でマウントすれば、クライアント側でもシンボリックリンクを
正しく追うことができます。


展開したソースコードの所有者
----------------------------

展開したソースコードの所有グループは展開時のコマンドラインから指定でき
ます。

利用者によって使いたいtagツールが違います。NFS経由なので複数の人がソー
スコードを閲覧する場合、閲覧先ディレクトリにタグファイルを書き込みたい
一方で、誤って展開したソースコードを変更してしまうのを避けたくなります。
以下のオプション::

   --set-group=GROUP

を使うと、ROOTDIR以下の一部のディレクトリの所有グループをGROUPとし、そ
こをグループ書き込み可能とします。

例::

  ./srpmix -f -s --set-group=wheel  \
      ~/archives/EL5SU0              \
      ~/images/EL5SU0/rhel-5-server-source-disc*.iso 

アーキテクチャの指定
--------------------

カーネルなど展開時にアーキテクチャを指定できるパッケージがあります。

::

    --target=arch

というオプションを追加すると、それに従ってrpmbuildを実施します。この指
定がない場合、i386, i686, x86_64, ia64, ppcの順に成功するまで試します。


ディレクトリ構成
----------------

ROOTDIRは--set-group=GROUPの指定があるとディレクトリの所有グループが
GROUPになり、書き込めます。追加的なツール用のデータを置けます。データ用
のファイルあるいはディレクトリには、そのツールの名称をプレフィックスと
して与えて下さい。たとえばgonzui であれば::

    gonzui-DATABASE

などとすると良いでしょう。srpmix-というプレフィックスはsrpmixが予約して
います。


ROOTDIR以下には次のようなファイル、ディレクトリが作成されます::

    drwxrwxr-x    2 yamato yamato  36864  5月 31 19:26 SPECS
    -r--r--r--    1 yamato yamato      4  5月 31 18:46 SRPMIX
    drwxrwxr-x 1100 yamato yamato  61440  5月 31 19:26 srpmix-BUILD
    drwxrwxr-x    2 yamato yamato 184320  5月 31 19:26 srpmix-LOG
    drwxrwxr-x 1100 yamato yamato  61440  5月 31 19:26 srpmix-SOURCES
    drwxrwxr-x    2 yamato yamato  65536  5月 31 19:26 srpmix-SPECS
    drwxrwxr-x    2 yamato yamato  65536  5月 31 19:26 srpmix-SPECS0


SPECSは無視して下さい。srpmixは直接には管理していません。展開時に一時的
に使うだけです。

SRPMIXにはこのディレクトリ構成のバージョンが記載されています。現在3.0.0で
す。etagsなどの補助的なツールを実行するときこのバージョン番号を見て、ディ
レクトリ構成を確認できます。これは書き込み禁止になります。

srpmix-LOGにはsrpmixの実行ログが保存されています。各src.rpmのrpm -ivhと
rpmbuild -bpの実行結果が記載されています。展開に失敗したときに、その原
因を調べることができます。ほとんどのログファイルは書き込み禁止になりま
す。

srpmix-SOURCESは /usr/src/redhat/SOURCESと同じですが、全てのソース、パッ
チを一つのディレクトリにフラットに配置するのではなく、各パッケージ名-バー
ジョン番号毎にサブディレクトリを作成して、そこに配置しています。パッケー
ジ間でソース、パッチのファイル名の衝突の恐れがありません。すべて書き込
み禁止になります。

srpmix-SPECS0は /usr/src/redhat/SPECSとほぼ同じですが、specファイル名
を::

  パッケージ名.spec

とするのではなく::

  パッケージ名-バージョン番号.spec

として配置しています。そのため、同じパッケージの異なるバージョンのソー
スを展開したときに、specファイル間で衝突する恐れがありません。すべて書
き込み禁止になります。

srpmix-SPECSはsrpmix-SPECS0とほぼ同じですが、srpmixがrpmbuildを実行する
ときに都合が良いように、specファイルの一部が改変されています。資料とし
ては重要ではありませんが、ソースコード展開に失敗したときに原因を追跡で
きるように保存してあります。すべて書き込み禁止になります。

srpmix-BUILDには, /usr/src/redhat/BUILDのようにソースコードが展開されま
すが、その構造はやや複雑です。srpmix-SPECS0などと同じように名前の衝突を
避けるために::

  ROOTDIR/srpmix-BUILD/パッケージ名-バージョン番号

というディレクトリが作成されます。さらにパッケージ名-バージョン番号とい
うディレクトリ以下はrpmbuildによって1つ以上のディレクトリが作成されてお
り、まさにソースコードが展開されます。通常そのディレクトリのパスは::

  ROOTDIR/srpmix-BUILD/パッケージ名-バージョン番号/パッケージ名

となります。このrpmbuildによって作成されたディレクトリは以下はすべて書
き込み禁止になります。一方::

  ROOTDIR/srpmix-BUILD/パッケージ名-バージョン番号

は--set-group=GROUPの指定があるとディレクトリの所有グループがGROUPにな
り、書き込めます。追加的なツール用のデータを置ける計画しましたが、将来禁止
する予定です。追加的なデータを::

  ROOTDIR/srpmix-BUILD/パッケージ名-バージョン番号

に展開した場合、

  ROOTDIR/srpmix-BUILD/パッケージ名-バージョン番号

に複数のファイルやディレクトリがあるとスクリプトなどから

  ROOTDIR/srpmix-BUILD/パッケージ名-バージョン番号/パッケージ名

の「パッケージ名」の部分を来める方法が無いたです。かわりにROOTDIR以下に
ツール毎にディレクトリを作成してデータを置いて下さい。データ用のファイ
ルあるいはディレクトリには、そのツールの名称をプレフィックスとして与え
て下さい。たとえばctags であれば::

    ctags-TAGS

などとすると良いでしょう。srpmix-というプレフィックスはsrpmixが予約して
います。



<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Created by xhtmlize-1.34 in external-css mode. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>htmlfontify.el</title>
    <link rel="stylesheet" type="text/css" href="css/default.css"/>
    <link rel="stylesheet" type="text/css" href="css/fringe.css"/>
    <link rel="stylesheet" type="text/css" href="css/highlight.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-builtin-face.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-comment-face.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-comment-delimiter-face.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-constant-face.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-doc-face.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-function-name-face.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-keyword-face.css"/>
    <link rel="stylesheet" type="text/css" href="css/linum.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-negation-char-face.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-regexp-grouping-backslash.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-regexp-grouping-construct.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-string-face.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-type-face.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-variable-name-face.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-lock-warning-face.css"/>
  </head>
  <body>
    <div style="position: fixed; left: 0; width: 100%; background: #CCC;  top: 0;    height: 1em;">
    </div>
<div style="position: fixed; left: 0; width: 100%; top: 1em; bottom: 2em; overflow: auto">
    <pre >
<a href="#linum:1"><span class="linum" id="linum:1">   1</span></a><span class="fringe" id="point:1"> </span><span class="comment-delimiter" id="font-lock:1">;;; </span><span class="comment" id="font-lock:5">htmlfontify.el --- htmlise a buffer/source tree with optional hyperlinks
</span><a href="#linum:2"><span class="linum" id="linum:2">   2</span></a><span class="fringe" id="point:78"> </span>
<a href="#linum:3"><span class="linum" id="linum:3">   3</span></a><span class="fringe" id="point:79"> </span><span class="comment-delimiter" id="font-lock:79">;; </span><span class="comment" id="font-lock:82">Copyright (C) 2002, 2003, 2009, 2010  Free Software Foundation, Inc.
</span><a href="#linum:4"><span class="linum" id="linum:4">   4</span></a><span class="fringe" id="point:151"> </span>
<a href="#linum:5"><span class="linum" id="linum:5">   5</span></a><span class="fringe" id="point:152"> </span><span class="comment-delimiter" id="font-lock:152">;; </span><span class="comment" id="font-lock:155">Emacs Lisp Archive Entry
</span><a href="#linum:6"><span class="linum" id="linum:6">   6</span></a><span class="fringe" id="point:180"> </span><span class="comment-delimiter" id="font-lock:180">;; </span><span class="comment" id="font-lock:183">Package: htmlfontify
</span><a href="#linum:7"><span class="linum" id="linum:7">   7</span></a><span class="fringe" id="point:204"> </span><span class="comment-delimiter" id="font-lock:204">;; </span><span class="comment" id="font-lock:207">Filename: htmlfontify.el
</span><a href="#linum:8"><span class="linum" id="linum:8">   8</span></a><span class="fringe" id="point:232"> </span><span class="comment-delimiter" id="font-lock:232">;; </span><span class="comment" id="font-lock:235">Version: 0.21
</span><a href="#linum:9"><span class="linum" id="linum:9">   9</span></a><span class="fringe" id="point:249"> </span><span class="comment-delimiter" id="font-lock:249">;; </span><span class="comment" id="font-lock:252">Keywords: html, hypermedia, markup, etags
</span><a href="#linum:10"><span class="linum" id="linum:10">  10</span></a><span class="fringe" id="point:294"> </span><span class="comment-delimiter" id="font-lock:294">;; </span><span class="comment" id="font-lock:297">Author: Vivek Dasmohapatra &lt;<a href="mailto:vivek&#64;etla.org">vivek&#64;etla.org</a>&gt;
</span><a href="#linum:11"><span class="linum" id="linum:11">  11</span></a><span class="fringe" id="point:341"> </span><span class="comment-delimiter" id="font-lock:341">;; </span><span class="comment" id="font-lock:344">Maintainer: Vivek Dasmohapatra &lt;<a href="mailto:vivek&#64;etla.org">vivek&#64;etla.org</a>&gt;
</span><a href="#linum:12"><span class="linum" id="linum:12">  12</span></a><span class="fringe" id="point:392"> </span><span class="comment-delimiter" id="font-lock:392">;; </span><span class="comment" id="font-lock:395">Created: 2002-01-05
</span><a href="#linum:13"><span class="linum" id="linum:13">  13</span></a><span class="fringe" id="point:415"> </span><span class="comment-delimiter" id="font-lock:415">;; </span><span class="comment" id="font-lock:418">Description: htmlise a buffer/source tree with optional hyperlinks
</span><a href="#linum:14"><span class="linum" id="linum:14">  14</span></a><span class="fringe" id="point:485"> </span><span class="comment-delimiter" id="font-lock:485">;; </span><span class="comment" id="font-lock:488">URL: http://rtfm.etla.org/emacs/htmlfontify/
</span><a href="#linum:15"><span class="linum" id="linum:15">  15</span></a><span class="fringe" id="point:533"> </span><span class="comment-delimiter" id="font-lock:533">;; </span><span class="comment" id="font-lock:536">Compatibility: Emacs23, Emacs22
</span><a href="#linum:16"><span class="linum" id="linum:16">  16</span></a><span class="fringe" id="point:568"> </span><span class="comment-delimiter" id="font-lock:568">;; </span><span class="comment" id="font-lock:571">Incompatibility: Emacs19, Emacs20, Emacs21
</span><a href="#linum:17"><span class="linum" id="linum:17">  17</span></a><span class="fringe" id="point:614"> </span><span class="comment-delimiter" id="font-lock:614">;; </span><span class="comment" id="font-lock:617">Last Updated: Thu 2009-11-19 01:31:21 +0000
</span><a href="#linum:18"><span class="linum" id="linum:18">  18</span></a><span class="fringe" id="point:661"> </span>
<a href="#linum:19"><span class="linum" id="linum:19">  19</span></a><span class="fringe" id="point:662"> </span><span class="comment-delimiter" id="font-lock:662">;; </span><span class="comment" id="font-lock:665">This file is part of GNU Emacs.
</span><a href="#linum:20"><span class="linum" id="linum:20">  20</span></a><span class="fringe" id="point:697"> </span>
<a href="#linum:21"><span class="linum" id="linum:21">  21</span></a><span class="fringe" id="point:698"> </span><span class="comment-delimiter" id="font-lock:698">;; </span><span class="comment" id="font-lock:701">GNU Emacs is free software: you can redistribute it and/or modify
</span><a href="#linum:22"><span class="linum" id="linum:22">  22</span></a><span class="fringe" id="point:767"> </span><span class="comment-delimiter" id="font-lock:767">;; </span><span class="comment" id="font-lock:770">it under the terms of the GNU General Public License as published by
</span><a href="#linum:23"><span class="linum" id="linum:23">  23</span></a><span class="fringe" id="point:839"> </span><span class="comment-delimiter" id="font-lock:839">;; </span><span class="comment" id="font-lock:842">the Free Software Foundation, either version 3 of the License, or
</span><a href="#linum:24"><span class="linum" id="linum:24">  24</span></a><span class="fringe" id="point:908"> </span><span class="comment-delimiter" id="font-lock:908">;; </span><span class="comment" id="font-lock:911">(at your option) any later version.
</span><a href="#linum:25"><span class="linum" id="linum:25">  25</span></a><span class="fringe" id="point:947"> </span>
<a href="#linum:26"><span class="linum" id="linum:26">  26</span></a><span class="fringe" id="point:948"> </span><span class="comment-delimiter" id="font-lock:948">;; </span><span class="comment" id="font-lock:951">GNU Emacs is distributed in the hope that it will be useful,
</span><a href="#linum:27"><span class="linum" id="linum:27">  27</span></a><span class="fringe" id="point:1012"> </span><span class="comment-delimiter" id="font-lock:1012">;; </span><span class="comment" id="font-lock:1015">but WITHOUT ANY WARRANTY; without even the implied warranty of
</span><a href="#linum:28"><span class="linum" id="linum:28">  28</span></a><span class="fringe" id="point:1078"> </span><span class="comment-delimiter" id="font-lock:1078">;; </span><span class="comment" id="font-lock:1081">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</span><a href="#linum:29"><span class="linum" id="linum:29">  29</span></a><span class="fringe" id="point:1143"> </span><span class="comment-delimiter" id="font-lock:1143">;; </span><span class="comment" id="font-lock:1146">GNU General Public License for more details.
</span><a href="#linum:30"><span class="linum" id="linum:30">  30</span></a><span class="fringe" id="point:1191"> </span>
<a href="#linum:31"><span class="linum" id="linum:31">  31</span></a><span class="fringe" id="point:1192"> </span><span class="comment-delimiter" id="font-lock:1192">;; </span><span class="comment" id="font-lock:1195">You should have received a copy of the GNU General Public License
</span><a href="#linum:32"><span class="linum" id="linum:32">  32</span></a><span class="fringe" id="point:1261"> </span><span class="comment-delimiter" id="font-lock:1261">;; </span><span class="comment" id="font-lock:1264">along with GNU Emacs.  If not, see &lt;<a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>&gt;.
</span><a href="#linum:33"><span class="linum" id="linum:33">  33</span></a><span class="fringe" id="point:1331"> </span>
<a href="#linum:34"><span class="linum" id="linum:34">  34</span></a><span class="fringe" id="point:1332"> </span><span class="comment-delimiter" id="font-lock:1332">;;; </span><span class="comment" id="font-lock:1336">Commentary:
</span><a href="#linum:35"><span class="linum" id="linum:35">  35</span></a><span class="fringe" id="point:1348"> </span><span class="comment-delimiter" id="font-lock:1348">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="comment" id="font-lock:1412">
</span><a href="#linum:36"><span class="linum" id="linum:36">  36</span></a><span class="fringe" id="point:1413"> </span><span class="comment-delimiter" id="font-lock:1413">;; </span><span class="comment" id="font-lock:1416">I have made some changes to make it work for Emacs 22.   A lot of
</span><a href="#linum:37"><span class="linum" id="linum:37">  37</span></a><span class="fringe" id="point:1482"> </span><span class="comment-delimiter" id="font-lock:1482">;; </span><span class="comment" id="font-lock:1485">small bug fixes related to the format of text and overlay
</span><a href="#linum:38"><span class="linum" id="linum:38">  38</span></a><span class="fringe" id="point:1543"> </span><span class="comment-delimiter" id="font-lock:1543">;; </span><span class="comment" id="font-lock:1546">properties (which might have changed since the beginning of 2003
</span><a href="#linum:39"><span class="linum" id="linum:39">  39</span></a><span class="fringe" id="point:1611"> </span><span class="comment-delimiter" id="font-lock:1611">;; </span><span class="comment" id="font-lock:1614">when this file was originally written).
</span><a href="#linum:40"><span class="linum" id="linum:40">  40</span></a><span class="fringe" id="point:1654"> </span><span class="comment-delimiter" id="font-lock:1654">;;</span><span class="comment" id="font-lock:1656">
</span><a href="#linum:41"><span class="linum" id="linum:41">  41</span></a><span class="fringe" id="point:1657"> </span><span class="comment-delimiter" id="font-lock:1657">;; </span><span class="comment" id="font-lock:1660">The function `</span><span class="comment" id="font-lock:1674"><span class="constant" id="font-lock:1674">hfy-face-at</span></span><span class="comment" id="font-lock:1685">' currently carries much of the burden of
</span><a href="#linum:42"><span class="linum" id="linum:42">  42</span></a><span class="fringe" id="point:1727"> </span><span class="comment-delimiter" id="font-lock:1727">;; </span><span class="comment" id="font-lock:1730">my lacking understanding of the formats mentioned above and should
</span><a href="#linum:43"><span class="linum" id="linum:43">  43</span></a><span class="fringe" id="point:1797"> </span><span class="comment-delimiter" id="font-lock:1797">;; </span><span class="comment" id="font-lock:1800">need some knowledgeable help.
</span><a href="#linum:44"><span class="linum" id="linum:44">  44</span></a><span class="fringe" id="point:1830"> </span><span class="comment-delimiter" id="font-lock:1830">;;</span><span class="comment" id="font-lock:1832">
</span><a href="#linum:45"><span class="linum" id="linum:45">  45</span></a><span class="fringe" id="point:1833"> </span><span class="comment-delimiter" id="font-lock:1833">;; </span><span class="comment" id="font-lock:1836">Another thing that maybe could be fixed is that overlay background
</span><a href="#linum:46"><span class="linum" id="linum:46">  46</span></a><span class="fringe" id="point:1903"> </span><span class="comment-delimiter" id="font-lock:1903">;; </span><span class="comment" id="font-lock:1906">colors which are now only seen where there is text (in the XHTML
</span><a href="#linum:47"><span class="linum" id="linum:47">  47</span></a><span class="fringe" id="point:1971"> </span><span class="comment-delimiter" id="font-lock:1971">;; </span><span class="comment" id="font-lock:1974">output).  A bit of CSS tweaking is necessary there.
</span><a href="#linum:48"><span class="linum" id="linum:48">  48</span></a><span class="fringe" id="point:2026"> </span><span class="comment-delimiter" id="font-lock:2026">;;</span><span class="comment" id="font-lock:2028">
</span><a href="#linum:49"><span class="linum" id="linum:49">  49</span></a><span class="fringe" id="point:2029"> </span><span class="comment-delimiter" id="font-lock:2029">;; </span><span class="comment" id="font-lock:2032">The face 'default has a value :background "SystemWindow" for the
</span><a href="#linum:50"><span class="linum" id="linum:50">  50</span></a><span class="fringe" id="point:2097"> </span><span class="comment-delimiter" id="font-lock:2097">;; </span><span class="comment" id="font-lock:2100">background color.   There is no explicit notion that this should be
</span><a href="#linum:51"><span class="linum" id="linum:51">  51</span></a><span class="fringe" id="point:2168"> </span><span class="comment-delimiter" id="font-lock:2168">;; </span><span class="comment" id="font-lock:2171">considered transparent, but I have assumed that it could be handled
</span><a href="#linum:52"><span class="linum" id="linum:52">  52</span></a><span class="fringe" id="point:2239"> </span><span class="comment-delimiter" id="font-lock:2239">;; </span><span class="comment" id="font-lock:2242">like if it was here.  (I am unsure that background and foreground
</span><a href="#linum:53"><span class="linum" id="linum:53">  53</span></a><span class="fringe" id="point:2308"> </span><span class="comment-delimiter" id="font-lock:2308">;; </span><span class="comment" id="font-lock:2311">priorities are handled ok, but it looks ok in my tests now.)
</span><a href="#linum:54"><span class="linum" id="linum:54">  54</span></a><span class="fringe" id="point:2372"> </span><span class="comment-delimiter" id="font-lock:2372">;;</span><span class="comment" id="font-lock:2374">
</span><a href="#linum:55"><span class="linum" id="linum:55">  55</span></a><span class="fringe" id="point:2375"> </span><span class="comment-delimiter" id="font-lock:2375">;; </span><span class="comment" id="font-lock:2378">2007-12-27 Lennart Borgman
</span><a href="#linum:56"><span class="linum" id="linum:56">  56</span></a><span class="fringe" id="point:2405"> </span><span class="comment-delimiter" id="font-lock:2405">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="comment" id="font-lock:2469">
</span><a href="#linum:57"><span class="linum" id="linum:57">  57</span></a><span class="fringe" id="point:2470"> </span>
<a href="#linum:58"><span class="linum" id="linum:58">  58</span></a><span class="fringe" id="point:2471"> </span><span class="comment-delimiter" id="font-lock:2471">;; </span><span class="comment" id="font-lock:2474">Here's some elisp code to html-pretty-print an Emacs buffer, preserving
</span><a href="#linum:59"><span class="linum" id="linum:59">  59</span></a><span class="fringe" id="point:2546"> </span><span class="comment-delimiter" id="font-lock:2546">;; </span><span class="comment" id="font-lock:2549">the Emacs syntax/whatever highlighting.  It also knows how to drive etags
</span><a href="#linum:60"><span class="linum" id="linum:60">  60</span></a><span class="fringe" id="point:2623"> </span><span class="comment-delimiter" id="font-lock:2623">;; </span><span class="comment" id="font-lock:2626">(exuberant-ctags or Emacs etags) and hyperlink the code according
</span><a href="#linum:61"><span class="linum" id="linum:61">  61</span></a><span class="fringe" id="point:2692"> </span><span class="comment-delimiter" id="font-lock:2692">;; </span><span class="comment" id="font-lock:2695">to its (etags') output.
</span><a href="#linum:62"><span class="linum" id="linum:62">  62</span></a><span class="fringe" id="point:2719"> </span>
<a href="#linum:63"><span class="linum" id="linum:63">  63</span></a><span class="fringe" id="point:2720"> </span><span class="comment-delimiter" id="font-lock:2720">;; </span><span class="comment" id="font-lock:2723">NOTE: Currently the hyperlinking code only knows how to drive GNU find
</span><a href="#linum:64"><span class="linum" id="linum:64">  64</span></a><span class="fringe" id="point:2794"> </span><span class="comment-delimiter" id="font-lock:2794">;; </span><span class="comment" id="font-lock:2797">and the exuberant and GNU variants of etags : I do not know of any other
</span><a href="#linum:65"><span class="linum" id="linum:65">  65</span></a><span class="fringe" id="point:2870"> </span><span class="comment-delimiter" id="font-lock:2870">;; </span><span class="comment" id="font-lock:2873">etags variants, but mechanisms have been provided to allow htmlfontify
</span><a href="#linum:66"><span class="linum" id="linum:66">  66</span></a><span class="fringe" id="point:2944"> </span><span class="comment-delimiter" id="font-lock:2944">;; </span><span class="comment" id="font-lock:2947">to be taught how to drive them.  As long as your version of find has
</span><a href="#linum:67"><span class="linum" id="linum:67">  67</span></a><span class="fringe" id="point:3016"> </span><span class="comment-delimiter" id="font-lock:3016">;; </span><span class="comment" id="font-lock:3019">the -path test and is reasonably sane, you should be fine.
</span><a href="#linum:68"><span class="linum" id="linum:68">  68</span></a><span class="fringe" id="point:3078"> </span>
<a href="#linum:69"><span class="linum" id="linum:69">  69</span></a><span class="fringe" id="point:3079"> </span><span class="comment-delimiter" id="font-lock:3079">;; </span><span class="comment" id="font-lock:3082">A sample of the htmlfontified / hyperlinked output of this module can be
</span><a href="#linum:70"><span class="linum" id="linum:70">  70</span></a><span class="fringe" id="point:3155"> </span><span class="comment-delimiter" id="font-lock:3155">;; </span><span class="comment" id="font-lock:3158">found at http://rtfm.etla.org/sql/dbishell/src/ - it's not perfect, but
</span><a href="#linum:71"><span class="linum" id="linum:71">  71</span></a><span class="fringe" id="point:3230"> </span><span class="comment-delimiter" id="font-lock:3230">;; </span><span class="comment" id="font-lock:3233">it's a hell of a lot faster and more thorough than I could hope to be
</span><a href="#linum:72"><span class="linum" id="linum:72">  72</span></a><span class="fringe" id="point:3303"> </span><span class="comment-delimiter" id="font-lock:3303">;; </span><span class="comment" id="font-lock:3306">doing this by hand.
</span><a href="#linum:73"><span class="linum" id="linum:73">  73</span></a><span class="fringe" id="point:3326"> </span>
<a href="#linum:74"><span class="linum" id="linum:74">  74</span></a><span class="fringe" id="point:3327"> </span><span class="comment-delimiter" id="font-lock:3327">;; </span><span class="comment" id="font-lock:3330">some user / horrified onlooker comments:
</span><a href="#linum:75"><span class="linum" id="linum:75">  75</span></a><span class="fringe" id="point:3371"> </span><span class="comment-delimiter" id="font-lock:3371">;; </span><span class="comment" id="font-lock:3374">What? No! There's something deeply wrong here...   (R. Shufflebotham)
</span><a href="#linum:76"><span class="linum" id="linum:76">  76</span></a><span class="fringe" id="point:3444"> </span><span class="comment-delimiter" id="font-lock:3444">;; </span><span class="comment" id="font-lock:3447">You're a freak.                                    (D. Silverstone)
</span><a href="#linum:77"><span class="linum" id="linum:77">  77</span></a><span class="fringe" id="point:3515"> </span><span class="comment-delimiter" id="font-lock:3515">;; </span><span class="comment" id="font-lock:3518">Aren't we giving you enough to do?                 (J. Busuttil)
</span><a href="#linum:78"><span class="linum" id="linum:78">  78</span></a><span class="fringe" id="point:3583"> </span><span class="comment-delimiter" id="font-lock:3583">;; </span><span class="comment" id="font-lock:3586">You're almost as messed up as Lexx is!             (N. Graves-Morris)
</span><a href="#linum:79"><span class="linum" id="linum:79">  79</span></a><span class="fringe" id="point:3656"> </span>
<a href="#linum:80"><span class="linum" id="linum:80">  80</span></a><span class="fringe" id="point:3657"> </span><span class="comment-delimiter" id="font-lock:3657">;;; </span><span class="comment" id="font-lock:3661">History:
</span><a href="#linum:81"><span class="linum" id="linum:81">  81</span></a><span class="fringe" id="point:3670"> </span><span class="comment-delimiter" id="font-lock:3670">;; </span><span class="comment" id="font-lock:3673">Changes: moved to changelog (CHANGES) file.
</span><a href="#linum:82"><span class="linum" id="linum:82">  82</span></a><span class="fringe" id="point:3717"> </span>
<a href="#linum:83"><span class="linum" id="linum:83">  83</span></a><span class="fringe" id="point:3718"> </span><span class="comment-delimiter" id="font-lock:3718">;;; </span><span class="comment" id="font-lock:3722">Code:
</span><a href="#linum:84"><span class="linum" id="linum:84">  84</span></a><span class="fringe" id="point:3728"> </span>(<span class="keyword" id="font-lock:3729">eval-when-compile</span> (<span class="keyword" id="font-lock:3748">require</span> '<span class="constant" id="font-lock:3757">cl</span>))
<a href="#linum:85"><span class="linum" id="linum:85">  85</span></a><span class="fringe" id="point:3762"> </span>(<span class="keyword" id="font-lock:3763">require</span> '<span class="constant" id="font-lock:3772">faces</span>)
<a href="#linum:86"><span class="linum" id="linum:86">  86</span></a><span class="fringe" id="point:3779"> </span><span class="comment-delimiter" id="font-lock:3779">;;  </span><span class="comment" id="font-lock:3783">(`</span><span class="comment" id="font-lock:3785"><span class="constant" id="font-lock:3785">facep</span></span><span class="comment" id="font-lock:3790">' `</span><span class="comment" id="font-lock:3793"><span class="constant" id="font-lock:3793">face-attr-construct</span></span><span class="comment" id="font-lock:3812">' `</span><span class="comment" id="font-lock:3815"><span class="constant" id="font-lock:3815">x-color-values</span></span><span class="comment" id="font-lock:3829">' `</span><span class="comment" id="font-lock:3832"><span class="constant" id="font-lock:3832">color-values</span></span><span class="comment" id="font-lock:3844">' `</span><span class="comment" id="font-lock:3847"><span class="constant" id="font-lock:3847">face-name</span></span><span class="comment" id="font-lock:3856">')
</span><a href="#linum:87"><span class="linum" id="linum:87">  87</span></a><span class="fringe" id="point:3859"> </span>(<span class="keyword" id="font-lock:3860">require</span> '<span class="constant" id="font-lock:3869">custom</span>)
<a href="#linum:88"><span class="linum" id="linum:88">  88</span></a><span class="fringe" id="point:3877"> </span><span class="comment-delimiter" id="font-lock:3877">;;  </span><span class="comment" id="font-lock:3881">(`</span><span class="comment" id="font-lock:3883"><span class="constant" id="font-lock:3883">defgroup</span></span><span class="comment" id="font-lock:3891">' `</span><span class="comment" id="font-lock:3894"><span class="constant" id="font-lock:3894">defcustom</span></span><span class="comment" id="font-lock:3903">')
</span><a href="#linum:89"><span class="linum" id="linum:89">  89</span></a><span class="fringe" id="point:3906"> </span>(<span class="keyword" id="font-lock:3907">require</span> '<span class="constant" id="font-lock:3916">font-lock</span>)
<a href="#linum:90"><span class="linum" id="linum:90">  90</span></a><span class="fringe" id="point:3927"> </span><span class="comment-delimiter" id="font-lock:3927">;;  </span><span class="comment" id="font-lock:3931">(`</span><span class="comment" id="font-lock:3933"><span class="constant" id="font-lock:3933">font-lock-fontify-region</span></span><span class="comment" id="font-lock:3957">')
</span><a href="#linum:91"><span class="linum" id="linum:91">  91</span></a><span class="fringe" id="point:3960"> </span>(<span class="keyword" id="font-lock:3961">require</span> '<span class="constant" id="font-lock:3970">cus-edit</span>)
<a href="#linum:92"><span class="linum" id="linum:92">  92</span></a><span class="fringe" id="point:3980"> </span>
<a href="#linum:93"><span class="linum" id="linum:93">  93</span></a><span class="fringe" id="point:3981"> </span>(<span class="keyword" id="font-lock:3982">eval-and-compile</span>
<a href="#linum:94"><span class="linum" id="linum:94">  94</span></a><span class="fringe" id="point:3999"> </span>  <span class="comment-delimiter" id="font-lock:4001">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="comment" id="font-lock:4076">
</span><a href="#linum:95"><span class="linum" id="linum:95">  95</span></a><span class="fringe" id="point:4077"> </span>  <span class="comment-delimiter" id="font-lock:4079">;; </span><span class="comment" id="font-lock:4082">I want these - can't be bothered requiring all of cl though.
</span><a href="#linum:96"><span class="linum" id="linum:96">  96</span></a><span class="fringe" id="point:4143"> </span>  (<span class="keyword" id="font-lock:4146">if</span> (not (fboundp 'caddr))
<a href="#linum:97"><span class="linum" id="linum:97">  97</span></a><span class="fringe" id="point:4172"> </span>      (<span class="keyword" id="font-lock:4179">defun</span> <span class="function-name" id="font-lock:4185">caddr</span> (list)
<a href="#linum:98"><span class="linum" id="linum:98">  98</span></a><span class="fringe" id="point:4198"> </span>        <span class="doc" id="font-lock:4206">"Return the `</span><span class="doc" id="font-lock:4219"><span class="constant" id="font-lock:4219">car</span></span><span class="doc" id="font-lock:4222">' of the `</span><span class="doc" id="font-lock:4232"><span class="constant" id="font-lock:4232">cddr</span></span><span class="doc" id="font-lock:4236">' of LIST."</span>
<a href="#linum:99"><span class="linum" id="linum:99">  99</span></a><span class="fringe" id="point:4248"> </span>        (car (cddr list))))
<a href="#linum:100"><span class="linum" id="linum:100"> 100</span></a><span class="fringe" id="point:4276"> </span>
<a href="#linum:101"><span class="linum" id="linum:101"> 101</span></a><span class="fringe" id="point:4277"> </span>  (<span class="keyword" id="font-lock:4280">if</span> (not (fboundp 'cadddr))
<a href="#linum:102"><span class="linum" id="linum:102"> 102</span></a><span class="fringe" id="point:4307"> </span>      (<span class="keyword" id="font-lock:4314">defun</span> <span class="function-name" id="font-lock:4320">cadddr</span> (list)
<a href="#linum:103"><span class="linum" id="linum:103"> 103</span></a><span class="fringe" id="point:4334"> </span>        <span class="doc" id="font-lock:4342">"Return the `</span><span class="doc" id="font-lock:4355"><span class="constant" id="font-lock:4355">cadr</span></span><span class="doc" id="font-lock:4359">' of the `</span><span class="doc" id="font-lock:4369"><span class="constant" id="font-lock:4369">cddr</span></span><span class="doc" id="font-lock:4373">' of LIST."</span>
<a href="#linum:104"><span class="linum" id="linum:104"> 104</span></a><span class="fringe" id="point:4385"> </span>        (cadr (cddr list))))
<a href="#linum:105"><span class="linum" id="linum:105"> 105</span></a><span class="fringe" id="point:4414"> </span>  <span class="comment-delimiter" id="font-lock:4416">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="comment" id="font-lock:4491">
</span><a href="#linum:106"><span class="linum" id="linum:106"> 106</span></a><span class="fringe" id="point:4492"> </span>
<a href="#linum:107"><span class="linum" id="linum:107"> 107</span></a><span class="fringe" id="point:4493"> </span>  (autoload
<a href="#linum:108"><span class="linum" id="linum:108"> 108</span></a><span class="fringe" id="point:4505"> </span>    'htmlfontify-load-rgb-file
<a href="#linum:109"><span class="linum" id="linum:109"> 109</span></a><span class="fringe" id="point:4536"> </span>    <span class="string" id="font-lock:4540">"hfy-cmap"</span>
<a href="#linum:110"><span class="linum" id="linum:110"> 110</span></a><span class="fringe" id="point:4551"> </span>    <span class="doc" id="font-lock:4555">"Load an rgb.txt file for color name -&gt; rgb translation purposes."</span>
<a href="#linum:111"><span class="linum" id="linum:111"> 111</span></a><span class="fringe" id="point:4622"> </span>    'interactive)
<a href="#linum:112"><span class="linum" id="linum:112"> 112</span></a><span class="fringe" id="point:4640"> </span>
<a href="#linum:113"><span class="linum" id="linum:113"> 113</span></a><span class="fringe" id="point:4641"> </span>  (autoload
<a href="#linum:114"><span class="linum" id="linum:114"> 114</span></a><span class="fringe" id="point:4653"> </span>    'htmlfontify-unload-rgb-file
<a href="#linum:115"><span class="linum" id="linum:115"> 115</span></a><span class="fringe" id="point:4686"> </span>    <span class="string" id="font-lock:4690">"hfy-cmap"</span>
<a href="#linum:116"><span class="linum" id="linum:116"> 116</span></a><span class="fringe" id="point:4701"> </span>    <span class="doc" id="font-lock:4705">"Unload the current color name -&gt; rgb translation map."</span>
<a href="#linum:117"><span class="linum" id="linum:117"> 117</span></a><span class="fringe" id="point:4761"> </span>    'interactive)
<a href="#linum:118"><span class="linum" id="linum:118"> 118</span></a><span class="fringe" id="point:4779"> </span>
<a href="#linum:119"><span class="linum" id="linum:119"> 119</span></a><span class="fringe" id="point:4780"> </span>  (autoload
<a href="#linum:120"><span class="linum" id="linum:120"> 120</span></a><span class="fringe" id="point:4792"> </span>    'hfy-fallback-colour-values
<a href="#linum:121"><span class="linum" id="linum:121"> 121</span></a><span class="fringe" id="point:4824"> </span>    <span class="string" id="font-lock:4828">"hfy-cmap"</span>
<a href="#linum:122"><span class="linum" id="linum:122"> 122</span></a><span class="fringe" id="point:4839"> </span>    <span class="doc" id="font-lock:4843">"Use a fallback method for obtaining the rgb values for a color."</span>
<a href="#linum:123"><span class="linum" id="linum:123"> 123</span></a><span class="fringe" id="point:4909"> </span>    'interactive)
<a href="#linum:124"><span class="linum" id="linum:124"> 124</span></a><span class="fringe" id="point:4927"> </span>  )
<a href="#linum:125"><span class="linum" id="linum:125"> 125</span></a><span class="fringe" id="point:4931"> </span>
<a href="#linum:126"><span class="linum" id="linum:126"> 126</span></a><span class="fringe" id="point:4932"> </span>(<span class="keyword" id="font-lock:4933">defconst</span> <span class="variable-name" id="font-lock:4942">htmlfontify-version</span> 0.21)
<a href="#linum:127"><span class="linum" id="linum:127"> 127</span></a><span class="fringe" id="point:4968"> </span>
<a href="#linum:128"><span class="linum" id="linum:128"> 128</span></a><span class="fringe" id="point:4969"> </span>(<span class="keyword" id="font-lock:4970">defconst</span> <span class="variable-name" id="font-lock:4979">hfy-meta-tags</span>
<a href="#linum:129"><span class="linum" id="linum:129"> 129</span></a><span class="fringe" id="point:4993"> </span>  (format <span class="string" id="font-lock:5003">"&lt;meta name=\"generator\" content=\"emacs %s; htmlfontify %0.2f\" /&gt;"</span>
<a href="#linum:130"><span class="linum" id="linum:130"> 130</span></a><span class="fringe" id="point:5073"> </span>          emacs-version htmlfontify-version)
<a href="#linum:131"><span class="linum" id="linum:131"> 131</span></a><span class="fringe" id="point:5118"> </span>  <span class="doc" id="font-lock:5120">"The generator meta tag for this version of htmlfontify."</span>)
<a href="#linum:132"><span class="linum" id="linum:132"> 132</span></a><span class="fringe" id="point:5179"> </span>
<a href="#linum:133"><span class="linum" id="linum:133"> 133</span></a><span class="fringe" id="point:5180"> </span>(<span class="keyword" id="font-lock:5181">defconst</span> <span class="variable-name" id="font-lock:5190">htmlfontify-manual</span> <span class="string" id="font-lock:5209">"Htmlfontify Manual"</span>
<a href="#linum:134"><span class="linum" id="linum:134"> 134</span></a><span class="fringe" id="point:5230"> </span>  <span class="doc" id="font-lock:5232">"Copy and convert buffers and files to HTML, adding hyperlinks between files
</span><a href="#linum:135"><span class="linum" id="linum:135"> 135</span></a><span class="fringe" id="point:5309"> </span><span class="doc" id="font-lock:5309">\(driven by etags) if requested.
</span><a href="#linum:136"><span class="linum" id="linum:136"> 136</span></a><span class="fringe" id="point:5342"> </span><span class="doc" id="font-lock:5342">\nInteractive functions:
</span><a href="#linum:137"><span class="linum" id="linum:137"> 137</span></a><span class="fringe" id="point:5367"> </span><span class="doc" id="font-lock:5367">  `</span><span class="doc" id="font-lock:5370"><span class="constant" id="font-lock:5370">htmlfontify-buffer</span></span><span class="doc" id="font-lock:5388">'
</span><a href="#linum:138"><span class="linum" id="linum:138"> 138</span></a><span class="fringe" id="point:5390"> </span><span class="doc" id="font-lock:5390">  `</span><span class="doc" id="font-lock:5393"><span class="constant" id="font-lock:5393">htmlfontify-run-etags</span></span><span class="doc" id="font-lock:5414">'
</span><a href="#linum:139"><span class="linum" id="linum:139"> 139</span></a><span class="fringe" id="point:5416"> </span><span class="doc" id="font-lock:5416">  `</span><span class="doc" id="font-lock:5419"><span class="constant" id="font-lock:5419">htmlfontify-copy-and-link-dir</span></span><span class="doc" id="font-lock:5448">'
</span><a href="#linum:140"><span class="linum" id="linum:140"> 140</span></a><span class="fringe" id="point:5450"> </span><span class="doc" id="font-lock:5450">  `</span><span class="doc" id="font-lock:5453"><span class="constant" id="font-lock:5453">htmlfontify-load-rgb-file</span></span><span class="doc" id="font-lock:5478">'
</span><a href="#linum:141"><span class="linum" id="linum:141"> 141</span></a><span class="fringe" id="point:5480"> </span><span class="doc" id="font-lock:5480">  `</span><span class="doc" id="font-lock:5483"><span class="constant" id="font-lock:5483">htmlfontify-unload-rgb-file</span></span><span class="doc" id="font-lock:5510">'\n
</span><a href="#linum:142"><span class="linum" id="linum:142"> 142</span></a><span class="fringe" id="point:5514"> </span><span class="doc" id="font-lock:5514">In order to:\n
</span><a href="#linum:143"><span class="linum" id="linum:143"> 143</span></a><span class="fringe" id="point:5529"> </span><span class="doc" id="font-lock:5529">fontify a file you have open:           M-x htmlfontify-buffer
</span><a href="#linum:144"><span class="linum" id="linum:144"> 144</span></a><span class="fringe" id="point:5592"> </span><span class="doc" id="font-lock:5592">prepare the etags map for a directory:  M-x htmlfontify-run-etags
</span><a href="#linum:145"><span class="linum" id="linum:145"> 145</span></a><span class="fringe" id="point:5658"> </span><span class="doc" id="font-lock:5658">copy a directory, fontifying as you go: M-x htmlfontify-copy-and-link-dir\n
</span><a href="#linum:146"><span class="linum" id="linum:146"> 146</span></a><span class="fringe" id="point:5734"> </span><span class="doc" id="font-lock:5734">The following might be useful when running non-windowed or in batch mode:
</span><a href="#linum:147"><span class="linum" id="linum:147"> 147</span></a><span class="fringe" id="point:5808"> </span><span class="doc" id="font-lock:5808">\(note that they shouldn't be necessary - we have a built in map)\n
</span><a href="#linum:148"><span class="linum" id="linum:148"> 148</span></a><span class="fringe" id="point:5876"> </span><span class="doc" id="font-lock:5876">load an X11 style rgb.txt file:         M-x htmlfontify-load-rgb-file
</span><a href="#linum:149"><span class="linum" id="linum:149"> 149</span></a><span class="fringe" id="point:5946"> </span><span class="doc" id="font-lock:5946">unload the current rgb.txt file:        M-x htmlfontify-unload-rgb-file\n
</span><a href="#linum:150"><span class="linum" id="linum:150"> 150</span></a><span class="fringe" id="point:6020"> </span><span class="doc" id="font-lock:6020">And here's a programmatic example:\n
</span><a href="#linum:151"><span class="linum" id="linum:151"> 151</span></a><span class="fringe" id="point:6057"> </span><span class="doc" id="font-lock:6057">\(defun rtfm-build-page-header (file style)
</span><a href="#linum:152"><span class="linum" id="linum:152"> 152</span></a><span class="fringe" id="point:6101"> </span><span class="doc" id="font-lock:6101">  (format \"#define  TEMPLATE red+black.html
</span><a href="#linum:153"><span class="linum" id="linum:153"> 153</span></a><span class="fringe" id="point:6146"> </span><span class="doc" id="font-lock:6146">#define  DEBUG    1
</span><a href="#linum:154"><span class="linum" id="linum:154"> 154</span></a><span class="fringe" id="point:6166"> </span><span class="doc" id="font-lock:6166">#include &lt;build/menu-dirlist|&gt;\\n
</span><a href="#linum:155"><span class="linum" id="linum:155"> 155</span></a><span class="fringe" id="point:6200"> </span><span class="doc" id="font-lock:6200">html-css-url := /css/red+black.css
</span><a href="#linum:156"><span class="linum" id="linum:156"> 156</span></a><span class="fringe" id="point:6235"> </span><span class="doc" id="font-lock:6235">title        := rtfm.etla.org ( %s / src/%s )
</span><a href="#linum:157"><span class="linum" id="linum:157"> 157</span></a><span class="fringe" id="point:6281"> </span><span class="doc" id="font-lock:6281">bodytag      :=
</span><a href="#linum:158"><span class="linum" id="linum:158"> 158</span></a><span class="fringe" id="point:6297"> </span><span class="doc" id="font-lock:6297">head         &lt;=STYLESHEET;\\n
</span><a href="#linum:159"><span class="linum" id="linum:159"> 159</span></a><span class="fringe" id="point:6327"> </span><span class="doc" id="font-lock:6327">%s
</span><a href="#linum:160"><span class="linum" id="linum:160"> 160</span></a><span class="fringe" id="point:6330"> </span><span class="doc" id="font-lock:6330">STYLESHEET
</span><a href="#linum:161"><span class="linum" id="linum:161"> 161</span></a><span class="fringe" id="point:6341"> </span><span class="doc" id="font-lock:6341">main-title   := rtfm / %s / src/%s\\n
</span><a href="#linum:162"><span class="linum" id="linum:162"> 162</span></a><span class="fringe" id="point:6379"> </span><span class="doc" id="font-lock:6379">main-content &lt;=MAIN_CONTENT;\\n\" rtfm-section file style rtfm-section file))
</span><a href="#linum:163"><span class="linum" id="linum:163"> 163</span></a><span class="fringe" id="point:6457"> </span><span class="doc" id="font-lock:6457">
</span><a href="#linum:164"><span class="linum" id="linum:164"> 164</span></a><span class="fringe" id="point:6458"> </span><span class="doc" id="font-lock:6458">\(defun rtfm-build-page-footer (file) \"\\nMAIN_CONTENT\\n\")
</span><a href="#linum:165"><span class="linum" id="linum:165"> 165</span></a><span class="fringe" id="point:6520"> </span><span class="doc" id="font-lock:6520">
</span><a href="#linum:166"><span class="linum" id="linum:166"> 166</span></a><span class="fringe" id="point:6521"> </span><span class="doc" id="font-lock:6521">\(defun rtfm-build-source-docs (section srcdir destdir)
</span><a href="#linum:167"><span class="linum" id="linum:167"> 167</span></a><span class="fringe" id="point:6577"> </span><span class="doc" id="font-lock:6577">  (interactive
</span><a href="#linum:168"><span class="linum" id="linum:168"> 168</span></a><span class="fringe" id="point:6592"> </span><span class="doc" id="font-lock:6592">   \"s section[eg- emacs / p4-blame]:\\nD source-dir: \\nD output-dir: \")
</span><a href="#linum:169"><span class="linum" id="linum:169"> 169</span></a><span class="fringe" id="point:6667"> </span><span class="doc" id="font-lock:6667">  (require 'htmlfontify)
</span><a href="#linum:170"><span class="linum" id="linum:170"> 170</span></a><span class="fringe" id="point:6692"> </span><span class="doc" id="font-lock:6692">  (hfy-load-tags-cache srcdir)
</span><a href="#linum:171"><span class="linum" id="linum:171"> 171</span></a><span class="fringe" id="point:6723"> </span><span class="doc" id="font-lock:6723">  (let ((hfy-page-header  'rtfm-build-page-header)
</span><a href="#linum:172"><span class="linum" id="linum:172"> 172</span></a><span class="fringe" id="point:6774"> </span><span class="doc" id="font-lock:6774">        (hfy-page-footer  'rtfm-build-page-footer)
</span><a href="#linum:173"><span class="linum" id="linum:173"> 173</span></a><span class="fringe" id="point:6825"> </span><span class="doc" id="font-lock:6825">        (rtfm-section                     section)
</span><a href="#linum:174"><span class="linum" id="linum:174"> 174</span></a><span class="fringe" id="point:6876"> </span><span class="doc" id="font-lock:6876">        (hfy-index-file                   \"index\"))
</span><a href="#linum:175"><span class="linum" id="linum:175"> 175</span></a><span class="fringe" id="point:6930"> </span><span class="doc" id="font-lock:6930">    (htmlfontify-run-etags srcdir)
</span><a href="#linum:176"><span class="linum" id="linum:176"> 176</span></a><span class="fringe" id="point:6965"> </span><span class="doc" id="font-lock:6965">    (htmlfontify-copy-and-link-dir srcdir destdir \".src\" \".html\")))"</span>)
<a href="#linum:177"><span class="linum" id="linum:177"> 177</span></a><span class="fringe" id="point:7039"> </span>
<a href="#linum:178"><span class="linum" id="linum:178"> 178</span></a><span class="fringe" id="point:7040"> </span>(<span class="keyword" id="font-lock:7041">defgroup</span> <span class="type" id="font-lock:7050">htmlfontify</span> nil
<a href="#linum:179"><span class="linum" id="linum:179"> 179</span></a><span class="fringe" id="point:7066"> </span>  <span class="doc" id="font-lock:7068">"Convert buffers and files to HTML."</span>
<a href="#linum:180"><span class="linum" id="linum:180"> 180</span></a><span class="fringe" id="point:7105"> </span>  <span class="builtin" id="font-lock:7107">:group</span>  'applications
<a href="#linum:181"><span class="linum" id="linum:181"> 181</span></a><span class="fringe" id="point:7129"> </span>  <span class="builtin" id="font-lock:7131">:link</span> '(variable-link htmlfontify-manual)
<a href="#linum:182"><span class="linum" id="linum:182"> 182</span></a><span class="fringe" id="point:7173"> </span>  <span class="builtin" id="font-lock:7175">:prefix</span> <span class="string" id="font-lock:7183">"hfy-"</span>)
<a href="#linum:183"><span class="linum" id="linum:183"> 183</span></a><span class="fringe" id="point:7191"> </span>
<a href="#linum:184"><span class="linum" id="linum:184"> 184</span></a><span class="fringe" id="point:7192"> </span>(<span class="keyword" id="font-lock:7193">defcustom</span> <span class="variable-name" id="font-lock:7203">hfy-page-header</span> 'hfy-default-header
<a href="#linum:185"><span class="linum" id="linum:185"> 185</span></a><span class="fringe" id="point:7239"> </span>  <span class="doc" id="font-lock:7241">"Function called with two arguments (the filename relative to the top
</span><a href="#linum:186"><span class="linum" id="linum:186"> 186</span></a><span class="fringe" id="point:7311"> </span><span class="doc" id="font-lock:7311">level source directory being etag'd and fontified), and a string containing
</span><a href="#linum:187"><span class="linum" id="linum:187"> 187</span></a><span class="fringe" id="point:7387"> </span><span class="doc" id="font-lock:7387">the &lt;style&gt;...&lt;/style&gt; text to embed in the document- the string returned will
</span><a href="#linum:188"><span class="linum" id="linum:188"> 188</span></a><span class="fringe" id="point:7466"> </span><span class="doc" id="font-lock:7466">be used as the header for the htmlfontified version of the source file.\n
</span><a href="#linum:189"><span class="linum" id="linum:189"> 189</span></a><span class="fringe" id="point:7540"> </span><span class="doc" id="font-lock:7540">See also `</span><span class="doc" id="font-lock:7550"><span class="constant" id="font-lock:7550">hfy-page-footer</span></span><span class="doc" id="font-lock:7565">'."</span>
<a href="#linum:190"><span class="linum" id="linum:190"> 190</span></a><span class="fringe" id="point:7569"> </span>  <span class="builtin" id="font-lock:7571">:group</span> 'htmlfontify
<a href="#linum:191"><span class="linum" id="linum:191"> 191</span></a><span class="fringe" id="point:7591"> </span>  <span class="comment-delimiter" id="font-lock:7593">;; </span><span class="comment" id="font-lock:7596">FIXME: Why place such a :tag everywhere?  Isn't it imposing your
</span><a href="#linum:192"><span class="linum" id="linum:192"> 192</span></a><span class="fringe" id="point:7661"> </span>  <span class="comment-delimiter" id="font-lock:7663">;; </span><span class="comment" id="font-lock:7666">own Custom preference on your users?  --Stef
</span><a href="#linum:193"><span class="linum" id="linum:193"> 193</span></a><span class="fringe" id="point:7711"> </span>  <span class="builtin" id="font-lock:7713">:tag</span>   <span class="string" id="font-lock:7720">"page-header"</span>
<a href="#linum:194"><span class="linum" id="linum:194"> 194</span></a><span class="fringe" id="point:7734"> </span>  <span class="builtin" id="font-lock:7736">:type</span>  '(function))
<a href="#linum:195"><span class="linum" id="linum:195"> 195</span></a><span class="fringe" id="point:7756"> </span>
<a href="#linum:196"><span class="linum" id="linum:196"> 196</span></a><span class="fringe" id="point:7757"> </span>(<span class="keyword" id="font-lock:7758">defcustom</span> <span class="variable-name" id="font-lock:7768">hfy-split-index</span> nil
<a href="#linum:197"><span class="linum" id="linum:197"> 197</span></a><span class="fringe" id="point:7788"> </span>  <span class="doc" id="font-lock:7790">"Whether or not to split the index `</span><span class="doc" id="font-lock:7826"><span class="constant" id="font-lock:7826">hfy-index-file</span></span><span class="doc" id="font-lock:7840">' alphabetically
</span><a href="#linum:198"><span class="linum" id="linum:198"> 198</span></a><span class="fringe" id="point:7857"> </span><span class="doc" id="font-lock:7857">on the first letter of each tag.  Useful when the index would otherwise
</span><a href="#linum:199"><span class="linum" id="linum:199"> 199</span></a><span class="fringe" id="point:7929"> </span><span class="doc" id="font-lock:7929">be large and take a long time to render or be difficult to navigate."</span>
<a href="#linum:200"><span class="linum" id="linum:200"> 200</span></a><span class="fringe" id="point:7999"> </span>  <span class="builtin" id="font-lock:8001">:group</span> 'htmlfontify
<a href="#linum:201"><span class="linum" id="linum:201"> 201</span></a><span class="fringe" id="point:8021"> </span>  <span class="builtin" id="font-lock:8023">:tag</span>   <span class="string" id="font-lock:8030">"split-index"</span>
<a href="#linum:202"><span class="linum" id="linum:202"> 202</span></a><span class="fringe" id="point:8044"> </span>  <span class="builtin" id="font-lock:8046">:type</span>  '(boolean))
<a href="#linum:203"><span class="linum" id="linum:203"> 203</span></a><span class="fringe" id="point:8065"> </span>
<a href="#linum:204"><span class="linum" id="linum:204"> 204</span></a><span class="fringe" id="point:8066"> </span>(<span class="keyword" id="font-lock:8067">defcustom</span> <span class="variable-name" id="font-lock:8077">hfy-page-footer</span> 'hfy-default-footer
<a href="#linum:205"><span class="linum" id="linum:205"> 205</span></a><span class="fringe" id="point:8113"> </span>  <span class="doc" id="font-lock:8115">"As `</span><span class="doc" id="font-lock:8120"><span class="constant" id="font-lock:8120">hfy-page-header</span></span><span class="doc" id="font-lock:8135">', but generates the output footer
</span><a href="#linum:206"><span class="linum" id="linum:206"> 206</span></a><span class="fringe" id="point:8170"> </span><span class="doc" id="font-lock:8170">\(and takes only one argument, the filename)."</span>
<a href="#linum:207"><span class="linum" id="linum:207"> 207</span></a><span class="fringe" id="point:8217"> </span>  <span class="builtin" id="font-lock:8219">:group</span> 'htmlfontify
<a href="#linum:208"><span class="linum" id="linum:208"> 208</span></a><span class="fringe" id="point:8239"> </span>  <span class="builtin" id="font-lock:8241">:tag</span>   <span class="string" id="font-lock:8248">"page-footer"</span>
<a href="#linum:209"><span class="linum" id="linum:209"> 209</span></a><span class="fringe" id="point:8262"> </span>  <span class="builtin" id="font-lock:8264">:type</span>  '(function))
<a href="#linum:210"><span class="linum" id="linum:210"> 210</span></a><span class="fringe" id="point:8284"> </span>
<a href="#linum:211"><span class="linum" id="linum:211"> 211</span></a><span class="fringe" id="point:8285"> </span>(<span class="keyword" id="font-lock:8286">defcustom</span> <span class="variable-name" id="font-lock:8296">hfy-extn</span>        <span class="string" id="font-lock:8312">".html"</span>
<a href="#linum:212"><span class="linum" id="linum:212"> 212</span></a><span class="fringe" id="point:8320"> </span>  <span class="doc" id="font-lock:8322">"File extension used for output files."</span>
<a href="#linum:213"><span class="linum" id="linum:213"> 213</span></a><span class="fringe" id="point:8362"> </span>  <span class="builtin" id="font-lock:8364">:group</span> 'htmlfontify
<a href="#linum:214"><span class="linum" id="linum:214"> 214</span></a><span class="fringe" id="point:8384"> </span>  <span class="builtin" id="font-lock:8386">:tag</span>   <span class="string" id="font-lock:8393">"extension"</span>
<a href="#linum:215"><span class="linum" id="linum:215"> 215</span></a><span class="fringe" id="point:8405"> </span>  <span class="builtin" id="font-lock:8407">:type</span>  '(string))
<a href="#linum:216"><span class="linum" id="linum:216"> 216</span></a><span class="fringe" id="point:8425"> </span>
<a href="#linum:217"><span class="linum" id="linum:217"> 217</span></a><span class="fringe" id="point:8426"> </span>(<span class="keyword" id="font-lock:8427">defcustom</span> <span class="variable-name" id="font-lock:8437">hfy-src-doc-link-style</span> <span class="string" id="font-lock:8460">"text-decoration: underline;"</span>
<a href="#linum:218"><span class="linum" id="linum:218"> 218</span></a><span class="fringe" id="point:8490"> </span>  <span class="doc" id="font-lock:8492">"String to add to the '&lt;style&gt; a' variant of an htmlfontify CSS class."</span>
<a href="#linum:219"><span class="linum" id="linum:219"> 219</span></a><span class="fringe" id="point:8564"> </span>  <span class="builtin" id="font-lock:8566">:group</span> 'htmlfontify
<a href="#linum:220"><span class="linum" id="linum:220"> 220</span></a><span class="fringe" id="point:8586"> </span>  <span class="builtin" id="font-lock:8588">:tag</span>   <span class="string" id="font-lock:8595">"src-doc-link-style"</span>
<a href="#linum:221"><span class="linum" id="linum:221"> 221</span></a><span class="fringe" id="point:8616"> </span>  <span class="builtin" id="font-lock:8618">:type</span>  '(string))
<a href="#linum:222"><span class="linum" id="linum:222"> 222</span></a><span class="fringe" id="point:8636"> </span>
<a href="#linum:223"><span class="linum" id="linum:223"> 223</span></a><span class="fringe" id="point:8637"> </span>(<span class="keyword" id="font-lock:8638">defcustom</span> <span class="variable-name" id="font-lock:8648">hfy-src-doc-link-unstyle</span> <span class="string" id="font-lock:8673">" text-decoration: none;"</span>
<a href="#linum:224"><span class="linum" id="linum:224"> 224</span></a><span class="fringe" id="point:8699"> </span>  <span class="doc" id="font-lock:8701">"Regex to remove from the &lt;style&gt; a variant of an htmlfontify CSS class."</span>
<a href="#linum:225"><span class="linum" id="linum:225"> 225</span></a><span class="fringe" id="point:8775"> </span>  <span class="builtin" id="font-lock:8777">:group</span> 'htmlfontify
<a href="#linum:226"><span class="linum" id="linum:226"> 226</span></a><span class="fringe" id="point:8797"> </span>  <span class="builtin" id="font-lock:8799">:tag</span>   <span class="string" id="font-lock:8806">"src-doc-link-unstyle"</span>
<a href="#linum:227"><span class="linum" id="linum:227"> 227</span></a><span class="fringe" id="point:8829"> </span>  <span class="builtin" id="font-lock:8831">:type</span>  '(string))
<a href="#linum:228"><span class="linum" id="linum:228"> 228</span></a><span class="fringe" id="point:8849"> </span>
<a href="#linum:229"><span class="linum" id="linum:229"> 229</span></a><span class="fringe" id="point:8850"> </span>(<span class="keyword" id="font-lock:8851">defcustom</span> <span class="variable-name" id="font-lock:8861">hfy-link-extn</span> nil
<a href="#linum:230"><span class="linum" id="linum:230"> 230</span></a><span class="fringe" id="point:8879"> </span>  <span class="doc" id="font-lock:8881">"File extension used for href links.
</span><a href="#linum:231"><span class="linum" id="linum:231"> 231</span></a><span class="fringe" id="point:8918"> </span><span class="doc" id="font-lock:8918">Useful where the htmlfontify output files are going to be processed
</span><a href="#linum:232"><span class="linum" id="linum:232"> 232</span></a><span class="fringe" id="point:8986"> </span><span class="doc" id="font-lock:8986">again, with a resulting change in file extension.  If nil, then any
</span><a href="#linum:233"><span class="linum" id="linum:233"> 233</span></a><span class="fringe" id="point:9054"> </span><span class="doc" id="font-lock:9054">code using this should fall back to `</span><span class="doc" id="font-lock:9091"><span class="constant" id="font-lock:9091">hfy-extn</span></span><span class="doc" id="font-lock:9099">'."</span>
<a href="#linum:234"><span class="linum" id="linum:234"> 234</span></a><span class="fringe" id="point:9103"> </span>  <span class="builtin" id="font-lock:9105">:group</span> 'htmlfontify
<a href="#linum:235"><span class="linum" id="linum:235"> 235</span></a><span class="fringe" id="point:9125"> </span>  <span class="builtin" id="font-lock:9127">:tag</span>   <span class="string" id="font-lock:9134">"link-extension"</span>
<a href="#linum:236"><span class="linum" id="linum:236"> 236</span></a><span class="fringe" id="point:9151"> </span>  <span class="builtin" id="font-lock:9153">:type</span>  '(choice string (const nil)))
<a href="#linum:237"><span class="linum" id="linum:237"> 237</span></a><span class="fringe" id="point:9190"> </span>
<a href="#linum:238"><span class="linum" id="linum:238"> 238</span></a><span class="fringe" id="point:9191"> </span>(<span class="keyword" id="font-lock:9192">defcustom</span> <span class="variable-name" id="font-lock:9202">hfy-link-style-fun</span> 'hfy-link-style-string
<a href="#linum:239"><span class="linum" id="linum:239"> 239</span></a><span class="fringe" id="point:9244"> </span>  <span class="doc" id="font-lock:9246">"Set this to a function, which will be called with one argument
</span><a href="#linum:240"><span class="linum" id="linum:240"> 240</span></a><span class="fringe" id="point:9310"> </span><span class="doc" id="font-lock:9310">\(a \"{ foo: bar; ...}\" CSS style-string) - it should return a copy of
</span><a href="#linum:241"><span class="linum" id="linum:241"> 241</span></a><span class="fringe" id="point:9382"> </span><span class="doc" id="font-lock:9382">its argument, altered so as to make any changes you want made for text which
</span><a href="#linum:242"><span class="linum" id="linum:242"> 242</span></a><span class="fringe" id="point:9459"> </span><span class="doc" id="font-lock:9459">is a hyperlink, in addition to being in the class to which that style would
</span><a href="#linum:243"><span class="linum" id="linum:243"> 243</span></a><span class="fringe" id="point:9535"> </span><span class="doc" id="font-lock:9535">normally be applied."</span>
<a href="#linum:244"><span class="linum" id="linum:244"> 244</span></a><span class="fringe" id="point:9557"> </span>  <span class="builtin" id="font-lock:9559">:group</span> 'htmlfontify
<a href="#linum:245"><span class="linum" id="linum:245"> 245</span></a><span class="fringe" id="point:9579"> </span>  <span class="builtin" id="font-lock:9581">:tag</span>   <span class="string" id="font-lock:9588">"link-style-function"</span>
<a href="#linum:246"><span class="linum" id="linum:246"> 246</span></a><span class="fringe" id="point:9610"> </span>  <span class="builtin" id="font-lock:9612">:type</span>  '(function))
<a href="#linum:247"><span class="linum" id="linum:247"> 247</span></a><span class="fringe" id="point:9632"> </span>
<a href="#linum:248"><span class="linum" id="linum:248"> 248</span></a><span class="fringe" id="point:9633"> </span>(<span class="keyword" id="font-lock:9634">defcustom</span> <span class="variable-name" id="font-lock:9644">hfy-index-file</span> <span class="string" id="font-lock:9659">"hfy-index"</span>
<a href="#linum:249"><span class="linum" id="linum:249"> 249</span></a><span class="fringe" id="point:9671"> </span>  <span class="doc" id="font-lock:9673">"Name (sans extension) of the tag definition index file produced during
</span><a href="#linum:250"><span class="linum" id="linum:250"> 250</span></a><span class="fringe" id="point:9745"> </span><span class="doc" id="font-lock:9745">fontification-and-hyperlinking."</span>
<a href="#linum:251"><span class="linum" id="linum:251"> 251</span></a><span class="fringe" id="point:9778"> </span>  <span class="builtin" id="font-lock:9780">:group</span> 'htmlfontify
<a href="#linum:252"><span class="linum" id="linum:252"> 252</span></a><span class="fringe" id="point:9800"> </span>  <span class="builtin" id="font-lock:9802">:tag</span>   <span class="string" id="font-lock:9809">"index-file"</span>
<a href="#linum:253"><span class="linum" id="linum:253"> 253</span></a><span class="fringe" id="point:9822"> </span>  <span class="builtin" id="font-lock:9824">:type</span>  '(string))
<a href="#linum:254"><span class="linum" id="linum:254"> 254</span></a><span class="fringe" id="point:9842"> </span>
<a href="#linum:255"><span class="linum" id="linum:255"> 255</span></a><span class="fringe" id="point:9843"> </span>(<span class="keyword" id="font-lock:9844">defcustom</span> <span class="variable-name" id="font-lock:9854">hfy-instance-file</span> <span class="string" id="font-lock:9872">"hfy-instance"</span>
<a href="#linum:256"><span class="linum" id="linum:256"> 256</span></a><span class="fringe" id="point:9887"> </span>  <span class="doc" id="font-lock:9889">"Name (sans extension) of the tag usage index file produced during
</span><a href="#linum:257"><span class="linum" id="linum:257"> 257</span></a><span class="fringe" id="point:9956"> </span><span class="doc" id="font-lock:9956">fontification-and-hyperlinking."</span>
<a href="#linum:258"><span class="linum" id="linum:258"> 258</span></a><span class="fringe" id="point:9989"> </span>  <span class="builtin" id="font-lock:9991">:group</span> 'htmlfontify
<a href="#linum:259"><span class="linum" id="linum:259"> 259</span></a><span class="fringe" id="point:10011"> </span>  <span class="builtin" id="font-lock:10013">:tag</span>   <span class="string" id="font-lock:10020">"instance-file"</span>
<a href="#linum:260"><span class="linum" id="linum:260"> 260</span></a><span class="fringe" id="point:10036"> </span>  <span class="builtin" id="font-lock:10038">:type</span>  '(string))
<a href="#linum:261"><span class="linum" id="linum:261"> 261</span></a><span class="fringe" id="point:10056"> </span>
<a href="#linum:262"><span class="linum" id="linum:262"> 262</span></a><span class="fringe" id="point:10057"> </span>(<span class="keyword" id="font-lock:10058">defcustom</span> <span class="variable-name" id="font-lock:10068">hfy-html-quote-regex</span> <span class="string" id="font-lock:10089">"</span><span class="string" id="font-lock:10090"><span class="regexp-grouping-backslash" id="font-lock:10090">\\</span></span><span class="string" id="font-lock:10092"><span class="regexp-grouping-construct" id="font-lock:10092">(</span></span><span class="string" id="font-lock:10093">&lt;</span><span class="string" id="font-lock:10094"><span class="regexp-grouping-backslash" id="font-lock:10094">\\</span></span><span class="string" id="font-lock:10096"><span class="regexp-grouping-construct" id="font-lock:10096">|</span></span><span class="string" id="font-lock:10097">\"</span><span class="string" id="font-lock:10099"><span class="regexp-grouping-backslash" id="font-lock:10099">\\</span></span><span class="string" id="font-lock:10101"><span class="regexp-grouping-construct" id="font-lock:10101">|</span></span><span class="string" id="font-lock:10102">&amp;</span><span class="string" id="font-lock:10103"><span class="regexp-grouping-backslash" id="font-lock:10103">\\</span></span><span class="string" id="font-lock:10105"><span class="regexp-grouping-construct" id="font-lock:10105">|</span></span><span class="string" id="font-lock:10106">&gt;</span><span class="string" id="font-lock:10107"><span class="regexp-grouping-backslash" id="font-lock:10107">\\</span></span><span class="string" id="font-lock:10109"><span class="regexp-grouping-construct" id="font-lock:10109">)</span></span><span class="string" id="font-lock:10110">"</span>
<a href="#linum:263"><span class="linum" id="linum:263"> 263</span></a><span class="fringe" id="point:10112"> </span>  <span class="doc" id="font-lock:10114">"Regex to match (with a single back-reference per match) strings in HTML
</span><a href="#linum:264"><span class="linum" id="linum:264"> 264</span></a><span class="fringe" id="point:10187"> </span><span class="doc" id="font-lock:10187">which should be quoted with `</span><span class="doc" id="font-lock:10216"><span class="constant" id="font-lock:10216">hfy-html-quote</span></span><span class="doc" id="font-lock:10230">' (and `</span><span class="doc" id="font-lock:10238"><span class="constant" id="font-lock:10238">hfy-html-quote-map</span></span><span class="doc" id="font-lock:10256">')
</span><a href="#linum:265"><span class="linum" id="linum:265"> 265</span></a><span class="fringe" id="point:10259"> </span><span class="doc" id="font-lock:10259">to make them safe."</span>
<a href="#linum:266"><span class="linum" id="linum:266"> 266</span></a><span class="fringe" id="point:10279"> </span>  <span class="builtin" id="font-lock:10281">:group</span> 'htmlfontify
<a href="#linum:267"><span class="linum" id="linum:267"> 267</span></a><span class="fringe" id="point:10301"> </span>  <span class="builtin" id="font-lock:10303">:tag</span>   <span class="string" id="font-lock:10310">"html-quote-regex"</span>
<a href="#linum:268"><span class="linum" id="linum:268"> 268</span></a><span class="fringe" id="point:10329"> </span>  <span class="builtin" id="font-lock:10331">:type</span>  '(regexp))
<a href="#linum:269"><span class="linum" id="linum:269"> 269</span></a><span class="fringe" id="point:10349"> </span>
<a href="#linum:270"><span class="linum" id="linum:270"> 270</span></a><span class="fringe" id="point:10350"> </span>(define-obsolete-variable-alias 'hfy-init-kludge-hooks 'hfy-init-kludge-hook
<a href="#linum:271"><span class="linum" id="linum:271"> 271</span></a><span class="fringe" id="point:10427"> </span>  <span class="string" id="font-lock:10429">"23.2"</span>)
<a href="#linum:272"><span class="linum" id="linum:272"> 272</span></a><span class="fringe" id="point:10437"> </span>(<span class="keyword" id="font-lock:10438">defcustom</span> <span class="variable-name" id="font-lock:10448">hfy-init-kludge-hook</span> '(hfy-kludge-cperl-mode)
<a href="#linum:273"><span class="linum" id="linum:273"> 273</span></a><span class="fringe" id="point:10494"> </span>  <span class="doc" id="font-lock:10496">"List of functions to call when starting `</span><span class="doc" id="font-lock:10538"><span class="constant" id="font-lock:10538">htmlfontify-buffer</span></span><span class="doc" id="font-lock:10556">' to do any
</span><a href="#linum:274"><span class="linum" id="linum:274"> 274</span></a><span class="fringe" id="point:10568"> </span><span class="doc" id="font-lock:10568">kludging necessary to get highlighting modes to behave as you want, even
</span><a href="#linum:275"><span class="linum" id="linum:275"> 275</span></a><span class="fringe" id="point:10641"> </span><span class="doc" id="font-lock:10641">when not running under a window system."</span>
<a href="#linum:276"><span class="linum" id="linum:276"> 276</span></a><span class="fringe" id="point:10682"> </span>  <span class="builtin" id="font-lock:10684">:group</span> 'htmlfontify
<a href="#linum:277"><span class="linum" id="linum:277"> 277</span></a><span class="fringe" id="point:10704"> </span>  <span class="builtin" id="font-lock:10706">:tag</span>   <span class="string" id="font-lock:10713">"init-kludge-hooks"</span>
<a href="#linum:278"><span class="linum" id="linum:278"> 278</span></a><span class="fringe" id="point:10733"> </span>  <span class="builtin" id="font-lock:10735">:type</span>  '(hook))
<a href="#linum:279"><span class="linum" id="linum:279"> 279</span></a><span class="fringe" id="point:10751"> </span>
<a href="#linum:280"><span class="linum" id="linum:280"> 280</span></a><span class="fringe" id="point:10752"> </span>(<span class="keyword" id="font-lock:10753">defcustom</span> <span class="variable-name" id="font-lock:10763">hfy-post-html-hooks</span> nil
<a href="#linum:281"><span class="linum" id="linum:281"> 281</span></a><span class="fringe" id="point:10787"> </span>  <span class="doc" id="font-lock:10789">"List of functions to call after creating and filling the HTML buffer.
</span><a href="#linum:282"><span class="linum" id="linum:282"> 282</span></a><span class="fringe" id="point:10860"> </span><span class="doc" id="font-lock:10860">These functions will be called with the html buffer as the current buffer."</span>
<a href="#linum:283"><span class="linum" id="linum:283"> 283</span></a><span class="fringe" id="point:10936"> </span>  <span class="builtin" id="font-lock:10938">:group</span>   'htmlfontify
<a href="#linum:284"><span class="linum" id="linum:284"> 284</span></a><span class="fringe" id="point:10960"> </span>  <span class="builtin" id="font-lock:10962">:tag</span>     <span class="string" id="font-lock:10971">"post-html-hooks"</span>
<a href="#linum:285"><span class="linum" id="linum:285"> 285</span></a><span class="fringe" id="point:10989"> </span>  <span class="builtin" id="font-lock:10991">:options</span> '(set-auto-mode)
<a href="#linum:286"><span class="linum" id="linum:286"> 286</span></a><span class="fringe" id="point:11017"> </span>  <span class="builtin" id="font-lock:11019">:type</span>    '(hook))
<a href="#linum:287"><span class="linum" id="linum:287"> 287</span></a><span class="fringe" id="point:11037"> </span>
<a href="#linum:288"><span class="linum" id="linum:288"> 288</span></a><span class="fringe" id="point:11038"> </span>(<span class="keyword" id="font-lock:11039">defcustom</span> <span class="variable-name" id="font-lock:11049">hfy-default-face-def</span> nil
<a href="#linum:289"><span class="linum" id="linum:289"> 289</span></a><span class="fringe" id="point:11074"> </span>  <span class="doc" id="font-lock:11076">"Fallback `</span><span class="doc" id="font-lock:11087"><span class="constant" id="font-lock:11087">defface</span></span><span class="doc" id="font-lock:11094">' specification for the face 'default, used when
</span><a href="#linum:290"><span class="linum" id="linum:290"> 290</span></a><span class="fringe" id="point:11143"> </span><span class="doc" id="font-lock:11143">`</span><span class="doc" id="font-lock:11144"><span class="constant" id="font-lock:11144">hfy-display-class</span></span><span class="doc" id="font-lock:11161">' has been set (the normal htmlfontify way of extracting
</span><a href="#linum:291"><span class="linum" id="linum:291"> 291</span></a><span class="fringe" id="point:11218"> </span><span class="doc" id="font-lock:11218">potentially non-current face information doesn't necessarily work for
</span><a href="#linum:292"><span class="linum" id="linum:292"> 292</span></a><span class="fringe" id="point:11288"> </span><span class="doc" id="font-lock:11288">'default).\n
</span><a href="#linum:293"><span class="linum" id="linum:293"> 293</span></a><span class="fringe" id="point:11301"> </span><span class="doc" id="font-lock:11301">Example: I customize this to:\n
</span><a href="#linum:294"><span class="linum" id="linum:294"> 294</span></a><span class="fringe" id="point:11333"> </span><span class="doc" id="font-lock:11333">\((t :background \"black\" :foreground \"white\" :family \"misc-fixed\"))"</span>
<a href="#linum:295"><span class="linum" id="linum:295"> 295</span></a><span class="fringe" id="point:11408"> </span>  <span class="builtin" id="font-lock:11410">:group</span>   'htmlfontify
<a href="#linum:296"><span class="linum" id="linum:296"> 296</span></a><span class="fringe" id="point:11432"> </span>  <span class="builtin" id="font-lock:11434">:tag</span>     <span class="string" id="font-lock:11443">"default-face-definition"</span>
<a href="#linum:297"><span class="linum" id="linum:297"> 297</span></a><span class="fringe" id="point:11469"> </span>  <span class="builtin" id="font-lock:11471">:type</span>    '(alist))
<a href="#linum:298"><span class="linum" id="linum:298"> 298</span></a><span class="fringe" id="point:11490"> </span>
<a href="#linum:299"><span class="linum" id="linum:299"> 299</span></a><span class="fringe" id="point:11491"> </span>(<span class="keyword" id="font-lock:11492">defcustom</span> <span class="variable-name" id="font-lock:11502">hfy-etag-regex</span> (concat <span class="string" id="font-lock:11525">".*"</span>
<a href="#linum:300"><span class="linum" id="linum:300"> 300</span></a><span class="fringe" id="point:11530"> </span>                                  <span class="string" id="font-lock:11564">"\x7f"</span> <span class="string" id="font-lock:11571">"</span><span class="string" id="font-lock:11572"><span class="regexp-grouping-backslash" id="font-lock:11572">\\</span></span><span class="string" id="font-lock:11574"><span class="regexp-grouping-construct" id="font-lock:11574">(</span></span><span class="string" id="font-lock:11575">[</span><span class="string" id="font-lock:11576"><span class="negation-char" id="font-lock:11576">^</span></span><span class="string" id="font-lock:11577">\x01\n]+</span><span class="string" id="font-lock:11585"><span class="regexp-grouping-backslash" id="font-lock:11585">\\</span></span><span class="string" id="font-lock:11587"><span class="regexp-grouping-construct" id="font-lock:11587">)</span></span><span class="string" id="font-lock:11588">"</span>
<a href="#linum:301"><span class="linum" id="linum:301"> 301</span></a><span class="fringe" id="point:11590"> </span>                                  <span class="string" id="font-lock:11624">"\x01"</span> <span class="string" id="font-lock:11631">"</span><span class="string" id="font-lock:11632"><span class="regexp-grouping-backslash" id="font-lock:11632">\\</span></span><span class="string" id="font-lock:11634"><span class="regexp-grouping-construct" id="font-lock:11634">(</span></span><span class="string" id="font-lock:11635">[0-9]+</span><span class="string" id="font-lock:11641"><span class="regexp-grouping-backslash" id="font-lock:11641">\\</span></span><span class="string" id="font-lock:11643"><span class="regexp-grouping-construct" id="font-lock:11643">)</span></span><span class="string" id="font-lock:11644">"</span>
<a href="#linum:302"><span class="linum" id="linum:302"> 302</span></a><span class="fringe" id="point:11646"> </span>                                  <span class="string" id="font-lock:11680">","</span>    <span class="string" id="font-lock:11687">"</span><span class="string" id="font-lock:11688"><span class="regexp-grouping-backslash" id="font-lock:11688">\\</span></span><span class="string" id="font-lock:11690"><span class="regexp-grouping-construct" id="font-lock:11690">(</span></span><span class="string" id="font-lock:11691">[0-9]+</span><span class="string" id="font-lock:11697"><span class="regexp-grouping-backslash" id="font-lock:11697">\\</span></span><span class="string" id="font-lock:11699"><span class="regexp-grouping-construct" id="font-lock:11699">)</span></span><span class="string" id="font-lock:11700">$"</span>
<a href="#linum:303"><span class="linum" id="linum:303"> 303</span></a><span class="fringe" id="point:11703"> </span>                                  <span class="string" id="font-lock:11737">"</span><span class="string" id="font-lock:11738"><span class="regexp-grouping-backslash" id="font-lock:11738">\\</span></span><span class="string" id="font-lock:11740"><span class="regexp-grouping-construct" id="font-lock:11740">|</span></span><span class="string" id="font-lock:11741">"</span>  <span class="string" id="font-lock:11744">".*\x7f[0-9]+,[0-9]+$"</span>)
<a href="#linum:304"><span class="linum" id="linum:304"> 304</span></a><span class="fringe" id="point:11768"> </span>  <span class="doc" id="font-lock:11770">"Regex used to parse an etags entry: must have 3 subexps, corresponding,
</span><a href="#linum:305"><span class="linum" id="linum:305"> 305</span></a><span class="fringe" id="point:11843"> </span><span class="doc" id="font-lock:11843">in order, to:\n
</span><a href="#linum:306"><span class="linum" id="linum:306"> 306</span></a><span class="fringe" id="point:11859"> </span><span class="doc" id="font-lock:11859">   1 - The tag
</span><a href="#linum:307"><span class="linum" id="linum:307"> 307</span></a><span class="fringe" id="point:11874"> </span><span class="doc" id="font-lock:11874">   2 - The line
</span><a href="#linum:308"><span class="linum" id="linum:308"> 308</span></a><span class="fringe" id="point:11890"> </span><span class="doc" id="font-lock:11890">   3 - The char (point) at which the tag occurs."</span>
<a href="#linum:309"><span class="linum" id="linum:309"> 309</span></a><span class="fringe" id="point:11940"> </span>  <span class="builtin" id="font-lock:11942">:group</span> 'htmlfontify
<a href="#linum:310"><span class="linum" id="linum:310"> 310</span></a><span class="fringe" id="point:11962"> </span>  <span class="builtin" id="font-lock:11964">:tag</span>   <span class="string" id="font-lock:11971">"etag-regex"</span>
<a href="#linum:311"><span class="linum" id="linum:311"> 311</span></a><span class="fringe" id="point:11984"> </span>  <span class="builtin" id="font-lock:11986">:type</span>  '(regexp))
<a href="#linum:312"><span class="linum" id="linum:312"> 312</span></a><span class="fringe" id="point:12004"> </span>
<a href="#linum:313"><span class="linum" id="linum:313"> 313</span></a><span class="fringe" id="point:12005"> </span>(<span class="keyword" id="font-lock:12006">defcustom</span> <span class="variable-name" id="font-lock:12016">hfy-html-quote-map</span> '((<span class="string" id="font-lock:12038">"\""</span> <span class="string" id="font-lock:12043">"&amp;quot;"</span>)
<a href="#linum:314"><span class="linum" id="linum:314"> 314</span></a><span class="fringe" id="point:12053"> </span>                                (<span class="string" id="font-lock:12086">"&lt;"</span>  <span class="string" id="font-lock:12091">"&amp;lt;"</span>  )
<a href="#linum:315"><span class="linum" id="linum:315"> 315</span></a><span class="fringe" id="point:12101"> </span>                                (<span class="string" id="font-lock:12134">"&amp;"</span>  <span class="string" id="font-lock:12139">"&amp;amp;"</span> )
<a href="#linum:316"><span class="linum" id="linum:316"> 316</span></a><span class="fringe" id="point:12149"> </span>                                (<span class="string" id="font-lock:12182">"&gt;"</span>  <span class="string" id="font-lock:12187">"&amp;gt;"</span>  ))
<a href="#linum:317"><span class="linum" id="linum:317"> 317</span></a><span class="fringe" id="point:12198"> </span>  <span class="doc" id="font-lock:12200">"Alist of char -&gt; entity mappings used to make the text HTML-safe."</span>
<a href="#linum:318"><span class="linum" id="linum:318"> 318</span></a><span class="fringe" id="point:12268"> </span>  <span class="builtin" id="font-lock:12270">:group</span> 'htmlfontify
<a href="#linum:319"><span class="linum" id="linum:319"> 319</span></a><span class="fringe" id="point:12290"> </span>  <span class="builtin" id="font-lock:12292">:tag</span>   <span class="string" id="font-lock:12299">"html-quote-map"</span>
<a href="#linum:320"><span class="linum" id="linum:320"> 320</span></a><span class="fringe" id="point:12316"> </span>  <span class="builtin" id="font-lock:12318">:type</span>  '(alist <span class="builtin" id="font-lock:12333">:key-type</span> (string)))
<a href="#linum:321"><span class="linum" id="linum:321"> 321</span></a><span class="fringe" id="point:12354"> </span>(<span class="keyword" id="font-lock:12355">eval-and-compile</span>
<a href="#linum:322"><span class="linum" id="linum:322"> 322</span></a><span class="fringe" id="point:12372"> </span>  (<span class="keyword" id="font-lock:12375">defconst</span> <span class="variable-name" id="font-lock:12384">hfy-e2x-etags-cmd</span> <span class="string" id="font-lock:12402">"for src in `find . -type f`;
</span><a href="#linum:323"><span class="linum" id="linum:323"> 323</span></a><span class="fringe" id="point:12432"> </span><span class="string" id="font-lock:12432">do
</span><a href="#linum:324"><span class="linum" id="linum:324"> 324</span></a><span class="fringe" id="point:12435"> </span><span class="string" id="font-lock:12435">  ETAGS=%s;
</span><a href="#linum:325"><span class="linum" id="linum:325"> 325</span></a><span class="fringe" id="point:12447"> </span><span class="string" id="font-lock:12447">  case ${src} in
</span><a href="#linum:326"><span class="linum" id="linum:326"> 326</span></a><span class="fringe" id="point:12464"> </span><span class="string" id="font-lock:12464">    *.ad[absm]|*.[CFHMSacfhlmpsty]|*.def|*.in[cs]|*.s[as]|*.src|*.cc|\\
</span><a href="#linum:327"><span class="linum" id="linum:327"> 327</span></a><span class="fringe" id="point:12536"> </span><span class="string" id="font-lock:12536">    *.hh|*.[chy]++|*.[ch]pp|*.[chy]xx|*.pdb|*.[ch]s|*.[Cc][Oo][Bb]|\\
</span><a href="#linum:328"><span class="linum" id="linum:328"> 328</span></a><span class="fringe" id="point:12606"> </span><span class="string" id="font-lock:12606">    *.[eh]rl|*.f90|*.for|*.java|*.[cem]l|*.clisp|*.lisp|*.[Ll][Ss][Pp]|\\
</span><a href="#linum:329"><span class="linum" id="linum:329"> 329</span></a><span class="fringe" id="point:12680"> </span><span class="string" id="font-lock:12680">    [Mm]akefile*|*.pas|*.[Pp][LlMm]|*.psw|*.lm|*.pc|*.prolog|*.oak|\\
</span><a href="#linum:330"><span class="linum" id="linum:330"> 330</span></a><span class="fringe" id="point:12750"> </span><span class="string" id="font-lock:12750">    *.p[sy]|*.sch|*.scheme|*.[Ss][Cc][Mm]|*.[Ss][Mm]|*.bib|*.cl[os]|\\
</span><a href="#linum:331"><span class="linum" id="linum:331"> 331</span></a><span class="fringe" id="point:12821"> </span><span class="string" id="font-lock:12821">    *.ltx|*.sty|*.TeX|*.tex|*.texi|*.texinfo|*.txi|*.x[bp]m|*.yy|\\
</span><a href="#linum:332"><span class="linum" id="linum:332"> 332</span></a><span class="fringe" id="point:12889"> </span><span class="string" id="font-lock:12889">    *.[Ss][Qq][Ll])
</span><a href="#linum:333"><span class="linum" id="linum:333"> 333</span></a><span class="fringe" id="point:12909"> </span><span class="string" id="font-lock:12909">          ${ETAGS} -o- ${src};
</span><a href="#linum:334"><span class="linum" id="linum:334"> 334</span></a><span class="fringe" id="point:12940"> </span><span class="string" id="font-lock:12940">          ;;
</span><a href="#linum:335"><span class="linum" id="linum:335"> 335</span></a><span class="fringe" id="point:12953"> </span><span class="string" id="font-lock:12953">      *)
</span><a href="#linum:336"><span class="linum" id="linum:336"> 336</span></a><span class="fringe" id="point:12962"> </span><span class="string" id="font-lock:12962">          FTYPE=`file ${src}`;
</span><a href="#linum:337"><span class="linum" id="linum:337"> 337</span></a><span class="fringe" id="point:12993"> </span><span class="string" id="font-lock:12993">          case ${FTYPE} in
</span><a href="#linum:338"><span class="linum" id="linum:338"> 338</span></a><span class="fringe" id="point:13020"> </span><span class="string" id="font-lock:13020">              *script*text*)
</span><a href="#linum:339"><span class="linum" id="linum:339"> 339</span></a><span class="fringe" id="point:13049"> </span><span class="string" id="font-lock:13049">                  ${ETAGS} -o- ${src};
</span><a href="#linum:340"><span class="linum" id="linum:340"> 340</span></a><span class="fringe" id="point:13088"> </span><span class="string" id="font-lock:13088">                  ;;
</span><a href="#linum:341"><span class="linum" id="linum:341"> 341</span></a><span class="fringe" id="point:13109"> </span><span class="string" id="font-lock:13109">              *text*)
</span><a href="#linum:342"><span class="linum" id="linum:342"> 342</span></a><span class="fringe" id="point:13131"> </span><span class="string" id="font-lock:13131">                  SHEBANG=`head -n1 ${src} | grep '#!' -c`;
</span><a href="#linum:343"><span class="linum" id="linum:343"> 343</span></a><span class="fringe" id="point:13191"> </span><span class="string" id="font-lock:13191">                  if [ ${SHEBANG} -eq 1 ];
</span><a href="#linum:344"><span class="linum" id="linum:344"> 344</span></a><span class="fringe" id="point:13234"> </span><span class="string" id="font-lock:13234">                  then
</span><a href="#linum:345"><span class="linum" id="linum:345"> 345</span></a><span class="fringe" id="point:13257"> </span><span class="string" id="font-lock:13257">                      ${ETAGS} -o- ${src};
</span><a href="#linum:346"><span class="linum" id="linum:346"> 346</span></a><span class="fringe" id="point:13300"> </span><span class="string" id="font-lock:13300">                  fi;
</span><a href="#linum:347"><span class="linum" id="linum:347"> 347</span></a><span class="fringe" id="point:13322"> </span><span class="string" id="font-lock:13322">                  ;;
</span><a href="#linum:348"><span class="linum" id="linum:348"> 348</span></a><span class="fringe" id="point:13343"> </span><span class="string" id="font-lock:13343">          esac;
</span><a href="#linum:349"><span class="linum" id="linum:349"> 349</span></a><span class="fringe" id="point:13359"> </span><span class="string" id="font-lock:13359">          ;;
</span><a href="#linum:350"><span class="linum" id="linum:350"> 350</span></a><span class="fringe" id="point:13372"> </span><span class="string" id="font-lock:13372">  esac;
</span><a href="#linum:351"><span class="linum" id="linum:351"> 351</span></a><span class="fringe" id="point:13380"> </span><span class="string" id="font-lock:13380">done;"</span>)
<a href="#linum:352"><span class="linum" id="linum:352"> 352</span></a><span class="fringe" id="point:13388"> </span>
<a href="#linum:353"><span class="linum" id="linum:353"> 353</span></a><span class="fringe" id="point:13389"> </span>  (<span class="keyword" id="font-lock:13392">defconst</span> <span class="variable-name" id="font-lock:13401">hfy-etags-cmd-alist-default</span>
<a href="#linum:354"><span class="linum" id="linum:354"> 354</span></a><span class="fringe" id="point:13429"> </span>    `((<span class="string" id="font-lock:13436">"emacs etags"</span>     . ,hfy-e2x-etags-cmd)
<a href="#linum:355"><span class="linum" id="linum:355"> 355</span></a><span class="fringe" id="point:13476"> </span>      (<span class="string" id="font-lock:13483">"exuberant ctags"</span> . <span class="string" id="font-lock:13503">"%s -R -f -"</span>   )))
<a href="#linum:356"><span class="linum" id="linum:356"> 356</span></a><span class="fringe" id="point:13522"> </span>
<a href="#linum:357"><span class="linum" id="linum:357"> 357</span></a><span class="fringe" id="point:13523"> </span>  (<span class="keyword" id="font-lock:13526">defcustom</span> <span class="variable-name" id="font-lock:13536">hfy-etags-cmd-alist</span>
<a href="#linum:358"><span class="linum" id="linum:358"> 358</span></a><span class="fringe" id="point:13556"> </span>    hfy-etags-cmd-alist-default
<a href="#linum:359"><span class="linum" id="linum:359"> 359</span></a><span class="fringe" id="point:13588"> </span>    <span class="doc" id="font-lock:13592">"Alist of possible shell commands that will generate etags output that
</span><a href="#linum:360"><span class="linum" id="linum:360"> 360</span></a><span class="fringe" id="point:13663"> </span><span class="doc" id="font-lock:13663">`</span><span class="doc" id="font-lock:13664"><span class="constant" id="font-lock:13664">htmlfontify</span></span><span class="doc" id="font-lock:13675">' can use.  '%s' will be replaced by `</span><span class="doc" id="font-lock:13713"><span class="constant" id="font-lock:13713">hfy-etags-bin</span></span><span class="doc" id="font-lock:13726">'."</span>
<a href="#linum:361"><span class="linum" id="linum:361"> 361</span></a><span class="fringe" id="point:13730"> </span>    <span class="builtin" id="font-lock:13734">:group</span> 'htmlfontify
<a href="#linum:362"><span class="linum" id="linum:362"> 362</span></a><span class="fringe" id="point:13754"> </span>    <span class="builtin" id="font-lock:13758">:tag</span>   <span class="string" id="font-lock:13765">"etags-cmd-alist"</span>
<a href="#linum:363"><span class="linum" id="linum:363"> 363</span></a><span class="fringe" id="point:13783"> </span>    <span class="builtin" id="font-lock:13787">:type</span>  '(alist <span class="builtin" id="font-lock:13802">:key-type</span> (string) <span class="builtin" id="font-lock:13821">:value-type</span> (string)) ))
<a href="#linum:364"><span class="linum" id="linum:364"> 364</span></a><span class="fringe" id="point:13846"> </span>
<a href="#linum:365"><span class="linum" id="linum:365"> 365</span></a><span class="fringe" id="point:13847"> </span>(<span class="keyword" id="font-lock:13848">defcustom</span> <span class="variable-name" id="font-lock:13858">hfy-etags-bin</span> <span class="string" id="font-lock:13872">"etags"</span>
<a href="#linum:366"><span class="linum" id="linum:366"> 366</span></a><span class="fringe" id="point:13880"> </span>  <span class="doc" id="font-lock:13882">"Location of etags binary (we begin by assuming it's in your path).\n
</span><a href="#linum:367"><span class="linum" id="linum:367"> 367</span></a><span class="fringe" id="point:13952"> </span><span class="doc" id="font-lock:13952">Note that if etags is not in your path, you will need to alter the shell
</span><a href="#linum:368"><span class="linum" id="linum:368"> 368</span></a><span class="fringe" id="point:14025"> </span><span class="doc" id="font-lock:14025">commands in `</span><span class="doc" id="font-lock:14038"><span class="constant" id="font-lock:14038">hfy-etags-cmd-alist</span></span><span class="doc" id="font-lock:14057">'."</span>
<a href="#linum:369"><span class="linum" id="linum:369"> 369</span></a><span class="fringe" id="point:14061"> </span>  <span class="builtin" id="font-lock:14063">:group</span> 'htmlfontify
<a href="#linum:370"><span class="linum" id="linum:370"> 370</span></a><span class="fringe" id="point:14083"> </span>  <span class="builtin" id="font-lock:14085">:tag</span>   <span class="string" id="font-lock:14092">"etags-bin"</span>
<a href="#linum:371"><span class="linum" id="linum:371"> 371</span></a><span class="fringe" id="point:14104"> </span>  <span class="builtin" id="font-lock:14106">:type</span>  '(file))
<a href="#linum:372"><span class="linum" id="linum:372"> 372</span></a><span class="fringe" id="point:14122"> </span>
<a href="#linum:373"><span class="linum" id="linum:373"> 373</span></a><span class="fringe" id="point:14123"> </span>(<span class="keyword" id="font-lock:14124">defcustom</span> <span class="variable-name" id="font-lock:14134">hfy-shell-file-name</span> <span class="string" id="font-lock:14154">"/bin/sh"</span>
<a href="#linum:374"><span class="linum" id="linum:374"> 374</span></a><span class="fringe" id="point:14164"> </span>  <span class="doc" id="font-lock:14166">"Shell (bourne or compatible) to invoke for complex shell operations."</span>
<a href="#linum:375"><span class="linum" id="linum:375"> 375</span></a><span class="fringe" id="point:14237"> </span>  <span class="builtin" id="font-lock:14239">:group</span> 'htmlfontify
<a href="#linum:376"><span class="linum" id="linum:376"> 376</span></a><span class="fringe" id="point:14259"> </span>  <span class="builtin" id="font-lock:14261">:tag</span>   <span class="string" id="font-lock:14268">"shell-file-name"</span>
<a href="#linum:377"><span class="linum" id="linum:377"> 377</span></a><span class="fringe" id="point:14286"> </span>  <span class="builtin" id="font-lock:14288">:type</span>  '(file))
<a href="#linum:378"><span class="linum" id="linum:378"> 378</span></a><span class="fringe" id="point:14304"> </span>
<a href="#linum:379"><span class="linum" id="linum:379"> 379</span></a><span class="fringe" id="point:14305"> </span>(<span class="keyword" id="font-lock:14306">defcustom</span> <span class="variable-name" id="font-lock:14316">hfy-ignored-properties</span> '(read-only
<a href="#linum:380"><span class="linum" id="linum:380"> 380</span></a><span class="fringe" id="point:14351"> </span>                                    intangible
<a href="#linum:381"><span class="linum" id="linum:381"> 381</span></a><span class="fringe" id="point:14398"> </span>                                    modification-hooks
<a href="#linum:382"><span class="linum" id="linum:382"> 382</span></a><span class="fringe" id="point:14453"> </span>                                    insert-in-front-hooks
<a href="#linum:383"><span class="linum" id="linum:383"> 383</span></a><span class="fringe" id="point:14511"> </span>                                    insert-behind-hooks
<a href="#linum:384"><span class="linum" id="linum:384"> 384</span></a><span class="fringe" id="point:14567"> </span>                                    point-entered
<a href="#linum:385"><span class="linum" id="linum:385"> 385</span></a><span class="fringe" id="point:14617"> </span>                                    point-left)
<a href="#linum:386"><span class="linum" id="linum:386"> 386</span></a><span class="fringe" id="point:14665"> </span>  <span class="doc" id="font-lock:14667">"Properties to omit when copying a fontified buffer for HTML transformation."</span>
<a href="#linum:387"><span class="linum" id="linum:387"> 387</span></a><span class="fringe" id="point:14745"> </span>  <span class="builtin" id="font-lock:14747">:group</span> 'htmlfontify
<a href="#linum:388"><span class="linum" id="linum:388"> 388</span></a><span class="fringe" id="point:14767"> </span>  <span class="builtin" id="font-lock:14769">:tag</span>   <span class="string" id="font-lock:14776">"ignored-properties"</span>
<a href="#linum:389"><span class="linum" id="linum:389"> 389</span></a><span class="fringe" id="point:14797"> </span>  <span class="builtin" id="font-lock:14799">:type</span> '(repeat symbol))
<a href="#linum:390"><span class="linum" id="linum:390"> 390</span></a><span class="fringe" id="point:14823"> </span>
<a href="#linum:391"><span class="linum" id="linum:391"> 391</span></a><span class="fringe" id="point:14824"> </span>(<span class="keyword" id="font-lock:14825">defun</span> <span class="function-name" id="font-lock:14831">hfy-which-etags</span> ()
<a href="#linum:392"><span class="linum" id="linum:392"> 392</span></a><span class="fringe" id="point:14850"> </span>  <span class="doc" id="font-lock:14852">"Return a string indicating which flavour of etags we are using."</span>
<a href="#linum:393"><span class="linum" id="linum:393"> 393</span></a><span class="fringe" id="point:14918"> </span>  (<span class="keyword" id="font-lock:14921">let</span> ((v (shell-command-to-string (concat hfy-etags-bin <span class="string" id="font-lock:14976">" --version"</span>))))
<a href="#linum:394"><span class="linum" id="linum:394"> 394</span></a><span class="fringe" id="point:14993"> </span>    (<span class="keyword" id="font-lock:14998">cond</span> ((string-match <span class="string" id="font-lock:15018">"exube"</span> v) <span class="string" id="font-lock:15029">"exuberant ctags"</span>)
<a href="#linum:395"><span class="linum" id="linum:395"> 395</span></a><span class="fringe" id="point:15048"> </span>          ((string-match <span class="string" id="font-lock:15073">"GNU E"</span> v) <span class="string" id="font-lock:15084">"emacs etags"</span>    )) ))
<a href="#linum:396"><span class="linum" id="linum:396"> 396</span></a><span class="fringe" id="point:15107"> </span>
<a href="#linum:397"><span class="linum" id="linum:397"> 397</span></a><span class="fringe" id="point:15108"> </span>(<span class="keyword" id="font-lock:15109">defcustom</span> <span class="variable-name" id="font-lock:15119">hfy-etags-cmd</span>
<a href="#linum:398"><span class="linum" id="linum:398"> 398</span></a><span class="fringe" id="point:15133"> </span>  (<span class="keyword" id="font-lock:15136">eval-and-compile</span> (cdr (assoc (hfy-which-etags) hfy-etags-cmd-alist)))
<a href="#linum:399"><span class="linum" id="linum:399"> 399</span></a><span class="fringe" id="point:15206"> </span>  <span class="doc" id="font-lock:15208">"The etags equivalent command to run in a source directory to generate a tags
</span><a href="#linum:400"><span class="linum" id="linum:400"> 400</span></a><span class="fringe" id="point:15286"> </span><span class="doc" id="font-lock:15286">file for the whole source tree from there on down.  The command should emit
</span><a href="#linum:401"><span class="linum" id="linum:401"> 401</span></a><span class="fringe" id="point:15362"> </span><span class="doc" id="font-lock:15362">the etags output on stdout.\n
</span><a href="#linum:402"><span class="linum" id="linum:402"> 402</span></a><span class="fringe" id="point:15392"> </span><span class="doc" id="font-lock:15392">Two canned commands are provided - they drive Emacs' etags and
</span><a href="#linum:403"><span class="linum" id="linum:403"> 403</span></a><span class="fringe" id="point:15455"> </span><span class="doc" id="font-lock:15455">exuberant-ctags' etags respectively."</span>
<a href="#linum:404"><span class="linum" id="linum:404"> 404</span></a><span class="fringe" id="point:15493"> </span>  <span class="builtin" id="font-lock:15495">:group</span> 'htmlfontify
<a href="#linum:405"><span class="linum" id="linum:405"> 405</span></a><span class="fringe" id="point:15515"> </span>  <span class="builtin" id="font-lock:15517">:tag</span>   <span class="string" id="font-lock:15524">"etags-command"</span>
<a href="#linum:406"><span class="linum" id="linum:406"> 406</span></a><span class="fringe" id="point:15540"> </span>  <span class="builtin" id="font-lock:15542">:type</span> (<span class="keyword" id="font-lock:15549">eval-and-compile</span>
<a href="#linum:407"><span class="linum" id="linum:407"> 407</span></a><span class="fringe" id="point:15566"> </span>          (<span class="keyword" id="font-lock:15577">let</span> ((clist (list '(string))))
<a href="#linum:408"><span class="linum" id="linum:408"> 408</span></a><span class="fringe" id="point:15608"> </span>            (<span class="keyword" id="font-lock:15621">dolist</span> (C hfy-etags-cmd-alist)
<a href="#linum:409"><span class="linum" id="linum:409"> 409</span></a><span class="fringe" id="point:15652"> </span>              (push (list 'const <span class="builtin" id="font-lock:15685">:tag</span> (car C) (cdr C)) clist))
<a href="#linum:410"><span class="linum" id="linum:410"> 410</span></a><span class="fringe" id="point:15715"> </span>            (cons 'choice clist)) ))
<a href="#linum:411"><span class="linum" id="linum:411"> 411</span></a><span class="fringe" id="point:15752"> </span>
<a href="#linum:412"><span class="linum" id="linum:412"> 412</span></a><span class="fringe" id="point:15753"> </span>(<span class="keyword" id="font-lock:15754">defcustom</span> <span class="variable-name" id="font-lock:15764">hfy-istext-command</span> <span class="string" id="font-lock:15783">"file %s | sed -e 's@^[</span><span class="string" id="font-lock:15806"><span class="negation-char" id="font-lock:15806">^</span></span><span class="string" id="font-lock:15807">:]*:[ \t]*@@'"</span>
<a href="#linum:413"><span class="linum" id="linum:413"> 413</span></a><span class="fringe" id="point:15822"> </span>  <span class="doc" id="font-lock:15824">"Command to run with the name of a file, to see whether it is a text file
</span><a href="#linum:414"><span class="linum" id="linum:414"> 414</span></a><span class="fringe" id="point:15898"> </span><span class="doc" id="font-lock:15898">or not.  The command should emit a string containing the word 'text' if
</span><a href="#linum:415"><span class="linum" id="linum:415"> 415</span></a><span class="fringe" id="point:15970"> </span><span class="doc" id="font-lock:15970">the file is a text file, and a string not containing 'text' otherwise."</span>
<a href="#linum:416"><span class="linum" id="linum:416"> 416</span></a><span class="fringe" id="point:16042"> </span>  <span class="builtin" id="font-lock:16044">:group</span> 'htmlfontify
<a href="#linum:417"><span class="linum" id="linum:417"> 417</span></a><span class="fringe" id="point:16064"> </span>  <span class="builtin" id="font-lock:16066">:tag</span>   <span class="string" id="font-lock:16073">"istext-command"</span>
<a href="#linum:418"><span class="linum" id="linum:418"> 418</span></a><span class="fringe" id="point:16090"> </span>  <span class="builtin" id="font-lock:16092">:type</span>  '(string))
<a href="#linum:419"><span class="linum" id="linum:419"> 419</span></a><span class="fringe" id="point:16110"> </span>
<a href="#linum:420"><span class="linum" id="linum:420"> 420</span></a><span class="fringe" id="point:16111"> </span>(<span class="keyword" id="font-lock:16112">defcustom</span> <span class="variable-name" id="font-lock:16122">hfy-find-cmd</span>
<a href="#linum:421"><span class="linum" id="linum:421"> 421</span></a><span class="fringe" id="point:16135"> </span>  <span class="string" id="font-lock:16137">"find . -type f \\! -name \\*~ \\! -name \\*.flc \\! -path \\*/CVS/\\*"</span>
<a href="#linum:422"><span class="linum" id="linum:422"> 422</span></a><span class="fringe" id="point:16209"> </span>  <span class="doc" id="font-lock:16211">"Find command used to harvest a list of files to attempt to fontify."</span>
<a href="#linum:423"><span class="linum" id="linum:423"> 423</span></a><span class="fringe" id="point:16281"> </span>  <span class="builtin" id="font-lock:16283">:group</span> 'htmlfontify
<a href="#linum:424"><span class="linum" id="linum:424"> 424</span></a><span class="fringe" id="point:16303"> </span>  <span class="builtin" id="font-lock:16305">:tag</span>   <span class="string" id="font-lock:16312">"find-command"</span>
<a href="#linum:425"><span class="linum" id="linum:425"> 425</span></a><span class="fringe" id="point:16327"> </span>  <span class="builtin" id="font-lock:16329">:type</span>  '(string))
<a href="#linum:426"><span class="linum" id="linum:426"> 426</span></a><span class="fringe" id="point:16347"> </span>
<a href="#linum:427"><span class="linum" id="linum:427"> 427</span></a><span class="fringe" id="point:16348"> </span>(<span class="keyword" id="font-lock:16349">defcustom</span> <span class="variable-name" id="font-lock:16359">hfy-display-class</span> nil
<a href="#linum:428"><span class="linum" id="linum:428"> 428</span></a><span class="fringe" id="point:16381"> </span>  <span class="doc" id="font-lock:16383">"Display class to use to determine which display class to use when
</span><a href="#linum:429"><span class="linum" id="linum:429"> 429</span></a><span class="fringe" id="point:16450"> </span><span class="doc" id="font-lock:16450">calculating a face's attributes.  This is useful when, for example, you
</span><a href="#linum:430"><span class="linum" id="linum:430"> 430</span></a><span class="fringe" id="point:16522"> </span><span class="doc" id="font-lock:16522">are running Emacs on a tty or in batch mode, and want htmlfontify to have
</span><a href="#linum:431"><span class="linum" id="linum:431"> 431</span></a><span class="fringe" id="point:16596"> </span><span class="doc" id="font-lock:16596">access to the face spec you would use if you were connected to an X display.\n
</span><a href="#linum:432"><span class="linum" id="linum:432"> 432</span></a><span class="fringe" id="point:16675"> </span><span class="doc" id="font-lock:16675">Some valid class specification elements are:\n
</span><a href="#linum:433"><span class="linum" id="linum:433"> 433</span></a><span class="fringe" id="point:16722"> </span><span class="doc" id="font-lock:16722">  '(class      color)
</span><a href="#linum:434"><span class="linum" id="linum:434"> 434</span></a><span class="fringe" id="point:16744"> </span><span class="doc" id="font-lock:16744">  '(class      grayscale)
</span><a href="#linum:435"><span class="linum" id="linum:435"> 435</span></a><span class="fringe" id="point:16770"> </span><span class="doc" id="font-lock:16770">  '(background dark)
</span><a href="#linum:436"><span class="linum" id="linum:436"> 436</span></a><span class="fringe" id="point:16791"> </span><span class="doc" id="font-lock:16791">  '(background light)
</span><a href="#linum:437"><span class="linum" id="linum:437"> 437</span></a><span class="fringe" id="point:16813"> </span><span class="doc" id="font-lock:16813">  '(type       x-toolkit)
</span><a href="#linum:438"><span class="linum" id="linum:438"> 438</span></a><span class="fringe" id="point:16839"> </span><span class="doc" id="font-lock:16839">  '(type       tty)
</span><a href="#linum:439"><span class="linum" id="linum:439"> 439</span></a><span class="fringe" id="point:16859"> </span><span class="doc" id="font-lock:16859">  '(type       motif)
</span><a href="#linum:440"><span class="linum" id="linum:440"> 440</span></a><span class="fringe" id="point:16881"> </span><span class="doc" id="font-lock:16881">  '(type       lucid)
</span><a href="#linum:441"><span class="linum" id="linum:441"> 441</span></a><span class="fringe" id="point:16903"> </span><span class="doc" id="font-lock:16903">Multiple values for a tag may be combined, to indicate that any one or more
</span><a href="#linum:442"><span class="linum" id="linum:442"> 442</span></a><span class="fringe" id="point:16979"> </span><span class="doc" id="font-lock:16979">of these values in the specification key constitutes a match, eg:\n
</span><a href="#linum:443"><span class="linum" id="linum:443"> 443</span></a><span class="fringe" id="point:17047"> </span><span class="doc" id="font-lock:17047">'((class color grayscale) (type tty)) would match any of:\n
</span><a href="#linum:444"><span class="linum" id="linum:444"> 444</span></a><span class="fringe" id="point:17107"> </span><span class="doc" id="font-lock:17107">  '((class color))
</span><a href="#linum:445"><span class="linum" id="linum:445"> 445</span></a><span class="fringe" id="point:17126"> </span><span class="doc" id="font-lock:17126">  '((class grayscale))
</span><a href="#linum:446"><span class="linum" id="linum:446"> 446</span></a><span class="fringe" id="point:17149"> </span><span class="doc" id="font-lock:17149">  '((class color grayscale))
</span><a href="#linum:447"><span class="linum" id="linum:447"> 447</span></a><span class="fringe" id="point:17178"> </span><span class="doc" id="font-lock:17178">  '((class color foo))
</span><a href="#linum:448"><span class="linum" id="linum:448"> 448</span></a><span class="fringe" id="point:17201"> </span><span class="doc" id="font-lock:17201">  '((type  tty))
</span><a href="#linum:449"><span class="linum" id="linum:449"> 449</span></a><span class="fringe" id="point:17218"> </span><span class="doc" id="font-lock:17218">  '((type  tty) (class color))\n
</span><a href="#linum:450"><span class="linum" id="linum:450"> 450</span></a><span class="fringe" id="point:17251"> </span><span class="doc" id="font-lock:17251">and so on."</span>
<a href="#linum:451"><span class="linum" id="linum:451"> 451</span></a><span class="fringe" id="point:17263"> </span>  <span class="builtin" id="font-lock:17265">:type</span>    '(alist <span class="builtin" id="font-lock:17282">:key-type</span> (symbol) <span class="builtin" id="font-lock:17301">:value-type</span> (symbol))
<a href="#linum:452"><span class="linum" id="linum:452"> 452</span></a><span class="fringe" id="point:17323"> </span>  <span class="builtin" id="font-lock:17325">:group</span>   'htmlfontify
<a href="#linum:453"><span class="linum" id="linum:453"> 453</span></a><span class="fringe" id="point:17347"> </span>  <span class="builtin" id="font-lock:17349">:tag</span>     <span class="string" id="font-lock:17358">"display-class"</span>
<a href="#linum:454"><span class="linum" id="linum:454"> 454</span></a><span class="fringe" id="point:17374"> </span>  <span class="builtin" id="font-lock:17376">:options</span> '((type       (choice (const <span class="builtin" id="font-lock:17414">:tag</span> <span class="string" id="font-lock:17419">"X11"</span>           x-toolkit)
<a href="#linum:455"><span class="linum" id="linum:455"> 455</span></a><span class="fringe" id="point:17446"> </span>                                 (const <span class="builtin" id="font-lock:17486">:tag</span> <span class="string" id="font-lock:17491">"Terminal"</span>      tty      )
<a href="#linum:456"><span class="linum" id="linum:456"> 456</span></a><span class="fringe" id="point:17518"> </span>                                 (const <span class="builtin" id="font-lock:17558">:tag</span> <span class="string" id="font-lock:17563">"Lucid Toolkit"</span> lucid    )
<a href="#linum:457"><span class="linum" id="linum:457"> 457</span></a><span class="fringe" id="point:17590"> </span>                                 (const <span class="builtin" id="font-lock:17630">:tag</span> <span class="string" id="font-lock:17635">"Motif Toolkit"</span> motif    )))
<a href="#linum:458"><span class="linum" id="linum:458"> 458</span></a><span class="fringe" id="point:17664"> </span>
<a href="#linum:459"><span class="linum" id="linum:459"> 459</span></a><span class="fringe" id="point:17665"> </span>             (class      (choice (const <span class="builtin" id="font-lock:17705">:tag</span> <span class="string" id="font-lock:17710">"Colour"</span>        color    )
<a href="#linum:460"><span class="linum" id="linum:460"> 460</span></a><span class="fringe" id="point:17737"> </span>                                 (const <span class="builtin" id="font-lock:17777">:tag</span> <span class="string" id="font-lock:17782">"Greyscale"</span>     grayscale)))
<a href="#linum:461"><span class="linum" id="linum:461"> 461</span></a><span class="fringe" id="point:17811"> </span>
<a href="#linum:462"><span class="linum" id="linum:462"> 462</span></a><span class="fringe" id="point:17812"> </span>             (background (choice (const <span class="builtin" id="font-lock:17852">:tag</span> <span class="string" id="font-lock:17857">"Dark"</span>          dark     )
<a href="#linum:463"><span class="linum" id="linum:463"> 463</span></a><span class="fringe" id="point:17884"> </span>                                 (const <span class="builtin" id="font-lock:17924">:tag</span> <span class="string" id="font-lock:17929">"Bright"</span>        light    ))) ))
<a href="#linum:464"><span class="linum" id="linum:464"> 464</span></a><span class="fringe" id="point:17961"> </span>
<a href="#linum:465"><span class="linum" id="linum:465"> 465</span></a><span class="fringe" id="point:17962"> </span>(<span class="keyword" id="font-lock:17963">defcustom</span> <span class="variable-name" id="font-lock:17973">hfy-optimisations</span> (list 'keep-overlays)
<a href="#linum:466"><span class="linum" id="linum:466"> 466</span></a><span class="fringe" id="point:18013"> </span>  <span class="doc" id="font-lock:18015">"Optimizations to turn on: So far, the following have been implemented:\n
</span><a href="#linum:467"><span class="linum" id="linum:467"> 467</span></a><span class="fringe" id="point:18089"> </span><span class="doc" id="font-lock:18089">  merge-adjacent-tags: If two (or more) span tags are adjacent, identical and
</span><a href="#linum:468"><span class="linum" id="linum:468"> 468</span></a><span class="fringe" id="point:18167"> </span><span class="doc" id="font-lock:18167">                       separated by nothing more than whitespace, they will
</span><a href="#linum:469"><span class="linum" id="linum:469"> 469</span></a><span class="fringe" id="point:18243"> </span><span class="doc" id="font-lock:18243">                       be merged into one span.
</span><a href="#linum:470"><span class="linum" id="linum:470"> 470</span></a><span class="fringe" id="point:18291"> </span><span class="doc" id="font-lock:18291">  zap-comment-links  : Suppress hyperlinking of tags found in comments.
</span><a href="#linum:471"><span class="linum" id="linum:471"> 471</span></a><span class="fringe" id="point:18363"> </span><span class="doc" id="font-lock:18363">  zap-string-links   : Suppress hyperlinking of tags found in strings.
</span><a href="#linum:472"><span class="linum" id="linum:472"> 472</span></a><span class="fringe" id="point:18434"> </span><span class="doc" id="font-lock:18434">  div-wrapper        : Add &lt;div class=\"default\"&gt; &lt;/div&gt; tags around the
</span><a href="#linum:473"><span class="linum" id="linum:473"> 473</span></a><span class="fringe" id="point:18508"> </span><span class="doc" id="font-lock:18508">                       output.
</span><a href="#linum:474"><span class="linum" id="linum:474"> 474</span></a><span class="fringe" id="point:18539"> </span><span class="doc" id="font-lock:18539">  keep-overlays      : More of a bell (or possibly whistle) than an
</span><a href="#linum:475"><span class="linum" id="linum:475"> 475</span></a><span class="fringe" id="point:18607"> </span><span class="doc" id="font-lock:18607">                       optimization - If on, preserve overlay highlighting
</span><a href="#linum:476"><span class="linum" id="linum:476"> 476</span></a><span class="fringe" id="point:18682"> </span><span class="doc" id="font-lock:18682">                       (cf ediff or goo-font-lock) as well as basic faces.\n
</span><a href="#linum:477"><span class="linum" id="linum:477"> 477</span></a><span class="fringe" id="point:18759"> </span><span class="doc" id="font-lock:18759">  And the following are planned but not yet available:\n
</span><a href="#linum:478"><span class="linum" id="linum:478"> 478</span></a><span class="fringe" id="point:18816"> </span><span class="doc" id="font-lock:18816">  kill-context-leak  : Suppress hyperlinking between files highlighted by
</span><a href="#linum:479"><span class="linum" id="linum:479"> 479</span></a><span class="fringe" id="point:18890"> </span><span class="doc" id="font-lock:18890">                       different modes.\n
</span><a href="#linum:480"><span class="linum" id="linum:480"> 480</span></a><span class="fringe" id="point:18932"> </span><span class="doc" id="font-lock:18932">Note: like compiler optimizations, these optimize the _output_ of the code,
</span><a href="#linum:481"><span class="linum" id="linum:481"> 481</span></a><span class="fringe" id="point:19008"> </span><span class="doc" id="font-lock:19008">not the processing of the source itself, and are therefore likely to slow
</span><a href="#linum:482"><span class="linum" id="linum:482"> 482</span></a><span class="fringe" id="point:19082"> </span><span class="doc" id="font-lock:19082">htmlfontify down, at least a little.  Except for skip-refontification,
</span><a href="#linum:483"><span class="linum" id="linum:483"> 483</span></a><span class="fringe" id="point:19153"> </span><span class="doc" id="font-lock:19153">which can never slow you down, but may result in incomplete fontification."</span>
<a href="#linum:484"><span class="linum" id="linum:484"> 484</span></a><span class="fringe" id="point:19229"> </span>  <span class="builtin" id="font-lock:19231">:type</span>  '(set (const <span class="builtin" id="font-lock:19251">:tag</span> <span class="string" id="font-lock:19256">"merge-adjacent-tags"</span>  merge-adjacent-tags )
<a href="#linum:485"><span class="linum" id="linum:485"> 485</span></a><span class="fringe" id="point:19301"> </span>               (const <span class="builtin" id="font-lock:19323">:tag</span> <span class="string" id="font-lock:19328">"zap-comment-links"</span>    zap-comment-links   )
<a href="#linum:486"><span class="linum" id="linum:486"> 486</span></a><span class="fringe" id="point:19373"> </span>               (const <span class="builtin" id="font-lock:19395">:tag</span> <span class="string" id="font-lock:19400">"zap-string-links"</span>     zap-string-links    )
<a href="#linum:487"><span class="linum" id="linum:487"> 487</span></a><span class="fringe" id="point:19445"> </span>               (const <span class="builtin" id="font-lock:19467">:tag</span> <span class="string" id="font-lock:19472">"skip-refontification"</span> skip-refontification)
<a href="#linum:488"><span class="linum" id="linum:488"> 488</span></a><span class="fringe" id="point:19517"> </span>               (const <span class="builtin" id="font-lock:19539">:tag</span> <span class="string" id="font-lock:19544">"kill-context-leak"</span>    kill-context-leak   )
<a href="#linum:489"><span class="linum" id="linum:489"> 489</span></a><span class="fringe" id="point:19589"> </span>               (const <span class="builtin" id="font-lock:19611">:tag</span> <span class="string" id="font-lock:19616">"div-wrapper"</span>          div-wrapper         )
<a href="#linum:490"><span class="linum" id="linum:490"> 490</span></a><span class="fringe" id="point:19661"> </span>               (const <span class="builtin" id="font-lock:19683">:tag</span> <span class="string" id="font-lock:19688">"keep-overlays"</span>        keep-overlays       ))
<a href="#linum:491"><span class="linum" id="linum:491"> 491</span></a><span class="fringe" id="point:19734"> </span>  <span class="builtin" id="font-lock:19736">:group</span> 'htmlfontify
<a href="#linum:492"><span class="linum" id="linum:492"> 492</span></a><span class="fringe" id="point:19756"> </span>  <span class="builtin" id="font-lock:19758">:tag</span>   <span class="string" id="font-lock:19765">"optimizations"</span>)
<a href="#linum:493"><span class="linum" id="linum:493"> 493</span></a><span class="fringe" id="point:19782"> </span>
<a href="#linum:494"><span class="linum" id="linum:494"> 494</span></a><span class="fringe" id="point:19783"> </span>(<span class="keyword" id="font-lock:19784">defvar</span> <span class="variable-name" id="font-lock:19791">hfy-tags-cache</span> nil
<a href="#linum:495"><span class="linum" id="linum:495"> 495</span></a><span class="fringe" id="point:19810"> </span>  <span class="doc" id="font-lock:19812">"Alist of the form:\n
</span><a href="#linum:496"><span class="linum" id="linum:496"> 496</span></a><span class="fringe" id="point:19834"> </span><span class="doc" id="font-lock:19834">\((\"/src/dir/0\" . tag-hash0) (\"/src/dir/1\" tag-hash1) ...)\n
</span><a href="#linum:497"><span class="linum" id="linum:497"> 497</span></a><span class="fringe" id="point:19899"> </span><span class="doc" id="font-lock:19899">Each tag hash entry then contains entries of the form:\n
</span><a href="#linum:498"><span class="linum" id="linum:498"> 498</span></a><span class="fringe" id="point:19956"> </span><span class="doc" id="font-lock:19956">\"tag_string\" =&gt; ((\"file/name.ext\" line char) ... )\n
</span><a href="#linum:499"><span class="linum" id="linum:499"> 499</span></a><span class="fringe" id="point:20013"> </span><span class="doc" id="font-lock:20013">ie an alist mapping (relative) file paths to line and character offsets.\n
</span><a href="#linum:500"><span class="linum" id="linum:500"> 500</span></a><span class="fringe" id="point:20088"> </span><span class="doc" id="font-lock:20088">See also `</span><span class="doc" id="font-lock:20098"><span class="constant" id="font-lock:20098">hfy-load-tags-cache</span></span><span class="doc" id="font-lock:20117">'."</span>)
<a href="#linum:501"><span class="linum" id="linum:501"> 501</span></a><span class="fringe" id="point:20122"> </span>
<a href="#linum:502"><span class="linum" id="linum:502"> 502</span></a><span class="fringe" id="point:20123"> </span>(<span class="keyword" id="font-lock:20124">defvar</span> <span class="variable-name" id="font-lock:20131">hfy-tags-sortl</span> nil
<a href="#linum:503"><span class="linum" id="linum:503"> 503</span></a><span class="fringe" id="point:20150"> </span>  <span class="doc" id="font-lock:20152">"Alist of the form ((\"/src/dir\" . (tag0 tag1 tag2)) ... )\n
</span><a href="#linum:504"><span class="linum" id="linum:504"> 504</span></a><span class="fringe" id="point:20214"> </span><span class="doc" id="font-lock:20214">where the tags are stored in descending order of length.\n
</span><a href="#linum:505"><span class="linum" id="linum:505"> 505</span></a><span class="fringe" id="point:20273"> </span><span class="doc" id="font-lock:20273">See also `</span><span class="doc" id="font-lock:20283"><span class="constant" id="font-lock:20283">hfy-load-tags-cache</span></span><span class="doc" id="font-lock:20302">'."</span>)
<a href="#linum:506"><span class="linum" id="linum:506"> 506</span></a><span class="fringe" id="point:20307"> </span>
<a href="#linum:507"><span class="linum" id="linum:507"> 507</span></a><span class="fringe" id="point:20308"> </span>(<span class="keyword" id="font-lock:20309">defvar</span> <span class="variable-name" id="font-lock:20316">hfy-tags-rmap</span> nil
<a href="#linum:508"><span class="linum" id="linum:508"> 508</span></a><span class="fringe" id="point:20334"> </span>  <span class="doc" id="font-lock:20336">"Alist of the form ((\"/src/dir\" . tag-rmap-hash))\n
</span><a href="#linum:509"><span class="linum" id="linum:509"> 509</span></a><span class="fringe" id="point:20390"> </span><span class="doc" id="font-lock:20390">where tag-rmap-hash has entries of the form:
</span><a href="#linum:510"><span class="linum" id="linum:510"> 510</span></a><span class="fringe" id="point:20435"> </span><span class="doc" id="font-lock:20435">\"tag_string\" =&gt; ( \"file/name.ext\" line char )
</span><a href="#linum:511"><span class="linum" id="linum:511"> 511</span></a><span class="fringe" id="point:20485"> </span><span class="doc" id="font-lock:20485">Unlike `</span><span class="doc" id="font-lock:20493"><span class="constant" id="font-lock:20493">hfy-tags-cache</span></span><span class="doc" id="font-lock:20507">' these are the locations of occurrences of
</span><a href="#linum:512"><span class="linum" id="linum:512"> 512</span></a><span class="fringe" id="point:20551"> </span><span class="doc" id="font-lock:20551">tagged items, not the locations of their definitions."</span>)
<a href="#linum:513"><span class="linum" id="linum:513"> 513</span></a><span class="fringe" id="point:20607"> </span>
<a href="#linum:514"><span class="linum" id="linum:514"> 514</span></a><span class="fringe" id="point:20608"> </span>(<span class="keyword" id="font-lock:20609">defvar</span> <span class="variable-name" id="font-lock:20616">hfy-style-assoc</span> 'please-ignore-this-line
<a href="#linum:515"><span class="linum" id="linum:515"> 515</span></a><span class="fringe" id="point:20657"> </span>  <span class="doc" id="font-lock:20659">"An assoc representing/describing an Emacs face.
</span><a href="#linum:516"><span class="linum" id="linum:516"> 516</span></a><span class="fringe" id="point:20708"> </span><span class="doc" id="font-lock:20708">Properties may be repeated, in which case later properties should be
</span><a href="#linum:517"><span class="linum" id="linum:517"> 517</span></a><span class="fringe" id="point:20777"> </span><span class="doc" id="font-lock:20777">treated as if they were inherited from a 'parent' font.
</span><a href="#linum:518"><span class="linum" id="linum:518"> 518</span></a><span class="fringe" id="point:20833"> </span><span class="doc" id="font-lock:20833">\(For some properties, only the first encountered value is of any importance,
</span><a href="#linum:519"><span class="linum" id="linum:519"> 519</span></a><span class="fringe" id="point:20911"> </span><span class="doc" id="font-lock:20911">for others the values might be cumulative, and for others they might be
</span><a href="#linum:520"><span class="linum" id="linum:520"> 520</span></a><span class="fringe" id="point:20983"> </span><span class="doc" id="font-lock:20983">cumulative in a complex way.)\n
</span><a href="#linum:521"><span class="linum" id="linum:521"> 521</span></a><span class="fringe" id="point:21015"> </span><span class="doc" id="font-lock:21015">Some examples:\n
</span><a href="#linum:522"><span class="linum" id="linum:522"> 522</span></a><span class="fringe" id="point:21032"> </span><span class="doc" id="font-lock:21032">\(hfy-face-to-style 'default) =&gt;
</span><a href="#linum:523"><span class="linum" id="linum:523"> 523</span></a><span class="fringe" id="point:21065"> </span><span class="doc" id="font-lock:21065">  ((\"background\"      . \"rgb(0, 0, 0)\")
</span><a href="#linum:524"><span class="linum" id="linum:524"> 524</span></a><span class="fringe" id="point:21109"> </span><span class="doc" id="font-lock:21109">   (\"color\"           . \"rgb(255, 255, 255)\")
</span><a href="#linum:525"><span class="linum" id="linum:525"> 525</span></a><span class="fringe" id="point:21159"> </span><span class="doc" id="font-lock:21159">   (\"font-style\"      . \"normal\")
</span><a href="#linum:526"><span class="linum" id="linum:526"> 526</span></a><span class="fringe" id="point:21197"> </span><span class="doc" id="font-lock:21197">   (\"font-weight\"     . \"500\")
</span><a href="#linum:527"><span class="linum" id="linum:527"> 527</span></a><span class="fringe" id="point:21232"> </span><span class="doc" id="font-lock:21232">   (\"font-stretch\"    . \"normal\")
</span><a href="#linum:528"><span class="linum" id="linum:528"> 528</span></a><span class="fringe" id="point:21270"> </span><span class="doc" id="font-lock:21270">   (\"font-family\"     . \"misc-fixed\")
</span><a href="#linum:529"><span class="linum" id="linum:529"> 529</span></a><span class="fringe" id="point:21312"> </span><span class="doc" id="font-lock:21312">   (\"font-size\"       . \"13pt\")
</span><a href="#linum:530"><span class="linum" id="linum:530"> 530</span></a><span class="fringe" id="point:21348"> </span><span class="doc" id="font-lock:21348">   (\"text-decoration\" . \"none\"))\n
</span><a href="#linum:531"><span class="linum" id="linum:531"> 531</span></a><span class="fringe" id="point:21387"> </span><span class="doc" id="font-lock:21387">\(hfy-face-to-style 'Info-title-3-face) =&gt;
</span><a href="#linum:532"><span class="linum" id="linum:532"> 532</span></a><span class="fringe" id="point:21430"> </span><span class="doc" id="font-lock:21430">  ((\"font-weight\"     . \"700\")
</span><a href="#linum:533"><span class="linum" id="linum:533"> 533</span></a><span class="fringe" id="point:21465"> </span><span class="doc" id="font-lock:21465">   (\"font-family\"     . \"helv\")
</span><a href="#linum:534"><span class="linum" id="linum:534"> 534</span></a><span class="fringe" id="point:21501"> </span><span class="doc" id="font-lock:21501">   (\"font-size\"       . \"120%\")
</span><a href="#linum:535"><span class="linum" id="linum:535"> 535</span></a><span class="fringe" id="point:21537"> </span><span class="doc" id="font-lock:21537">   (\"text-decoration\" . \"none\"))\n"</span>)
<a href="#linum:536"><span class="linum" id="linum:536"> 536</span></a><span class="fringe" id="point:21578"> </span>
<a href="#linum:537"><span class="linum" id="linum:537"> 537</span></a><span class="fringe" id="point:21579"> </span>(<span class="keyword" id="font-lock:21580">defvar</span> <span class="variable-name" id="font-lock:21587">hfy-sheet-assoc</span> 'please-ignore-this-line
<a href="#linum:538"><span class="linum" id="linum:538"> 538</span></a><span class="fringe" id="point:21628"> </span>  <span class="doc" id="font-lock:21630">"An assoc with elements of the form (face-name style-name . style-string):\n
</span><a href="#linum:539"><span class="linum" id="linum:539"> 539</span></a><span class="fringe" id="point:21707"> </span><span class="doc" id="font-lock:21707">'((default               \"default\" . \"{background: black; color: white}\")
</span><a href="#linum:540"><span class="linum" id="linum:540"> 540</span></a><span class="fringe" id="point:21785"> </span><span class="doc" id="font-lock:21785">  (font-lock-string-face \"string\"  . \"{color: rgb(64,224,208)}\"))"</span> )
<a href="#linum:541"><span class="linum" id="linum:541"> 541</span></a><span class="fringe" id="point:21858"> </span>
<a href="#linum:542"><span class="linum" id="linum:542"> 542</span></a><span class="fringe" id="point:21859"> </span>(<span class="keyword" id="font-lock:21860">defvar</span> <span class="variable-name" id="font-lock:21867">hfy-facemap-assoc</span> 'please-ignore-this-line
<a href="#linum:543"><span class="linum" id="linum:543"> 543</span></a><span class="fringe" id="point:21910"> </span>  <span class="doc" id="font-lock:21912">"An assoc of (point . FACE-SYMBOL) or (point . DEFFACE-LIST)
</span><a href="#linum:544"><span class="linum" id="linum:544"> 544</span></a><span class="fringe" id="point:21973"> </span><span class="doc" id="font-lock:21973">and (point . 'end) elements, in descending order of point value
</span><a href="#linum:545"><span class="linum" id="linum:545"> 545</span></a><span class="fringe" id="point:22037"> </span><span class="doc" id="font-lock:22037">\(ie from the file's end to its beginning).\n
</span><a href="#linum:546"><span class="linum" id="linum:546"> 546</span></a><span class="fringe" id="point:22083"> </span><span class="doc" id="font-lock:22083">The map is in reverse order because inserting a &lt;style&gt; tag (or any other
</span><a href="#linum:547"><span class="linum" id="linum:547"> 547</span></a><span class="fringe" id="point:22157"> </span><span class="doc" id="font-lock:22157">string) at `</span><span class="doc" id="font-lock:22169"><span class="constant" id="font-lock:22169">point</span></span><span class="doc" id="font-lock:22174">' invalidates the map for all entries with a greater value of
</span><a href="#linum:548"><span class="linum" id="linum:548"> 548</span></a><span class="fringe" id="point:22236"> </span><span class="doc" id="font-lock:22236">point.  By traversing the map from greatest to least point, we still invalidate
</span><a href="#linum:549"><span class="linum" id="linum:549"> 549</span></a><span class="fringe" id="point:22316"> </span><span class="doc" id="font-lock:22316">the map as we go, but only those points we have already dealt with (and
</span><a href="#linum:550"><span class="linum" id="linum:550"> 550</span></a><span class="fringe" id="point:22388"> </span><span class="doc" id="font-lock:22388">therefore no longer care about) will be invalid at any time.\n
</span><a href="#linum:551"><span class="linum" id="linum:551"> 551</span></a><span class="fringe" id="point:22451"> </span><span class="doc" id="font-lock:22451">'((64820 . end)
</span><a href="#linum:552"><span class="linum" id="linum:552"> 552</span></a><span class="fringe" id="point:22467"> </span><span class="doc" id="font-lock:22467">  (64744 . font-lock-comment-face)
</span><a href="#linum:553"><span class="linum" id="linum:553"> 553</span></a><span class="fringe" id="point:22502"> </span><span class="doc" id="font-lock:22502">  (64736 . end)
</span><a href="#linum:554"><span class="linum" id="linum:554"> 554</span></a><span class="fringe" id="point:22518"> </span><span class="doc" id="font-lock:22518">  (64722 . font-lock-string-face)
</span><a href="#linum:555"><span class="linum" id="linum:555"> 555</span></a><span class="fringe" id="point:22552"> </span><span class="doc" id="font-lock:22552">  (64630 . end)
</span><a href="#linum:556"><span class="linum" id="linum:556"> 556</span></a><span class="fringe" id="point:22568"> </span><span class="doc" id="font-lock:22568">  (64623 . font-lock-string-face)
</span><a href="#linum:557"><span class="linum" id="linum:557"> 557</span></a><span class="fringe" id="point:22602"> </span><span class="doc" id="font-lock:22602">  (64449 . end)
</span><a href="#linum:558"><span class="linum" id="linum:558"> 558</span></a><span class="fringe" id="point:22618"> </span><span class="doc" id="font-lock:22618">  (64446 . font-lock-keyword-face)
</span><a href="#linum:559"><span class="linum" id="linum:559"> 559</span></a><span class="fringe" id="point:22653"> </span><span class="doc" id="font-lock:22653">  (64406 . end)
</span><a href="#linum:560"><span class="linum" id="linum:560"> 560</span></a><span class="fringe" id="point:22669"> </span><span class="doc" id="font-lock:22669">  (64395 . font-lock-constant-face)
</span><a href="#linum:561"><span class="linum" id="linum:561"> 561</span></a><span class="fringe" id="point:22705"> </span><span class="doc" id="font-lock:22705">  (64393 . end)
</span><a href="#linum:562"><span class="linum" id="linum:562"> 562</span></a><span class="fringe" id="point:22721"> </span><span class="doc" id="font-lock:22721">  (64386 . font-lock-keyword-face)
</span><a href="#linum:563"><span class="linum" id="linum:563"> 563</span></a><span class="fringe" id="point:22756"> </span><span class="doc" id="font-lock:22756">  (64379 . end)
</span><a href="#linum:564"><span class="linum" id="linum:564"> 564</span></a><span class="fringe" id="point:22772"> </span><span class="doc" id="font-lock:22772">  ;; big similar section elided.  You get the idea.
</span><a href="#linum:565"><span class="linum" id="linum:565"> 565</span></a><span class="fringe" id="point:22824"> </span><span class="doc" id="font-lock:22824">  (4285 . font-lock-constant-face)
</span><a href="#linum:566"><span class="linum" id="linum:566"> 566</span></a><span class="fringe" id="point:22859"> </span><span class="doc" id="font-lock:22859">  (4285 . end)
</span><a href="#linum:567"><span class="linum" id="linum:567"> 567</span></a><span class="fringe" id="point:22874"> </span><span class="doc" id="font-lock:22874">  (4221 . font-lock-comment-face)
</span><a href="#linum:568"><span class="linum" id="linum:568"> 568</span></a><span class="fringe" id="point:22908"> </span><span class="doc" id="font-lock:22908">  (4221 . end)
</span><a href="#linum:569"><span class="linum" id="linum:569"> 569</span></a><span class="fringe" id="point:22923"> </span><span class="doc" id="font-lock:22923">  (4197 . font-lock-constant-face)
</span><a href="#linum:570"><span class="linum" id="linum:570"> 570</span></a><span class="fringe" id="point:22958"> </span><span class="doc" id="font-lock:22958">  (4197 . end)
</span><a href="#linum:571"><span class="linum" id="linum:571"> 571</span></a><span class="fringe" id="point:22973"> </span><span class="doc" id="font-lock:22973">  (1 . font-lock-comment-face))"</span>)
<a href="#linum:572"><span class="linum" id="linum:572"> 572</span></a><span class="fringe" id="point:23007"> </span>
<a href="#linum:573"><span class="linum" id="linum:573"> 573</span></a><span class="fringe" id="point:23008"> </span>(<span class="keyword" id="font-lock:23009">defvar</span> <span class="variable-name" id="font-lock:23016">hfy-tmpfont-stack</span> nil
<a href="#linum:574"><span class="linum" id="linum:574"> 574</span></a><span class="fringe" id="point:23038"> </span>  <span class="doc" id="font-lock:23040">"An alist of derived fonts resulting from overlays."</span>)
<a href="#linum:575"><span class="linum" id="linum:575"> 575</span></a><span class="fringe" id="point:23094"> </span>
<a href="#linum:576"><span class="linum" id="linum:576"> 576</span></a><span class="fringe" id="point:23095"> </span>(<span class="keyword" id="font-lock:23096">defconst</span> <span class="variable-name" id="font-lock:23105">hfy-hex-regex</span> <span class="string" id="font-lock:23119">"[0-9A-Fa-f]"</span>)
<a href="#linum:577"><span class="linum" id="linum:577"> 577</span></a><span class="fringe" id="point:23134"> </span>
<a href="#linum:578"><span class="linum" id="linum:578"> 578</span></a><span class="fringe" id="point:23135"> </span>(<span class="keyword" id="font-lock:23136">defconst</span> <span class="variable-name" id="font-lock:23145">hfy-triplet-regex</span>
<a href="#linum:579"><span class="linum" id="linum:579"> 579</span></a><span class="fringe" id="point:23163"> </span>  (concat
<a href="#linum:580"><span class="linum" id="linum:580"> 580</span></a><span class="fringe" id="point:23173"> </span>   <span class="string" id="font-lock:23176">"</span><span class="string" id="font-lock:23177"><span class="regexp-grouping-backslash" id="font-lock:23177">\\</span></span><span class="string" id="font-lock:23179"><span class="regexp-grouping-construct" id="font-lock:23179">(</span></span><span class="string" id="font-lock:23180">"</span> hfy-hex-regex hfy-hex-regex <span class="string" id="font-lock:23210">"</span><span class="string" id="font-lock:23211"><span class="regexp-grouping-backslash" id="font-lock:23211">\\</span></span><span class="string" id="font-lock:23213"><span class="regexp-grouping-construct" id="font-lock:23213">)</span></span><span class="string" id="font-lock:23214">"</span>
<a href="#linum:581"><span class="linum" id="linum:581"> 581</span></a><span class="fringe" id="point:23216"> </span>   <span class="string" id="font-lock:23219">"</span><span class="string" id="font-lock:23220"><span class="regexp-grouping-backslash" id="font-lock:23220">\\</span></span><span class="string" id="font-lock:23222"><span class="regexp-grouping-construct" id="font-lock:23222">(</span></span><span class="string" id="font-lock:23223">"</span> hfy-hex-regex hfy-hex-regex <span class="string" id="font-lock:23253">"</span><span class="string" id="font-lock:23254"><span class="regexp-grouping-backslash" id="font-lock:23254">\\</span></span><span class="string" id="font-lock:23256"><span class="regexp-grouping-construct" id="font-lock:23256">)</span></span><span class="string" id="font-lock:23257">"</span>
<a href="#linum:582"><span class="linum" id="linum:582"> 582</span></a><span class="fringe" id="point:23259"> </span>   <span class="string" id="font-lock:23262">"</span><span class="string" id="font-lock:23263"><span class="regexp-grouping-backslash" id="font-lock:23263">\\</span></span><span class="string" id="font-lock:23265"><span class="regexp-grouping-construct" id="font-lock:23265">(</span></span><span class="string" id="font-lock:23266">"</span> hfy-hex-regex hfy-hex-regex <span class="string" id="font-lock:23296">"</span><span class="string" id="font-lock:23297"><span class="regexp-grouping-backslash" id="font-lock:23297">\\</span></span><span class="string" id="font-lock:23299"><span class="regexp-grouping-construct" id="font-lock:23299">)</span></span><span class="string" id="font-lock:23300">"</span>))
<a href="#linum:583"><span class="linum" id="linum:583"> 583</span></a><span class="fringe" id="point:23304"> </span>
<a href="#linum:584"><span class="linum" id="linum:584"> 584</span></a><span class="fringe" id="point:23305"> </span>(<span class="keyword" id="font-lock:23306">defun</span> <span class="function-name" id="font-lock:23312">hfy-interq</span> (set-a set-b)
<a href="#linum:585"><span class="linum" id="linum:585"> 585</span></a><span class="fringe" id="point:23337"> </span>  <span class="doc" id="font-lock:23339">"Return the intersection (using `</span><span class="doc" id="font-lock:23372"><span class="constant" id="font-lock:23372">eq</span></span><span class="doc" id="font-lock:23374">') of two lists SET-A and SET-B."</span>
<a href="#linum:586"><span class="linum" id="linum:586"> 586</span></a><span class="fringe" id="point:23408"> </span>  (<span class="keyword" id="font-lock:23411">let</span> ((sa set-a) (interq nil) (elt nil))
<a href="#linum:587"><span class="linum" id="linum:587"> 587</span></a><span class="fringe" id="point:23451"> </span>    (<span class="keyword" id="font-lock:23456">while</span> sa
<a href="#linum:588"><span class="linum" id="linum:588"> 588</span></a><span class="fringe" id="point:23465"> </span>      (setq elt (car sa)
<a href="#linum:589"><span class="linum" id="linum:589"> 589</span></a><span class="fringe" id="point:23490"> </span>            sa  (cdr sa))
<a href="#linum:590"><span class="linum" id="linum:590"> 590</span></a><span class="fringe" id="point:23516"> </span>      (<span class="keyword" id="font-lock:23523">if</span> (memq elt set-b) (setq interq (cons elt interq)))) interq))
<a href="#linum:591"><span class="linum" id="linum:591"> 591</span></a><span class="fringe" id="point:23586"> </span>
<a href="#linum:592"><span class="linum" id="linum:592"> 592</span></a><span class="fringe" id="point:23587"> </span>(<span class="keyword" id="font-lock:23588">defun</span> <span class="function-name" id="font-lock:23594">hfy-colour-vals</span> (colour)
<a href="#linum:593"><span class="linum" id="linum:593"> 593</span></a><span class="fringe" id="point:23619"> </span>  <span class="doc" id="font-lock:23621">"Where COLOUR is a color name or #XXXXXX style triplet, return a
</span><a href="#linum:594"><span class="linum" id="linum:594"> 594</span></a><span class="fringe" id="point:23686"> </span><span class="doc" id="font-lock:23686">list of three (16 bit) rgb values for said color.\n
</span><a href="#linum:595"><span class="linum" id="linum:595"> 595</span></a><span class="fringe" id="point:23738"> </span><span class="doc" id="font-lock:23738">If a window system is unavailable, calls `</span><span class="doc" id="font-lock:23780"><span class="constant" id="font-lock:23780">hfy-fallback-colour-values</span></span><span class="doc" id="font-lock:23806">'."</span>
<a href="#linum:596"><span class="linum" id="linum:596"> 596</span></a><span class="fringe" id="point:23810"> </span>  (<span class="keyword" id="font-lock:23813">if</span> (string-match hfy-triplet-regex colour)
<a href="#linum:597"><span class="linum" id="linum:597"> 597</span></a><span class="fringe" id="point:23856"> </span>      (mapcar
<a href="#linum:598"><span class="linum" id="linum:598"> 598</span></a><span class="fringe" id="point:23870"> </span>       (<span class="keyword" id="font-lock:23878">lambda</span> (x) (* (string-to-number (match-string x colour) 16) 257))
<a href="#linum:599"><span class="linum" id="linum:599"> 599</span></a><span class="fringe" id="point:23944"> </span>       '(1 2 3))
<a href="#linum:600"><span class="linum" id="linum:600"> 600</span></a><span class="fringe" id="point:23961"> </span>    <span class="comment-delimiter" id="font-lock:23965">;;</span><span class="comment" id="font-lock:23967">(message "&gt;&gt; %s" colour)
</span><a href="#linum:601"><span class="linum" id="linum:601"> 601</span></a><span class="fringe" id="point:23992"> </span>    (<span class="keyword" id="font-lock:23997">if</span> window-system
<a href="#linum:602"><span class="linum" id="linum:602"> 602</span></a><span class="fringe" id="point:24014"> </span>        (<span class="keyword" id="font-lock:24023">if</span> (fboundp 'color-values)
<a href="#linum:603"><span class="linum" id="linum:603"> 603</span></a><span class="fringe" id="point:24050"> </span>            (color-values colour)
<a href="#linum:604"><span class="linum" id="linum:604"> 604</span></a><span class="fringe" id="point:24084"> </span>          <span class="comment-delimiter" id="font-lock:24094">;;</span><span class="comment" id="font-lock:24096">(message "[%S]" window-system)
</span><a href="#linum:605"><span class="linum" id="linum:605"> 605</span></a><span class="fringe" id="point:24127"> </span>          (x-color-values colour))
<a href="#linum:606"><span class="linum" id="linum:606"> 606</span></a><span class="fringe" id="point:24162"> </span>      <span class="comment-delimiter" id="font-lock:24168">;; </span><span class="comment" id="font-lock:24171">blarg - tty colours are no good - go fetch some X colours:
</span><a href="#linum:607"><span class="linum" id="linum:607"> 607</span></a><span class="fringe" id="point:24230"> </span>      (hfy-fallback-colour-values colour))))
<a href="#linum:608"><span class="linum" id="linum:608"> 608</span></a><span class="fringe" id="point:24275"> </span>
<a href="#linum:609"><span class="linum" id="linum:609"> 609</span></a><span class="fringe" id="point:24276"> </span>(<span class="keyword" id="font-lock:24277">defvar</span> <span class="variable-name" id="font-lock:24284">hfy-cperl-mode-kludged-p</span> nil)
<a href="#linum:610"><span class="linum" id="linum:610"> 610</span></a><span class="fringe" id="point:24314"> </span>
<a href="#linum:611"><span class="linum" id="linum:611"> 611</span></a><span class="fringe" id="point:24315"> </span>(<span class="keyword" id="font-lock:24316">defun</span> <span class="function-name" id="font-lock:24322">hfy-kludge-cperl-mode</span> ()
<a href="#linum:612"><span class="linum" id="linum:612"> 612</span></a><span class="fringe" id="point:24347"> </span>  <span class="doc" id="font-lock:24349">"CPerl mode does its damndest not to do some of its fontification when not
</span><a href="#linum:613"><span class="linum" id="linum:613"> 613</span></a><span class="fringe" id="point:24424"> </span><span class="doc" id="font-lock:24424">in a windowing system - try to trick it..."</span>
<a href="#linum:614"><span class="linum" id="linum:614"> 614</span></a><span class="fringe" id="point:24468"> </span>  (<span class="keyword" id="font-lock:24471">if</span> (not hfy-cperl-mode-kludged-p)
<a href="#linum:615"><span class="linum" id="linum:615"> 615</span></a><span class="fringe" id="point:24505"> </span>      (<span class="keyword" id="font-lock:24512">progn</span> (<span class="keyword" id="font-lock:24519">if</span> (not window-system)
<a href="#linum:616"><span class="linum" id="linum:616"> 616</span></a><span class="fringe" id="point:24542"> </span>                 (<span class="keyword" id="font-lock:24560">let</span> ((window-system 'htmlfontify))
<a href="#linum:617"><span class="linum" id="linum:617"> 617</span></a><span class="fringe" id="point:24595"> </span>                   (<span class="keyword" id="font-lock:24615">eval-and-compile</span> (<span class="keyword" id="font-lock:24633">require</span> '<span class="constant" id="font-lock:24642">cperl-mode</span>))
<a href="#linum:618"><span class="linum" id="linum:618"> 618</span></a><span class="fringe" id="point:24655"> </span>                   (setq cperl-syntaxify-by-font-lock t)))
<a href="#linum:619"><span class="linum" id="linum:619"> 619</span></a><span class="fringe" id="point:24714"> </span>             (setq hfy-cperl-mode-kludged-p t))) )
<a href="#linum:620"><span class="linum" id="linum:620"> 620</span></a><span class="fringe" id="point:24765"> </span>
<a href="#linum:621"><span class="linum" id="linum:621"> 621</span></a><span class="fringe" id="point:24766"> </span>(<span class="keyword" id="font-lock:24767">defun</span> <span class="function-name" id="font-lock:24773">hfy-opt</span> (symbol) <span class="doc" id="font-lock:24790">"Is option SYMBOL set."</span> (memq symbol hfy-optimisations))
<a href="#linum:622"><span class="linum" id="linum:622"> 622</span></a><span class="fringe" id="point:24847"> </span>
<a href="#linum:623"><span class="linum" id="linum:623"> 623</span></a><span class="fringe" id="point:24848"> </span>(<span class="keyword" id="font-lock:24849">defun</span> <span class="function-name" id="font-lock:24855">hfy-default-header</span> (file style)
<a href="#linum:624"><span class="linum" id="linum:624"> 624</span></a><span class="fringe" id="point:24887"> </span>  <span class="doc" id="font-lock:24889">"Default value for `</span><span class="doc" id="font-lock:24909"><span class="constant" id="font-lock:24909">hfy-page-header</span></span><span class="doc" id="font-lock:24924">'.
</span><a href="#linum:625"><span class="linum" id="linum:625"> 625</span></a><span class="fringe" id="point:24927"> </span><span class="doc" id="font-lock:24927">FILE is the name of the file.
</span><a href="#linum:626"><span class="linum" id="linum:626"> 626</span></a><span class="fringe" id="point:24957"> </span><span class="doc" id="font-lock:24957">STYLE is the inline CSS stylesheet (or tag referring to an external sheet)."</span>
<a href="#linum:627"><span class="linum" id="linum:627"> 627</span></a><span class="fringe" id="point:25034"> </span><span class="comment-delimiter" id="font-lock:25034">;;   </span><span class="comment" id="font-lock:25039">(format "&lt;!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\"&gt;
</span><a href="#linum:628"><span class="linum" id="linum:628"> 628</span></a><span class="fringe" id="point:25114"> </span><span class="comment-delimiter" id="font-lock:25114">;; </span><span class="comment" id="font-lock:25117">&lt;html&gt;\n &lt;head&gt;\n  &lt;title&gt;%s&lt;/title&gt;\n %s\n &lt;/head&gt;\n  &lt;body&gt;\n" file style))
</span><a href="#linum:629"><span class="linum" id="linum:629"> 629</span></a><span class="fringe" id="point:25195"> </span>  (format <span class="string" id="font-lock:25205">"&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;
</span><a href="#linum:630"><span class="linum" id="linum:630"> 630</span></a><span class="fringe" id="point:25249"> </span><span class="string" id="font-lock:25249">&lt;!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.1//EN\"
</span><a href="#linum:631"><span class="linum" id="linum:631"> 631</span></a><span class="fringe" id="point:25301"> </span><span class="string" id="font-lock:25301">\"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd\"&gt;
</span><a href="#linum:632"><span class="linum" id="linum:632"> 632</span></a><span class="fringe" id="point:25351"> </span><span class="string" id="font-lock:25351">&lt;html xmlns=\"http://www.w3.org/1999/xhtml\"&gt;
</span><a href="#linum:633"><span class="linum" id="linum:633"> 633</span></a><span class="fringe" id="point:25397"> </span><span class="string" id="font-lock:25397">  &lt;head&gt;
</span><a href="#linum:634"><span class="linum" id="linum:634"> 634</span></a><span class="fringe" id="point:25406"> </span><span class="string" id="font-lock:25406">    &lt;title&gt;%s&lt;/title&gt;
</span><a href="#linum:635"><span class="linum" id="linum:635"> 635</span></a><span class="fringe" id="point:25428"> </span><span class="string" id="font-lock:25428">%s
</span><a href="#linum:636"><span class="linum" id="linum:636"> 636</span></a><span class="fringe" id="point:25431"> </span><span class="string" id="font-lock:25431">    &lt;script type=\"text/javascript\"&gt;&lt;!--
</span><a href="#linum:637"><span class="linum" id="linum:637"> 637</span></a><span class="fringe" id="point:25473"> </span><span class="string" id="font-lock:25473">  // this function is needed to work around
</span><a href="#linum:638"><span class="linum" id="linum:638"> 638</span></a><span class="fringe" id="point:25517"> </span><span class="string" id="font-lock:25517">  // a bug in IE related to element attributes
</span><a href="#linum:639"><span class="linum" id="linum:639"> 639</span></a><span class="fringe" id="point:25564"> </span><span class="string" id="font-lock:25564">  function hasClass(obj)
</span><a href="#linum:640"><span class="linum" id="linum:640"> 640</span></a><span class="fringe" id="point:25589"> </span><span class="string" id="font-lock:25589">  {
</span><a href="#linum:641"><span class="linum" id="linum:641"> 641</span></a><span class="fringe" id="point:25593"> </span><span class="string" id="font-lock:25593">      var result = false;
</span><a href="#linum:642"><span class="linum" id="linum:642"> 642</span></a><span class="fringe" id="point:25619"> </span><span class="string" id="font-lock:25619">      if (obj.getAttributeNode(\"class\") != null)
</span><a href="#linum:643"><span class="linum" id="linum:643"> 643</span></a><span class="fringe" id="point:25670"> </span><span class="string" id="font-lock:25670">      {
</span><a href="#linum:644"><span class="linum" id="linum:644"> 644</span></a><span class="fringe" id="point:25678"> </span><span class="string" id="font-lock:25678">          result = obj.getAttributeNode(\"class\").value;
</span><a href="#linum:645"><span class="linum" id="linum:645"> 645</span></a><span class="fringe" id="point:25736"> </span><span class="string" id="font-lock:25736">      }
</span><a href="#linum:646"><span class="linum" id="linum:646"> 646</span></a><span class="fringe" id="point:25744"> </span><span class="string" id="font-lock:25744">      return result;
</span><a href="#linum:647"><span class="linum" id="linum:647"> 647</span></a><span class="fringe" id="point:25765"> </span><span class="string" id="font-lock:25765">  }
</span><a href="#linum:648"><span class="linum" id="linum:648"> 648</span></a><span class="fringe" id="point:25769"> </span><span class="string" id="font-lock:25769">
</span><a href="#linum:649"><span class="linum" id="linum:649"> 649</span></a><span class="fringe" id="point:25770"> </span><span class="string" id="font-lock:25770">  function stripe(id)
</span><a href="#linum:650"><span class="linum" id="linum:650"> 650</span></a><span class="fringe" id="point:25792"> </span><span class="string" id="font-lock:25792">  {
</span><a href="#linum:651"><span class="linum" id="linum:651"> 651</span></a><span class="fringe" id="point:25796"> </span><span class="string" id="font-lock:25796">      // the flag we'll use to keep track of
</span><a href="#linum:652"><span class="linum" id="linum:652"> 652</span></a><span class="fringe" id="point:25841"> </span><span class="string" id="font-lock:25841">      // whether the current row is odd or even
</span><a href="#linum:653"><span class="linum" id="linum:653"> 653</span></a><span class="fringe" id="point:25889"> </span><span class="string" id="font-lock:25889">      var even = false;
</span><a href="#linum:654"><span class="linum" id="linum:654"> 654</span></a><span class="fringe" id="point:25913"> </span><span class="string" id="font-lock:25913">
</span><a href="#linum:655"><span class="linum" id="linum:655"> 655</span></a><span class="fringe" id="point:25914"> </span><span class="string" id="font-lock:25914">      // if arguments are provided to specify the colors
</span><a href="#linum:656"><span class="linum" id="linum:656"> 656</span></a><span class="fringe" id="point:25971"> </span><span class="string" id="font-lock:25971">      // of the even &amp; odd rows, then use the them;
</span><a href="#linum:657"><span class="linum" id="linum:657"> 657</span></a><span class="fringe" id="point:26023"> </span><span class="string" id="font-lock:26023">      // otherwise use the following defaults:
</span><a href="#linum:658"><span class="linum" id="linum:658"> 658</span></a><span class="fringe" id="point:26070"> </span><span class="string" id="font-lock:26070">      var evenColor = arguments[1] ? arguments[1] : \"#fff\";
</span><a href="#linum:659"><span class="linum" id="linum:659"> 659</span></a><span class="fringe" id="point:26132"> </span><span class="string" id="font-lock:26132">      var oddColor  = arguments[2] ? arguments[2] : \"#ddd\";
</span><a href="#linum:660"><span class="linum" id="linum:660"> 660</span></a><span class="fringe" id="point:26194"> </span><span class="string" id="font-lock:26194">
</span><a href="#linum:661"><span class="linum" id="linum:661"> 661</span></a><span class="fringe" id="point:26195"> </span><span class="string" id="font-lock:26195">      // obtain a reference to the desired table
</span><a href="#linum:662"><span class="linum" id="linum:662"> 662</span></a><span class="fringe" id="point:26244"> </span><span class="string" id="font-lock:26244">      // if no such table exists, abort
</span><a href="#linum:663"><span class="linum" id="linum:663"> 663</span></a><span class="fringe" id="point:26284"> </span><span class="string" id="font-lock:26284">      var table = document.getElementById(id);
</span><a href="#linum:664"><span class="linum" id="linum:664"> 664</span></a><span class="fringe" id="point:26331"> </span><span class="string" id="font-lock:26331">      if (! table) { return; }
</span><a href="#linum:665"><span class="linum" id="linum:665"> 665</span></a><span class="fringe" id="point:26362"> </span><span class="string" id="font-lock:26362">
</span><a href="#linum:666"><span class="linum" id="linum:666"> 666</span></a><span class="fringe" id="point:26363"> </span><span class="string" id="font-lock:26363">      // by definition, tables can have more than one tbody
</span><a href="#linum:667"><span class="linum" id="linum:667"> 667</span></a><span class="fringe" id="point:26423"> </span><span class="string" id="font-lock:26423">      // element, so we'll have to get the list of child
</span><a href="#linum:668"><span class="linum" id="linum:668"> 668</span></a><span class="fringe" id="point:26480"> </span><span class="string" id="font-lock:26480">      // &amp;lt;tbody&amp;gt;s
</span><a href="#linum:669"><span class="linum" id="linum:669"> 669</span></a><span class="fringe" id="point:26504"> </span><span class="string" id="font-lock:26504">      var tbodies = table.getElementsByTagName(\"tbody\");
</span><a href="#linum:670"><span class="linum" id="linum:670"> 670</span></a><span class="fringe" id="point:26563"> </span><span class="string" id="font-lock:26563">
</span><a href="#linum:671"><span class="linum" id="linum:671"> 671</span></a><span class="fringe" id="point:26564"> </span><span class="string" id="font-lock:26564">      // and iterate through them...
</span><a href="#linum:672"><span class="linum" id="linum:672"> 672</span></a><span class="fringe" id="point:26601"> </span><span class="string" id="font-lock:26601">      for (var h = 0; h &lt; tbodies.length; h++)
</span><a href="#linum:673"><span class="linum" id="linum:673"> 673</span></a><span class="fringe" id="point:26648"> </span><span class="string" id="font-lock:26648">      {
</span><a href="#linum:674"><span class="linum" id="linum:674"> 674</span></a><span class="fringe" id="point:26656"> </span><span class="string" id="font-lock:26656">          // find all the &amp;lt;tr&amp;gt; elements...
</span><a href="#linum:675"><span class="linum" id="linum:675"> 675</span></a><span class="fringe" id="point:26705"> </span><span class="string" id="font-lock:26705">          var trs = tbodies[h].getElementsByTagName(\"tr\");
</span><a href="#linum:676"><span class="linum" id="linum:676"> 676</span></a><span class="fringe" id="point:26766"> </span><span class="string" id="font-lock:26766">
</span><a href="#linum:677"><span class="linum" id="linum:677"> 677</span></a><span class="fringe" id="point:26767"> </span><span class="string" id="font-lock:26767">          // ... and iterate through them
</span><a href="#linum:678"><span class="linum" id="linum:678"> 678</span></a><span class="fringe" id="point:26809"> </span><span class="string" id="font-lock:26809">          for (var i = 0; i &lt; trs.length; i++)
</span><a href="#linum:679"><span class="linum" id="linum:679"> 679</span></a><span class="fringe" id="point:26856"> </span><span class="string" id="font-lock:26856">          {
</span><a href="#linum:680"><span class="linum" id="linum:680"> 680</span></a><span class="fringe" id="point:26868"> </span><span class="string" id="font-lock:26868">              // avoid rows that have a class attribute
</span><a href="#linum:681"><span class="linum" id="linum:681"> 681</span></a><span class="fringe" id="point:26924"> </span><span class="string" id="font-lock:26924">              // or backgroundColor style
</span><a href="#linum:682"><span class="linum" id="linum:682"> 682</span></a><span class="fringe" id="point:26966"> </span><span class="string" id="font-lock:26966">              if (! hasClass(trs[i]) &amp;&amp;
</span><a href="#linum:683"><span class="linum" id="linum:683"> 683</span></a><span class="fringe" id="point:27006"> </span><span class="string" id="font-lock:27006">                  ! trs[i].style.backgroundColor)
</span><a href="#linum:684"><span class="linum" id="linum:684"> 684</span></a><span class="fringe" id="point:27056"> </span><span class="string" id="font-lock:27056">              {
</span><a href="#linum:685"><span class="linum" id="linum:685"> 685</span></a><span class="fringe" id="point:27072"> </span><span class="string" id="font-lock:27072">                  // get all the cells in this row...
</span><a href="#linum:686"><span class="linum" id="linum:686"> 686</span></a><span class="fringe" id="point:27126"> </span><span class="string" id="font-lock:27126">                  var tds = trs[i].getElementsByTagName(\"td\");
</span><a href="#linum:687"><span class="linum" id="linum:687"> 687</span></a><span class="fringe" id="point:27191"> </span><span class="string" id="font-lock:27191">
</span><a href="#linum:688"><span class="linum" id="linum:688"> 688</span></a><span class="fringe" id="point:27192"> </span><span class="string" id="font-lock:27192">                  // and iterate through them...
</span><a href="#linum:689"><span class="linum" id="linum:689"> 689</span></a><span class="fringe" id="point:27241"> </span><span class="string" id="font-lock:27241">                  for (var j = 0; j &lt; tds.length; j++)
</span><a href="#linum:690"><span class="linum" id="linum:690"> 690</span></a><span class="fringe" id="point:27296"> </span><span class="string" id="font-lock:27296">                  {
</span><a href="#linum:691"><span class="linum" id="linum:691"> 691</span></a><span class="fringe" id="point:27316"> </span><span class="string" id="font-lock:27316">                      var mytd = tds[j];
</span><a href="#linum:692"><span class="linum" id="linum:692"> 692</span></a><span class="fringe" id="point:27357"> </span><span class="string" id="font-lock:27357">
</span><a href="#linum:693"><span class="linum" id="linum:693"> 693</span></a><span class="fringe" id="point:27358"> </span><span class="string" id="font-lock:27358">                      // avoid cells that have a class attribute
</span><a href="#linum:694"><span class="linum" id="linum:694"> 694</span></a><span class="fringe" id="point:27423"> </span><span class="string" id="font-lock:27423">                      // or backgroundColor style
</span><a href="#linum:695"><span class="linum" id="linum:695"> 695</span></a><span class="fringe" id="point:27473"> </span><span class="string" id="font-lock:27473">                      if (! hasClass(mytd) &amp;&amp;
</span><a href="#linum:696"><span class="linum" id="linum:696"> 696</span></a><span class="fringe" id="point:27519"> </span><span class="string" id="font-lock:27519">                          ! mytd.style.backgroundColor)
</span><a href="#linum:697"><span class="linum" id="linum:697"> 697</span></a><span class="fringe" id="point:27575"> </span><span class="string" id="font-lock:27575">                      {
</span><a href="#linum:698"><span class="linum" id="linum:698"> 698</span></a><span class="fringe" id="point:27599"> </span><span class="string" id="font-lock:27599">                          mytd.style.backgroundColor =
</span><a href="#linum:699"><span class="linum" id="linum:699"> 699</span></a><span class="fringe" id="point:27654"> </span><span class="string" id="font-lock:27654">                            even ? evenColor : oddColor;
</span><a href="#linum:700"><span class="linum" id="linum:700"> 700</span></a><span class="fringe" id="point:27711"> </span><span class="string" id="font-lock:27711">                      }
</span><a href="#linum:701"><span class="linum" id="linum:701"> 701</span></a><span class="fringe" id="point:27735"> </span><span class="string" id="font-lock:27735">                  }
</span><a href="#linum:702"><span class="linum" id="linum:702"> 702</span></a><span class="fringe" id="point:27755"> </span><span class="string" id="font-lock:27755">              }
</span><a href="#linum:703"><span class="linum" id="linum:703"> 703</span></a><span class="fringe" id="point:27771"> </span><span class="string" id="font-lock:27771">              // flip from odd to even, or vice-versa
</span><a href="#linum:704"><span class="linum" id="linum:704"> 704</span></a><span class="fringe" id="point:27825"> </span><span class="string" id="font-lock:27825">              even =  ! even;
</span><a href="#linum:705"><span class="linum" id="linum:705"> 705</span></a><span class="fringe" id="point:27855"> </span><span class="string" id="font-lock:27855">          }
</span><a href="#linum:706"><span class="linum" id="linum:706"> 706</span></a><span class="fringe" id="point:27867"> </span><span class="string" id="font-lock:27867">      }
</span><a href="#linum:707"><span class="linum" id="linum:707"> 707</span></a><span class="fringe" id="point:27875"> </span><span class="string" id="font-lock:27875">  }
</span><a href="#linum:708"><span class="linum" id="linum:708"> 708</span></a><span class="fringe" id="point:27879"> </span><span class="string" id="font-lock:27879">
</span><a href="#linum:709"><span class="linum" id="linum:709"> 709</span></a><span class="fringe" id="point:27880"> </span><span class="string" id="font-lock:27880">  function toggle_invis( name )
</span><a href="#linum:710"><span class="linum" id="linum:710"> 710</span></a><span class="fringe" id="point:27912"> </span><span class="string" id="font-lock:27912">  {
</span><a href="#linum:711"><span class="linum" id="linum:711"> 711</span></a><span class="fringe" id="point:27916"> </span><span class="string" id="font-lock:27916">      var filter =
</span><a href="#linum:712"><span class="linum" id="linum:712"> 712</span></a><span class="fringe" id="point:27935"> </span><span class="string" id="font-lock:27935">        { acceptNode:
</span><a href="#linum:713"><span class="linum" id="linum:713"> 713</span></a><span class="fringe" id="point:27957"> </span><span class="string" id="font-lock:27957">          function( node )
</span><a href="#linum:714"><span class="linum" id="linum:714"> 714</span></a><span class="fringe" id="point:27984"> </span><span class="string" id="font-lock:27984">          { var classname = node.id;
</span><a href="#linum:715"><span class="linum" id="linum:715"> 715</span></a><span class="fringe" id="point:28021"> </span><span class="string" id="font-lock:28021">            if( classname )
</span><a href="#linum:716"><span class="linum" id="linum:716"> 716</span></a><span class="fringe" id="point:28049"> </span><span class="string" id="font-lock:28049">            { var classbase = classname.substr( 0, name.length );
</span><a href="#linum:717"><span class="linum" id="linum:717"> 717</span></a><span class="fringe" id="point:28115"> </span><span class="string" id="font-lock:28115">              if( classbase == name ) { return NodeFilter.FILTER_ACCEPT; } }
</span><a href="#linum:718"><span class="linum" id="linum:718"> 718</span></a><span class="fringe" id="point:28192"> </span><span class="string" id="font-lock:28192">            return NodeFilter.FILTER_SKIP; } };
</span><a href="#linum:719"><span class="linum" id="linum:719"> 719</span></a><span class="fringe" id="point:28240"> </span><span class="string" id="font-lock:28240">      var walker = document.createTreeWalker( document.body           ,
</span><a href="#linum:720"><span class="linum" id="linum:720"> 720</span></a><span class="fringe" id="point:28312"> </span><span class="string" id="font-lock:28312">                                              NodeFilter.SHOW_ELEMENT ,
</span><a href="#linum:721"><span class="linum" id="linum:721"> 721</span></a><span class="fringe" id="point:28384"> </span><span class="string" id="font-lock:28384">                                              filter                  ,
</span><a href="#linum:722"><span class="linum" id="linum:722"> 722</span></a><span class="fringe" id="point:28456"> </span><span class="string" id="font-lock:28456">                                              false                   );
</span><a href="#linum:723"><span class="linum" id="linum:723"> 723</span></a><span class="fringe" id="point:28529"> </span><span class="string" id="font-lock:28529">      while( walker.nextNode() )
</span><a href="#linum:724"><span class="linum" id="linum:724"> 724</span></a><span class="fringe" id="point:28562"> </span><span class="string" id="font-lock:28562">      {
</span><a href="#linum:725"><span class="linum" id="linum:725"> 725</span></a><span class="fringe" id="point:28570"> </span><span class="string" id="font-lock:28570">          var e = walker.currentNode;
</span><a href="#linum:726"><span class="linum" id="linum:726"> 726</span></a><span class="fringe" id="point:28608"> </span><span class="string" id="font-lock:28608">          if( e.style.display == \"none\" ) { e.style.display = \"inline\"; }
</span><a href="#linum:727"><span class="linum" id="linum:727"> 727</span></a><span class="fringe" id="point:28686"> </span><span class="string" id="font-lock:28686">          else                            { e.style.display = \"none\";   }
</span><a href="#linum:728"><span class="linum" id="linum:728"> 728</span></a><span class="fringe" id="point:28762"> </span><span class="string" id="font-lock:28762">      }
</span><a href="#linum:729"><span class="linum" id="linum:729"> 729</span></a><span class="fringe" id="point:28770"> </span><span class="string" id="font-lock:28770">  }
</span><a href="#linum:730"><span class="linum" id="linum:730"> 730</span></a><span class="fringe" id="point:28774"> </span><span class="string" id="font-lock:28774">--&gt; &lt;/script&gt;
</span><a href="#linum:731"><span class="linum" id="linum:731"> 731</span></a><span class="fringe" id="point:28788"> </span><span class="string" id="font-lock:28788">  &lt;/head&gt;
</span><a href="#linum:732"><span class="linum" id="linum:732"> 732</span></a><span class="fringe" id="point:28798"> </span><span class="string" id="font-lock:28798">  &lt;body onload=\"stripe('index'); return true;\"&gt;\n"</span>
<a href="#linum:733"><span class="linum" id="linum:733"> 733</span></a><span class="fringe" id="point:28851"> </span>          file style))
<a href="#linum:734"><span class="linum" id="linum:734"> 734</span></a><span class="fringe" id="point:28874"> </span>
<a href="#linum:735"><span class="linum" id="linum:735"> 735</span></a><span class="fringe" id="point:28875"> </span>(<span class="keyword" id="font-lock:28876">defun</span> <span class="function-name" id="font-lock:28882">hfy-default-footer</span> (file)
<a href="#linum:736"><span class="linum" id="linum:736"> 736</span></a><span class="fringe" id="point:28908"> </span>  <span class="doc" id="font-lock:28910">"Default value for `</span><span class="doc" id="font-lock:28930"><span class="constant" id="font-lock:28930">hfy-page-footer</span></span><span class="doc" id="font-lock:28945">'.
</span><a href="#linum:737"><span class="linum" id="linum:737"> 737</span></a><span class="fringe" id="point:28948"> </span><span class="doc" id="font-lock:28948">FILE is the name of the file being rendered, in case it is needed."</span>
<a href="#linum:738"><span class="linum" id="linum:738"> 738</span></a><span class="fringe" id="point:29016"> </span>  <span class="string" id="font-lock:29018">"\n &lt;/body&gt;\n&lt;/html&gt;\n"</span>)
<a href="#linum:739"><span class="linum" id="linum:739"> 739</span></a><span class="fringe" id="point:29043"> </span>
<a href="#linum:740"><span class="linum" id="linum:740"> 740</span></a><span class="fringe" id="point:29044"> </span>(<span class="keyword" id="font-lock:29045">defun</span> <span class="function-name" id="font-lock:29051">hfy-link-style-string</span> (style-string)
<a href="#linum:741"><span class="linum" id="linum:741"> 741</span></a><span class="fringe" id="point:29088"> </span>  <span class="doc" id="font-lock:29090">"Replace the end of a CSS style declaration STYLE-STRING with the contents
</span><a href="#linum:742"><span class="linum" id="linum:742"> 742</span></a><span class="fringe" id="point:29165"> </span><span class="doc" id="font-lock:29165">of the variable `</span><span class="doc" id="font-lock:29182"><span class="constant" id="font-lock:29182">hfy-src-doc-link-style</span></span><span class="doc" id="font-lock:29204">', removing text matching the regex
</span><a href="#linum:743"><span class="linum" id="linum:743"> 743</span></a><span class="fringe" id="point:29240"> </span><span class="doc" id="font-lock:29240">`</span><span class="doc" id="font-lock:29241"><span class="constant" id="font-lock:29241">hfy-src-doc-link-unstyle</span></span><span class="doc" id="font-lock:29265">' first, if necessary."</span>
<a href="#linum:744"><span class="linum" id="linum:744"> 744</span></a><span class="fringe" id="point:29289"> </span>  <span class="comment-delimiter" id="font-lock:29291">;;</span><span class="comment" id="font-lock:29293">(message "hfy-colour-vals");;DBUG
</span><a href="#linum:745"><span class="linum" id="linum:745"> 745</span></a><span class="fringe" id="point:29327"> </span>  (<span class="keyword" id="font-lock:29330">if</span> (string-match hfy-src-doc-link-unstyle style-string)
<a href="#linum:746"><span class="linum" id="linum:746"> 746</span></a><span class="fringe" id="point:29386"> </span>      (setq style-string (replace-match <span class="string" id="font-lock:29426">""</span> 'fixed-case 'literal style-string)))
<a href="#linum:747"><span class="linum" id="linum:747"> 747</span></a><span class="fringe" id="point:29466"> </span>  (<span class="keyword" id="font-lock:29469">if</span> (and (not (string-match hfy-src-doc-link-style style-string))
<a href="#linum:748"><span class="linum" id="linum:748"> 748</span></a><span class="fringe" id="point:29534"> </span>           (string-match <span class="string" id="font-lock:29559">"} *$"</span> style-string))
<a href="#linum:749"><span class="linum" id="linum:749"> 749</span></a><span class="fringe" id="point:29581"> </span>      (concat (replace-match hfy-src-doc-link-style
<a href="#linum:750"><span class="linum" id="linum:750"> 750</span></a><span class="fringe" id="point:29633"> </span>                             'fixed-case
<a href="#linum:751"><span class="linum" id="linum:751"> 751</span></a><span class="fringe" id="point:29674"> </span>                             'literal
<a href="#linum:752"><span class="linum" id="linum:752"> 752</span></a><span class="fringe" id="point:29712"> </span>                             style-string) <span class="string" id="font-lock:29755">" }"</span>) style-string))
<a href="#linum:753"><span class="linum" id="linum:753"> 753</span></a><span class="fringe" id="point:29776"> </span>
<a href="#linum:754"><span class="linum" id="linum:754"> 754</span></a><span class="fringe" id="point:29777"> </span><span class="comment-delimiter" id="font-lock:29777">;; </span><span class="comment" id="font-lock:29780">utility functions - cast emacs style specification values into their
</span><a href="#linum:755"><span class="linum" id="linum:755"> 755</span></a><span class="fringe" id="point:29849"> </span><span class="comment-delimiter" id="font-lock:29849">;; </span><span class="comment" id="font-lock:29852">css2 equivalents:
</span><a href="#linum:756"><span class="linum" id="linum:756"> 756</span></a><span class="fringe" id="point:29870"> </span>(<span class="keyword" id="font-lock:29871">defun</span> <span class="function-name" id="font-lock:29877">hfy-triplet</span> (colour)
<a href="#linum:757"><span class="linum" id="linum:757"> 757</span></a><span class="fringe" id="point:29898"> </span>  <span class="doc" id="font-lock:29900">"Takes a COLOUR name (string) and return a CSS rgb(R, G, B) triplet string.
</span><a href="#linum:758"><span class="linum" id="linum:758"> 758</span></a><span class="fringe" id="point:29976"> </span><span class="doc" id="font-lock:29976">Uses the definition of \"white\" to map the numbers to the 0-255 range, so
</span><a href="#linum:759"><span class="linum" id="linum:759"> 759</span></a><span class="fringe" id="point:30051"> </span><span class="doc" id="font-lock:30051">if you've redefined white, (esp. if you've redefined it to have a triplet
</span><a href="#linum:760"><span class="linum" id="linum:760"> 760</span></a><span class="fringe" id="point:30125"> </span><span class="doc" id="font-lock:30125">member lower than that of the color you are processing) strange things
</span><a href="#linum:761"><span class="linum" id="linum:761"> 761</span></a><span class="fringe" id="point:30196"> </span><span class="doc" id="font-lock:30196">may happen."</span>
<a href="#linum:762"><span class="linum" id="linum:762"> 762</span></a><span class="fringe" id="point:30209"> </span>  <span class="comment-delimiter" id="font-lock:30211">;;</span><span class="comment" id="font-lock:30213">(message "hfy-colour-vals");;DBUG
</span><a href="#linum:763"><span class="linum" id="linum:763"> 763</span></a><span class="fringe" id="point:30247"> </span>  (<span class="keyword" id="font-lock:30250">let</span> ((white (mapcar (<span class="keyword" id="font-lock:30271">lambda</span> (I) (float (1+ I))) (hfy-colour-vals <span class="string" id="font-lock:30315">"white"</span>)))
<a href="#linum:764"><span class="linum" id="linum:764"> 764</span></a><span class="fringe" id="point:30326"> </span>        (rgb16 (mapcar (<span class="keyword" id="font-lock:30350">lambda</span> (I) (float (1+ I))) (hfy-colour-vals  colour))))
<a href="#linum:765"><span class="linum" id="linum:765"> 765</span></a><span class="fringe" id="point:30406"> </span>    (<span class="keyword" id="font-lock:30411">if</span> rgb16
<a href="#linum:766"><span class="linum" id="linum:766"> 766</span></a><span class="fringe" id="point:30420"> </span>        <span class="comment-delimiter" id="font-lock:30428">;;</span><span class="comment" id="font-lock:30430">(apply 'format "rgb(%d, %d, %d)"
</span><a href="#linum:767"><span class="linum" id="linum:767"> 767</span></a><span class="fringe" id="point:30463"> </span>        <span class="comment-delimiter" id="font-lock:30471">;; </span><span class="comment" id="font-lock:30474">Use #rrggbb instead, it is smaller
</span><a href="#linum:768"><span class="linum" id="linum:768"> 768</span></a><span class="fringe" id="point:30509"> </span>        (apply 'format <span class="string" id="font-lock:30532">"#%02x%02x%02x"</span>
<a href="#linum:769"><span class="linum" id="linum:769"> 769</span></a><span class="fringe" id="point:30548"> </span>               (mapcar (<span class="keyword" id="font-lock:30572">lambda</span> (X)
<a href="#linum:770"><span class="linum" id="linum:770"> 770</span></a><span class="fringe" id="point:30583"> </span>                         (* (/ (nth X rgb16)
<a href="#linum:771"><span class="linum" id="linum:771"> 771</span></a><span class="fringe" id="point:30628"> </span>                               (nth X white)) 255))
<a href="#linum:772"><span class="linum" id="linum:772"> 772</span></a><span class="fringe" id="point:30680"> </span>                       '(0 1 2))))))
<a href="#linum:773"><span class="linum" id="linum:773"> 773</span></a><span class="fringe" id="point:30717"> </span>
<a href="#linum:774"><span class="linum" id="linum:774"> 774</span></a><span class="fringe" id="point:30718"> </span>(<span class="keyword" id="font-lock:30719">defun</span> <span class="function-name" id="font-lock:30725">hfy-family</span> (family) (list (cons <span class="string" id="font-lock:30757">"font-family"</span>  family)))
<a href="#linum:775"><span class="linum" id="linum:775"> 775</span></a><span class="fringe" id="point:30782"> </span>(<span class="keyword" id="font-lock:30783">defun</span> <span class="function-name" id="font-lock:30789">hfy-bgcol</span>  (colour) (list (cons <span class="string" id="font-lock:30821">"background"</span>   (hfy-triplet colour))))
<a href="#linum:776"><span class="linum" id="linum:776"> 776</span></a><span class="fringe" id="point:30860"> </span>(<span class="keyword" id="font-lock:30861">defun</span> <span class="function-name" id="font-lock:30867">hfy-colour</span> (colour) (list (cons <span class="string" id="font-lock:30899">"color"</span>        (hfy-triplet colour))))
<a href="#linum:777"><span class="linum" id="linum:777"> 777</span></a><span class="fringe" id="point:30938"> </span>(<span class="keyword" id="font-lock:30939">defun</span> <span class="function-name" id="font-lock:30945">hfy-width</span>  (width)  (list (cons <span class="string" id="font-lock:30977">"font-stretch"</span> (symbol-name  width))))
<a href="#linum:778"><span class="linum" id="linum:778"> 778</span></a><span class="fringe" id="point:31016"> </span>
<a href="#linum:779"><span class="linum" id="linum:779"> 779</span></a><span class="fringe" id="point:31017"> </span>(<span class="keyword" id="font-lock:31018">defcustom</span> <span class="variable-name" id="font-lock:31028">hfy-font-zoom</span> 1.05
<a href="#linum:780"><span class="linum" id="linum:780"> 780</span></a><span class="fringe" id="point:31047"> </span>  <span class="doc" id="font-lock:31049">"Font scaling from Emacs to HTML."</span>
<a href="#linum:781"><span class="linum" id="linum:781"> 781</span></a><span class="fringe" id="point:31084"> </span>  <span class="builtin" id="font-lock:31086">:type</span> 'float
<a href="#linum:782"><span class="linum" id="linum:782"> 782</span></a><span class="fringe" id="point:31099"> </span>  <span class="builtin" id="font-lock:31101">:group</span> 'htmlfontify)
<a href="#linum:783"><span class="linum" id="linum:783"> 783</span></a><span class="fringe" id="point:31122"> </span>
<a href="#linum:784"><span class="linum" id="linum:784"> 784</span></a><span class="fringe" id="point:31123"> </span>(<span class="keyword" id="font-lock:31124">defun</span> <span class="function-name" id="font-lock:31130">hfy-size</span> (height)
<a href="#linum:785"><span class="linum" id="linum:785"> 785</span></a><span class="fringe" id="point:31148"> </span>  <span class="doc" id="font-lock:31150">"Derive a CSS font-size specifier from an Emacs font :height attribute HEIGHT.
</span><a href="#linum:786"><span class="linum" id="linum:786"> 786</span></a><span class="fringe" id="point:31229"> </span><span class="doc" id="font-lock:31229">Does not cope with the case where height is a function to be applied to
</span><a href="#linum:787"><span class="linum" id="linum:787"> 787</span></a><span class="fringe" id="point:31301"> </span><span class="doc" id="font-lock:31301">the height of the underlying font."</span>
<a href="#linum:788"><span class="linum" id="linum:788"> 788</span></a><span class="fringe" id="point:31337"> </span>  (list
<a href="#linum:789"><span class="linum" id="linum:789"> 789</span></a><span class="fringe" id="point:31345"> </span>   (<span class="keyword" id="font-lock:31349">cond</span>
<a href="#linum:790"><span class="linum" id="linum:790"> 790</span></a><span class="fringe" id="point:31354"> </span>    <span class="comment-delimiter" id="font-lock:31358">;;</span><span class="comment" id="font-lock:31360">(t                 (cons "font-size" ": 1em"))
</span><a href="#linum:791"><span class="linum" id="linum:791"> 791</span></a><span class="fringe" id="point:31407"> </span>    ((floatp   height)
<a href="#linum:792"><span class="linum" id="linum:792"> 792</span></a><span class="fringe" id="point:31430"> </span>     (cons <span class="string" id="font-lock:31441">"font-size"</span> (format <span class="string" id="font-lock:31461">"%d%%"</span> (* (* hfy-font-zoom height) 100))))
<a href="#linum:793"><span class="linum" id="linum:793"> 793</span></a><span class="fringe" id="point:31504"> </span>    ((integerp height)
<a href="#linum:794"><span class="linum" id="linum:794"> 794</span></a><span class="fringe" id="point:31527"> </span>     (cons <span class="string" id="font-lock:31538">"font-size"</span> (format <span class="string" id="font-lock:31558">"%dpt"</span> (/ (* hfy-font-zoom height) 10 )))) )) )
<a href="#linum:795"><span class="linum" id="linum:795"> 795</span></a><span class="fringe" id="point:31606"> </span>
<a href="#linum:796"><span class="linum" id="linum:796"> 796</span></a><span class="fringe" id="point:31607"> </span>(<span class="keyword" id="font-lock:31608">defun</span> <span class="function-name" id="font-lock:31614">hfy-slant</span> (slant)
<a href="#linum:797"><span class="linum" id="linum:797"> 797</span></a><span class="fringe" id="point:31632"> </span>  <span class="doc" id="font-lock:31634">"Derive a font-style CSS specifier from the Emacs :slant attribute SLANT:
</span><a href="#linum:798"><span class="linum" id="linum:798"> 798</span></a><span class="fringe" id="point:31708"> </span><span class="doc" id="font-lock:31708">CSS does not define the reverse-* styles, so just maps those to the
</span><a href="#linum:799"><span class="linum" id="linum:799"> 799</span></a><span class="fringe" id="point:31776"> </span><span class="doc" id="font-lock:31776">regular specifiers."</span>
<a href="#linum:800"><span class="linum" id="linum:800"> 800</span></a><span class="fringe" id="point:31797"> </span>  (list (cons <span class="string" id="font-lock:31811">"font-style"</span>
<a href="#linum:801"><span class="linum" id="linum:801"> 801</span></a><span class="fringe" id="point:31824"> </span>              (or (cdr (assq slant '((italic          . <span class="string" id="font-lock:31880">"italic"</span>)
<a href="#linum:802"><span class="linum" id="linum:802"> 802</span></a><span class="fringe" id="point:31890"> </span>                                     (reverse-italic  . <span class="string" id="font-lock:31946">"italic"</span> )
<a href="#linum:803"><span class="linum" id="linum:803"> 803</span></a><span class="fringe" id="point:31957"> </span>                                     (oblique         . <span class="string" id="font-lock:32013">"oblique"</span>)
<a href="#linum:804"><span class="linum" id="linum:804"> 804</span></a><span class="fringe" id="point:32024"> </span>                                     (reverse-oblique . <span class="string" id="font-lock:32080">"oblique"</span>))))
<a href="#linum:805"><span class="linum" id="linum:805"> 805</span></a><span class="fringe" id="point:32094"> </span>                  <span class="string" id="font-lock:32112">"normal"</span>))))
<a href="#linum:806"><span class="linum" id="linum:806"> 806</span></a><span class="fringe" id="point:32125"> </span>
<a href="#linum:807"><span class="linum" id="linum:807"> 807</span></a><span class="fringe" id="point:32126"> </span>(<span class="keyword" id="font-lock:32127">defun</span> <span class="function-name" id="font-lock:32133">hfy-weight</span> (weight)
<a href="#linum:808"><span class="linum" id="linum:808"> 808</span></a><span class="fringe" id="point:32153"> </span>  <span class="doc" id="font-lock:32155">"Derive a font-weight CSS specifier from an Emacs weight spec symbol WEIGHT."</span>
<a href="#linum:809"><span class="linum" id="linum:809"> 809</span></a><span class="fringe" id="point:32233"> </span>  (list (cons <span class="string" id="font-lock:32247">"font-weight"</span> (cdr (assq weight '((ultra-bold  . <span class="string" id="font-lock:32296">"900"</span>)
<a href="#linum:810"><span class="linum" id="linum:810"> 810</span></a><span class="fringe" id="point:32303"> </span>                                                (extra-bold  . <span class="string" id="font-lock:32366">"800"</span>)
<a href="#linum:811"><span class="linum" id="linum:811"> 811</span></a><span class="fringe" id="point:32373"> </span>                                                (bold        . <span class="string" id="font-lock:32436">"700"</span>)
<a href="#linum:812"><span class="linum" id="linum:812"> 812</span></a><span class="fringe" id="point:32443"> </span>                                                (semi-bold   . <span class="string" id="font-lock:32506">"600"</span>)
<a href="#linum:813"><span class="linum" id="linum:813"> 813</span></a><span class="fringe" id="point:32513"> </span>                                                (normal      . <span class="string" id="font-lock:32576">"500"</span>)
<a href="#linum:814"><span class="linum" id="linum:814"> 814</span></a><span class="fringe" id="point:32583"> </span>                                                (semi-light  . <span class="string" id="font-lock:32646">"400"</span>)
<a href="#linum:815"><span class="linum" id="linum:815"> 815</span></a><span class="fringe" id="point:32653"> </span>                                                (light       . <span class="string" id="font-lock:32716">"300"</span>)
<a href="#linum:816"><span class="linum" id="linum:816"> 816</span></a><span class="fringe" id="point:32723"> </span>                                                (extra-light . <span class="string" id="font-lock:32786">"200"</span>)
<a href="#linum:817"><span class="linum" id="linum:817"> 817</span></a><span class="fringe" id="point:32793"> </span>                                                (ultra-light . <span class="string" id="font-lock:32856">"100"</span>)))))))
<a href="#linum:818"><span class="linum" id="linum:818"> 818</span></a><span class="fringe" id="point:32869"> </span>
<a href="#linum:819"><span class="linum" id="linum:819"> 819</span></a><span class="fringe" id="point:32870"> </span>(<span class="keyword" id="font-lock:32871">defun</span> <span class="function-name" id="font-lock:32877">hfy-box-to-border-assoc</span> (spec)
<a href="#linum:820"><span class="linum" id="linum:820"> 820</span></a><span class="fringe" id="point:32908"> </span>  (<span class="keyword" id="font-lock:32911">if</span> spec
<a href="#linum:821"><span class="linum" id="linum:821"> 821</span></a><span class="fringe" id="point:32919"> </span>      (<span class="keyword" id="font-lock:32926">let</span> ((tag (car  spec))
<a href="#linum:822"><span class="linum" id="linum:822"> 822</span></a><span class="fringe" id="point:32949"> </span>            (val (cadr spec)))
<a href="#linum:823"><span class="linum" id="linum:823"> 823</span></a><span class="fringe" id="point:32980"> </span>        (cons (<span class="keyword" id="font-lock:32995">case</span> tag
<a href="#linum:824"><span class="linum" id="linum:824"> 824</span></a><span class="fringe" id="point:33004"> </span>                (<span class="builtin" id="font-lock:33021">:color</span> (cons <span class="string" id="font-lock:33034">"colour"</span> val))
<a href="#linum:825"><span class="linum" id="linum:825"> 825</span></a><span class="fringe" id="point:33049"> </span>                (<span class="builtin" id="font-lock:33066">:width</span> (cons <span class="string" id="font-lock:33079">"width"</span>  val))
<a href="#linum:826"><span class="linum" id="linum:826"> 826</span></a><span class="fringe" id="point:33094"> </span>                (<span class="builtin" id="font-lock:33111">:style</span> (cons <span class="string" id="font-lock:33124">"style"</span>  val)))
<a href="#linum:827"><span class="linum" id="linum:827"> 827</span></a><span class="fringe" id="point:33140"> </span>              (hfy-box-to-border-assoc (cddr spec))))))
<a href="#linum:828"><span class="linum" id="linum:828"> 828</span></a><span class="fringe" id="point:33196"> </span>
<a href="#linum:829"><span class="linum" id="linum:829"> 829</span></a><span class="fringe" id="point:33197"> </span>(<span class="keyword" id="font-lock:33198">defun</span> <span class="function-name" id="font-lock:33204">hfy-box-to-style</span> (spec)
<a href="#linum:830"><span class="linum" id="linum:830"> 830</span></a><span class="fringe" id="point:33228"> </span>  (<span class="keyword" id="font-lock:33231">let*</span> ((css (hfy-box-to-border-assoc  spec))
<a href="#linum:831"><span class="linum" id="linum:831"> 831</span></a><span class="fringe" id="point:33275"> </span>         (col (cdr      (assoc <span class="string" id="font-lock:33306">"colour"</span> css)))
<a href="#linum:832"><span class="linum" id="linum:832"> 832</span></a><span class="fringe" id="point:33322"> </span>         (s   (cdr      (assoc <span class="string" id="font-lock:33353">"style"</span>  css))))
<a href="#linum:833"><span class="linum" id="linum:833"> 833</span></a><span class="fringe" id="point:33370"> </span>    (list
<a href="#linum:834"><span class="linum" id="linum:834"> 834</span></a><span class="fringe" id="point:33380"> </span>     (<span class="keyword" id="font-lock:33386">if</span> col (cons <span class="string" id="font-lock:33399">"border-color"</span> (cdr (assoc <span class="string" id="font-lock:33426">"colour"</span> css))))
<a href="#linum:835"><span class="linum" id="linum:835"> 835</span></a><span class="fringe" id="point:33443"> </span>     (cons <span class="string" id="font-lock:33454">"border-width"</span> (format <span class="string" id="font-lock:33477">"%dpx"</span> (or (cdr (assoc <span class="string" id="font-lock:33500">"width"</span> css)) 1)))
<a href="#linum:836"><span class="linum" id="linum:836"> 836</span></a><span class="fringe" id="point:33519"> </span>     (cons <span class="string" id="font-lock:33530">"border-style"</span> (<span class="keyword" id="font-lock:33546">case</span> s
<a href="#linum:837"><span class="linum" id="linum:837"> 837</span></a><span class="fringe" id="point:33553"> </span>                            (released-button <span class="string" id="font-lock:33598">"outset"</span>)
<a href="#linum:838"><span class="linum" id="linum:838"> 838</span></a><span class="fringe" id="point:33608"> </span>                            (pressed-button  <span class="string" id="font-lock:33653">"inset"</span> )
<a href="#linum:839"><span class="linum" id="linum:839"> 839</span></a><span class="fringe" id="point:33663"> </span>                            (t               <span class="string" id="font-lock:33708">"solid"</span> ))))))
<a href="#linum:840"><span class="linum" id="linum:840"> 840</span></a><span class="fringe" id="point:33723"> </span>
<a href="#linum:841"><span class="linum" id="linum:841"> 841</span></a><span class="fringe" id="point:33724"> </span>(<span class="keyword" id="font-lock:33725">defun</span> <span class="function-name" id="font-lock:33731">hfy-box</span> (box)
<a href="#linum:842"><span class="linum" id="linum:842"> 842</span></a><span class="fringe" id="point:33745"> </span>  <span class="doc" id="font-lock:33747">"Derive CSS border-* attributes from the Emacs :box attribute BOX."</span>
<a href="#linum:843"><span class="linum" id="linum:843"> 843</span></a><span class="fringe" id="point:33815"> </span>  (<span class="keyword" id="font-lock:33818">if</span> box
<a href="#linum:844"><span class="linum" id="linum:844"> 844</span></a><span class="fringe" id="point:33825"> </span>      (<span class="keyword" id="font-lock:33832">cond</span>
<a href="#linum:845"><span class="linum" id="linum:845"> 845</span></a><span class="fringe" id="point:33837"> </span>       ((integerp box) (list (cons <span class="string" id="font-lock:33872">"border-width"</span> (format <span class="string" id="font-lock:33895">"%dpx"</span>   box))))
<a href="#linum:846"><span class="linum" id="linum:846"> 846</span></a><span class="fringe" id="point:33912"> </span>       ((stringp  box) (list (cons <span class="string" id="font-lock:33947">"border"</span> (format <span class="string" id="font-lock:33964">"solid %s 1px"</span> box))))
<a href="#linum:847"><span class="linum" id="linum:847"> 847</span></a><span class="fringe" id="point:33987"> </span>       ((listp    box) (hfy-box-to-style box)                            ))) )
<a href="#linum:848"><span class="linum" id="linum:848"> 848</span></a><span class="fringe" id="point:34066"> </span>
<a href="#linum:849"><span class="linum" id="linum:849"> 849</span></a><span class="fringe" id="point:34067"> </span>(<span class="keyword" id="font-lock:34068">defun</span> <span class="function-name" id="font-lock:34074">hfy-decor</span> (tag val)
<a href="#linum:850"><span class="linum" id="linum:850"> 850</span></a><span class="fringe" id="point:34094"> </span>  <span class="doc" id="font-lock:34096">"Derive CSS text-decoration specifiers from various Emacs font attributes.
</span><a href="#linum:851"><span class="linum" id="linum:851"> 851</span></a><span class="fringe" id="point:34171"> </span><span class="doc" id="font-lock:34171">TAG is an Emacs font attribute key (eg :underline).
</span><a href="#linum:852"><span class="linum" id="linum:852"> 852</span></a><span class="fringe" id="point:34223"> </span><span class="doc" id="font-lock:34223">VAL is ignored."</span>
<a href="#linum:853"><span class="linum" id="linum:853"> 853</span></a><span class="fringe" id="point:34240"> </span>  (list
<a href="#linum:854"><span class="linum" id="linum:854"> 854</span></a><span class="fringe" id="point:34248"> </span>   <span class="comment-delimiter" id="font-lock:34251">;; </span><span class="comment" id="font-lock:34254">FIXME: Why not '("text-decoration" . "underline")?  --Stef
</span><a href="#linum:855"><span class="linum" id="linum:855"> 855</span></a><span class="fringe" id="point:34313"> </span>   (<span class="keyword" id="font-lock:34317">case</span> tag
<a href="#linum:856"><span class="linum" id="linum:856"> 856</span></a><span class="fringe" id="point:34326"> </span>     (<span class="builtin" id="font-lock:34332">:underline</span>      (cons <span class="string" id="font-lock:34354">"text-decoration"</span> <span class="string" id="font-lock:34372">"underline"</span>   ))
<a href="#linum:857"><span class="linum" id="linum:857"> 857</span></a><span class="fringe" id="point:34389"> </span>     (<span class="builtin" id="font-lock:34395">:overline</span>       (cons <span class="string" id="font-lock:34417">"text-decoration"</span> <span class="string" id="font-lock:34435">"overline"</span>    ))
<a href="#linum:858"><span class="linum" id="linum:858"> 858</span></a><span class="fringe" id="point:34452"> </span>     (<span class="builtin" id="font-lock:34458">:strike-through</span> (cons <span class="string" id="font-lock:34480">"text-decoration"</span> <span class="string" id="font-lock:34498">"line-through"</span>)))))
<a href="#linum:859"><span class="linum" id="linum:859"> 859</span></a><span class="fringe" id="point:34518"> </span>
<a href="#linum:860"><span class="linum" id="linum:860"> 860</span></a><span class="fringe" id="point:34519"> </span>(<span class="keyword" id="font-lock:34520">defun</span> <span class="function-name" id="font-lock:34526">hfy-invisible</span> (<span class="type" id="font-lock:34541">&amp;optional</span> val)
<a href="#linum:861"><span class="linum" id="linum:861"> 861</span></a><span class="fringe" id="point:34556"> </span>  <span class="doc" id="font-lock:34558">"This text should be invisible.
</span><a href="#linum:862"><span class="linum" id="linum:862"> 862</span></a><span class="fringe" id="point:34590"> </span><span class="doc" id="font-lock:34590">Do something in CSS to make that happen.
</span><a href="#linum:863"><span class="linum" id="linum:863"> 863</span></a><span class="fringe" id="point:34631"> </span><span class="doc" id="font-lock:34631">VAL is ignored here."</span>
<a href="#linum:864"><span class="linum" id="linum:864"> 864</span></a><span class="fringe" id="point:34653"> </span>  '((<span class="string" id="font-lock:34658">"display"</span> . <span class="string" id="font-lock:34670">"none"</span>)))
<a href="#linum:865"><span class="linum" id="linum:865"> 865</span></a><span class="fringe" id="point:34680"> </span>
<a href="#linum:866"><span class="linum" id="linum:866"> 866</span></a><span class="fringe" id="point:34681"> </span>(<span class="keyword" id="font-lock:34682">defun</span> <span class="function-name" id="font-lock:34688">hfy-combined-face-spec</span> (face)
<a href="#linum:867"><span class="linum" id="linum:867"> 867</span></a><span class="fringe" id="point:34718"> </span>  <span class="doc" id="font-lock:34720">"Return a `</span><span class="doc" id="font-lock:34731"><span class="constant" id="font-lock:34731">defface</span></span><span class="doc" id="font-lock:34738">' style alist of possible specifications for FACE.
</span><a href="#linum:868"><span class="linum" id="linum:868"> 868</span></a><span class="fringe" id="point:34789"> </span><span class="doc" id="font-lock:34789">Entries resulting from customization (`</span><span class="doc" id="font-lock:34828"><span class="constant" id="font-lock:34828">custom-set-faces</span></span><span class="doc" id="font-lock:34844">') will take
</span><a href="#linum:869"><span class="linum" id="linum:869"> 869</span></a><span class="fringe" id="point:34857"> </span><span class="doc" id="font-lock:34857">precedence."</span>
<a href="#linum:870"><span class="linum" id="linum:870"> 870</span></a><span class="fringe" id="point:34870"> </span>  (<span class="keyword" id="font-lock:34873">let</span> ((spec  nil))
<a href="#linum:871"><span class="linum" id="linum:871"> 871</span></a><span class="fringe" id="point:34891"> </span>    (setq spec (append (or (get face 'saved-face)        (list))
<a href="#linum:872"><span class="linum" id="linum:872"> 872</span></a><span class="fringe" id="point:34956"> </span>                       (or (get face 'face-defface-spec) (list))))
<a href="#linum:873"><span class="linum" id="linum:873"> 873</span></a><span class="fringe" id="point:35023"> </span>    (<span class="keyword" id="font-lock:35028">if</span> (and hfy-display-class hfy-default-face-def (eq face 'default))
<a href="#linum:874"><span class="linum" id="linum:874"> 874</span></a><span class="fringe" id="point:35095"> </span>        (setq spec (append hfy-default-face-def spec))) spec))
<a href="#linum:875"><span class="linum" id="linum:875"> 875</span></a><span class="fringe" id="point:35158"> </span>
<a href="#linum:876"><span class="linum" id="linum:876"> 876</span></a><span class="fringe" id="point:35159"> </span>(<span class="keyword" id="font-lock:35160">defun</span> <span class="function-name" id="font-lock:35166">hfy-face-attr-for-class</span> (face <span class="type" id="font-lock:35196">&amp;optional</span> class)
<a href="#linum:877"><span class="linum" id="linum:877"> 877</span></a><span class="fringe" id="point:35213"> </span>  <span class="doc" id="font-lock:35215">"Return the face attributes for FACE.
</span><a href="#linum:878"><span class="linum" id="linum:878"> 878</span></a><span class="fringe" id="point:35253"> </span><span class="doc" id="font-lock:35253">If CLASS is set, it must be a `</span><span class="doc" id="font-lock:35284"><span class="constant" id="font-lock:35284">defface</span></span><span class="doc" id="font-lock:35291">' alist key [see below],
</span><a href="#linum:879"><span class="linum" id="linum:879"> 879</span></a><span class="fringe" id="point:35316"> </span><span class="doc" id="font-lock:35316">in which case the first face specification returned by `</span><span class="doc" id="font-lock:35372"><span class="constant" id="font-lock:35372">hfy-combined-face-spec</span></span><span class="doc" id="font-lock:35394">'
</span><a href="#linum:880"><span class="linum" id="linum:880"> 880</span></a><span class="fringe" id="point:35396"> </span><span class="doc" id="font-lock:35396">which *doesn't* clash with CLASS is returned.\n
</span><a href="#linum:881"><span class="linum" id="linum:881"> 881</span></a><span class="fringe" id="point:35444"> </span><span class="doc" id="font-lock:35444">\(A specification with a class of t is considered to match any class you
</span><a href="#linum:882"><span class="linum" id="linum:882"> 882</span></a><span class="fringe" id="point:35517"> </span><span class="doc" id="font-lock:35517">specify - this matches Emacs' behavior when deciding on which face attributes
</span><a href="#linum:883"><span class="linum" id="linum:883"> 883</span></a><span class="fringe" id="point:35595"> </span><span class="doc" id="font-lock:35595">to use, to the best of my understanding).\n
</span><a href="#linum:884"><span class="linum" id="linum:884"> 884</span></a><span class="fringe" id="point:35639"> </span><span class="doc" id="font-lock:35639">If CLASS is nil, then you just get get whatever `</span><span class="doc" id="font-lock:35688"><span class="constant" id="font-lock:35688">face-attr-construct</span></span><span class="doc" id="font-lock:35707">' returns,
</span><a href="#linum:885"><span class="linum" id="linum:885"> 885</span></a><span class="fringe" id="point:35718"> </span><span class="doc" id="font-lock:35718">ie the current specification in effect for FACE.\n
</span><a href="#linum:886"><span class="linum" id="linum:886"> 886</span></a><span class="fringe" id="point:35769"> </span><span class="doc" id="font-lock:35769">*NOTE*: This function forces any face that is not 'default and which has
</span><a href="#linum:887"><span class="linum" id="linum:887"> 887</span></a><span class="fringe" id="point:35842"> </span><span class="doc" id="font-lock:35842">no :inherit property to inherit from 'default (this is because 'default
</span><a href="#linum:888"><span class="linum" id="linum:888"> 888</span></a><span class="fringe" id="point:35914"> </span><span class="doc" id="font-lock:35914">is magical in that Emacs' fonts behave as if they inherit implicitly from
</span><a href="#linum:889"><span class="linum" id="linum:889"> 889</span></a><span class="fringe" id="point:35988"> </span><span class="doc" id="font-lock:35988">'default, but no such behavior exists in HTML/CSS).\n
</span><a href="#linum:890"><span class="linum" id="linum:890"> 890</span></a><span class="fringe" id="point:36042"> </span><span class="doc" id="font-lock:36042">See also `</span><span class="doc" id="font-lock:36052"><span class="constant" id="font-lock:36052">hfy-display-class</span></span><span class="doc" id="font-lock:36069">' for details of valid values for CLASS."</span>
<a href="#linum:891"><span class="linum" id="linum:891"> 891</span></a><span class="fringe" id="point:36111"> </span>  (<span class="keyword" id="font-lock:36114">let</span> ((face-spec
<a href="#linum:892"><span class="linum" id="linum:892"> 892</span></a><span class="fringe" id="point:36130"> </span>         (<span class="keyword" id="font-lock:36140">if</span> class
<a href="#linum:893"><span class="linum" id="linum:893"> 893</span></a><span class="fringe" id="point:36149"> </span>             (<span class="keyword" id="font-lock:36163">let</span> ((face-props (hfy-combined-face-spec face))
<a href="#linum:894"><span class="linum" id="linum:894"> 894</span></a><span class="fringe" id="point:36211"> </span>                   (face-specn nil)
<a href="#linum:895"><span class="linum" id="linum:895"> 895</span></a><span class="fringe" id="point:36247"> </span>                   (face-class nil)
<a href="#linum:896"><span class="linum" id="linum:896"> 896</span></a><span class="fringe" id="point:36283"> </span>                   (face-attrs nil)
<a href="#linum:897"><span class="linum" id="linum:897"> 897</span></a><span class="fringe" id="point:36319"> </span>                   (face-score  -1)
<a href="#linum:898"><span class="linum" id="linum:898"> 898</span></a><span class="fringe" id="point:36355"> </span>                   (face-match nil))
<a href="#linum:899"><span class="linum" id="linum:899"> 899</span></a><span class="fringe" id="point:36392"> </span>               (<span class="keyword" id="font-lock:36408">while</span> face-props
<a href="#linum:900"><span class="linum" id="linum:900"> 900</span></a><span class="fringe" id="point:36425"> </span>                 (setq face-specn (car face-props)
<a href="#linum:901"><span class="linum" id="linum:901"> 901</span></a><span class="fringe" id="point:36476"> </span>                       face-class (car face-specn)
<a href="#linum:902"><span class="linum" id="linum:902"> 902</span></a><span class="fringe" id="point:36527"> </span>                       face-attrs (cdr face-specn)
<a href="#linum:903"><span class="linum" id="linum:903"> 903</span></a><span class="fringe" id="point:36578"> </span>                       face-props (cdr face-props))
<a href="#linum:904"><span class="linum" id="linum:904"> 904</span></a><span class="fringe" id="point:36630"> </span>                 <span class="comment-delimiter" id="font-lock:36647">;; </span><span class="comment" id="font-lock:36650">if the current element CEL of CLASS is t we match
</span><a href="#linum:905"><span class="linum" id="linum:905"> 905</span></a><span class="fringe" id="point:36700"> </span>                 <span class="comment-delimiter" id="font-lock:36717">;; </span><span class="comment" id="font-lock:36720">if the current face-class is t, we match
</span><a href="#linum:906"><span class="linum" id="linum:906"> 906</span></a><span class="fringe" id="point:36761"> </span>                 <span class="comment-delimiter" id="font-lock:36778">;; </span><span class="comment" id="font-lock:36781">if the cdr of CEL has a non-nil
</span><a href="#linum:907"><span class="linum" id="linum:907"> 907</span></a><span class="fringe" id="point:36813"> </span>                 <span class="comment-delimiter" id="font-lock:36830">;;   </span><span class="comment" id="font-lock:36835">intersection with the cdr of the first member of
</span><a href="#linum:908"><span class="linum" id="linum:908"> 908</span></a><span class="fringe" id="point:36884"> </span>                 <span class="comment-delimiter" id="font-lock:36901">;;   </span><span class="comment" id="font-lock:36906">the current face-class with the same car as CEL, we match
</span><a href="#linum:909"><span class="linum" id="linum:909"> 909</span></a><span class="fringe" id="point:36964"> </span>                 <span class="comment-delimiter" id="font-lock:36981">;; </span><span class="comment" id="font-lock:36984">if we actually clash, then we can't match
</span><a href="#linum:910"><span class="linum" id="linum:910"> 910</span></a><span class="fringe" id="point:37026"> </span>                 (<span class="keyword" id="font-lock:37044">let</span> ((cbuf class)
<a href="#linum:911"><span class="linum" id="linum:911"> 911</span></a><span class="fringe" id="point:37062"> </span>                       (cel    nil)
<a href="#linum:912"><span class="linum" id="linum:912"> 912</span></a><span class="fringe" id="point:37098"> </span>                       (key    nil)
<a href="#linum:913"><span class="linum" id="linum:913"> 913</span></a><span class="fringe" id="point:37134"> </span>                       (val    nil)
<a href="#linum:914"><span class="linum" id="linum:914"> 914</span></a><span class="fringe" id="point:37170"> </span>                       (x      nil)
<a href="#linum:915"><span class="linum" id="linum:915"> 915</span></a><span class="fringe" id="point:37206"> </span>                       (next   nil)
<a href="#linum:916"><span class="linum" id="linum:916"> 916</span></a><span class="fringe" id="point:37242"> </span>                       (score    0))
<a href="#linum:917"><span class="linum" id="linum:917"> 917</span></a><span class="fringe" id="point:37279"> </span>                   (<span class="keyword" id="font-lock:37299">while</span> (and cbuf (not next))
<a href="#linum:918"><span class="linum" id="linum:918"> 918</span></a><span class="fringe" id="point:37327"> </span>                     (setq cel  (car cbuf)
<a href="#linum:919"><span class="linum" id="linum:919"> 919</span></a><span class="fringe" id="point:37370"> </span>                           cbuf (cdr cbuf)
<a href="#linum:920"><span class="linum" id="linum:920"> 920</span></a><span class="fringe" id="point:37413"> </span>                           key  (car  cel)
<a href="#linum:921"><span class="linum" id="linum:921"> 921</span></a><span class="fringe" id="point:37456"> </span>                           val  (cdr  cel)
<a href="#linum:922"><span class="linum" id="linum:922"> 922</span></a><span class="fringe" id="point:37499"> </span>                           val  (<span class="keyword" id="font-lock:37532">if</span> (listp val) val (list val)))
<a href="#linum:923"><span class="linum" id="linum:923"> 923</span></a><span class="fringe" id="point:37564"> </span>                     (<span class="keyword" id="font-lock:37586">cond</span>
<a href="#linum:924"><span class="linum" id="linum:924"> 924</span></a><span class="fringe" id="point:37591"> </span>                      ((or (eq cel t)
<a href="#linum:925"><span class="linum" id="linum:925"> 925</span></a><span class="fringe" id="point:37629"> </span>                           (memq face-class '(t default))) <span class="comment-delimiter" id="font-lock:37688">;</span><span class="comment" id="font-lock:37689">Default match.
</span><a href="#linum:926"><span class="linum" id="linum:926"> 926</span></a><span class="fringe" id="point:37704"> </span>                       (setq score 0) (ignore <span class="string" id="font-lock:37750">"t match"</span>))
<a href="#linum:927"><span class="linum" id="linum:927"> 927</span></a><span class="fringe" id="point:37762"> </span>                      ((not (cdr (assq key face-class))) <span class="comment-delimiter" id="font-lock:37819">;</span><span class="comment" id="font-lock:37820">Neither good nor bad.
</span><a href="#linum:928"><span class="linum" id="linum:928"> 928</span></a><span class="fringe" id="point:37842"> </span>                       nil (ignore <span class="string" id="font-lock:37877">"non match, non collision"</span>))
<a href="#linum:929"><span class="linum" id="linum:929"> 929</span></a><span class="fringe" id="point:37906"> </span>                      ((setq x (hfy-interq val (cdr (assq key face-class))))
<a href="#linum:930"><span class="linum" id="linum:930"> 930</span></a><span class="fringe" id="point:37983"> </span>                       (setq score (+ score (length x)))
<a href="#linum:931"><span class="linum" id="linum:931"> 931</span></a><span class="fringe" id="point:38040"> </span>                       (ignore <span class="string" id="font-lock:38071">"intersection"</span>))
<a href="#linum:932"><span class="linum" id="linum:932"> 932</span></a><span class="fringe" id="point:38088"> </span>                      (t <span class="comment-delimiter" id="font-lock:38113">;; </span><span class="comment" id="font-lock:38116">nope.
</span><a href="#linum:933"><span class="linum" id="linum:933"> 933</span></a><span class="fringe" id="point:38122"> </span>                       (setq next t score -10) (ignore <span class="string" id="font-lock:38177">"collision"</span>)) ))
<a href="#linum:934"><span class="linum" id="linum:934"> 934</span></a><span class="fringe" id="point:38194"> </span>                   (<span class="keyword" id="font-lock:38214">if</span> (&gt; score face-score)
<a href="#linum:935"><span class="linum" id="linum:935"> 935</span></a><span class="fringe" id="point:38238"> </span>                       (<span class="keyword" id="font-lock:38262">progn</span>
<a href="#linum:936"><span class="linum" id="linum:936"> 936</span></a><span class="fringe" id="point:38268"> </span>                         (setq face-match face-attrs
<a href="#linum:937"><span class="linum" id="linum:937"> 937</span></a><span class="fringe" id="point:38321"> </span>                               face-score score     )
<a href="#linum:938"><span class="linum" id="linum:938"> 938</span></a><span class="fringe" id="point:38375"> </span>                         (ignore <span class="string" id="font-lock:38408">"%d &lt;&lt; %S/%S"</span> score face-class class))
<a href="#linum:939"><span class="linum" id="linum:939"> 939</span></a><span class="fringe" id="point:38447"> </span>                     (ignore <span class="string" id="font-lock:38476">"--- %d ---- (insufficient)"</span> score)) ))
<a href="#linum:940"><span class="linum" id="linum:940"> 940</span></a><span class="fringe" id="point:38516"> </span>               <span class="comment-delimiter" id="font-lock:38531">;; </span><span class="comment" id="font-lock:38534">matched ? last attrs : nil
</span><a href="#linum:941"><span class="linum" id="linum:941"> 941</span></a><span class="fringe" id="point:38561"> </span>               (<span class="keyword" id="font-lock:38577">if</span> face-match
<a href="#linum:942"><span class="linum" id="linum:942"> 942</span></a><span class="fringe" id="point:38591"> </span>                   (<span class="keyword" id="font-lock:38611">if</span> (listp (car face-match)) (car face-match) face-match)
<a href="#linum:943"><span class="linum" id="linum:943"> 943</span></a><span class="fringe" id="point:38668"> </span>                 nil))
<a href="#linum:944"><span class="linum" id="linum:944"> 944</span></a><span class="fringe" id="point:38691"> </span>           <span class="comment-delimiter" id="font-lock:38702">;; </span><span class="comment" id="font-lock:38705">Unfortunately the default face returns a
</span><a href="#linum:945"><span class="linum" id="linum:945"> 945</span></a><span class="fringe" id="point:38746"> </span>           <span class="comment-delimiter" id="font-lock:38757">;; </span><span class="comment" id="font-lock:38760">:background. Fortunately we can remove it, but how do we do
</span><a href="#linum:946"><span class="linum" id="linum:946"> 946</span></a><span class="fringe" id="point:38820"> </span>           <span class="comment-delimiter" id="font-lock:38831">;; </span><span class="comment" id="font-lock:38834">that in a non-system specific way?
</span><a href="#linum:947"><span class="linum" id="linum:947"> 947</span></a><span class="fringe" id="point:38869"> </span>           (<span class="keyword" id="font-lock:38881">let</span> ((spec (face-attr-construct face))
<a href="#linum:948"><span class="linum" id="linum:948"> 948</span></a><span class="fringe" id="point:38920"> </span>                 (new-spec nil))
<a href="#linum:949"><span class="linum" id="linum:949"> 949</span></a><span class="fringe" id="point:38953"> </span>             (<span class="keyword" id="font-lock:38967">if</span> (not (memq <span class="builtin" id="font-lock:38981">:background</span> spec))
<a href="#linum:950"><span class="linum" id="linum:950"> 950</span></a><span class="fringe" id="point:39000"> </span>                 spec
<a href="#linum:951"><span class="linum" id="linum:951"> 951</span></a><span class="fringe" id="point:39022"> </span>               (<span class="keyword" id="font-lock:39038">while</span> spec
<a href="#linum:952"><span class="linum" id="linum:952"> 952</span></a><span class="fringe" id="point:39049"> </span>                 (<span class="keyword" id="font-lock:39067">let</span> ((a (nth 0 spec))
<a href="#linum:953"><span class="linum" id="linum:953"> 953</span></a><span class="fringe" id="point:39089"> </span>                       (b (nth 1 spec)))
<a href="#linum:954"><span class="linum" id="linum:954"> 954</span></a><span class="fringe" id="point:39130"> </span>                   (<span class="keyword" id="font-lock:39150">unless</span> (and (eq a <span class="builtin" id="font-lock:39168">:background</span>)
<a href="#linum:955"><span class="linum" id="linum:955"> 955</span></a><span class="fringe" id="point:39181"> </span>                                (stringp b)
<a href="#linum:956"><span class="linum" id="linum:956"> 956</span></a><span class="fringe" id="point:39225"> </span>                                (string= b <span class="string" id="font-lock:39268">"SystemWindow"</span>))
<a href="#linum:957"><span class="linum" id="linum:957"> 957</span></a><span class="fringe" id="point:39285"> </span>                     (setq new-spec (cons a (cons b new-spec)))))
<a href="#linum:958"><span class="linum" id="linum:958"> 958</span></a><span class="fringe" id="point:39351"> </span>                 (setq spec (cddr spec)))
<a href="#linum:959"><span class="linum" id="linum:959"> 959</span></a><span class="fringe" id="point:39393"> </span>               new-spec)))))
<a href="#linum:960"><span class="linum" id="linum:960"> 960</span></a><span class="fringe" id="point:39422"> </span>    (<span class="keyword" id="font-lock:39427">if</span> (or (memq <span class="builtin" id="font-lock:39440">:inherit</span> face-spec) (eq 'default face))
<a href="#linum:961"><span class="linum" id="linum:961"> 961</span></a><span class="fringe" id="point:39480"> </span>        face-spec
<a href="#linum:962"><span class="linum" id="linum:962"> 962</span></a><span class="fringe" id="point:39498"> </span>      (nconc face-spec (list <span class="builtin" id="font-lock:39527">:inherit</span> 'default))) ))
<a href="#linum:963"><span class="linum" id="linum:963"> 963</span></a><span class="fringe" id="point:39551"> </span>
<a href="#linum:964"><span class="linum" id="linum:964"> 964</span></a><span class="fringe" id="point:39552"> </span><span class="comment-delimiter" id="font-lock:39552">;; </span><span class="comment" id="font-lock:39555">construct an assoc of (css-tag-name . css-tag-value) pairs
</span><a href="#linum:965"><span class="linum" id="linum:965"> 965</span></a><span class="fringe" id="point:39614"> </span><span class="comment-delimiter" id="font-lock:39614">;; </span><span class="comment" id="font-lock:39617">from a face or assoc of face attributes:
</span><a href="#linum:966"><span class="linum" id="linum:966"> 966</span></a><span class="fringe" id="point:39658"> </span>
<a href="#linum:967"><span class="linum" id="linum:967"> 967</span></a><span class="fringe" id="point:39659"> </span><span class="comment-delimiter" id="font-lock:39659">;; </span><span class="comment" id="font-lock:39662">Some tests etc:
</span><a href="#linum:968"><span class="linum" id="linum:968"> 968</span></a><span class="fringe" id="point:39678"> </span><span class="comment-delimiter" id="font-lock:39678">;;  </span><span class="comment" id="font-lock:39682">(mumamo-message-with-face "testing face" 'highlight)
</span><a href="#linum:969"><span class="linum" id="linum:969"> 969</span></a><span class="fringe" id="point:39735"> </span><span class="comment-delimiter" id="font-lock:39735">;;  </span><span class="comment" id="font-lock:39739">(mumamo-message-with-face "testing face" '(:foreground "red" :background "yellow"))
</span><a href="#linum:970"><span class="linum" id="linum:970"> 970</span></a><span class="fringe" id="point:39823"> </span><span class="comment-delimiter" id="font-lock:39823">;;  </span><span class="comment" id="font-lock:39827">(hfy-face-to-style-i '(:inherit default foreground-color "red"))
</span><a href="#linum:971"><span class="linum" id="linum:971"> 971</span></a><span class="fringe" id="point:39892"> </span><span class="comment-delimiter" id="font-lock:39892">;;  </span><span class="comment" id="font-lock:39896">default face=(:stipple nil :background "SystemWindow" :foreground
</span><a href="#linum:972"><span class="linum" id="linum:972"> 972</span></a><span class="fringe" id="point:39962"> </span><span class="comment-delimiter" id="font-lock:39962">;;    </span><span class="comment" id="font-lock:39968">"SystemWindowText" :inverse-video nil :box nil :strike-through
</span><a href="#linum:973"><span class="linum" id="linum:973"> 973</span></a><span class="fringe" id="point:40031"> </span><span class="comment-delimiter" id="font-lock:40031">;;    </span><span class="comment" id="font-lock:40037">nil :overline nil :underline nil :slant normal :weight normal
</span><a href="#linum:974"><span class="linum" id="linum:974"> 974</span></a><span class="fringe" id="point:40099"> </span><span class="comment-delimiter" id="font-lock:40099">;;    </span><span class="comment" id="font-lock:40105">:height 98 :width normal :family "outline-courier new")
</span><a href="#linum:975"><span class="linum" id="linum:975"> 975</span></a><span class="fringe" id="point:40161"> </span>(<span class="keyword" id="font-lock:40162">defun</span> <span class="function-name" id="font-lock:40168">hfy-face-to-style-i</span> (fn)
<a href="#linum:976"><span class="linum" id="linum:976"> 976</span></a><span class="fringe" id="point:40193"> </span>  <span class="doc" id="font-lock:40195">"The guts of `</span><span class="doc" id="font-lock:40209"><span class="constant" id="font-lock:40209">hfy-face-to-style</span></span><span class="doc" id="font-lock:40226">': FN should be a `</span><span class="doc" id="font-lock:40245"><span class="constant" id="font-lock:40245">defface</span></span><span class="doc" id="font-lock:40252">' font spec,
</span><a href="#linum:977"><span class="linum" id="linum:977"> 977</span></a><span class="fringe" id="point:40265"> </span><span class="doc" id="font-lock:40265">as returned by `</span><span class="doc" id="font-lock:40281"><span class="constant" id="font-lock:40281">face-attr-construct</span></span><span class="doc" id="font-lock:40300">' or `</span><span class="doc" id="font-lock:40306"><span class="constant" id="font-lock:40306">hfy-face-attr-for-class</span></span><span class="doc" id="font-lock:40329">'.
</span><a href="#linum:978"><span class="linum" id="linum:978"> 978</span></a><span class="fringe" id="point:40332"> </span><span class="doc" id="font-lock:40332">Note that this function does not get font-sizes right if they are based
</span><a href="#linum:979"><span class="linum" id="linum:979"> 979</span></a><span class="fringe" id="point:40404"> </span><span class="doc" id="font-lock:40404">on inherited modifiers (via the :inherit) attribute, and any other
</span><a href="#linum:980"><span class="linum" id="linum:980"> 980</span></a><span class="fringe" id="point:40471"> </span><span class="doc" id="font-lock:40471">modifiers that are cumulative if they appear multiple times need to be
</span><a href="#linum:981"><span class="linum" id="linum:981"> 981</span></a><span class="fringe" id="point:40542"> </span><span class="doc" id="font-lock:40542">merged by the user - `</span><span class="doc" id="font-lock:40564"><span class="constant" id="font-lock:40564">hfy-flatten-style</span></span><span class="doc" id="font-lock:40581">' should do this."</span>
<a href="#linum:982"><span class="linum" id="linum:982"> 982</span></a><span class="fringe" id="point:40600"> </span>  <span class="comment-delimiter" id="font-lock:40602">;;</span><span class="comment" id="font-lock:40604">(message "hfy-face-to-style-i");;DBUG
</span><a href="#linum:983"><span class="linum" id="linum:983"> 983</span></a><span class="fringe" id="point:40642"> </span>
<a href="#linum:984"><span class="linum" id="linum:984"> 984</span></a><span class="fringe" id="point:40643"> </span>  <span class="comment-delimiter" id="font-lock:40645">;; </span><span class="comment" id="font-lock:40648">fn's value could be something like
</span><a href="#linum:985"><span class="linum" id="linum:985"> 985</span></a><span class="fringe" id="point:40683"> </span>  <span class="comment-delimiter" id="font-lock:40685">;; </span><span class="comment" id="font-lock:40688">(:inherit
</span><a href="#linum:986"><span class="linum" id="linum:986"> 986</span></a><span class="fringe" id="point:40698"> </span>  <span class="comment-delimiter" id="font-lock:40700">;;  </span><span class="comment" id="font-lock:40704">((foreground-color . "blue"))
</span><a href="#linum:987"><span class="linum" id="linum:987"> 987</span></a><span class="fringe" id="point:40734"> </span>  <span class="comment-delimiter" id="font-lock:40736">;;  </span><span class="comment" id="font-lock:40740">(foreground-color . "blue")
</span><a href="#linum:988"><span class="linum" id="linum:988"> 988</span></a><span class="fringe" id="point:40768"> </span>  <span class="comment-delimiter" id="font-lock:40770">;;  </span><span class="comment" id="font-lock:40774">nil)
</span><a href="#linum:989"><span class="linum" id="linum:989"> 989</span></a><span class="fringe" id="point:40779"> </span>
<a href="#linum:990"><span class="linum" id="linum:990"> 990</span></a><span class="fringe" id="point:40780"> </span>  (<span class="keyword" id="font-lock:40783">when</span> fn
<a href="#linum:991"><span class="linum" id="linum:991"> 991</span></a><span class="fringe" id="point:40791"> </span>    (<span class="keyword" id="font-lock:40796">let</span> ((key  (car  fn))
<a href="#linum:992"><span class="linum" id="linum:992"> 992</span></a><span class="fringe" id="point:40818"> </span>          (val  (cadr fn))
<a href="#linum:993"><span class="linum" id="linum:993"> 993</span></a><span class="fringe" id="point:40845"> </span>          (next (cddr fn))
<a href="#linum:994"><span class="linum" id="linum:994"> 994</span></a><span class="fringe" id="point:40872"> </span>          (that       nil)
<a href="#linum:995"><span class="linum" id="linum:995"> 995</span></a><span class="fringe" id="point:40899"> </span>          (this       nil)
<a href="#linum:996"><span class="linum" id="linum:996"> 996</span></a><span class="fringe" id="point:40926"> </span>          (parent     nil))
<a href="#linum:997"><span class="linum" id="linum:997"> 997</span></a><span class="fringe" id="point:40954"> </span>      (<span class="keyword" id="font-lock:40961">if</span> (eq key <span class="builtin" id="font-lock:40972">:inherit</span>)
<a href="#linum:998"><span class="linum" id="linum:998"> 998</span></a><span class="fringe" id="point:40982"> </span>        (<span class="keyword" id="font-lock:40991">let</span> ((vs (<span class="keyword" id="font-lock:41001">if</span> (listp val) val (list val))))
<a href="#linum:999"><span class="linum" id="linum:999"> 999</span></a><span class="fringe" id="point:41034"> </span>          <span class="comment-delimiter" id="font-lock:41044">;; </span><span class="comment" id="font-lock:41047">(let ((x '(a b))) (setq x (append '(c d) x)))
</span><a href="#linum:1000"><span class="linum" id="linum:1000">1000</span></a><span class="fringe" id="point:41093"> </span>          <span class="comment-delimiter" id="font-lock:41103">;; </span><span class="comment" id="font-lock:41106">(let ((x '(a b))) (setq x (append '(c d) x)))
</span><a href="#linum:1001"><span class="linum" id="linum:1001">1001</span></a><span class="fringe" id="point:41152"> </span>          (<span class="keyword" id="font-lock:41163">dolist</span> (v vs)
<a href="#linum:1002"><span class="linum" id="linum:1002">1002</span></a><span class="fringe" id="point:41177"> </span>            (setq parent
<a href="#linum:1003"><span class="linum" id="linum:1003">1003</span></a><span class="fringe" id="point:41202"> </span>                  (append
<a href="#linum:1004"><span class="linum" id="linum:1004">1004</span></a><span class="fringe" id="point:41228"> </span>                   parent
<a href="#linum:1005"><span class="linum" id="linum:1005">1005</span></a><span class="fringe" id="point:41254"> </span>                   (hfy-face-to-style-i
<a href="#linum:1006"><span class="linum" id="linum:1006">1006</span></a><span class="fringe" id="point:41294"> </span>                    (hfy-face-attr-for-class v hfy-display-class)) ))))
<a href="#linum:1007"><span class="linum" id="linum:1007">1007</span></a><span class="fringe" id="point:41366"> </span>        (setq this
<a href="#linum:1008"><span class="linum" id="linum:1008">1008</span></a><span class="fringe" id="point:41385"> </span>              (<span class="keyword" id="font-lock:41400">if</span> val (<span class="keyword" id="font-lock:41408">case</span> key
<a href="#linum:1009"><span class="linum" id="linum:1009">1009</span></a><span class="fringe" id="point:41417"> </span>                       (<span class="builtin" id="font-lock:41441">:family</span>         (hfy-family    val))
<a href="#linum:1010"><span class="linum" id="linum:1010">1010</span></a><span class="fringe" id="point:41478"> </span>                       (<span class="builtin" id="font-lock:41502">:width</span>          (hfy-width     val))
<a href="#linum:1011"><span class="linum" id="linum:1011">1011</span></a><span class="fringe" id="point:41539"> </span>                       (<span class="builtin" id="font-lock:41563">:weight</span>         (hfy-weight    val))
<a href="#linum:1012"><span class="linum" id="linum:1012">1012</span></a><span class="fringe" id="point:41600"> </span>                       (<span class="builtin" id="font-lock:41624">:slant</span>          (hfy-slant     val))
<a href="#linum:1013"><span class="linum" id="linum:1013">1013</span></a><span class="fringe" id="point:41661"> </span>                       (<span class="builtin" id="font-lock:41685">:foreground</span>     (hfy-colour    val))
<a href="#linum:1014"><span class="linum" id="linum:1014">1014</span></a><span class="fringe" id="point:41722"> </span>                       (<span class="builtin" id="font-lock:41746">:background</span>     (hfy-bgcol     val))
<a href="#linum:1015"><span class="linum" id="linum:1015">1015</span></a><span class="fringe" id="point:41783"> </span>                       (<span class="builtin" id="font-lock:41807">:box</span>            (hfy-box       val))
<a href="#linum:1016"><span class="linum" id="linum:1016">1016</span></a><span class="fringe" id="point:41844"> </span>                       (<span class="builtin" id="font-lock:41868">:height</span>         (hfy-size      val))
<a href="#linum:1017"><span class="linum" id="linum:1017">1017</span></a><span class="fringe" id="point:41905"> </span>                       (<span class="builtin" id="font-lock:41929">:underline</span>      (hfy-decor key val))
<a href="#linum:1018"><span class="linum" id="linum:1018">1018</span></a><span class="fringe" id="point:41966"> </span>                       (<span class="builtin" id="font-lock:41990">:overline</span>       (hfy-decor key val))
<a href="#linum:1019"><span class="linum" id="linum:1019">1019</span></a><span class="fringe" id="point:42027"> </span>                       (<span class="builtin" id="font-lock:42051">:strike-through</span> (hfy-decor key val))
<a href="#linum:1020"><span class="linum" id="linum:1020">1020</span></a><span class="fringe" id="point:42088"> </span>                       (<span class="builtin" id="font-lock:42112">:invisible</span>      (hfy-invisible val))
<a href="#linum:1021"><span class="linum" id="linum:1021">1021</span></a><span class="fringe" id="point:42149"> </span>                       (<span class="builtin" id="font-lock:42173">:bold</span>           (hfy-weight  'bold))
<a href="#linum:1022"><span class="linum" id="linum:1022">1022</span></a><span class="fringe" id="point:42210"> </span>                       (<span class="builtin" id="font-lock:42234">:italic</span>         (hfy-slant 'italic))))))
<a href="#linum:1023"><span class="linum" id="linum:1023">1023</span></a><span class="fringe" id="point:42275"> </span>      (setq that (hfy-face-to-style-i next))
<a href="#linum:1024"><span class="linum" id="linum:1024">1024</span></a><span class="fringe" id="point:42320"> </span>      <span class="comment-delimiter" id="font-lock:42326">;;</span><span class="comment" id="font-lock:42328">(lwarn t :warning "%S =&gt; %S" fn (nconc this that parent))
</span><a href="#linum:1025"><span class="linum" id="linum:1025">1025</span></a><span class="fringe" id="point:42386"> </span>      (nconc this that parent))) )
<a href="#linum:1026"><span class="linum" id="linum:1026">1026</span></a><span class="fringe" id="point:42421"> </span>
<a href="#linum:1027"><span class="linum" id="linum:1027">1027</span></a><span class="fringe" id="point:42422"> </span>(<span class="keyword" id="font-lock:42423">defun</span> <span class="function-name" id="font-lock:42429">hfy-size-to-int</span> (spec)
<a href="#linum:1028"><span class="linum" id="linum:1028">1028</span></a><span class="fringe" id="point:42452"> </span>  <span class="doc" id="font-lock:42454">"Convert SPEC, a CSS font-size specifier, to an Emacs :height attribute value.
</span><a href="#linum:1029"><span class="linum" id="linum:1029">1029</span></a><span class="fringe" id="point:42533"> </span><span class="doc" id="font-lock:42533">Used while merging multiple font-size attributes."</span>
<a href="#linum:1030"><span class="linum" id="linum:1030">1030</span></a><span class="fringe" id="point:42584"> </span>  <span class="comment-delimiter" id="font-lock:42586">;;</span><span class="comment" id="font-lock:42588">(message "hfy-size-to-int");;DBUG
</span><a href="#linum:1031"><span class="linum" id="linum:1031">1031</span></a><span class="fringe" id="point:42622"> </span>  (list
<a href="#linum:1032"><span class="linum" id="linum:1032">1032</span></a><span class="fringe" id="point:42630"> </span>   (<span class="keyword" id="font-lock:42634">if</span> (string-match <span class="string" id="font-lock:42651">"</span><span class="string" id="font-lock:42652"><span class="regexp-grouping-backslash" id="font-lock:42652">\\</span></span><span class="string" id="font-lock:42654"><span class="regexp-grouping-construct" id="font-lock:42654">(</span></span><span class="string" id="font-lock:42655">[0-9]+</span><span class="string" id="font-lock:42661"><span class="regexp-grouping-backslash" id="font-lock:42661">\\</span></span><span class="string" id="font-lock:42663"><span class="regexp-grouping-construct" id="font-lock:42663">)</span></span><span class="string" id="font-lock:42664"><span class="regexp-grouping-backslash" id="font-lock:42664">\\</span></span><span class="string" id="font-lock:42666"><span class="regexp-grouping-construct" id="font-lock:42666">(</span></span><span class="string" id="font-lock:42667">%</span><span class="string" id="font-lock:42668"><span class="regexp-grouping-backslash" id="font-lock:42668">\\</span></span><span class="string" id="font-lock:42670"><span class="regexp-grouping-construct" id="font-lock:42670">|</span></span><span class="string" id="font-lock:42671">pt</span><span class="string" id="font-lock:42673"><span class="regexp-grouping-backslash" id="font-lock:42673">\\</span></span><span class="string" id="font-lock:42675"><span class="regexp-grouping-construct" id="font-lock:42675">)</span></span><span class="string" id="font-lock:42676">"</span> spec)
<a href="#linum:1033"><span class="linum" id="linum:1033">1033</span></a><span class="fringe" id="point:42684"> </span>       (<span class="keyword" id="font-lock:42692">cond</span> ((string= <span class="string" id="font-lock:42707">"%"</span>  (match-string 2 spec))
<a href="#linum:1034"><span class="linum" id="linum:1034">1034</span></a><span class="fringe" id="point:42735"> </span>              (/ (string-to-number (match-string 1 spec)) 100.0))
<a href="#linum:1035"><span class="linum" id="linum:1035">1035</span></a><span class="fringe" id="point:42801"> </span>             ((string= <span class="string" id="font-lock:42824">"pt"</span> (match-string 2 spec))
<a href="#linum:1036"><span class="linum" id="linum:1036">1036</span></a><span class="fringe" id="point:42852"> </span>              (* (string-to-number (match-string 1 spec))    10)))
<a href="#linum:1037"><span class="linum" id="linum:1037">1037</span></a><span class="fringe" id="point:42919"> </span>     (string-to-number spec))) )
<a href="#linum:1038"><span class="linum" id="linum:1038">1038</span></a><span class="fringe" id="point:42952"> </span>
<a href="#linum:1039"><span class="linum" id="linum:1039">1039</span></a><span class="fringe" id="point:42953"> </span><span class="comment-delimiter" id="font-lock:42953">;; </span><span class="comment" id="font-lock:42956">size is different, in that in order to get it right at all,
</span><a href="#linum:1040"><span class="linum" id="linum:1040">1040</span></a><span class="fringe" id="point:43016"> </span><span class="comment-delimiter" id="font-lock:43016">;; </span><span class="comment" id="font-lock:43019">we have to trawl the inheritance path, accumulating modifiers,
</span><a href="#linum:1041"><span class="linum" id="linum:1041">1041</span></a><span class="fringe" id="point:43082"> </span><span class="comment-delimiter" id="font-lock:43082">;; </span><span class="comment" id="font-lock:43085">_until_ we get to an absolute (pt) specifier, then combine the lot
</span><a href="#linum:1042"><span class="linum" id="linum:1042">1042</span></a><span class="fringe" id="point:43152"> </span>(<span class="keyword" id="font-lock:43153">defun</span> <span class="function-name" id="font-lock:43159">hfy-flatten-style</span> (style)
<a href="#linum:1043"><span class="linum" id="linum:1043">1043</span></a><span class="fringe" id="point:43185"> </span>  <span class="doc" id="font-lock:43187">"Take STYLE (see `</span><span class="doc" id="font-lock:43205"><span class="constant" id="font-lock:43205">hfy-face-to-style-i</span></span><span class="doc" id="font-lock:43224">', `</span><span class="doc" id="font-lock:43228"><span class="constant" id="font-lock:43228">hfy-face-to-style</span></span><span class="doc" id="font-lock:43245">') and merge
</span><a href="#linum:1044"><span class="linum" id="linum:1044">1044</span></a><span class="fringe" id="point:43258"> </span><span class="doc" id="font-lock:43258">any multiple attributes appropriately.  Currently only font-size is merged
</span><a href="#linum:1045"><span class="linum" id="linum:1045">1045</span></a><span class="fringe" id="point:43333"> </span><span class="doc" id="font-lock:43333">down to a single occurrence - others may need special handling, but I
</span><a href="#linum:1046"><span class="linum" id="linum:1046">1046</span></a><span class="fringe" id="point:43403"> </span><span class="doc" id="font-lock:43403">haven't encountered them yet.  Returns a `</span><span class="doc" id="font-lock:43445"><span class="constant" id="font-lock:43445">hfy-style-assoc</span></span><span class="doc" id="font-lock:43460">'."</span>
<a href="#linum:1047"><span class="linum" id="linum:1047">1047</span></a><span class="fringe" id="point:43464"> </span>  <span class="comment-delimiter" id="font-lock:43466">;;</span><span class="comment" id="font-lock:43468">(message "(hfy-flatten-style %S)" style) ;;DBUG
</span><a href="#linum:1048"><span class="linum" id="linum:1048">1048</span></a><span class="fringe" id="point:43516"> </span>  (<span class="keyword" id="font-lock:43519">let</span> ((n        0)
<a href="#linum:1049"><span class="linum" id="linum:1049">1049</span></a><span class="fringe" id="point:43537"> </span>        (m (list 1))
<a href="#linum:1050"><span class="linum" id="linum:1050">1050</span></a><span class="fringe" id="point:43558"> </span>        (x      nil)
<a href="#linum:1051"><span class="linum" id="linum:1051">1051</span></a><span class="fringe" id="point:43579"> </span>        (r      nil))
<a href="#linum:1052"><span class="linum" id="linum:1052">1052</span></a><span class="fringe" id="point:43601"> </span>    (<span class="keyword" id="font-lock:43606">dolist</span> (css style)
<a href="#linum:1053"><span class="linum" id="linum:1053">1053</span></a><span class="fringe" id="point:43625"> </span>      (<span class="keyword" id="font-lock:43632">if</span> (string= (car css) <span class="string" id="font-lock:43654">"font-size"</span>)
<a href="#linum:1054"><span class="linum" id="linum:1054">1054</span></a><span class="fringe" id="point:43667"> </span>          (<span class="keyword" id="font-lock:43678">progn</span>
<a href="#linum:1055"><span class="linum" id="linum:1055">1055</span></a><span class="fringe" id="point:43684"> </span>            (<span class="keyword" id="font-lock:43697">when</span> (not x) (setq m (nconc m (hfy-size-to-int (cdr css)))))
<a href="#linum:1056"><span class="linum" id="linum:1056">1056</span></a><span class="fringe" id="point:43758"> </span>            (<span class="keyword" id="font-lock:43771">when</span> (string-match <span class="string" id="font-lock:43790">"pt"</span> (cdr css)) (setq x t)))
<a href="#linum:1057"><span class="linum" id="linum:1057">1057</span></a><span class="fringe" id="point:43819"> </span>        (setq r (nconc r (list css)))))
<a href="#linum:1058"><span class="linum" id="linum:1058">1058</span></a><span class="fringe" id="point:43859"> </span>    <span class="comment-delimiter" id="font-lock:43863">;;</span><span class="comment" id="font-lock:43865">(message "r: %S" r)
</span><a href="#linum:1059"><span class="linum" id="linum:1059">1059</span></a><span class="fringe" id="point:43885"> </span>    (setq  n (apply '* m))
<a href="#linum:1060"><span class="linum" id="linum:1060">1060</span></a><span class="fringe" id="point:43912"> </span>    (nconc r (hfy-size (<span class="keyword" id="font-lock:43936">if</span> x (round n) (* n 1.0)))) ))
<a href="#linum:1061"><span class="linum" id="linum:1061">1061</span></a><span class="fringe" id="point:43967"> </span>
<a href="#linum:1062"><span class="linum" id="linum:1062">1062</span></a><span class="fringe" id="point:43968"> </span>(<span class="keyword" id="font-lock:43969">defun</span> <span class="function-name" id="font-lock:43975">hfy-face-to-style</span> (fn)
<a href="#linum:1063"><span class="linum" id="linum:1063">1063</span></a><span class="fringe" id="point:43998"> </span>  <span class="doc" id="font-lock:44000">"Take FN, a font or `</span><span class="doc" id="font-lock:44021"><span class="constant" id="font-lock:44021">defface</span></span><span class="doc" id="font-lock:44028">' style font specification,
</span><a href="#linum:1064"><span class="linum" id="linum:1064">1064</span></a><span class="fringe" id="point:44056"> </span><span class="doc" id="font-lock:44056">\(as returned by `</span><span class="doc" id="font-lock:44074"><span class="constant" id="font-lock:44074">face-attr-construct</span></span><span class="doc" id="font-lock:44093">' or `</span><span class="doc" id="font-lock:44099"><span class="constant" id="font-lock:44099">hfy-face-attr-for-class</span></span><span class="doc" id="font-lock:44122">')
</span><a href="#linum:1065"><span class="linum" id="linum:1065">1065</span></a><span class="fringe" id="point:44125"> </span><span class="doc" id="font-lock:44125">and return a `</span><span class="doc" id="font-lock:44139"><span class="constant" id="font-lock:44139">hfy-style-assoc</span></span><span class="doc" id="font-lock:44154">'.\n
</span><a href="#linum:1066"><span class="linum" id="linum:1066">1066</span></a><span class="fringe" id="point:44159"> </span><span class="doc" id="font-lock:44159">See also `</span><span class="doc" id="font-lock:44169"><span class="constant" id="font-lock:44169">hfy-face-to-style-i</span></span><span class="doc" id="font-lock:44188">', `</span><span class="doc" id="font-lock:44192"><span class="constant" id="font-lock:44192">hfy-flatten-style</span></span><span class="doc" id="font-lock:44209">'."</span>
<a href="#linum:1067"><span class="linum" id="linum:1067">1067</span></a><span class="fringe" id="point:44213"> </span>  <span class="comment-delimiter" id="font-lock:44215">;;</span><span class="comment" id="font-lock:44217">(message "hfy-face-to-style");;DBUG
</span><a href="#linum:1068"><span class="linum" id="linum:1068">1068</span></a><span class="fringe" id="point:44253"> </span>  (<span class="keyword" id="font-lock:44256">let</span> ((face-def (<span class="keyword" id="font-lock:44272">if</span> (facep fn)
<a href="#linum:1069"><span class="linum" id="linum:1069">1069</span></a><span class="fringe" id="point:44286"> </span>                      (hfy-face-attr-for-class fn hfy-display-class) fn))
<a href="#linum:1070"><span class="linum" id="linum:1070">1070</span></a><span class="fringe" id="point:44360"> </span>        (final-style nil))
<a href="#linum:1071"><span class="linum" id="linum:1071">1071</span></a><span class="fringe" id="point:44387"> </span>
<a href="#linum:1072"><span class="linum" id="linum:1072">1072</span></a><span class="fringe" id="point:44388"> </span>    (setq final-style (hfy-flatten-style (hfy-face-to-style-i face-def)))
<a href="#linum:1073"><span class="linum" id="linum:1073">1073</span></a><span class="fringe" id="point:44462"> </span>    <span class="comment-delimiter" id="font-lock:44466">;;</span><span class="comment" id="font-lock:44468">(message "%S" final-style)
</span><a href="#linum:1074"><span class="linum" id="linum:1074">1074</span></a><span class="fringe" id="point:44495"> </span>    (<span class="keyword" id="font-lock:44500">if</span> (not (assoc <span class="string" id="font-lock:44515">"text-decoration"</span> final-style))
<a href="#linum:1075"><span class="linum" id="linum:1075">1075</span></a><span class="fringe" id="point:44547"> </span>        (<span class="keyword" id="font-lock:44556">progn</span> (setq final-style
<a href="#linum:1076"><span class="linum" id="linum:1076">1076</span></a><span class="fringe" id="point:44580"> </span>                     <span class="comment-delimiter" id="font-lock:44601">;; </span><span class="comment" id="font-lock:44604">Fix-me: there is no need for this since
</span><a href="#linum:1077"><span class="linum" id="linum:1077">1077</span></a><span class="fringe" id="point:44644"> </span>                     <span class="comment-delimiter" id="font-lock:44665">;; </span><span class="comment" id="font-lock:44668">text-decoration is not inherited.
</span><a href="#linum:1078"><span class="linum" id="linum:1078">1078</span></a><span class="fringe" id="point:44702"> </span>                     <span class="comment-delimiter" id="font-lock:44723">;; </span><span class="comment" id="font-lock:44726">but it's not wrong and if this ever changes it will
</span><a href="#linum:1079"><span class="linum" id="linum:1079">1079</span></a><span class="fringe" id="point:44778"> </span>                     <span class="comment-delimiter" id="font-lock:44799">;; </span><span class="comment" id="font-lock:44802">be needed, so I think it's better to leave it in? -- v
</span><a href="#linum:1080"><span class="linum" id="linum:1080">1080</span></a><span class="fringe" id="point:44857"> </span>                     (nconc final-style '((<span class="string" id="font-lock:44900">"text-decoration"</span>.<span class="string" id="font-lock:44918">"none"</span>))))))
<a href="#linum:1081"><span class="linum" id="linum:1081">1081</span></a><span class="fringe" id="point:44931"> </span>    final-style))
<a href="#linum:1082"><span class="linum" id="linum:1082">1082</span></a><span class="fringe" id="point:44949"> </span>
<a href="#linum:1083"><span class="linum" id="linum:1083">1083</span></a><span class="fringe" id="point:44950"> </span><span class="comment-delimiter" id="font-lock:44950">;; </span><span class="comment" id="font-lock:44953">strip redundant bits from a name. Technically, this could result in
</span><a href="#linum:1084"><span class="linum" id="linum:1084">1084</span></a><span class="fringe" id="point:45021"> </span><span class="comment-delimiter" id="font-lock:45021">;; </span><span class="comment" id="font-lock:45024">a collision, but it is pretty unlikely - will fix later...
</span><a href="#linum:1085"><span class="linum" id="linum:1085">1085</span></a><span class="fringe" id="point:45083"> </span><span class="comment-delimiter" id="font-lock:45083">;; </span><span class="comment" id="font-lock:45086">also handle ephemeral fonts created by overlays, which don't actually
</span><a href="#linum:1086"><span class="linum" id="linum:1086">1086</span></a><span class="fringe" id="point:45156"> </span><span class="comment-delimiter" id="font-lock:45156">;; </span><span class="comment" id="font-lock:45159">have names:
</span><a href="#linum:1087"><span class="linum" id="linum:1087">1087</span></a><span class="fringe" id="point:45171"> </span>(<span class="keyword" id="font-lock:45172">defun</span> <span class="function-name" id="font-lock:45178">hfy-face-or-def-to-name</span> (fn)
<a href="#linum:1088"><span class="linum" id="linum:1088">1088</span></a><span class="fringe" id="point:45207"> </span>  <span class="doc" id="font-lock:45209">"Render a font symbol or `</span><span class="doc" id="font-lock:45235"><span class="constant" id="font-lock:45235">defface</span></span><span class="doc" id="font-lock:45242">' font spec FN into a name (string)."</span>
<a href="#linum:1089"><span class="linum" id="linum:1089">1089</span></a><span class="fringe" id="point:45280"> </span>  <span class="comment-delimiter" id="font-lock:45282">;;</span><span class="comment" id="font-lock:45284">(message "generating name for %s" fn)
</span><a href="#linum:1090"><span class="linum" id="linum:1090">1090</span></a><span class="fringe" id="point:45322"> </span>  (<span class="keyword" id="font-lock:45325">if</span> (not (listp fn))
<a href="#linum:1091"><span class="linum" id="linum:1091">1091</span></a><span class="fringe" id="point:45345"> </span>      (format <span class="string" id="font-lock:45359">"%s"</span> fn)
<a href="#linum:1092"><span class="linum" id="linum:1092">1092</span></a><span class="fringe" id="point:45368"> </span>    (<span class="keyword" id="font-lock:45373">let*</span> ((key   (format       <span class="string" id="font-lock:45400">"%s"</span>        fn))
<a href="#linum:1093"><span class="linum" id="linum:1093">1093</span></a><span class="fringe" id="point:45417"> </span>           (entry (assoc key hfy-tmpfont-stack))
<a href="#linum:1094"><span class="linum" id="linum:1094">1094</span></a><span class="fringe" id="point:45466"> </span>           (base  (cadr   (memq  <span class="builtin" id="font-lock:45499">:inherit</span>  fn)))
<a href="#linum:1095"><span class="linum" id="linum:1095">1095</span></a><span class="fringe" id="point:45515"> </span>           (tag   (cdr                   entry)))
<a href="#linum:1096"><span class="linum" id="linum:1096">1096</span></a><span class="fringe" id="point:45565"> </span>      <span class="comment-delimiter" id="font-lock:45571">;;</span><span class="comment" id="font-lock:45573">(message "checking for key &#171;%s&#187; in font stack [%d]"
</span><a href="#linum:1097"><span class="linum" id="linum:1097">1097</span></a><span class="fringe" id="point:45625"> </span>      <span class="comment-delimiter" id="font-lock:45631">;;         </span><span class="comment" id="font-lock:45642">key (if entry 1 0))
</span><a href="#linum:1098"><span class="linum" id="linum:1098">1098</span></a><span class="fringe" id="point:45662"> </span>      (<span class="keyword" id="font-lock:45669">if</span> entry nil <span class="comment-delimiter" id="font-lock:45682">;; </span><span class="comment" id="font-lock:45685">noop
</span><a href="#linum:1099"><span class="linum" id="linum:1099">1099</span></a><span class="fringe" id="point:45690"> </span>        (setq tag               (format <span class="string" id="font-lock:45730">"%04d"</span> (length hfy-tmpfont-stack))
<a href="#linum:1100"><span class="linum" id="linum:1100">1100</span></a><span class="fringe" id="point:45765"> </span>              entry             (cons key tag)
<a href="#linum:1101"><span class="linum" id="linum:1101">1101</span></a><span class="fringe" id="point:45812"> </span>              hfy-tmpfont-stack (cons entry hfy-tmpfont-stack)))
<a href="#linum:1102"><span class="linum" id="linum:1102">1102</span></a><span class="fringe" id="point:45877"> </span>      <span class="comment-delimiter" id="font-lock:45883">;;</span><span class="comment" id="font-lock:45885">(message "  -&gt; name: %s-%s" (or base 'default) tag)
</span><a href="#linum:1103"><span class="linum" id="linum:1103">1103</span></a><span class="fringe" id="point:45937"> </span>      (format <span class="string" id="font-lock:45951">"%s-%s"</span> (or base 'default) tag)) ))
<a href="#linum:1104"><span class="linum" id="linum:1104">1104</span></a><span class="fringe" id="point:45987"> </span>
<a href="#linum:1105"><span class="linum" id="linum:1105">1105</span></a><span class="fringe" id="point:45988"> </span>(<span class="keyword" id="font-lock:45989">defun</span> <span class="function-name" id="font-lock:45995">hfy-css-name</span> (fn)
<a href="#linum:1106"><span class="linum" id="linum:1106">1106</span></a><span class="fringe" id="point:46013"> </span>  <span class="doc" id="font-lock:46015">"Strip the boring bits from a font-name FN and return a CSS style name."</span>
<a href="#linum:1107"><span class="linum" id="linum:1107">1107</span></a><span class="fringe" id="point:46088"> </span>  <span class="comment-delimiter" id="font-lock:46090">;;</span><span class="comment" id="font-lock:46092">(message "hfy-css-name");;DBUG
</span><a href="#linum:1108"><span class="linum" id="linum:1108">1108</span></a><span class="fringe" id="point:46123"> </span>  (<span class="keyword" id="font-lock:46126">let</span> ((face-name (hfy-face-or-def-to-name fn)))
<a href="#linum:1109"><span class="linum" id="linum:1109">1109</span></a><span class="fringe" id="point:46173"> </span>    (<span class="keyword" id="font-lock:46178">if</span> (or (string-match <span class="string" id="font-lock:46199">"font-lock-</span><span class="string" id="font-lock:46210"><span class="regexp-grouping-backslash" id="font-lock:46210">\\</span></span><span class="string" id="font-lock:46212"><span class="regexp-grouping-construct" id="font-lock:46212">(</span></span><span class="string" id="font-lock:46213">.*</span><span class="string" id="font-lock:46215"><span class="regexp-grouping-backslash" id="font-lock:46215">\\</span></span><span class="string" id="font-lock:46217"><span class="regexp-grouping-construct" id="font-lock:46217">)</span></span><span class="string" id="font-lock:46218">"</span> face-name)
<a href="#linum:1110"><span class="linum" id="linum:1110">1110</span></a><span class="fringe" id="point:46231"> </span>            (string-match <span class="string" id="font-lock:46257">"cperl-</span><span class="string" id="font-lock:46264"><span class="regexp-grouping-backslash" id="font-lock:46264">\\</span></span><span class="string" id="font-lock:46266"><span class="regexp-grouping-construct" id="font-lock:46266">(</span></span><span class="string" id="font-lock:46267">.*</span><span class="string" id="font-lock:46269"><span class="regexp-grouping-backslash" id="font-lock:46269">\\</span></span><span class="string" id="font-lock:46271"><span class="regexp-grouping-construct" id="font-lock:46271">)</span></span><span class="string" id="font-lock:46272">"</span>     face-name)
<a href="#linum:1111"><span class="linum" id="linum:1111">1111</span></a><span class="fringe" id="point:46289"> </span>            (string-match <span class="string" id="font-lock:46315">"^[Ii]nfo-</span><span class="string" id="font-lock:46325"><span class="regexp-grouping-backslash" id="font-lock:46325">\\</span></span><span class="string" id="font-lock:46327"><span class="regexp-grouping-construct" id="font-lock:46327">(</span></span><span class="string" id="font-lock:46328">.*</span><span class="string" id="font-lock:46330"><span class="regexp-grouping-backslash" id="font-lock:46330">\\</span></span><span class="string" id="font-lock:46332"><span class="regexp-grouping-construct" id="font-lock:46332">)</span></span><span class="string" id="font-lock:46333">"</span>   face-name))
<a href="#linum:1112"><span class="linum" id="linum:1112">1112</span></a><span class="fringe" id="point:46349"> </span>        (<span class="keyword" id="font-lock:46358">progn</span>
<a href="#linum:1113"><span class="linum" id="linum:1113">1113</span></a><span class="fringe" id="point:46364"> </span>          (setq face-name (match-string 1 face-name))
<a href="#linum:1114"><span class="linum" id="linum:1114">1114</span></a><span class="fringe" id="point:46418"> </span>          (<span class="keyword" id="font-lock:46429">if</span> (string-match <span class="string" id="font-lock:46446">"</span><span class="string" id="font-lock:46447"><span class="regexp-grouping-backslash" id="font-lock:46447">\\</span></span><span class="string" id="font-lock:46449"><span class="regexp-grouping-construct" id="font-lock:46449">(</span></span><span class="string" id="font-lock:46450">.*</span><span class="string" id="font-lock:46452"><span class="regexp-grouping-backslash" id="font-lock:46452">\\</span></span><span class="string" id="font-lock:46454"><span class="regexp-grouping-construct" id="font-lock:46454">)</span></span><span class="string" id="font-lock:46455">-face$"</span> face-name)
<a href="#linum:1115"><span class="linum" id="linum:1115">1115</span></a><span class="fringe" id="point:46474"> </span>              (setq face-name (match-string 1 face-name))) face-name)
<a href="#linum:1116"><span class="linum" id="linum:1116">1116</span></a><span class="fringe" id="point:46544"> </span>      face-name)) )
<a href="#linum:1117"><span class="linum" id="linum:1117">1117</span></a><span class="fringe" id="point:46564"> </span>
<a href="#linum:1118"><span class="linum" id="linum:1118">1118</span></a><span class="fringe" id="point:46565"> </span><span class="comment-delimiter" id="font-lock:46565">;; </span><span class="comment" id="font-lock:46568">construct an assoc of (stripped-name . "{ css-stuff-here }") pairs
</span><a href="#linum:1119"><span class="linum" id="linum:1119">1119</span></a><span class="fringe" id="point:46635"> </span><span class="comment-delimiter" id="font-lock:46635">;; </span><span class="comment" id="font-lock:46638">from a face:
</span><a href="#linum:1120"><span class="linum" id="linum:1120">1120</span></a><span class="fringe" id="point:46651"> </span>(<span class="keyword" id="font-lock:46652">defun</span> <span class="function-name" id="font-lock:46658">hfy-face-to-css</span> (fn)
<a href="#linum:1121"><span class="linum" id="linum:1121">1121</span></a><span class="fringe" id="point:46679"> </span>  <span class="doc" id="font-lock:46681">"Take FN, a font or `</span><span class="doc" id="font-lock:46702"><span class="constant" id="font-lock:46702">defface</span></span><span class="doc" id="font-lock:46709">' specification (cf `</span><span class="doc" id="font-lock:46730"><span class="constant" id="font-lock:46730">face-attr-construct</span></span><span class="doc" id="font-lock:46749">')
</span><a href="#linum:1122"><span class="linum" id="linum:1122">1122</span></a><span class="fringe" id="point:46752"> </span><span class="doc" id="font-lock:46752">and return a CSS style specification.\n
</span><a href="#linum:1123"><span class="linum" id="linum:1123">1123</span></a><span class="fringe" id="point:46792"> </span><span class="doc" id="font-lock:46792">See also `</span><span class="doc" id="font-lock:46802"><span class="constant" id="font-lock:46802">hfy-face-to-style</span></span><span class="doc" id="font-lock:46819">'."</span>
<a href="#linum:1124"><span class="linum" id="linum:1124">1124</span></a><span class="fringe" id="point:46823"> </span>  <span class="comment-delimiter" id="font-lock:46825">;;</span><span class="comment" id="font-lock:46827">(message "hfy-face-to-css");;DBUG
</span><a href="#linum:1125"><span class="linum" id="linum:1125">1125</span></a><span class="fringe" id="point:46861"> </span>  (<span class="keyword" id="font-lock:46864">let</span> ((css-list nil)
<a href="#linum:1126"><span class="linum" id="linum:1126">1126</span></a><span class="fringe" id="point:46884"> </span>        (css-text nil)
<a href="#linum:1127"><span class="linum" id="linum:1127">1127</span></a><span class="fringe" id="point:46907"> </span>        (seen     nil))
<a href="#linum:1128"><span class="linum" id="linum:1128">1128</span></a><span class="fringe" id="point:46931"> </span>    <span class="comment-delimiter" id="font-lock:46935">;;</span><span class="comment" id="font-lock:46937">(message "(hfy-face-to-style %S)" fn)
</span><a href="#linum:1129"><span class="linum" id="linum:1129">1129</span></a><span class="fringe" id="point:46975"> </span>    (setq css-list (hfy-face-to-style fn))
<a href="#linum:1130"><span class="linum" id="linum:1130">1130</span></a><span class="fringe" id="point:47018"> </span>    (setq css-text
<a href="#linum:1131"><span class="linum" id="linum:1131">1131</span></a><span class="fringe" id="point:47037"> </span>          (mapcar
<a href="#linum:1132"><span class="linum" id="linum:1132">1132</span></a><span class="fringe" id="point:47055"> </span>           (<span class="keyword" id="font-lock:47067">lambda</span> (E)
<a href="#linum:1133"><span class="linum" id="linum:1133">1133</span></a><span class="fringe" id="point:47078"> </span>             (<span class="keyword" id="font-lock:47092">if</span> (car E)
<a href="#linum:1134"><span class="linum" id="linum:1134">1134</span></a><span class="fringe" id="point:47103"> </span>                 (<span class="keyword" id="font-lock:47121">unless</span> (member (car E) seen)
<a href="#linum:1135"><span class="linum" id="linum:1135">1135</span></a><span class="fringe" id="point:47150"> </span>                   (push (car E) seen)
<a href="#linum:1136"><span class="linum" id="linum:1136">1136</span></a><span class="fringe" id="point:47189"> </span>                   (format <span class="string" id="font-lock:47216">" %s: %s; "</span> (car E) (cdr E)))))
<a href="#linum:1137"><span class="linum" id="linum:1137">1137</span></a><span class="fringe" id="point:47248"> </span>           css-list))
<a href="#linum:1138"><span class="linum" id="linum:1138">1138</span></a><span class="fringe" id="point:47270"> </span>    (cons (hfy-css-name fn) (format <span class="string" id="font-lock:47306">"{%s}"</span> (apply 'concat css-text)))) )
<a href="#linum:1139"><span class="linum" id="linum:1139">1139</span></a><span class="fringe" id="point:47343"> </span>
<a href="#linum:1140"><span class="linum" id="linum:1140">1140</span></a><span class="fringe" id="point:47344"> </span><span class="comment-delimiter" id="font-lock:47344">;; </span><span class="comment" id="font-lock:47347">extract a face from a list of char properties, if there is one:
</span><a href="#linum:1141"><span class="linum" id="linum:1141">1141</span></a><span class="fringe" id="point:47411"> </span>(<span class="keyword" id="font-lock:47412">defun</span> <span class="function-name" id="font-lock:47418">hfy-p-to-face</span> (props)
<a href="#linum:1142"><span class="linum" id="linum:1142">1142</span></a><span class="fringe" id="point:47440"> </span>  <span class="doc" id="font-lock:47442">"Given PROPS, a list of text properties, return the value of the face
</span><a href="#linum:1143"><span class="linum" id="linum:1143">1143</span></a><span class="fringe" id="point:47512"> </span><span class="doc" id="font-lock:47512">property, or nil."</span>
<a href="#linum:1144"><span class="linum" id="linum:1144">1144</span></a><span class="fringe" id="point:47531"> </span>  (<span class="keyword" id="font-lock:47534">if</span> props
<a href="#linum:1145"><span class="linum" id="linum:1145">1145</span></a><span class="fringe" id="point:47543"> </span>      (<span class="keyword" id="font-lock:47550">if</span> (string= (car props) <span class="string" id="font-lock:47574">"face"</span>)
<a href="#linum:1146"><span class="linum" id="linum:1146">1146</span></a><span class="fringe" id="point:47582"> </span>          (<span class="keyword" id="font-lock:47593">let</span> ((propval (cadr props)))
<a href="#linum:1147"><span class="linum" id="linum:1147">1147</span></a><span class="fringe" id="point:47622"> </span>              (<span class="keyword" id="font-lock:47637">if</span> (and (listp propval) (not (cdr propval)))
<a href="#linum:1148"><span class="linum" id="linum:1148">1148</span></a><span class="fringe" id="point:47682"> </span>                  (car propval)
<a href="#linum:1149"><span class="linum" id="linum:1149">1149</span></a><span class="fringe" id="point:47714"> </span>                propval))
<a href="#linum:1150"><span class="linum" id="linum:1150">1150</span></a><span class="fringe" id="point:47740"> </span>        (hfy-p-to-face (cddr props)))
<a href="#linum:1151"><span class="linum" id="linum:1151">1151</span></a><span class="fringe" id="point:47778"> </span>    nil))
<a href="#linum:1152"><span class="linum" id="linum:1152">1152</span></a><span class="fringe" id="point:47788"> </span>
<a href="#linum:1153"><span class="linum" id="linum:1153">1153</span></a><span class="fringe" id="point:47789"> </span>(<span class="keyword" id="font-lock:47790">defun</span> <span class="function-name" id="font-lock:47796">hfy-p-to-face-lennart</span> (props)
<a href="#linum:1154"><span class="linum" id="linum:1154">1154</span></a><span class="fringe" id="point:47826"> </span>  <span class="doc" id="font-lock:47828">"Given PROPS, a list of text properties, return the value of the face
</span><a href="#linum:1155"><span class="linum" id="linum:1155">1155</span></a><span class="fringe" id="point:47898"> </span><span class="doc" id="font-lock:47898">property, or nil."</span>
<a href="#linum:1156"><span class="linum" id="linum:1156">1156</span></a><span class="fringe" id="point:47917"> </span>  (<span class="keyword" id="font-lock:47920">when</span> props
<a href="#linum:1157"><span class="linum" id="linum:1157">1157</span></a><span class="fringe" id="point:47931"> </span>    (<span class="keyword" id="font-lock:47936">let</span> ((face (plist-get props 'face))
<a href="#linum:1158"><span class="linum" id="linum:1158">1158</span></a><span class="fringe" id="point:47972"> </span>          (font-lock-face (plist-get props 'font-lock-face))
<a href="#linum:1159"><span class="linum" id="linum:1159">1159</span></a><span class="fringe" id="point:48033"> </span>          (button (plist-get props 'button))
<a href="#linum:1160"><span class="linum" id="linum:1160">1160</span></a><span class="fringe" id="point:48078"> </span>          <span class="comment-delimiter" id="font-lock:48088">;;</span><span class="comment" id="font-lock:48090">(face-rec (memq 'face props))
</span><a href="#linum:1161"><span class="linum" id="linum:1161">1161</span></a><span class="fringe" id="point:48120"> </span>          <span class="comment-delimiter" id="font-lock:48130">;;</span><span class="comment" id="font-lock:48132">(button-rec (memq 'button props)))
</span><a href="#linum:1162"><span class="linum" id="linum:1162">1162</span></a><span class="fringe" id="point:48167"> </span>          )
<a href="#linum:1163"><span class="linum" id="linum:1163">1163</span></a><span class="fringe" id="point:48179"> </span>      (<span class="keyword" id="font-lock:48186">if</span> button
<a href="#linum:1164"><span class="linum" id="linum:1164">1164</span></a><span class="fringe" id="point:48196"> </span>          (<span class="keyword" id="font-lock:48207">let*</span> ((category (plist-get props 'category))
<a href="#linum:1165"><span class="linum" id="linum:1165">1165</span></a><span class="fringe" id="point:48252"> </span>                 (face (<span class="keyword" id="font-lock:48276">when</span> category (plist-get (symbol-plist category) 'face))))
<a href="#linum:1166"><span class="linum" id="linum:1166">1166</span></a><span class="fringe" id="point:48335"> </span>            face)
<a href="#linum:1167"><span class="linum" id="linum:1167">1167</span></a><span class="fringe" id="point:48353"> </span>        (or font-lock-face
<a href="#linum:1168"><span class="linum" id="linum:1168">1168</span></a><span class="fringe" id="point:48380"> </span>            face)))))
<a href="#linum:1169"><span class="linum" id="linum:1169">1169</span></a><span class="fringe" id="point:48402"> </span>
<a href="#linum:1170"><span class="linum" id="linum:1170">1170</span></a><span class="fringe" id="point:48403"> </span><span class="comment-delimiter" id="font-lock:48403">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="comment" id="font-lock:48444">
</span><a href="#linum:1171"><span class="linum" id="linum:1171">1171</span></a><span class="fringe" id="point:48445"> </span><span class="comment-delimiter" id="font-lock:48445">;; </span><span class="comment" id="font-lock:48448">(defun hfy-get-face-at (pos)
</span><a href="#linum:1172"><span class="linum" id="linum:1172">1172</span></a><span class="fringe" id="point:48477"> </span><span class="comment-delimiter" id="font-lock:48477">;; </span><span class="comment" id="font-lock:48480">;;   (let ((face (get-char-property-and-overlay pos 'face)))
</span><a href="#linum:1173"><span class="linum" id="linum:1173">1173</span></a><span class="fringe" id="point:48541"> </span><span class="comment-delimiter" id="font-lock:48541">;; </span><span class="comment" id="font-lock:48544">;;     (when (and face (listp face)) (setq face (car face)))
</span><a href="#linum:1174"><span class="linum" id="linum:1174">1174</span></a><span class="fringe" id="point:48605"> </span><span class="comment-delimiter" id="font-lock:48605">;; </span><span class="comment" id="font-lock:48608">;;     (unless (listp face)
</span><a href="#linum:1175"><span class="linum" id="linum:1175">1175</span></a><span class="fringe" id="point:48636"> </span><span class="comment-delimiter" id="font-lock:48636">;; </span><span class="comment" id="font-lock:48639">;;       face)))
</span><a href="#linum:1176"><span class="linum" id="linum:1176">1176</span></a><span class="fringe" id="point:48656"> </span><span class="comment-delimiter" id="font-lock:48656">;;   </span><span class="comment" id="font-lock:48661">;;(get-char-property pos 'face)
</span><a href="#linum:1177"><span class="linum" id="linum:1177">1177</span></a><span class="fringe" id="point:48693"> </span><span class="comment-delimiter" id="font-lock:48693">;;   </span><span class="comment" id="font-lock:48698">;; Overlays are handled later
</span><a href="#linum:1178"><span class="linum" id="linum:1178">1178</span></a><span class="fringe" id="point:48728"> </span><span class="comment-delimiter" id="font-lock:48728">;;   </span><span class="comment" id="font-lock:48733">(if (or (not show-trailing-whitespace)
</span><a href="#linum:1179"><span class="linum" id="linum:1179">1179</span></a><span class="fringe" id="point:48772"> </span><span class="comment-delimiter" id="font-lock:48772">;;           </span><span class="comment" id="font-lock:48785">(not (get-text-property pos 'hfy-show-trailing-whitespace)))
</span><a href="#linum:1180"><span class="linum" id="linum:1180">1180</span></a><span class="fringe" id="point:48846"> </span><span class="comment-delimiter" id="font-lock:48846">;;       </span><span class="comment" id="font-lock:48855">(get-text-property pos 'face)
</span><a href="#linum:1181"><span class="linum" id="linum:1181">1181</span></a><span class="fringe" id="point:48885"> </span><span class="comment-delimiter" id="font-lock:48885">;;     </span><span class="comment" id="font-lock:48892">(list 'trailing-whitespace (get-text-property pos 'face)))
</span><a href="#linum:1182"><span class="linum" id="linum:1182">1182</span></a><span class="fringe" id="point:48951"> </span><span class="comment-delimiter" id="font-lock:48951">;;   </span><span class="comment" id="font-lock:48956">)
</span><a href="#linum:1183"><span class="linum" id="linum:1183">1183</span></a><span class="fringe" id="point:48958"> </span>
<a href="#linum:1184"><span class="linum" id="linum:1184">1184</span></a><span class="fringe" id="point:48959"> </span>(<span class="keyword" id="font-lock:48960">defun</span> <span class="function-name" id="font-lock:48966">hfy-prop-invisible-p</span> (prop)
<a href="#linum:1185"><span class="linum" id="linum:1185">1185</span></a><span class="fringe" id="point:48994"> </span>  <span class="doc" id="font-lock:48996">"Is text property PROP an active invisibility property?"</span>
<a href="#linum:1186"><span class="linum" id="linum:1186">1186</span></a><span class="fringe" id="point:49053"> </span>  (or (and (eq buffer-invisibility-spec t) prop)
<a href="#linum:1187"><span class="linum" id="linum:1187">1187</span></a><span class="fringe" id="point:49102"> </span>      (or (memq prop buffer-invisibility-spec)
<a href="#linum:1188"><span class="linum" id="linum:1188">1188</span></a><span class="fringe" id="point:49149"> </span>          (assq prop buffer-invisibility-spec))))
<a href="#linum:1189"><span class="linum" id="linum:1189">1189</span></a><span class="fringe" id="point:49199"> </span>
<a href="#linum:1190"><span class="linum" id="linum:1190">1190</span></a><span class="fringe" id="point:49200"> </span>(<span class="keyword" id="font-lock:49201">defun</span> <span class="function-name" id="font-lock:49207">hfy-find-invisible-ranges</span> ()
<a href="#linum:1191"><span class="linum" id="linum:1191">1191</span></a><span class="fringe" id="point:49236"> </span>  <span class="doc" id="font-lock:49238">"Return a list of (start-point . end-point) cons cells of invisible regions."</span>
<a href="#linum:1192"><span class="linum" id="linum:1192">1192</span></a><span class="fringe" id="point:49316"> </span>  (<span class="keyword" id="font-lock:49319">let</span> (invisible p i e s) <span class="comment-delimiter" id="font-lock:49343">;; </span><span class="comment" id="font-lock:49346">return-value pos invisible end start
</span><a href="#linum:1193"><span class="linum" id="linum:1193">1193</span></a><span class="fringe" id="point:49383"> </span>    (<span class="keyword" id="font-lock:49388">save-excursion</span>
<a href="#linum:1194"><span class="linum" id="linum:1194">1194</span></a><span class="fringe" id="point:49403"> </span>      (setq p (goto-char (point-min)))
<a href="#linum:1195"><span class="linum" id="linum:1195">1195</span></a><span class="fringe" id="point:49442"> </span>      (<span class="keyword" id="font-lock:49449">when</span> (invisible-p p) (setq s p i t))
<a href="#linum:1196"><span class="linum" id="linum:1196">1196</span></a><span class="fringe" id="point:49486"> </span>      (<span class="keyword" id="font-lock:49493">while</span> (&lt; p (point-max))
<a href="#linum:1197"><span class="linum" id="linum:1197">1197</span></a><span class="fringe" id="point:49517"> </span>        (<span class="keyword" id="font-lock:49526">if</span> i <span class="comment-delimiter" id="font-lock:49531">;; </span><span class="comment" id="font-lock:49534">currently invisible
</span><a href="#linum:1198"><span class="linum" id="linum:1198">1198</span></a><span class="fringe" id="point:49554"> </span>            (<span class="keyword" id="font-lock:49567">when</span> (not (invisible-p p)) <span class="comment-delimiter" id="font-lock:49594">;; </span><span class="comment" id="font-lock:49597">but became visible
</span><a href="#linum:1199"><span class="linum" id="linum:1199">1199</span></a><span class="fringe" id="point:49616"> </span>              (setq e         p
<a href="#linum:1200"><span class="linum" id="linum:1200">1200</span></a><span class="fringe" id="point:49648"> </span>                    i         nil
<a href="#linum:1201"><span class="linum" id="linum:1201">1201</span></a><span class="fringe" id="point:49682"> </span>                    invisible (cons (cons s e) invisible)))
<a href="#linum:1202"><span class="linum" id="linum:1202">1202</span></a><span class="fringe" id="point:49742"> </span>          <span class="comment-delimiter" id="font-lock:49752">;; </span><span class="comment" id="font-lock:49755">currently visible:
</span><a href="#linum:1203"><span class="linum" id="linum:1203">1203</span></a><span class="fringe" id="point:49774"> </span>          (<span class="keyword" id="font-lock:49785">when</span> (invisible-p p)  <span class="comment-delimiter" id="font-lock:49807">;; </span><span class="comment" id="font-lock:49810">but have become invisible
</span><a href="#linum:1204"><span class="linum" id="linum:1204">1204</span></a><span class="fringe" id="point:49836"> </span>            (setq s p i t)))
<a href="#linum:1205"><span class="linum" id="linum:1205">1205</span></a><span class="fringe" id="point:49865"> </span>        (setq p (next-char-property-change p)))
<a href="#linum:1206"><span class="linum" id="linum:1206">1206</span></a><span class="fringe" id="point:49913"> </span>      <span class="comment-delimiter" id="font-lock:49919">;; </span><span class="comment" id="font-lock:49922">still invisible at buffer end?
</span><a href="#linum:1207"><span class="linum" id="linum:1207">1207</span></a><span class="fringe" id="point:49953"> </span>      (<span class="keyword" id="font-lock:49960">when</span> i
<a href="#linum:1208"><span class="linum" id="linum:1208">1208</span></a><span class="fringe" id="point:49967"> </span>        (setq e         (point-max)
<a href="#linum:1209"><span class="linum" id="linum:1209">1209</span></a><span class="fringe" id="point:50003"> </span>              invisible (cons (cons s e) invisible))) ) invisible))
<a href="#linum:1210"><span class="linum" id="linum:1210">1210</span></a><span class="fringe" id="point:50071"> </span>
<a href="#linum:1211"><span class="linum" id="linum:1211">1211</span></a><span class="fringe" id="point:50072"> </span>(<span class="keyword" id="font-lock:50073">defun</span> <span class="function-name" id="font-lock:50079">hfy-invisible-name</span> (point map)
<a href="#linum:1212"><span class="linum" id="linum:1212">1212</span></a><span class="fringe" id="point:50110"> </span>  <span class="doc" id="font-lock:50112">"Generate a CSS style name for an invisible section of the buffer.
</span><a href="#linum:1213"><span class="linum" id="linum:1213">1213</span></a><span class="fringe" id="point:50179"> </span><span class="doc" id="font-lock:50179">POINT is the point inside the invisible region.
</span><a href="#linum:1214"><span class="linum" id="linum:1214">1214</span></a><span class="fringe" id="point:50227"> </span><span class="doc" id="font-lock:50227">MAP is the invisibility map as returned by `</span><span class="doc" id="font-lock:50271"><span class="constant" id="font-lock:50271">hfy-find-invisible-ranges</span></span><span class="doc" id="font-lock:50296">'."</span>
<a href="#linum:1215"><span class="linum" id="linum:1215">1215</span></a><span class="fringe" id="point:50300"> </span>  <span class="comment-delimiter" id="font-lock:50302">;;</span><span class="comment" id="font-lock:50304">(message "(hfy-invisible-name %S %S)" point map)
</span><a href="#linum:1216"><span class="linum" id="linum:1216">1216</span></a><span class="fringe" id="point:50353"> </span>  (<span class="keyword" id="font-lock:50356">let</span> (name)
<a href="#linum:1217"><span class="linum" id="linum:1217">1217</span></a><span class="fringe" id="point:50367"> </span>    (<span class="keyword" id="font-lock:50372">dolist</span> (range map)
<a href="#linum:1218"><span class="linum" id="linum:1218">1218</span></a><span class="fringe" id="point:50391"> </span>      (<span class="keyword" id="font-lock:50398">when</span> (and (&gt;= point (car range))
<a href="#linum:1219"><span class="linum" id="linum:1219">1219</span></a><span class="fringe" id="point:50431"> </span>                 (&lt;  point (cdr range)))
<a href="#linum:1220"><span class="linum" id="linum:1220">1220</span></a><span class="fringe" id="point:50472"> </span>        (setq name (format <span class="string" id="font-lock:50499">"invisible-%S-%S"</span> (car range) (cdr range)))))
<a href="#linum:1221"><span class="linum" id="linum:1221">1221</span></a><span class="fringe" id="point:50545"> </span>    name))
<a href="#linum:1222"><span class="linum" id="linum:1222">1222</span></a><span class="fringe" id="point:50556"> </span>
<a href="#linum:1223"><span class="linum" id="linum:1223">1223</span></a><span class="fringe" id="point:50557"> </span><span class="comment-delimiter" id="font-lock:50557">;; </span><span class="comment" id="font-lock:50560">Fix-me: This function needs some cleanup by someone who understand
</span><a href="#linum:1224"><span class="linum" id="linum:1224">1224</span></a><span class="fringe" id="point:50627"> </span><span class="comment-delimiter" id="font-lock:50627">;; </span><span class="comment" id="font-lock:50630">all the formats that face properties can have.
</span><a href="#linum:1225"><span class="linum" id="linum:1225">1225</span></a><span class="fringe" id="point:50677"> </span><span class="comment-delimiter" id="font-lock:50677">;;</span><span class="comment" id="font-lock:50679">
</span><a href="#linum:1226"><span class="linum" id="linum:1226">1226</span></a><span class="fringe" id="point:50680"> </span><span class="comment-delimiter" id="font-lock:50680">;; </span><span class="comment" id="font-lock:50683">overlay handling should be fine. haven't tested multiple stacked overlapping
</span><a href="#linum:1227"><span class="linum" id="linum:1227">1227</span></a><span class="fringe" id="point:50760"> </span><span class="comment-delimiter" id="font-lock:50760">;; </span><span class="comment" id="font-lock:50763">overlays recently, but the common case of a text property face + an overlay
</span><a href="#linum:1228"><span class="linum" id="linum:1228">1228</span></a><span class="fringe" id="point:50839"> </span><span class="comment-delimiter" id="font-lock:50839">;; </span><span class="comment" id="font-lock:50842">face produces the correct merged css style (or as close to it as css can get)
</span><a href="#linum:1229"><span class="linum" id="linum:1229">1229</span></a><span class="fringe" id="point:50920"> </span><span class="comment-delimiter" id="font-lock:50920">;; </span><span class="comment" id="font-lock:50923">-- v
</span><a href="#linum:1230"><span class="linum" id="linum:1230">1230</span></a><span class="fringe" id="point:50928"> </span>(<span class="keyword" id="font-lock:50929">defun</span> <span class="function-name" id="font-lock:50935">hfy-face-at</span> (p)
<a href="#linum:1231"><span class="linum" id="linum:1231">1231</span></a><span class="fringe" id="point:50951"> </span>  <span class="doc" id="font-lock:50953">"Find face in effect at point P.
</span><a href="#linum:1232"><span class="linum" id="linum:1232">1232</span></a><span class="fringe" id="point:50986"> </span><span class="doc" id="font-lock:50986">If overlays are to be considered (see `</span><span class="doc" id="font-lock:51025"><span class="constant" id="font-lock:51025">hfy-optimisations</span></span><span class="doc" id="font-lock:51042">') then this may
</span><a href="#linum:1233"><span class="linum" id="linum:1233">1233</span></a><span class="fringe" id="point:51059"> </span><span class="doc" id="font-lock:51059">return a `</span><span class="doc" id="font-lock:51069"><span class="constant" id="font-lock:51069">defface</span></span><span class="doc" id="font-lock:51076">' style list of face properties instead of a face symbol."</span>
<a href="#linum:1234"><span class="linum" id="linum:1234">1234</span></a><span class="fringe" id="point:51135"> </span>  <span class="comment-delimiter" id="font-lock:51137">;;</span><span class="comment" id="font-lock:51139">(message "hfy-face-at");;DBUG
</span><a href="#linum:1235"><span class="linum" id="linum:1235">1235</span></a><span class="fringe" id="point:51169"> </span>  <span class="comment-delimiter" id="font-lock:51171">;; </span><span class="comment" id="font-lock:51174">Fix-me: clean up, remove face-name etc
</span><a href="#linum:1236"><span class="linum" id="linum:1236">1236</span></a><span class="fringe" id="point:51213"> </span>  <span class="comment-delimiter" id="font-lock:51215">;; </span><span class="comment" id="font-lock:51218">not sure why we'd want to remove face-name? -- v
</span><a href="#linum:1237"><span class="linum" id="linum:1237">1237</span></a><span class="fringe" id="point:51267"> </span>  (<span class="keyword" id="font-lock:51270">let</span> ((overlay-data nil)
<a href="#linum:1238"><span class="linum" id="linum:1238">1238</span></a><span class="fringe" id="point:51294"> </span>        (base-face    nil)
<a href="#linum:1239"><span class="linum" id="linum:1239">1239</span></a><span class="fringe" id="point:51321"> </span>        <span class="comment-delimiter" id="font-lock:51329">;; </span><span class="comment" id="font-lock:51332">restored hfy-p-to-face as it handles faces like (bold) as
</span><a href="#linum:1240"><span class="linum" id="linum:1240">1240</span></a><span class="fringe" id="point:51390"> </span>        <span class="comment-delimiter" id="font-lock:51398">;; </span><span class="comment" id="font-lock:51401">well as face like 'bold - hfy-get-face-at doesn't dtrt -- v
</span><a href="#linum:1241"><span class="linum" id="linum:1241">1241</span></a><span class="fringe" id="point:51461"> </span>        (face-name   (hfy-p-to-face (text-properties-at p)))
<a href="#linum:1242"><span class="linum" id="linum:1242">1242</span></a><span class="fringe" id="point:51522"> </span>        <span class="comment-delimiter" id="font-lock:51530">;; </span><span class="comment" id="font-lock:51533">(face-name    (hfy-get-face-at p))
</span><a href="#linum:1243"><span class="linum" id="linum:1243">1243</span></a><span class="fringe" id="point:51568"> </span>        (prop-seen    nil)
<a href="#linum:1244"><span class="linum" id="linum:1244">1244</span></a><span class="fringe" id="point:51595"> </span>        (extra-props  nil)
<a href="#linum:1245"><span class="linum" id="linum:1245">1245</span></a><span class="fringe" id="point:51622"> </span>        (text-props   (text-properties-at p)))
<a href="#linum:1246"><span class="linum" id="linum:1246">1246</span></a><span class="fringe" id="point:51669"> </span>    <span class="comment-delimiter" id="font-lock:51673">;;</span><span class="comment" id="font-lock:51675">(message "face-name: %S" face-name)
</span><a href="#linum:1247"><span class="linum" id="linum:1247">1247</span></a><span class="fringe" id="point:51711"> </span>    (<span class="keyword" id="font-lock:51716">when</span> (and face-name (listp face-name) (facep (car face-name)))
<a href="#linum:1248"><span class="linum" id="linum:1248">1248</span></a><span class="fringe" id="point:51779"> </span>      <span class="comment-delimiter" id="font-lock:51785">;;</span><span class="comment" id="font-lock:51787">(message "face-name is a list %S" face-name)
</span><a href="#linum:1249"><span class="linum" id="linum:1249">1249</span></a><span class="fringe" id="point:51832"> </span>      <span class="comment-delimiter" id="font-lock:51838">;;</span><span class="comment" id="font-lock:51840">(setq text-props (cons 'face face-name))
</span><a href="#linum:1250"><span class="linum" id="linum:1250">1250</span></a><span class="fringe" id="point:51881"> </span>      (<span class="keyword" id="font-lock:51888">dolist</span> (f face-name)
<a href="#linum:1251"><span class="linum" id="linum:1251">1251</span></a><span class="fringe" id="point:51909"> </span>        (setq extra-props (<span class="keyword" id="font-lock:51936">if</span> (listp f)
<a href="#linum:1252"><span class="linum" id="linum:1252">1252</span></a><span class="fringe" id="point:51949"> </span>                              <span class="comment-delimiter" id="font-lock:51979">;; </span><span class="comment" id="font-lock:51982">for things like (variable-pitch
</span><a href="#linum:1253"><span class="linum" id="linum:1253">1253</span></a><span class="fringe" id="point:52014"> </span>                              <span class="comment-delimiter" id="font-lock:52044">;; </span><span class="comment" id="font-lock:52047">(:foreground "red"))
</span><a href="#linum:1254"><span class="linum" id="linum:1254">1254</span></a><span class="fringe" id="point:52068"> </span>                              (cons f extra-props)
<a href="#linum:1255"><span class="linum" id="linum:1255">1255</span></a><span class="fringe" id="point:52119"> </span>                            (cons <span class="builtin" id="font-lock:52153">:inherit</span> (cons f extra-props)))))
<a href="#linum:1256"><span class="linum" id="linum:1256">1256</span></a><span class="fringe" id="point:52187"> </span>      (setq base-face (car face-name)
<a href="#linum:1257"><span class="linum" id="linum:1257">1257</span></a><span class="fringe" id="point:52225"> </span>            face-name nil))
<a href="#linum:1258"><span class="linum" id="linum:1258">1258</span></a><span class="fringe" id="point:52253"> </span>    <span class="comment-delimiter" id="font-lock:52257">;; </span><span class="comment" id="font-lock:52260">text-properties-at =&gt; (face (:foreground "red" ...))
</span><a href="#linum:1259"><span class="linum" id="linum:1259">1259</span></a><span class="fringe" id="point:52313"> </span>    <span class="comment-delimiter" id="font-lock:52317">;;                 </span><span class="comment" id="font-lock:52336">or =&gt; (face (compilation-info underline)) list of faces
</span><a href="#linum:1260"><span class="linum" id="linum:1260">1260</span></a><span class="fringe" id="point:52392"> </span>    <span class="comment-delimiter" id="font-lock:52396">;; </span><span class="comment" id="font-lock:52399">overlay-properties
</span><a href="#linum:1261"><span class="linum" id="linum:1261">1261</span></a><span class="fringe" id="point:52418"> </span>    <span class="comment-delimiter" id="font-lock:52422">;;   </span><span class="comment" id="font-lock:52427">format= (evaporate t face ((foreground-color . "red")))
</span><a href="#linum:1262"><span class="linum" id="linum:1262">1262</span></a><span class="fringe" id="point:52483"> </span>
<a href="#linum:1263"><span class="linum" id="linum:1263">1263</span></a><span class="fringe" id="point:52484"> </span>    <span class="comment-delimiter" id="font-lock:52488">;; </span><span class="comment" id="font-lock:52491">SO:    if we have turned overlays off,
</span><a href="#linum:1264"><span class="linum" id="linum:1264">1264</span></a><span class="fringe" id="point:52530"> </span>    <span class="comment-delimiter" id="font-lock:52534">;;     </span><span class="comment" id="font-lock:52541">or if there's no overlay data
</span><a href="#linum:1265"><span class="linum" id="linum:1265">1265</span></a><span class="fringe" id="point:52571"> </span>    <span class="comment-delimiter" id="font-lock:52575">;; </span><span class="comment" id="font-lock:52578">just bail out and return whatever face data we've accumulated so far
</span><a href="#linum:1266"><span class="linum" id="linum:1266">1266</span></a><span class="fringe" id="point:52647"> </span>    (<span class="keyword" id="font-lock:52652">if</span> (or (not (hfy-opt                      'keep-overlays))
<a href="#linum:1267"><span class="linum" id="linum:1267">1267</span></a><span class="fringe" id="point:52711"> </span>            (not (setq overlay-data  (hfy-overlay-props-at p))))
<a href="#linum:1268"><span class="linum" id="linum:1268">1268</span></a><span class="fringe" id="point:52776"> </span>        (<span class="keyword" id="font-lock:52785">progn</span>
<a href="#linum:1269"><span class="linum" id="linum:1269">1269</span></a><span class="fringe" id="point:52791"> </span>          <span class="comment-delimiter" id="font-lock:52801">;;</span><span class="comment" id="font-lock:52803">(message "&#183; %d: %s; %S; %s"
</span><a href="#linum:1270"><span class="linum" id="linum:1270">1270</span></a><span class="fringe" id="point:52831"> </span>          <span class="comment-delimiter" id="font-lock:52841">;;         </span><span class="comment" id="font-lock:52852">p face-name extra-props text-props)
</span><a href="#linum:1271"><span class="linum" id="linum:1271">1271</span></a><span class="fringe" id="point:52888"> </span>          (or face-name base-face)) <span class="comment-delimiter" id="font-lock:52924">;; </span><span class="comment" id="font-lock:52927">no overlays or extra properties
</span><a href="#linum:1272"><span class="linum" id="linum:1272">1272</span></a><span class="fringe" id="point:52959"> </span>      <span class="comment-delimiter" id="font-lock:52965">;; </span><span class="comment" id="font-lock:52968">collect any face data and any overlay data for processing:
</span><a href="#linum:1273"><span class="linum" id="linum:1273">1273</span></a><span class="fringe" id="point:53027"> </span>      (<span class="keyword" id="font-lock:53034">when</span> text-props
<a href="#linum:1274"><span class="linum" id="linum:1274">1274</span></a><span class="fringe" id="point:53050"> </span>        (push text-props overlay-data))
<a href="#linum:1275"><span class="linum" id="linum:1275">1275</span></a><span class="fringe" id="point:53090"> </span>      (setq overlay-data (nreverse overlay-data))
<a href="#linum:1276"><span class="linum" id="linum:1276">1276</span></a><span class="fringe" id="point:53140"> </span>      <span class="comment-delimiter" id="font-lock:53146">;;</span><span class="comment" id="font-lock:53148">(message "- %d: %s; %S; %s; %s"
</span><a href="#linum:1277"><span class="linum" id="linum:1277">1277</span></a><span class="fringe" id="point:53180"> </span>      <span class="comment-delimiter" id="font-lock:53186">;;         </span><span class="comment" id="font-lock:53197">p face-name extra-props text-props overlay-data)
</span><a href="#linum:1278"><span class="linum" id="linum:1278">1278</span></a><span class="fringe" id="point:53246"> </span>      <span class="comment-delimiter" id="font-lock:53252">;; </span><span class="comment" id="font-lock:53255">remember the basic face name so we don't keep repeating its specs:
</span><a href="#linum:1279"><span class="linum" id="linum:1279">1279</span></a><span class="fringe" id="point:53322"> </span>      (<span class="keyword" id="font-lock:53329">when</span> face-name (setq base-face face-name))
<a href="#linum:1280"><span class="linum" id="linum:1280">1280</span></a><span class="fringe" id="point:53372"> </span>      (<span class="keyword" id="font-lock:53379">dolist</span> (P overlay-data)
<a href="#linum:1281"><span class="linum" id="linum:1281">1281</span></a><span class="fringe" id="point:53403"> </span>        (<span class="keyword" id="font-lock:53412">let</span> ((iprops (cadr (memq 'invisible P)))) <span class="comment-delimiter" id="font-lock:53454">;</span><span class="comment" id="font-lock:53455">FIXME: plist-get?
</span><a href="#linum:1282"><span class="linum" id="linum:1282">1282</span></a><span class="fringe" id="point:53473"> </span>          <span class="comment-delimiter" id="font-lock:53483">;;</span><span class="comment" id="font-lock:53485">(message "(hfy-prop-invisible-p %S)" iprops)
</span><a href="#linum:1283"><span class="linum" id="linum:1283">1283</span></a><span class="fringe" id="point:53530"> </span>          (<span class="keyword" id="font-lock:53541">when</span> (and iprops (hfy-prop-invisible-p iprops))
<a href="#linum:1284"><span class="linum" id="linum:1284">1284</span></a><span class="fringe" id="point:53589"> </span>            (setq extra-props
<a href="#linum:1285"><span class="linum" id="linum:1285">1285</span></a><span class="fringe" id="point:53619"> </span>                  (cons <span class="builtin" id="font-lock:53643">:invisible</span> (cons t extra-props))) ))
<a href="#linum:1286"><span class="linum" id="linum:1286">1286</span></a><span class="fringe" id="point:53680"> </span>        (<span class="keyword" id="font-lock:53689">let</span> ((fprops (cadr (or (memq 'face P)
<a href="#linum:1287"><span class="linum" id="linum:1287">1287</span></a><span class="fringe" id="point:53727"> </span>                                (memq 'font-lock-face P)))))
<a href="#linum:1288"><span class="linum" id="linum:1288">1288</span></a><span class="fringe" id="point:53788"> </span>          <span class="comment-delimiter" id="font-lock:53798">;;</span><span class="comment" id="font-lock:53800">(message "overlay face: %s" fprops)
</span><a href="#linum:1289"><span class="linum" id="linum:1289">1289</span></a><span class="fringe" id="point:53836"> </span>          (<span class="keyword" id="font-lock:53847">if</span> (not (listp fprops))
<a href="#linum:1290"><span class="linum" id="linum:1290">1290</span></a><span class="fringe" id="point:53871"> </span>              (<span class="keyword" id="font-lock:53886">let</span> ((this-face (<span class="keyword" id="font-lock:53903">if</span> (stringp fprops) (intern fprops) fprops)))
<a href="#linum:1291"><span class="linum" id="linum:1291">1291</span></a><span class="fringe" id="point:53949"> </span>                (<span class="keyword" id="font-lock:53966">when</span> (not (eq this-face base-face))
<a href="#linum:1292"><span class="linum" id="linum:1292">1292</span></a><span class="fringe" id="point:54002"> </span>                  (setq extra-props
<a href="#linum:1293"><span class="linum" id="linum:1293">1293</span></a><span class="fringe" id="point:54038"> </span>                        (cons <span class="builtin" id="font-lock:54068">:inherit</span>
<a href="#linum:1294"><span class="linum" id="linum:1294">1294</span></a><span class="fringe" id="point:54077"> </span>                              (cons this-face extra-props))) ))
<a href="#linum:1295"><span class="linum" id="linum:1295">1295</span></a><span class="fringe" id="point:54141"> </span>            (<span class="keyword" id="font-lock:54154">while</span> fprops
<a href="#linum:1296"><span class="linum" id="linum:1296">1296</span></a><span class="fringe" id="point:54167"> </span>              (<span class="keyword" id="font-lock:54182">if</span> (facep (car fprops))
<a href="#linum:1297"><span class="linum" id="linum:1297">1297</span></a><span class="fringe" id="point:54206"> </span>                  (<span class="keyword" id="font-lock:54225">let</span> ((face (car fprops)))
<a href="#linum:1298"><span class="linum" id="linum:1298">1298</span></a><span class="fringe" id="point:54251"> </span>                    (<span class="keyword" id="font-lock:54272">when</span> (stringp face) (setq face (intern fprops)))
<a href="#linum:1299"><span class="linum" id="linum:1299">1299</span></a><span class="fringe" id="point:54321"> </span>                    (setq extra-props
<a href="#linum:1300"><span class="linum" id="linum:1300">1300</span></a><span class="fringe" id="point:54359"> </span>                          (cons <span class="builtin" id="font-lock:54391">:inherit</span>
<a href="#linum:1301"><span class="linum" id="linum:1301">1301</span></a><span class="fringe" id="point:54400"> </span>                                (cons face
<a href="#linum:1302"><span class="linum" id="linum:1302">1302</span></a><span class="fringe" id="point:54443"> </span>                                      extra-props)))
<a href="#linum:1303"><span class="linum" id="linum:1303">1303</span></a><span class="fringe" id="point:54496"> </span>                    (setq fprops (cdr fprops)))
<a href="#linum:1304"><span class="linum" id="linum:1304">1304</span></a><span class="fringe" id="point:54544"> </span>                (<span class="keyword" id="font-lock:54561">let</span> (p v)
<a href="#linum:1305"><span class="linum" id="linum:1305">1305</span></a><span class="fringe" id="point:54571"> </span>                  <span class="comment-delimiter" id="font-lock:54589">;; </span><span class="comment" id="font-lock:54592">Sigh.
</span><a href="#linum:1306"><span class="linum" id="linum:1306">1306</span></a><span class="fringe" id="point:54598"> </span>                  (<span class="keyword" id="font-lock:54617">if</span> (listp (car fprops))
<a href="#linum:1307"><span class="linum" id="linum:1307">1307</span></a><span class="fringe" id="point:54641"> </span>                      (<span class="keyword" id="font-lock:54664">if</span> (nlistp (cdr (car fprops)))
<a href="#linum:1308"><span class="linum" id="linum:1308">1308</span></a><span class="fringe" id="point:54695"> </span>                          (<span class="keyword" id="font-lock:54722">progn</span>
<a href="#linum:1309"><span class="linum" id="linum:1309">1309</span></a><span class="fringe" id="point:54728"> </span>                            <span class="comment-delimiter" id="font-lock:54756">;; </span><span class="comment" id="font-lock:54759">((prop . val))
</span><a href="#linum:1310"><span class="linum" id="linum:1310">1310</span></a><span class="fringe" id="point:54774"> </span>                            (setq p (caar fprops))
<a href="#linum:1311"><span class="linum" id="linum:1311">1311</span></a><span class="fringe" id="point:54825"> </span>                            (setq v (cdar fprops))
<a href="#linum:1312"><span class="linum" id="linum:1312">1312</span></a><span class="fringe" id="point:54876"> </span>                            (setq fprops (cdr fprops)))
<a href="#linum:1313"><span class="linum" id="linum:1313">1313</span></a><span class="fringe" id="point:54932"> </span>                        <span class="comment-delimiter" id="font-lock:54956">;; </span><span class="comment" id="font-lock:54959">((prop val))
</span><a href="#linum:1314"><span class="linum" id="linum:1314">1314</span></a><span class="fringe" id="point:54972"> </span>                        (setq p (caar fprops))
<a href="#linum:1315"><span class="linum" id="linum:1315">1315</span></a><span class="fringe" id="point:55019"> </span>                        (setq v (cadar fprops))
<a href="#linum:1316"><span class="linum" id="linum:1316">1316</span></a><span class="fringe" id="point:55067"> </span>                        (setq fprops (cdr fprops)))
<a href="#linum:1317"><span class="linum" id="linum:1317">1317</span></a><span class="fringe" id="point:55119"> </span>                    (<span class="keyword" id="font-lock:55140">if</span> (listp (cdr fprops))
<a href="#linum:1318"><span class="linum" id="linum:1318">1318</span></a><span class="fringe" id="point:55164"> </span>                        (<span class="keyword" id="font-lock:55189">progn</span>
<a href="#linum:1319"><span class="linum" id="linum:1319">1319</span></a><span class="fringe" id="point:55195"> </span>                          <span class="comment-delimiter" id="font-lock:55221">;; </span><span class="comment" id="font-lock:55224">(:prop val :prop val ...)
</span><a href="#linum:1320"><span class="linum" id="linum:1320">1320</span></a><span class="fringe" id="point:55250"> </span>                          (setq p (car fprops))
<a href="#linum:1321"><span class="linum" id="linum:1321">1321</span></a><span class="fringe" id="point:55298"> </span>                          (setq v (cadr fprops))
<a href="#linum:1322"><span class="linum" id="linum:1322">1322</span></a><span class="fringe" id="point:55347"> </span>                          (setq fprops (cddr fprops)))
<a href="#linum:1323"><span class="linum" id="linum:1323">1323</span></a><span class="fringe" id="point:55402"> </span>                      (<span class="keyword" id="font-lock:55425">if</span> (and (listp fprops)
<a href="#linum:1324"><span class="linum" id="linum:1324">1324</span></a><span class="fringe" id="point:55448"> </span>                               (not (listp (cdr fprops))))
<a href="#linum:1325"><span class="linum" id="linum:1325">1325</span></a><span class="fringe" id="point:55507"> </span>                          <span class="comment-delimiter" id="font-lock:55533">;;</span><span class="comment" id="font-lock:55535">(and (consp x) (cdr (last x)))
</span><a href="#linum:1326"><span class="linum" id="linum:1326">1326</span></a><span class="fringe" id="point:55566"> </span>                          (<span class="keyword" id="font-lock:55593">progn</span>
<a href="#linum:1327"><span class="linum" id="linum:1327">1327</span></a><span class="fringe" id="point:55599"> </span>                            <span class="comment-delimiter" id="font-lock:55627">;; </span><span class="comment" id="font-lock:55630">(prop . val)
</span><a href="#linum:1328"><span class="linum" id="linum:1328">1328</span></a><span class="fringe" id="point:55643"> </span>                            (setq p (car fprops))
<a href="#linum:1329"><span class="linum" id="linum:1329">1329</span></a><span class="fringe" id="point:55693"> </span>                            (setq v (cdr fprops))
<a href="#linum:1330"><span class="linum" id="linum:1330">1330</span></a><span class="fringe" id="point:55743"> </span>                            (setq fprops nil))
<a href="#linum:1331"><span class="linum" id="linum:1331">1331</span></a><span class="fringe" id="point:55790"> </span>                        (<span class="warning" id="font-lock:55815">error</span> <span class="string" id="font-lock:55821">"Eh... another format! fprops=%s"</span> fprops) )))
<a href="#linum:1332"><span class="linum" id="linum:1332">1332</span></a><span class="fringe" id="point:55867"> </span>                  (setq p (<span class="keyword" id="font-lock:55894">case</span> p
<a href="#linum:1333"><span class="linum" id="linum:1333">1333</span></a><span class="fringe" id="point:55901"> </span>                            <span class="comment-delimiter" id="font-lock:55929">;; </span><span class="comment" id="font-lock:55932">These are all the properties handled
</span><a href="#linum:1334"><span class="linum" id="linum:1334">1334</span></a><span class="fringe" id="point:55969"> </span>                            <span class="comment-delimiter" id="font-lock:55997">;; </span><span class="comment" id="font-lock:56000">in `</span><span class="comment" id="font-lock:56004"><span class="constant" id="font-lock:56004">hfy-face-to-style-i</span></span><span class="comment" id="font-lock:56023">'.
</span><a href="#linum:1335"><span class="linum" id="linum:1335">1335</span></a><span class="fringe" id="point:56026"> </span>                            <span class="comment-delimiter" id="font-lock:56054">;;</span><span class="comment" id="font-lock:56056">
</span><a href="#linum:1336"><span class="linum" id="linum:1336">1336</span></a><span class="fringe" id="point:56057"> </span>                            <span class="comment-delimiter" id="font-lock:56085">;; </span><span class="comment" id="font-lock:56088">Are these translations right?
</span><a href="#linum:1337"><span class="linum" id="linum:1337">1337</span></a><span class="fringe" id="point:56118"> </span>                            <span class="comment-delimiter" id="font-lock:56146">;; </span><span class="comment" id="font-lock:56149">yes, they are -- v
</span><a href="#linum:1338"><span class="linum" id="linum:1338">1338</span></a><span class="fringe" id="point:56168"> </span>                            (family           <span class="builtin" id="font-lock:56214">:family</span>    )
<a href="#linum:1339"><span class="linum" id="linum:1339">1339</span></a><span class="fringe" id="point:56227"> </span>                            (width            <span class="builtin" id="font-lock:56273">:width</span>     )
<a href="#linum:1340"><span class="linum" id="linum:1340">1340</span></a><span class="fringe" id="point:56286"> </span>                            (height           <span class="builtin" id="font-lock:56332">:height</span>    )
<a href="#linum:1341"><span class="linum" id="linum:1341">1341</span></a><span class="fringe" id="point:56345"> </span>                            (weight           <span class="builtin" id="font-lock:56391">:weight</span>    )
<a href="#linum:1342"><span class="linum" id="linum:1342">1342</span></a><span class="fringe" id="point:56404"> </span>                            (slant            <span class="builtin" id="font-lock:56450">:slant</span>     )
<a href="#linum:1343"><span class="linum" id="linum:1343">1343</span></a><span class="fringe" id="point:56463"> </span>                            (underline        <span class="builtin" id="font-lock:56509">:underline</span> )
<a href="#linum:1344"><span class="linum" id="linum:1344">1344</span></a><span class="fringe" id="point:56522"> </span>                            (overline         <span class="builtin" id="font-lock:56568">:overline</span>  )
<a href="#linum:1345"><span class="linum" id="linum:1345">1345</span></a><span class="fringe" id="point:56581"> </span>                            (strike-through   <span class="builtin" id="font-lock:56627">:strike-through</span>)
<a href="#linum:1346"><span class="linum" id="linum:1346">1346</span></a><span class="fringe" id="point:56644"> </span>                            (box              <span class="builtin" id="font-lock:56690">:box</span>       )
<a href="#linum:1347"><span class="linum" id="linum:1347">1347</span></a><span class="fringe" id="point:56703"> </span>                            (foreground-color <span class="builtin" id="font-lock:56749">:foreground</span>)
<a href="#linum:1348"><span class="linum" id="linum:1348">1348</span></a><span class="fringe" id="point:56762"> </span>                            (background-color <span class="builtin" id="font-lock:56808">:background</span>)
<a href="#linum:1349"><span class="linum" id="linum:1349">1349</span></a><span class="fringe" id="point:56821"> </span>                            (bold             <span class="builtin" id="font-lock:56867">:bold</span>      )
<a href="#linum:1350"><span class="linum" id="linum:1350">1350</span></a><span class="fringe" id="point:56880"> </span>                            (italic           <span class="builtin" id="font-lock:56926">:italic</span>    )
<a href="#linum:1351"><span class="linum" id="linum:1351">1351</span></a><span class="fringe" id="point:56939"> </span>                            (t                 p)))
<a href="#linum:1352"><span class="linum" id="linum:1352">1352</span></a><span class="fringe" id="point:56991"> </span>                  (<span class="keyword" id="font-lock:57010">if</span> (memq p prop-seen) nil <span class="comment-delimiter" id="font-lock:57036">;; </span><span class="comment" id="font-lock:57039">noop
</span><a href="#linum:1353"><span class="linum" id="linum:1353">1353</span></a><span class="fringe" id="point:57044"> </span>                    (setq prop-seen   (cons p prop-seen)
<a href="#linum:1354"><span class="linum" id="linum:1354">1354</span></a><span class="fringe" id="point:57101"> </span>                          extra-props (cons p (cons v extra-props))))))))))
<a href="#linum:1355"><span class="linum" id="linum:1355">1355</span></a><span class="fringe" id="point:57177"> </span>      <span class="comment-delimiter" id="font-lock:57183">;;</span><span class="comment" id="font-lock:57185">(message "+ %d: %s; %S" p face-name extra-props)
</span><a href="#linum:1356"><span class="linum" id="linum:1356">1356</span></a><span class="fringe" id="point:57234"> </span>      (<span class="keyword" id="font-lock:57241">if</span> extra-props
<a href="#linum:1357"><span class="linum" id="linum:1357">1357</span></a><span class="fringe" id="point:57256"> </span>          (<span class="keyword" id="font-lock:57267">if</span> (listp face-name)
<a href="#linum:1358"><span class="linum" id="linum:1358">1358</span></a><span class="fringe" id="point:57288"> </span>              (nconc extra-props face-name)
<a href="#linum:1359"><span class="linum" id="linum:1359">1359</span></a><span class="fringe" id="point:57332"> </span>            (nconc extra-props (face-attr-construct face-name)))
<a href="#linum:1360"><span class="linum" id="linum:1360">1360</span></a><span class="fringe" id="point:57397"> </span>        face-name)) ))
<a href="#linum:1361"><span class="linum" id="linum:1361">1361</span></a><span class="fringe" id="point:57420"> </span>
<a href="#linum:1362"><span class="linum" id="linum:1362">1362</span></a><span class="fringe" id="point:57421"> </span>(<span class="keyword" id="font-lock:57422">defun</span> <span class="function-name" id="font-lock:57428">hfy-overlay-props-at</span> (p)
<a href="#linum:1363"><span class="linum" id="linum:1363">1363</span></a><span class="fringe" id="point:57453"> </span>  <span class="doc" id="font-lock:57455">"Grab overlay properties at point P.
</span><a href="#linum:1364"><span class="linum" id="linum:1364">1364</span></a><span class="fringe" id="point:57492"> </span><span class="doc" id="font-lock:57492">The plists are returned in descending priority order."</span>
<a href="#linum:1365"><span class="linum" id="linum:1365">1365</span></a><span class="fringe" id="point:57547"> </span>  (sort (mapcar #'overlay-properties (overlays-at p))
<a href="#linum:1366"><span class="linum" id="linum:1366">1366</span></a><span class="fringe" id="point:57601"> </span>        (<span class="keyword" id="font-lock:57610">lambda</span> (A B) (&gt; (or (cadr (memq 'priority A)) 0) <span class="comment-delimiter" id="font-lock:57659">;</span><span class="comment" id="font-lock:57660">FIXME: plist-get?
</span><a href="#linum:1367"><span class="linum" id="linum:1367">1367</span></a><span class="fringe" id="point:57678"> </span>                    (or (cadr (memq 'priority B)) 0)))))
<a href="#linum:1368"><span class="linum" id="linum:1368">1368</span></a><span class="fringe" id="point:57735"> </span>
<a href="#linum:1369"><span class="linum" id="linum:1369">1369</span></a><span class="fringe" id="point:57736"> </span><span class="comment-delimiter" id="font-lock:57736">;; </span><span class="comment" id="font-lock:57739">construct an assoc of (face-name . (css-name . "{ css-style }")) elements:
</span><a href="#linum:1370"><span class="linum" id="linum:1370">1370</span></a><span class="fringe" id="point:57814"> </span>(<span class="keyword" id="font-lock:57815">defun</span> <span class="function-name" id="font-lock:57821">hfy-compile-stylesheet</span> ()
<a href="#linum:1371"><span class="linum" id="linum:1371">1371</span></a><span class="fringe" id="point:57847"> </span>  <span class="doc" id="font-lock:57849">"Trawl the current buffer, construct and return a `</span><span class="doc" id="font-lock:57900"><span class="constant" id="font-lock:57900">hfy-sheet-assoc</span></span><span class="doc" id="font-lock:57915">'."</span>
<a href="#linum:1372"><span class="linum" id="linum:1372">1372</span></a><span class="fringe" id="point:57919"> </span>  <span class="comment-delimiter" id="font-lock:57921">;;</span><span class="comment" id="font-lock:57923">(message "hfy-compile-stylesheet");;DBUG
</span><a href="#linum:1373"><span class="linum" id="linum:1373">1373</span></a><span class="fringe" id="point:57964"> </span>  (<span class="keyword" id="font-lock:57967">let</span> ((pt (point-min))
<a href="#linum:1374"><span class="linum" id="linum:1374">1374</span></a><span class="fringe" id="point:57989"> </span>        <span class="comment-delimiter" id="font-lock:57997">;; </span><span class="comment" id="font-lock:58000">Make the font stack stay:
</span><a href="#linum:1375"><span class="linum" id="linum:1375">1375</span></a><span class="fringe" id="point:58026"> </span>        <span class="comment-delimiter" id="font-lock:58034">;;</span><span class="comment" id="font-lock:58036">(hfy-tmpfont-stack nil)
</span><a href="#linum:1376"><span class="linum" id="linum:1376">1376</span></a><span class="fringe" id="point:58060"> </span>        (fn         nil)
<a href="#linum:1377"><span class="linum" id="linum:1377">1377</span></a><span class="fringe" id="point:58085"> </span>        (style      nil))
<a href="#linum:1378"><span class="linum" id="linum:1378">1378</span></a><span class="fringe" id="point:58111"> </span>    (<span class="keyword" id="font-lock:58116">save-excursion</span>
<a href="#linum:1379"><span class="linum" id="linum:1379">1379</span></a><span class="fringe" id="point:58131"> </span>      (goto-char pt)
<a href="#linum:1380"><span class="linum" id="linum:1380">1380</span></a><span class="fringe" id="point:58152"> </span>      (<span class="keyword" id="font-lock:58159">while</span> (&lt; pt (point-max))
<a href="#linum:1381"><span class="linum" id="linum:1381">1381</span></a><span class="fringe" id="point:58184"> </span>        (<span class="keyword" id="font-lock:58193">if</span> (and (setq fn (hfy-face-at pt)) (not (assoc fn style)))
<a href="#linum:1382"><span class="linum" id="linum:1382">1382</span></a><span class="fringe" id="point:58252"> </span>            (push (cons fn (hfy-face-to-css fn)) style))
<a href="#linum:1383"><span class="linum" id="linum:1383">1383</span></a><span class="fringe" id="point:58309"> </span>        (setq pt (next-char-property-change pt))) )
<a href="#linum:1384"><span class="linum" id="linum:1384">1384</span></a><span class="fringe" id="point:58361"> </span>    (push (cons 'default (hfy-face-to-css 'default)) style)))
<a href="#linum:1385"><span class="linum" id="linum:1385">1385</span></a><span class="fringe" id="point:58423"> </span>
<a href="#linum:1386"><span class="linum" id="linum:1386">1386</span></a><span class="fringe" id="point:58424"> </span>(<span class="keyword" id="font-lock:58425">defun</span> <span class="function-name" id="font-lock:58431">hfy-fontified-p</span> ()
<a href="#linum:1387"><span class="linum" id="linum:1387">1387</span></a><span class="fringe" id="point:58450"> </span>  <span class="doc" id="font-lock:58452">"`</span><span class="doc" id="font-lock:58454"><span class="constant" id="font-lock:58454">font-lock</span></span><span class="doc" id="font-lock:58463">' doesn't like to say it's been fontified when in batch
</span><a href="#linum:1388"><span class="linum" id="linum:1388">1388</span></a><span class="fringe" id="point:58519"> </span><span class="doc" id="font-lock:58519">mode, but we want to know if we should fontify or raw copy, so in batch
</span><a href="#linum:1389"><span class="linum" id="linum:1389">1389</span></a><span class="fringe" id="point:58591"> </span><span class="doc" id="font-lock:58591">mode we check for non-default face properties.  Otherwise we test
</span><a href="#linum:1390"><span class="linum" id="linum:1390">1390</span></a><span class="fringe" id="point:58657"> </span><span class="doc" id="font-lock:58657">variable `</span><span class="doc" id="font-lock:58667"><span class="constant" id="font-lock:58667">font-lock-mode</span></span><span class="doc" id="font-lock:58681">' and variable `</span><span class="doc" id="font-lock:58697"><span class="constant" id="font-lock:58697">font-lock-fontified</span></span><span class="doc" id="font-lock:58716">' for truth."</span>
<a href="#linum:1391"><span class="linum" id="linum:1391">1391</span></a><span class="fringe" id="point:58730"> </span>  <span class="comment-delimiter" id="font-lock:58732">;;</span><span class="comment" id="font-lock:58734">(message "font-lock-fontified: %S" font-lock-fontified)
</span><a href="#linum:1392"><span class="linum" id="linum:1392">1392</span></a><span class="fringe" id="point:58790"> </span>  <span class="comment-delimiter" id="font-lock:58792">;;</span><span class="comment" id="font-lock:58794">(message "noninteractive     : %S" noninteractive)
</span><a href="#linum:1393"><span class="linum" id="linum:1393">1393</span></a><span class="fringe" id="point:58845"> </span>  <span class="comment-delimiter" id="font-lock:58847">;;</span><span class="comment" id="font-lock:58849">(message "font-lock-mode     : %S" font-lock-mode)
</span><a href="#linum:1394"><span class="linum" id="linum:1394">1394</span></a><span class="fringe" id="point:58900"> </span>  (and font-lock-fontified
<a href="#linum:1395"><span class="linum" id="linum:1395">1395</span></a><span class="fringe" id="point:58927"> </span>       (<span class="keyword" id="font-lock:58935">if</span> noninteractive
<a href="#linum:1396"><span class="linum" id="linum:1396">1396</span></a><span class="fringe" id="point:58953"> </span>           (<span class="keyword" id="font-lock:58965">let</span> ((pt  (point-min))
<a href="#linum:1397"><span class="linum" id="linum:1397">1397</span></a><span class="fringe" id="point:58988"> </span>                 (face-name   nil))
<a href="#linum:1398"><span class="linum" id="linum:1398">1398</span></a><span class="fringe" id="point:59024"> </span>             (<span class="keyword" id="font-lock:59038">save-excursion</span>
<a href="#linum:1399"><span class="linum" id="linum:1399">1399</span></a><span class="fringe" id="point:59053"> </span>               (goto-char pt)
<a href="#linum:1400"><span class="linum" id="linum:1400">1400</span></a><span class="fringe" id="point:59083"> </span>               (<span class="keyword" id="font-lock:59099">while</span> (and (&lt; pt (point-max)) (not face-name))
<a href="#linum:1401"><span class="linum" id="linum:1401">1401</span></a><span class="fringe" id="point:59146"> </span>                 (setq face-name (hfy-face-at pt))
<a href="#linum:1402"><span class="linum" id="linum:1402">1402</span></a><span class="fringe" id="point:59197"> </span>                 (setq pt (next-char-property-change pt)))) face-name)
<a href="#linum:1403"><span class="linum" id="linum:1403">1403</span></a><span class="fringe" id="point:59268"> </span>         font-lock-mode)))
<a href="#linum:1404"><span class="linum" id="linum:1404">1404</span></a><span class="fringe" id="point:59295"> </span>
<a href="#linum:1405"><span class="linum" id="linum:1405">1405</span></a><span class="fringe" id="point:59296"> </span><span class="comment-delimiter" id="font-lock:59296">;; </span><span class="comment" id="font-lock:59299">remember, the map is in reverse point order:
</span><a href="#linum:1406"><span class="linum" id="linum:1406">1406</span></a><span class="fringe" id="point:59344"> </span><span class="comment-delimiter" id="font-lock:59344">;; </span><span class="comment" id="font-lock:59347">I wrote this while suffering the effects of a cold, and maybe a
</span><a href="#linum:1407"><span class="linum" id="linum:1407">1407</span></a><span class="fringe" id="point:59411"> </span><span class="comment-delimiter" id="font-lock:59411">;; </span><span class="comment" id="font-lock:59414">mild fever - I think it's correct, but it might be a little warped
</span><a href="#linum:1408"><span class="linum" id="linum:1408">1408</span></a><span class="fringe" id="point:59481"> </span><span class="comment-delimiter" id="font-lock:59481">;; </span><span class="comment" id="font-lock:59484">as my minfd keeps ... where was I? Oh yes, the bunnies...
</span><a href="#linum:1409"><span class="linum" id="linum:1409">1409</span></a><span class="fringe" id="point:59542"> </span>(<span class="keyword" id="font-lock:59543">defun</span> <span class="function-name" id="font-lock:59549">hfy-merge-adjacent-spans</span> (face-map)
<a href="#linum:1410"><span class="linum" id="linum:1410">1410</span></a><span class="fringe" id="point:59585"> </span>  <span class="doc" id="font-lock:59587">"Where FACE-MAP is a `</span><span class="doc" id="font-lock:59609"><span class="constant" id="font-lock:59609">hfy-facemap-assoc</span></span><span class="doc" id="font-lock:59626">' for the current buffer,
</span><a href="#linum:1411"><span class="linum" id="linum:1411">1411</span></a><span class="fringe" id="point:59652"> </span><span class="doc" id="font-lock:59652">this function merges adjacent style blocks which are of the same value
</span><a href="#linum:1412"><span class="linum" id="linum:1412">1412</span></a><span class="fringe" id="point:59723"> </span><span class="doc" id="font-lock:59723">and are separated by nothing more interesting than whitespace.\n
</span><a href="#linum:1413"><span class="linum" id="linum:1413">1413</span></a><span class="fringe" id="point:59788"> </span><span class="doc" id="font-lock:59788">  &lt;span class=\"foo\"&gt;narf&lt;/span&gt; &lt;span class=\"foo\"&gt;brain&lt;/span&gt;\n
</span><a href="#linum:1414"><span class="linum" id="linum:1414">1414</span></a><span class="fringe" id="point:59857"> </span><span class="doc" id="font-lock:59857">\(as interpreted from FACE-MAP) would become:\n
</span><a href="#linum:1415"><span class="linum" id="linum:1415">1415</span></a><span class="fringe" id="point:59905"> </span><span class="doc" id="font-lock:59905">  &lt;span class=\"foo\"&gt;narf brain&lt;/span&gt;\n
</span><a href="#linum:1416"><span class="linum" id="linum:1416">1416</span></a><span class="fringe" id="point:59947"> </span><span class="doc" id="font-lock:59947">Returns a modified copy of FACE-MAP."</span>
<a href="#linum:1417"><span class="linum" id="linum:1417">1417</span></a><span class="fringe" id="point:59985"> </span>  (<span class="keyword" id="font-lock:59988">let</span> ((tmp-map face-map)
<a href="#linum:1418"><span class="linum" id="linum:1418">1418</span></a><span class="fringe" id="point:60012"> </span>        (map-buf      nil)
<a href="#linum:1419"><span class="linum" id="linum:1419">1419</span></a><span class="fringe" id="point:60039"> </span>        (first-start  nil)
<a href="#linum:1420"><span class="linum" id="linum:1420">1420</span></a><span class="fringe" id="point:60066"> </span>        (first-stop   nil)
<a href="#linum:1421"><span class="linum" id="linum:1421">1421</span></a><span class="fringe" id="point:60093"> </span>        (last-start   nil)
<a href="#linum:1422"><span class="linum" id="linum:1422">1422</span></a><span class="fringe" id="point:60120"> </span>        (last-stop    nil)
<a href="#linum:1423"><span class="linum" id="linum:1423">1423</span></a><span class="fringe" id="point:60147"> </span>        (span-stop    nil)
<a href="#linum:1424"><span class="linum" id="linum:1424">1424</span></a><span class="fringe" id="point:60174"> </span>        (span-start   nil)
<a href="#linum:1425"><span class="linum" id="linum:1425">1425</span></a><span class="fringe" id="point:60201"> </span>        (reduced-map  nil))
<a href="#linum:1426"><span class="linum" id="linum:1426">1426</span></a><span class="fringe" id="point:60229"> </span>    <span class="comment-delimiter" id="font-lock:60233">;;</span><span class="comment" id="font-lock:60235">(push (car  tmp-map) reduced-map)
</span><a href="#linum:1427"><span class="linum" id="linum:1427">1427</span></a><span class="fringe" id="point:60269"> </span>    <span class="comment-delimiter" id="font-lock:60273">;;</span><span class="comment" id="font-lock:60275">(push (cadr tmp-map) reduced-map)
</span><a href="#linum:1428"><span class="linum" id="linum:1428">1428</span></a><span class="fringe" id="point:60309"> </span>    (<span class="keyword" id="font-lock:60314">while</span> tmp-map
<a href="#linum:1429"><span class="linum" id="linum:1429">1429</span></a><span class="fringe" id="point:60328"> </span>      (setq first-start (cadddr tmp-map)
<a href="#linum:1430"><span class="linum" id="linum:1430">1430</span></a><span class="fringe" id="point:60369"> </span>            first-stop  (caddr  tmp-map)
<a href="#linum:1431"><span class="linum" id="linum:1431">1431</span></a><span class="fringe" id="point:60410"> </span>            last-start  (cadr   tmp-map)
<a href="#linum:1432"><span class="linum" id="linum:1432">1432</span></a><span class="fringe" id="point:60451"> </span>            last-stop   (car    tmp-map)
<a href="#linum:1433"><span class="linum" id="linum:1433">1433</span></a><span class="fringe" id="point:60492"> </span>            map-buf      tmp-map
<a href="#linum:1434"><span class="linum" id="linum:1434">1434</span></a><span class="fringe" id="point:60525"> </span>            span-start   last-start
<a href="#linum:1435"><span class="linum" id="linum:1435">1435</span></a><span class="fringe" id="point:60561"> </span>            span-stop    last-stop      )
<a href="#linum:1436"><span class="linum" id="linum:1436">1436</span></a><span class="fringe" id="point:60603"> </span>      (<span class="keyword" id="font-lock:60610">while</span> (and (equal (cdr first-start)
<a href="#linum:1437"><span class="linum" id="linum:1437">1437</span></a><span class="fringe" id="point:60646"> </span>                         (cdr  last-start))
<a href="#linum:1438"><span class="linum" id="linum:1438">1438</span></a><span class="fringe" id="point:60690"> </span>                  (<span class="keyword" id="font-lock:60709">save-excursion</span>
<a href="#linum:1439"><span class="linum" id="linum:1439">1439</span></a><span class="fringe" id="point:60724"> </span>                    (goto-char (car first-stop))
<a href="#linum:1440"><span class="linum" id="linum:1440">1440</span></a><span class="fringe" id="point:60773"> </span>                    (not (re-search-forward <span class="string" id="font-lock:60817">"[</span><span class="string" id="font-lock:60819"><span class="negation-char" id="font-lock:60819">^</span></span><span class="string" id="font-lock:60820"> \t\n\r]"</span> (car last-start) t))))
<a href="#linum:1441"><span class="linum" id="linum:1441">1441</span></a><span class="fringe" id="point:60853"> </span>        (setq map-buf     (cddr map-buf)
<a href="#linum:1442"><span class="linum" id="linum:1442">1442</span></a><span class="fringe" id="point:60894"> </span>              span-start  first-start
<a href="#linum:1443"><span class="linum" id="linum:1443">1443</span></a><span class="fringe" id="point:60932"> </span>              first-start (cadddr map-buf)
<a href="#linum:1444"><span class="linum" id="linum:1444">1444</span></a><span class="fringe" id="point:60975"> </span>              first-stop  (caddr  map-buf)
<a href="#linum:1445"><span class="linum" id="linum:1445">1445</span></a><span class="fringe" id="point:61018"> </span>              last-start  (cadr   map-buf)
<a href="#linum:1446"><span class="linum" id="linum:1446">1446</span></a><span class="fringe" id="point:61061"> </span>              last-stop   (car    map-buf)))
<a href="#linum:1447"><span class="linum" id="linum:1447">1447</span></a><span class="fringe" id="point:61106"> </span>      (push span-stop  reduced-map)
<a href="#linum:1448"><span class="linum" id="linum:1448">1448</span></a><span class="fringe" id="point:61142"> </span>      (push span-start reduced-map)
<a href="#linum:1449"><span class="linum" id="linum:1449">1449</span></a><span class="fringe" id="point:61178"> </span>      (setq tmp-map (memq last-start tmp-map))
<a href="#linum:1450"><span class="linum" id="linum:1450">1450</span></a><span class="fringe" id="point:61225"> </span>      (setq tmp-map (cdr tmp-map)))
<a href="#linum:1451"><span class="linum" id="linum:1451">1451</span></a><span class="fringe" id="point:61261"> </span>    (setq reduced-map (nreverse reduced-map))))
<a href="#linum:1452"><span class="linum" id="linum:1452">1452</span></a><span class="fringe" id="point:61309"> </span>
<a href="#linum:1453"><span class="linum" id="linum:1453">1453</span></a><span class="fringe" id="point:61310"> </span><span class="comment-delimiter" id="font-lock:61310">;; </span><span class="comment" id="font-lock:61313">remember to generate 'synthetic' &lt;/span&gt; entries -
</span><a href="#linum:1454"><span class="linum" id="linum:1454">1454</span></a><span class="fringe" id="point:61364"> </span><span class="comment-delimiter" id="font-lock:61364">;; </span><span class="comment" id="font-lock:61367">emacs copes by just having a stack of styles in effect
</span><a href="#linum:1455"><span class="linum" id="linum:1455">1455</span></a><span class="fringe" id="point:61422"> </span><span class="comment-delimiter" id="font-lock:61422">;; </span><span class="comment" id="font-lock:61425">and only using the top one: html has a more simplistic approach -
</span><a href="#linum:1456"><span class="linum" id="linum:1456">1456</span></a><span class="fringe" id="point:61491"> </span><span class="comment-delimiter" id="font-lock:61491">;; </span><span class="comment" id="font-lock:61494">we have to explicitly end a style, there's no way of temporarily
</span><a href="#linum:1457"><span class="linum" id="linum:1457">1457</span></a><span class="fringe" id="point:61559"> </span><span class="comment-delimiter" id="font-lock:61559">;; </span><span class="comment" id="font-lock:61562">overriding it w. another one... (afaik)
</span><a href="#linum:1458"><span class="linum" id="linum:1458">1458</span></a><span class="fringe" id="point:61602"> </span>(<span class="keyword" id="font-lock:61603">defun</span> <span class="function-name" id="font-lock:61609">hfy-compile-face-map</span> ()
<a href="#linum:1459"><span class="linum" id="linum:1459">1459</span></a><span class="fringe" id="point:61633"> </span><span class="comment-delimiter" id="font-lock:61633">;; </span><span class="comment" id="font-lock:61636">no need for special &lt;a&gt; version.
</span><a href="#linum:1460"><span class="linum" id="linum:1460">1460</span></a><span class="fringe" id="point:61669"> </span><span class="comment-delimiter" id="font-lock:61669">;; </span><span class="comment" id="font-lock:61672">IME hyperlinks don't get underlined, esp when you htmlfontify a whole
</span><a href="#linum:1461"><span class="linum" id="linum:1461">1461</span></a><span class="fringe" id="point:61742"> </span><span class="comment-delimiter" id="font-lock:61742">;; </span><span class="comment" id="font-lock:61745">source tree, so the &lt;a&gt; version is needed -- v
</span><a href="#linum:1462"><span class="linum" id="linum:1462">1462</span></a><span class="fringe" id="point:61792"> </span><span class="comment-delimiter" id="font-lock:61792">;; </span><span class="comment" id="font-lock:61795">Fix-me: save table for multi-buffer
</span><a href="#linum:1463"><span class="linum" id="linum:1463">1463</span></a><span class="fringe" id="point:61831"> </span>  <span class="doc" id="font-lock:61833">"Compile and return a `</span><span class="doc" id="font-lock:61856"><span class="constant" id="font-lock:61856">hfy-facemap-assoc</span></span><span class="doc" id="font-lock:61873">' for the current buffer."</span>
<a href="#linum:1464"><span class="linum" id="linum:1464">1464</span></a><span class="fringe" id="point:61900"> </span>  <span class="comment-delimiter" id="font-lock:61902">;;</span><span class="comment" id="font-lock:61904">(message "hfy-compile-face-map");;DBUG
</span><a href="#linum:1465"><span class="linum" id="linum:1465">1465</span></a><span class="fringe" id="point:61943"> </span>  (<span class="keyword" id="font-lock:61946">let</span> ((pt (point-min))
<a href="#linum:1466"><span class="linum" id="linum:1466">1466</span></a><span class="fringe" id="point:61968"> </span>        (pt-narrow  1)
<a href="#linum:1467"><span class="linum" id="linum:1467">1467</span></a><span class="fringe" id="point:61991"> </span>        (fn         nil)
<a href="#linum:1468"><span class="linum" id="linum:1468">1468</span></a><span class="fringe" id="point:62016"> </span>        (map        nil)
<a href="#linum:1469"><span class="linum" id="linum:1469">1469</span></a><span class="fringe" id="point:62041"> </span>        (prev-tag   nil)) <span class="comment-delimiter" id="font-lock:62067">;; </span><span class="comment" id="font-lock:62070">t   if the last tag-point was a span-start
</span><a href="#linum:1470"><span class="linum" id="linum:1470">1470</span></a><span class="fringe" id="point:62113"> </span>                          <span class="comment-delimiter" id="font-lock:62139">;; </span><span class="comment" id="font-lock:62142">nil if it was a span-stop
</span><a href="#linum:1471"><span class="linum" id="linum:1471">1471</span></a><span class="fringe" id="point:62168"> </span>    (<span class="keyword" id="font-lock:62173">save-excursion</span>
<a href="#linum:1472"><span class="linum" id="linum:1472">1472</span></a><span class="fringe" id="point:62188"> </span>      (goto-char pt)
<a href="#linum:1473"><span class="linum" id="linum:1473">1473</span></a><span class="fringe" id="point:62209"> </span>      (<span class="keyword" id="font-lock:62216">while</span> (&lt; pt (point-max))
<a href="#linum:1474"><span class="linum" id="linum:1474">1474</span></a><span class="fringe" id="point:62241"> </span>        (<span class="keyword" id="font-lock:62250">if</span> (setq fn (hfy-face-at pt))
<a href="#linum:1475"><span class="linum" id="linum:1475">1475</span></a><span class="fringe" id="point:62280"> </span>            (<span class="keyword" id="font-lock:62293">progn</span> (<span class="keyword" id="font-lock:62300">if</span> prev-tag (push (cons pt-narrow 'end) map))
<a href="#linum:1476"><span class="linum" id="linum:1476">1476</span></a><span class="fringe" id="point:62346"> </span>                   (push (cons pt-narrow fn) map)
<a href="#linum:1477"><span class="linum" id="linum:1477">1477</span></a><span class="fringe" id="point:62396"> </span>                   (setq prev-tag t))
<a href="#linum:1478"><span class="linum" id="linum:1478">1478</span></a><span class="fringe" id="point:62434"> </span>          (<span class="keyword" id="font-lock:62445">if</span> prev-tag (push (cons pt-narrow 'end) map))
<a href="#linum:1479"><span class="linum" id="linum:1479">1479</span></a><span class="fringe" id="point:62491"> </span>          (setq prev-tag nil))
<a href="#linum:1480"><span class="linum" id="linum:1480">1480</span></a><span class="fringe" id="point:62522"> </span>        (setq pt (next-char-property-change pt))
<a href="#linum:1481"><span class="linum" id="linum:1481">1481</span></a><span class="fringe" id="point:62571"> </span>        (setq pt-narrow (1+ (- pt (point-min)))))
<a href="#linum:1482"><span class="linum" id="linum:1482">1482</span></a><span class="fringe" id="point:62621"> </span>      (<span class="keyword" id="font-lock:62628">if</span> (and map (not (eq 'end (cdar map))))
<a href="#linum:1483"><span class="linum" id="linum:1483">1483</span></a><span class="fringe" id="point:62668"> </span>          (push (cons (- (point-max) (point-min)) 'end) map)))
<a href="#linum:1484"><span class="linum" id="linum:1484">1484</span></a><span class="fringe" id="point:62731"> </span>    (<span class="keyword" id="font-lock:62736">if</span> (hfy-opt 'merge-adjacent-tags) (hfy-merge-adjacent-spans map) map)))
<a href="#linum:1485"><span class="linum" id="linum:1485">1485</span></a><span class="fringe" id="point:62808"> </span>
<a href="#linum:1486"><span class="linum" id="linum:1486">1486</span></a><span class="fringe" id="point:62809"> </span>(<span class="keyword" id="font-lock:62810">defun</span> <span class="function-name" id="font-lock:62816">hfy-buffer</span> ()
<a href="#linum:1487"><span class="linum" id="linum:1487">1487</span></a><span class="fringe" id="point:62830"> </span>  <span class="doc" id="font-lock:62832">"Generate a buffer to hold the HTML output.
</span><a href="#linum:1488"><span class="linum" id="linum:1488">1488</span></a><span class="fringe" id="point:62876"> </span><span class="doc" id="font-lock:62876">The filename of this buffer is derived from the source (current) buffer's
</span><a href="#linum:1489"><span class="linum" id="linum:1489">1489</span></a><span class="fringe" id="point:62950"> </span><span class="doc" id="font-lock:62950">variable `</span><span class="doc" id="font-lock:62960"><span class="constant" id="font-lock:62960">buffer-file-name</span></span><span class="doc" id="font-lock:62976">', if it is set, plus `</span><span class="doc" id="font-lock:62999"><span class="constant" id="font-lock:62999">hfy-extn</span></span><span class="doc" id="font-lock:63007">'.
</span><a href="#linum:1490"><span class="linum" id="linum:1490">1490</span></a><span class="fringe" id="point:63010"> </span><span class="doc" id="font-lock:63010">Otherwise a plausible filename is constructed from `</span><span class="doc" id="font-lock:63062"><span class="constant" id="font-lock:63062">default-directory</span></span><span class="doc" id="font-lock:63079">',
</span><a href="#linum:1491"><span class="linum" id="linum:1491">1491</span></a><span class="fringe" id="point:63082"> </span><span class="doc" id="font-lock:63082">`</span><span class="doc" id="font-lock:63083"><span class="constant" id="font-lock:63083">buffer-name</span></span><span class="doc" id="font-lock:63094">' and `</span><span class="doc" id="font-lock:63101"><span class="constant" id="font-lock:63101">hfy-extn</span></span><span class="doc" id="font-lock:63109">'."</span>
<a href="#linum:1492"><span class="linum" id="linum:1492">1492</span></a><span class="fringe" id="point:63113"> </span>  (<span class="keyword" id="font-lock:63116">let*</span> ((name (concat (buffer-name) hfy-extn))
<a href="#linum:1493"><span class="linum" id="linum:1493">1493</span></a><span class="fringe" id="point:63161"> </span>         (src               (buffer-file-name))
<a href="#linum:1494"><span class="linum" id="linum:1494">1494</span></a><span class="fringe" id="point:63209"> </span>         (buf  (get-buffer-create        name)))
<a href="#linum:1495"><span class="linum" id="linum:1495">1495</span></a><span class="fringe" id="point:63258"> </span>    (<span class="keyword" id="font-lock:63263">with-current-buffer</span> buf
<a href="#linum:1496"><span class="linum" id="linum:1496">1496</span></a><span class="fringe" id="point:63287"> </span>      (setq buffer-file-name
<a href="#linum:1497"><span class="linum" id="linum:1497">1497</span></a><span class="fringe" id="point:63316"> </span>            (<span class="keyword" id="font-lock:63329">if</span> src (concat src hfy-extn)
<a href="#linum:1498"><span class="linum" id="linum:1498">1498</span></a><span class="fringe" id="point:63358"> </span>              (expand-file-name (<span class="keyword" id="font-lock:63391">if</span> (string-match <span class="string" id="font-lock:63408">"^.*/</span><span class="string" id="font-lock:63413"><span class="regexp-grouping-backslash" id="font-lock:63413">\\</span></span><span class="string" id="font-lock:63415"><span class="regexp-grouping-construct" id="font-lock:63415">(</span></span><span class="string" id="font-lock:63416">[</span><span class="string" id="font-lock:63417"><span class="negation-char" id="font-lock:63417">^</span></span><span class="string" id="font-lock:63418">/]*</span><span class="string" id="font-lock:63421"><span class="regexp-grouping-backslash" id="font-lock:63421">\\</span></span><span class="string" id="font-lock:63423"><span class="regexp-grouping-construct" id="font-lock:63423">)</span></span><span class="string" id="font-lock:63424">$"</span> name)
<a href="#linum:1499"><span class="linum" id="linum:1499">1499</span></a><span class="fringe" id="point:63433"> </span>                                    (match-string 1 name)
<a href="#linum:1500"><span class="linum" id="linum:1500">1500</span></a><span class="fringe" id="point:63491"> </span>                                  name))))
<a href="#linum:1501"><span class="linum" id="linum:1501">1501</span></a><span class="fringe" id="point:63534"> </span>      buf)))
<a href="#linum:1502"><span class="linum" id="linum:1502">1502</span></a><span class="fringe" id="point:63547"> </span>
<a href="#linum:1503"><span class="linum" id="linum:1503">1503</span></a><span class="fringe" id="point:63548"> </span>(<span class="keyword" id="font-lock:63549">defun</span> <span class="function-name" id="font-lock:63555">hfy-lookup</span> (face style)
<a href="#linum:1504"><span class="linum" id="linum:1504">1504</span></a><span class="fringe" id="point:63579"> </span>  <span class="doc" id="font-lock:63581">"Get a CSS style name for FACE from STYLE."</span>
<a href="#linum:1505"><span class="linum" id="linum:1505">1505</span></a><span class="fringe" id="point:63625"> </span>  (cadr (assoc face style)))
<a href="#linum:1506"><span class="linum" id="linum:1506">1506</span></a><span class="fringe" id="point:63654"> </span>
<a href="#linum:1507"><span class="linum" id="linum:1507">1507</span></a><span class="fringe" id="point:63655"> </span>(<span class="keyword" id="font-lock:63656">defun</span> <span class="function-name" id="font-lock:63662">hfy-link-style</span> (style-string)
<a href="#linum:1508"><span class="linum" id="linum:1508">1508</span></a><span class="fringe" id="point:63692"> </span>  <span class="doc" id="font-lock:63694">"Copy, alter and return a STYLE-STRING to make it suitable for a hyperlink.
</span><a href="#linum:1509"><span class="linum" id="linum:1509">1509</span></a><span class="fringe" id="point:63770"> </span><span class="doc" id="font-lock:63770">Uses `</span><span class="doc" id="font-lock:63776"><span class="constant" id="font-lock:63776">hfy-link-style-fun</span></span><span class="doc" id="font-lock:63794">' to do this."</span>
<a href="#linum:1510"><span class="linum" id="linum:1510">1510</span></a><span class="fringe" id="point:63809"> </span>  (<span class="keyword" id="font-lock:63812">if</span> (functionp hfy-link-style-fun)
<a href="#linum:1511"><span class="linum" id="linum:1511">1511</span></a><span class="fringe" id="point:63846"> </span>      (funcall hfy-link-style-fun style-string)
<a href="#linum:1512"><span class="linum" id="linum:1512">1512</span></a><span class="fringe" id="point:63894"> </span>    style-string))
<a href="#linum:1513"><span class="linum" id="linum:1513">1513</span></a><span class="fringe" id="point:63913"> </span>
<a href="#linum:1514"><span class="linum" id="linum:1514">1514</span></a><span class="fringe" id="point:63914"> </span>(<span class="keyword" id="font-lock:63915">defun</span> <span class="function-name" id="font-lock:63921">hfy-sprintf-stylesheet</span> (css file)
<a href="#linum:1515"><span class="linum" id="linum:1515">1515</span></a><span class="fringe" id="point:63955"> </span>  <span class="doc" id="font-lock:63957">"Return the inline CSS style sheet for FILE as a string."</span>
<a href="#linum:1516"><span class="linum" id="linum:1516">1516</span></a><span class="fringe" id="point:64015"> </span>  (<span class="keyword" id="font-lock:64018">let</span> ((stylesheet nil))
<a href="#linum:1517"><span class="linum" id="linum:1517">1517</span></a><span class="fringe" id="point:64041"> </span>    (setq stylesheet
<a href="#linum:1518"><span class="linum" id="linum:1518">1518</span></a><span class="fringe" id="point:64062"> </span>          (concat
<a href="#linum:1519"><span class="linum" id="linum:1519">1519</span></a><span class="fringe" id="point:64080"> </span>           hfy-meta-tags
<a href="#linum:1520"><span class="linum" id="linum:1520">1520</span></a><span class="fringe" id="point:64105"> </span>           <span class="string" id="font-lock:64116">"\n&lt;style type=\"text/css\"&gt;&lt;!-- \n"</span>
<a href="#linum:1521"><span class="linum" id="linum:1521">1521</span></a><span class="fringe" id="point:64153"> </span>           <span class="comment-delimiter" id="font-lock:64164">;; </span><span class="comment" id="font-lock:64167">Fix-me: Add handling of page breaks here + scan for ^L
</span><a href="#linum:1522"><span class="linum" id="linum:1522">1522</span></a><span class="fringe" id="point:64222"> </span>           <span class="comment-delimiter" id="font-lock:64233">;; </span><span class="comment" id="font-lock:64236">where appropriate.
</span><a href="#linum:1523"><span class="linum" id="linum:1523">1523</span></a><span class="fringe" id="point:64255"> </span>           (format <span class="string" id="font-lock:64274">"body %s\n"</span> (cddr (assq 'default css)))
<a href="#linum:1524"><span class="linum" id="linum:1524">1524</span></a><span class="fringe" id="point:64314"> </span>           (apply 'concat
<a href="#linum:1525"><span class="linum" id="linum:1525">1525</span></a><span class="fringe" id="point:64340"> </span>                  (mapcar
<a href="#linum:1526"><span class="linum" id="linum:1526">1526</span></a><span class="fringe" id="point:64366"> </span>                   (<span class="keyword" id="font-lock:64386">lambda</span> (style)
<a href="#linum:1527"><span class="linum" id="linum:1527">1527</span></a><span class="fringe" id="point:64401"> </span>                     (format
<a href="#linum:1528"><span class="linum" id="linum:1528">1528</span></a><span class="fringe" id="point:64430"> </span>                      <span class="string" id="font-lock:64452">"span.%s   %s\nspan.%s a %s\n"</span>
<a href="#linum:1529"><span class="linum" id="linum:1529">1529</span></a><span class="fringe" id="point:64483"> </span>                      (cadr style) (cddr style)
<a href="#linum:1530"><span class="linum" id="linum:1530">1530</span></a><span class="fringe" id="point:64531"> </span>                      (cadr style) (hfy-link-style (cddr style))))
<a href="#linum:1531"><span class="linum" id="linum:1531">1531</span></a><span class="fringe" id="point:64598"> </span>                   css))
<a href="#linum:1532"><span class="linum" id="linum:1532">1532</span></a><span class="fringe" id="point:64623"> </span>           <span class="string" id="font-lock:64634">" --&gt;&lt;/style&gt;\n"</span>))
<a href="#linum:1533"><span class="linum" id="linum:1533">1533</span></a><span class="fringe" id="point:64653"> </span>    (funcall hfy-page-header file stylesheet)))
<a href="#linum:1534"><span class="linum" id="linum:1534">1534</span></a><span class="fringe" id="point:64701"> </span>
<a href="#linum:1535"><span class="linum" id="linum:1535">1535</span></a><span class="fringe" id="point:64702"> </span><span class="comment-delimiter" id="font-lock:64702">;; </span><span class="comment" id="font-lock:64705">tag all the dangerous characters we want to escape
</span><a href="#linum:1536"><span class="linum" id="linum:1536">1536</span></a><span class="fringe" id="point:64756"> </span><span class="comment-delimiter" id="font-lock:64756">;; </span><span class="comment" id="font-lock:64759">(ie any "&lt;&gt; chars we _didn't_ put there explicitly for css markup)
</span><a href="#linum:1537"><span class="linum" id="linum:1537">1537</span></a><span class="fringe" id="point:64826"> </span>(<span class="keyword" id="font-lock:64827">defun</span> <span class="function-name" id="font-lock:64833">hfy-html-enkludge-buffer</span> ()
<a href="#linum:1538"><span class="linum" id="linum:1538">1538</span></a><span class="fringe" id="point:64861"> </span>  <span class="doc" id="font-lock:64863">"Mark dangerous [\"&lt;&gt;] characters with the `</span><span class="doc" id="font-lock:64907"><span class="constant" id="font-lock:64907">hfy-quoteme</span></span><span class="doc" id="font-lock:64918">' property.\n
</span><a href="#linum:1539"><span class="linum" id="linum:1539">1539</span></a><span class="fringe" id="point:64932"> </span><span class="doc" id="font-lock:64932">See also `</span><span class="doc" id="font-lock:64942"><span class="constant" id="font-lock:64942">hfy-html-dekludge-buffer</span></span><span class="doc" id="font-lock:64966">'."</span>
<a href="#linum:1540"><span class="linum" id="linum:1540">1540</span></a><span class="fringe" id="point:64970"> </span>  <span class="comment-delimiter" id="font-lock:64972">;;</span><span class="comment" id="font-lock:64974">(message "hfy-html-enkludge-buffer");;DBUG
</span><a href="#linum:1541"><span class="linum" id="linum:1541">1541</span></a><span class="fringe" id="point:65017"> </span>  (<span class="keyword" id="font-lock:65020">save-excursion</span>
<a href="#linum:1542"><span class="linum" id="linum:1542">1542</span></a><span class="fringe" id="point:65035"> </span>    (goto-char (point-min))
<a href="#linum:1543"><span class="linum" id="linum:1543">1543</span></a><span class="fringe" id="point:65063"> </span>    (<span class="keyword" id="font-lock:65068">while</span> (re-search-forward hfy-html-quote-regex nil t)
<a href="#linum:1544"><span class="linum" id="linum:1544">1544</span></a><span class="fringe" id="point:65121"> </span>      (put-text-property (match-beginning 0) (point) 'hfy-quoteme t))) )
<a href="#linum:1545"><span class="linum" id="linum:1545">1545</span></a><span class="fringe" id="point:65194"> </span>
<a href="#linum:1546"><span class="linum" id="linum:1546">1546</span></a><span class="fringe" id="point:65195"> </span><span class="comment-delimiter" id="font-lock:65195">;; </span><span class="comment" id="font-lock:65198">dangerous char -&gt; &amp;entity;
</span><a href="#linum:1547"><span class="linum" id="linum:1547">1547</span></a><span class="fringe" id="point:65225"> </span>(<span class="keyword" id="font-lock:65226">defun</span> <span class="function-name" id="font-lock:65232">hfy-html-quote</span> (char-string)
<a href="#linum:1548"><span class="linum" id="linum:1548">1548</span></a><span class="fringe" id="point:65261"> </span>  <span class="doc" id="font-lock:65263">"Map CHAR-STRING to an HTML safe string (entity) if need be."</span>
<a href="#linum:1549"><span class="linum" id="linum:1549">1549</span></a><span class="fringe" id="point:65325"> </span>  <span class="comment-delimiter" id="font-lock:65327">;;</span><span class="comment" id="font-lock:65329">(message "hfy-html-quote");;DBUG
</span><a href="#linum:1550"><span class="linum" id="linum:1550">1550</span></a><span class="fringe" id="point:65362"> </span>  (or (cadr (assoc char-string hfy-html-quote-map)) char-string) )
<a href="#linum:1551"><span class="linum" id="linum:1551">1551</span></a><span class="fringe" id="point:65429"> </span>
<a href="#linum:1552"><span class="linum" id="linum:1552">1552</span></a><span class="fringe" id="point:65430"> </span><span class="comment-delimiter" id="font-lock:65430">;; </span><span class="comment" id="font-lock:65433">actually entity-ise dangerous chars.
</span><a href="#linum:1553"><span class="linum" id="linum:1553">1553</span></a><span class="fringe" id="point:65470"> </span><span class="comment-delimiter" id="font-lock:65470">;; </span><span class="comment" id="font-lock:65473">note that we can't do this until _after_ we have inserted the css
</span><a href="#linum:1554"><span class="linum" id="linum:1554">1554</span></a><span class="fringe" id="point:65539"> </span><span class="comment-delimiter" id="font-lock:65539">;; </span><span class="comment" id="font-lock:65542">markup, since we use a position-based map to insert this, and if we
</span><a href="#linum:1555"><span class="linum" id="linum:1555">1555</span></a><span class="fringe" id="point:65610"> </span><span class="comment-delimiter" id="font-lock:65610">;; </span><span class="comment" id="font-lock:65613">enter any other text before we do this, we'd have to track another
</span><a href="#linum:1556"><span class="linum" id="linum:1556">1556</span></a><span class="fringe" id="point:65680"> </span><span class="comment-delimiter" id="font-lock:65680">;; </span><span class="comment" id="font-lock:65683">map of offsets, which would be tedious...
</span><a href="#linum:1557"><span class="linum" id="linum:1557">1557</span></a><span class="fringe" id="point:65725"> </span>(<span class="keyword" id="font-lock:65726">defun</span> <span class="function-name" id="font-lock:65732">hfy-html-dekludge-buffer</span> ()
<a href="#linum:1558"><span class="linum" id="linum:1558">1558</span></a><span class="fringe" id="point:65760"> </span>  <span class="doc" id="font-lock:65762">"Transform all dangerous characters marked with the `</span><span class="doc" id="font-lock:65815"><span class="constant" id="font-lock:65815">hfy-quoteme</span></span><span class="doc" id="font-lock:65826">' property
</span><a href="#linum:1559"><span class="linum" id="linum:1559">1559</span></a><span class="fringe" id="point:65837"> </span><span class="doc" id="font-lock:65837">using `</span><span class="doc" id="font-lock:65844"><span class="constant" id="font-lock:65844">hfy-html-quote</span></span><span class="doc" id="font-lock:65858">'.\n
</span><a href="#linum:1560"><span class="linum" id="linum:1560">1560</span></a><span class="fringe" id="point:65863"> </span><span class="doc" id="font-lock:65863">See also `</span><span class="doc" id="font-lock:65873"><span class="constant" id="font-lock:65873">hfy-html-enkludge-buffer</span></span><span class="doc" id="font-lock:65897">'."</span>
<a href="#linum:1561"><span class="linum" id="linum:1561">1561</span></a><span class="fringe" id="point:65901"> </span>  <span class="comment-delimiter" id="font-lock:65903">;;</span><span class="comment" id="font-lock:65905">(message "hfy-html-dekludge-buffer");;DBUG
</span><a href="#linum:1562"><span class="linum" id="linum:1562">1562</span></a><span class="fringe" id="point:65948"> </span>  (<span class="keyword" id="font-lock:65951">save-excursion</span>
<a href="#linum:1563"><span class="linum" id="linum:1563">1563</span></a><span class="fringe" id="point:65966"> </span>    (goto-char (point-min))
<a href="#linum:1564"><span class="linum" id="linum:1564">1564</span></a><span class="fringe" id="point:65994"> </span>    (<span class="keyword" id="font-lock:65999">while</span> (re-search-forward hfy-html-quote-regex nil t)
<a href="#linum:1565"><span class="linum" id="linum:1565">1565</span></a><span class="fringe" id="point:66052"> </span>      (<span class="keyword" id="font-lock:66059">if</span> (get-text-property (match-beginning 0) 'hfy-quoteme)
<a href="#linum:1566"><span class="linum" id="linum:1566">1566</span></a><span class="fringe" id="point:66115"> </span>          (replace-match (hfy-html-quote (match-string 1))) )) ))
<a href="#linum:1567"><span class="linum" id="linum:1567">1567</span></a><span class="fringe" id="point:66181"> </span>
<a href="#linum:1568"><span class="linum" id="linum:1568">1568</span></a><span class="fringe" id="point:66182"> </span><span class="comment-delimiter" id="font-lock:66182">;; </span><span class="comment" id="font-lock:66185">Borrowed from font-lock.el
</span><a href="#linum:1569"><span class="linum" id="linum:1569">1569</span></a><span class="fringe" id="point:66212"> </span>(<span class="keyword" id="font-lock:66213">defmacro</span> <span class="function-name" id="font-lock:66222">hfy-save-buffer-state</span> (varlist <span class="type" id="font-lock:66253">&amp;rest</span> body)
<a href="#linum:1570"><span class="linum" id="linum:1570">1570</span></a><span class="fringe" id="point:66265"> </span>  <span class="doc" id="font-lock:66267">"Bind variables according to VARLIST and eval BODY restoring buffer state.
</span><a href="#linum:1571"><span class="linum" id="linum:1571">1571</span></a><span class="fringe" id="point:66342"> </span><span class="doc" id="font-lock:66342">Do not record undo information during evaluation of BODY."</span>
<a href="#linum:1572"><span class="linum" id="linum:1572">1572</span></a><span class="fringe" id="point:66401"> </span>  (<span class="keyword" id="font-lock:66404">declare</span> (indent 1) (debug let))
<a href="#linum:1573"><span class="linum" id="linum:1573">1573</span></a><span class="fringe" id="point:66436"> </span>  (<span class="keyword" id="font-lock:66439">let</span> ((modified (make-symbol <span class="string" id="font-lock:66467">"modified"</span>)))
<a href="#linum:1574"><span class="linum" id="linum:1574">1574</span></a><span class="fringe" id="point:66481"> </span>    `(<span class="keyword" id="font-lock:66487">let*</span> ,(append varlist
<a href="#linum:1575"><span class="linum" id="linum:1575">1575</span></a><span class="fringe" id="point:66509"> </span>                    `((,modified (buffer-modified-p))
<a href="#linum:1576"><span class="linum" id="linum:1576">1576</span></a><span class="fringe" id="point:66563"> </span>                      (buffer-undo-list t)
<a href="#linum:1577"><span class="linum" id="linum:1577">1577</span></a><span class="fringe" id="point:66606"> </span>                      (inhibit-read-only t)
<a href="#linum:1578"><span class="linum" id="linum:1578">1578</span></a><span class="fringe" id="point:66650"> </span>                      (inhibit-point-motion-hooks t)
<a href="#linum:1579"><span class="linum" id="linum:1579">1579</span></a><span class="fringe" id="point:66703"> </span>                      (inhibit-modification-hooks t)
<a href="#linum:1580"><span class="linum" id="linum:1580">1580</span></a><span class="fringe" id="point:66756"> </span>                      deactivate-mark
<a href="#linum:1581"><span class="linum" id="linum:1581">1581</span></a><span class="fringe" id="point:66794"> </span>                      buffer-file-name
<a href="#linum:1582"><span class="linum" id="linum:1582">1582</span></a><span class="fringe" id="point:66833"> </span>                      buffer-file-truename))
<a href="#linum:1583"><span class="linum" id="linum:1583">1583</span></a><span class="fringe" id="point:66878"> </span>       (<span class="keyword" id="font-lock:66886">progn</span>
<a href="#linum:1584"><span class="linum" id="linum:1584">1584</span></a><span class="fringe" id="point:66892"> </span>         ,@body)
<a href="#linum:1585"><span class="linum" id="linum:1585">1585</span></a><span class="fringe" id="point:66909"> </span>       (<span class="keyword" id="font-lock:66917">unless</span> ,modified
<a href="#linum:1586"><span class="linum" id="linum:1586">1586</span></a><span class="fringe" id="point:66934"> </span>         (restore-buffer-modified-p nil)))))
<a href="#linum:1587"><span class="linum" id="linum:1587">1587</span></a><span class="fringe" id="point:66979"> </span>
<a href="#linum:1588"><span class="linum" id="linum:1588">1588</span></a><span class="fringe" id="point:66980"> </span>(<span class="keyword" id="font-lock:66981">defun</span> <span class="function-name" id="font-lock:66987">hfy-mark-trailing-whitespace</span> ()
<a href="#linum:1589"><span class="linum" id="linum:1589">1589</span></a><span class="fringe" id="point:67019"> </span>  <span class="doc" id="font-lock:67021">"Tag trailing whitespace with a hfy property if it is currently highlighted."</span>
<a href="#linum:1590"><span class="linum" id="linum:1590">1590</span></a><span class="fringe" id="point:67099"> </span>  (<span class="keyword" id="font-lock:67102">when</span> show-trailing-whitespace
<a href="#linum:1591"><span class="linum" id="linum:1591">1591</span></a><span class="fringe" id="point:67132"> </span>    (<span class="keyword" id="font-lock:67137">let</span> ((inhibit-read-only t))
<a href="#linum:1592"><span class="linum" id="linum:1592">1592</span></a><span class="fringe" id="point:67165"> </span>      (<span class="keyword" id="font-lock:67172">save-excursion</span>
<a href="#linum:1593"><span class="linum" id="linum:1593">1593</span></a><span class="fringe" id="point:67187"> </span>        (goto-char (point-min))
<a href="#linum:1594"><span class="linum" id="linum:1594">1594</span></a><span class="fringe" id="point:67219"> </span>        (hfy-save-buffer-state nil
<a href="#linum:1595"><span class="linum" id="linum:1595">1595</span></a><span class="fringe" id="point:67254"> </span>          (<span class="keyword" id="font-lock:67265">while</span> (re-search-forward <span class="string" id="font-lock:67290">"[ \t]+$"</span> nil t)
<a href="#linum:1596"><span class="linum" id="linum:1596">1596</span></a><span class="fringe" id="point:67307"> </span>            (put-text-property (match-beginning 0) (match-end 0)
<a href="#linum:1597"><span class="linum" id="linum:1597">1597</span></a><span class="fringe" id="point:67372"> </span>                                   'hfy-show-trailing-whitespace t)))))))
<a href="#linum:1598"><span class="linum" id="linum:1598">1598</span></a><span class="fringe" id="point:67446"> </span>
<a href="#linum:1599"><span class="linum" id="linum:1599">1599</span></a><span class="fringe" id="point:67447"> </span>(<span class="keyword" id="font-lock:67448">defun</span> <span class="function-name" id="font-lock:67454">hfy-unmark-trailing-whitespace</span> ()
<a href="#linum:1600"><span class="linum" id="linum:1600">1600</span></a><span class="fringe" id="point:67488"> </span>  <span class="doc" id="font-lock:67490">"Undo the effect of `</span><span class="doc" id="font-lock:67511"><span class="constant" id="font-lock:67511">hfy-mark-trailing-whitespace</span></span><span class="doc" id="font-lock:67539">'."</span>
<a href="#linum:1601"><span class="linum" id="linum:1601">1601</span></a><span class="fringe" id="point:67543"> </span>  (<span class="keyword" id="font-lock:67546">when</span> show-trailing-whitespace
<a href="#linum:1602"><span class="linum" id="linum:1602">1602</span></a><span class="fringe" id="point:67576"> </span>    (hfy-save-buffer-state nil
<a href="#linum:1603"><span class="linum" id="linum:1603">1603</span></a><span class="fringe" id="point:67607"> </span>      (remove-text-properties (point-min) (point-max)
<a href="#linum:1604"><span class="linum" id="linum:1604">1604</span></a><span class="fringe" id="point:67661"> </span>                              '(hfy-show-trailing-whitespace)))))
<a href="#linum:1605"><span class="linum" id="linum:1605">1605</span></a><span class="fringe" id="point:67727"> </span>
<a href="#linum:1606"><span class="linum" id="linum:1606">1606</span></a><span class="fringe" id="point:67728"> </span>(<span class="keyword" id="font-lock:67729">defun</span> <span class="function-name" id="font-lock:67735">hfy-fontify-buffer</span> (<span class="type" id="font-lock:67755">&amp;optional</span> srcdir file)
<a href="#linum:1607"><span class="linum" id="linum:1607">1607</span></a><span class="fringe" id="point:67778"> </span>  <span class="doc" id="font-lock:67780">"Implement the guts of `</span><span class="doc" id="font-lock:67804"><span class="constant" id="font-lock:67804">htmlfontify-buffer</span></span><span class="doc" id="font-lock:67822">'.
</span><a href="#linum:1608"><span class="linum" id="linum:1608">1608</span></a><span class="fringe" id="point:67825"> </span><span class="doc" id="font-lock:67825">SRCDIR, if set, is the directory being htmlfontified.
</span><a href="#linum:1609"><span class="linum" id="linum:1609">1609</span></a><span class="fringe" id="point:67879"> </span><span class="doc" id="font-lock:67879">FILE, if set, is the file name."</span>
<a href="#linum:1610"><span class="linum" id="linum:1610">1610</span></a><span class="fringe" id="point:67912"> </span>  (<span class="keyword" id="font-lock:67915">if</span> srcdir (setq srcdir (directory-file-name srcdir)))
<a href="#linum:1611"><span class="linum" id="linum:1611">1611</span></a><span class="fringe" id="point:67969"> </span>  (<span class="keyword" id="font-lock:67972">let*</span> ( (html-buffer        (hfy-buffer))
<a href="#linum:1612"><span class="linum" id="linum:1612">1612</span></a><span class="fringe" id="point:68013"> </span>          (css-sheet                   nil)
<a href="#linum:1613"><span class="linum" id="linum:1613">1613</span></a><span class="fringe" id="point:68057"> </span>          (css-map                     nil)
<a href="#linum:1614"><span class="linum" id="linum:1614">1614</span></a><span class="fringe" id="point:68101"> </span>          (invis-ranges                nil)
<a href="#linum:1615"><span class="linum" id="linum:1615">1615</span></a><span class="fringe" id="point:68145"> </span>          (rovl                        nil)
<a href="#linum:1616"><span class="linum" id="linum:1616">1616</span></a><span class="fringe" id="point:68189"> </span>          (orig-ovls      (overlays-in (point-min) (point-max)))
<a href="#linum:1617"><span class="linum" id="linum:1617">1617</span></a><span class="fringe" id="point:68254"> </span>          (rmin           (<span class="keyword" id="font-lock:68281">when</span> mark-active (region-beginning)))
<a href="#linum:1618"><span class="linum" id="linum:1618">1618</span></a><span class="fringe" id="point:68319"> </span>          (rmax           (<span class="keyword" id="font-lock:68346">when</span> mark-active (region-end      ))) )
<a href="#linum:1619"><span class="linum" id="linum:1619">1619</span></a><span class="fringe" id="point:68386"> </span>    (<span class="keyword" id="font-lock:68391">when</span> (and mark-active
<a href="#linum:1620"><span class="linum" id="linum:1620">1620</span></a><span class="fringe" id="point:68413"> </span>               transient-mark-mode)
<a href="#linum:1621"><span class="linum" id="linum:1621">1621</span></a><span class="fringe" id="point:68449"> </span>      (<span class="keyword" id="font-lock:68456">unless</span> (and (= rmin (point-min))
<a href="#linum:1622"><span class="linum" id="linum:1622">1622</span></a><span class="fringe" id="point:68489"> </span>                   (= rmax (point-max)))
<a href="#linum:1623"><span class="linum" id="linum:1623">1623</span></a><span class="fringe" id="point:68530"> </span>        (setq rovl (make-overlay rmin rmax))
<a href="#linum:1624"><span class="linum" id="linum:1624">1624</span></a><span class="fringe" id="point:68575"> </span>        (overlay-put rovl 'priority 1000)
<a href="#linum:1625"><span class="linum" id="linum:1625">1625</span></a><span class="fringe" id="point:68617"> </span>        (overlay-put rovl 'face 'region)))
<a href="#linum:1626"><span class="linum" id="linum:1626">1626</span></a><span class="fringe" id="point:68660"> </span>    <span class="comment-delimiter" id="font-lock:68664">;; </span><span class="comment" id="font-lock:68667">copy the buffer, including fontification, and switch to it:
</span><a href="#linum:1627"><span class="linum" id="linum:1627">1627</span></a><span class="fringe" id="point:68727"> </span>    (hfy-mark-trailing-whitespace)
<a href="#linum:1628"><span class="linum" id="linum:1628">1628</span></a><span class="fringe" id="point:68762"> </span>    (setq css-sheet             (hfy-compile-stylesheet   )
<a href="#linum:1629"><span class="linum" id="linum:1629">1629</span></a><span class="fringe" id="point:68822"> </span>          css-map               (hfy-compile-face-map     )
<a href="#linum:1630"><span class="linum" id="linum:1630">1630</span></a><span class="fringe" id="point:68882"> </span>          invis-ranges          (hfy-find-invisible-ranges))
<a href="#linum:1631"><span class="linum" id="linum:1631">1631</span></a><span class="fringe" id="point:68943"> </span>    (hfy-unmark-trailing-whitespace)
<a href="#linum:1632"><span class="linum" id="linum:1632">1632</span></a><span class="fringe" id="point:68980"> </span>    (<span class="keyword" id="font-lock:68985">when</span> rovl
<a href="#linum:1633"><span class="linum" id="linum:1633">1633</span></a><span class="fringe" id="point:68995"> </span>      (delete-overlay rovl))
<a href="#linum:1634"><span class="linum" id="linum:1634">1634</span></a><span class="fringe" id="point:69024"> </span>    (copy-to-buffer html-buffer (point-min) (point-max))
<a href="#linum:1635"><span class="linum" id="linum:1635">1635</span></a><span class="fringe" id="point:69081"> </span>    (set-buffer     html-buffer)
<a href="#linum:1636"><span class="linum" id="linum:1636">1636</span></a><span class="fringe" id="point:69114"> </span>    <span class="comment-delimiter" id="font-lock:69118">;; </span><span class="comment" id="font-lock:69121">rip out props that could interfere with our htmlisation of the buffer:
</span><a href="#linum:1637"><span class="linum" id="linum:1637">1637</span></a><span class="fringe" id="point:69192"> </span>    (remove-text-properties (point-min) (point-max) hfy-ignored-properties)
<a href="#linum:1638"><span class="linum" id="linum:1638">1638</span></a><span class="fringe" id="point:69268"> </span>    <span class="comment-delimiter" id="font-lock:69272">;; </span><span class="comment" id="font-lock:69275">Apply overlay invisible spec
</span><a href="#linum:1639"><span class="linum" id="linum:1639">1639</span></a><span class="fringe" id="point:69304"> </span>    (setq orig-ovls
<a href="#linum:1640"><span class="linum" id="linum:1640">1640</span></a><span class="fringe" id="point:69324"> </span>          (sort orig-ovls
<a href="#linum:1641"><span class="linum" id="linum:1641">1641</span></a><span class="fringe" id="point:69350"> </span>                (<span class="keyword" id="font-lock:69367">lambda</span> (A B)
<a href="#linum:1642"><span class="linum" id="linum:1642">1642</span></a><span class="fringe" id="point:69380"> </span>                  (&gt; (or (cadr (memq 'priority (overlay-properties A))) 0)
<a href="#linum:1643"><span class="linum" id="linum:1643">1643</span></a><span class="fringe" id="point:69455"> </span>                     (or (cadr (memq 'priority (overlay-properties B))) 0)))))
<a href="#linum:1644"><span class="linum" id="linum:1644">1644</span></a><span class="fringe" id="point:69534"> </span>    <span class="comment-delimiter" id="font-lock:69538">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="comment" id="font-lock:69613">
</span><a href="#linum:1645"><span class="linum" id="linum:1645">1645</span></a><span class="fringe" id="point:69614"> </span>    <span class="comment-delimiter" id="font-lock:69618">;; </span><span class="comment" id="font-lock:69621">at this point, html-buffer retains the fontification of the parent:
</span><a href="#linum:1646"><span class="linum" id="linum:1646">1646</span></a><span class="fringe" id="point:69689"> </span>    <span class="comment-delimiter" id="font-lock:69693">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="comment" id="font-lock:69768">
</span><a href="#linum:1647"><span class="linum" id="linum:1647">1647</span></a><span class="fringe" id="point:69769"> </span>    <span class="comment-delimiter" id="font-lock:69773">;; </span><span class="comment" id="font-lock:69776">we don't really need or want text in the html buffer to be invisible, as
</span><a href="#linum:1648"><span class="linum" id="linum:1648">1648</span></a><span class="fringe" id="point:69849"> </span>    <span class="comment-delimiter" id="font-lock:69853">;; </span><span class="comment" id="font-lock:69856">that can make it look like we've rendered invalid xhtml when all that's
</span><a href="#linum:1649"><span class="linum" id="linum:1649">1649</span></a><span class="fringe" id="point:69928"> </span>    <span class="comment-delimiter" id="font-lock:69932">;; </span><span class="comment" id="font-lock:69935">happened is some tags are in the invisible portions of the buffer:
</span><a href="#linum:1650"><span class="linum" id="linum:1650">1650</span></a><span class="fringe" id="point:70002"> </span>    (setq buffer-invisibility-spec nil)
<a href="#linum:1651"><span class="linum" id="linum:1651">1651</span></a><span class="fringe" id="point:70042"> </span>    <span class="comment-delimiter" id="font-lock:70046">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="comment" id="font-lock:70121">
</span><a href="#linum:1652"><span class="linum" id="linum:1652">1652</span></a><span class="fringe" id="point:70122"> </span>    <span class="comment-delimiter" id="font-lock:70126">;; </span><span class="comment" id="font-lock:70129">#####################################################################
</span><a href="#linum:1653"><span class="linum" id="linum:1653">1653</span></a><span class="fringe" id="point:70199"> </span>    <span class="comment-delimiter" id="font-lock:70203">;; </span><span class="comment" id="font-lock:70206">if we are in etags mode, add properties to mark the anchors and links
</span><a href="#linum:1654"><span class="linum" id="linum:1654">1654</span></a><span class="fringe" id="point:70276"> </span>    (<span class="keyword" id="font-lock:70281">if</span> (and srcdir file)
<a href="#linum:1655"><span class="linum" id="linum:1655">1655</span></a><span class="fringe" id="point:70302"> </span>        (<span class="keyword" id="font-lock:70311">progn</span>
<a href="#linum:1656"><span class="linum" id="linum:1656">1656</span></a><span class="fringe" id="point:70317"> </span>          (hfy-mark-tag-names srcdir file) <span class="comment-delimiter" id="font-lock:70360">;; </span><span class="comment" id="font-lock:70363">mark anchors
</span><a href="#linum:1657"><span class="linum" id="linum:1657">1657</span></a><span class="fringe" id="point:70376"> </span>          (hfy-mark-tag-hrefs srcdir file))) <span class="comment-delimiter" id="font-lock:70421">;; </span><span class="comment" id="font-lock:70424">mark links
</span><a href="#linum:1658"><span class="linum" id="linum:1658">1658</span></a><span class="fringe" id="point:70435"> </span>    <span class="comment-delimiter" id="font-lock:70439">;; </span><span class="comment" id="font-lock:70442">#####################################################################
</span><a href="#linum:1659"><span class="linum" id="linum:1659">1659</span></a><span class="fringe" id="point:70512"> </span>    <span class="comment-delimiter" id="font-lock:70516">;; </span><span class="comment" id="font-lock:70519">mark the 'dangerous' characters
</span><a href="#linum:1660"><span class="linum" id="linum:1660">1660</span></a><span class="fringe" id="point:70551"> </span>    <span class="comment-delimiter" id="font-lock:70555">;;</span><span class="comment" id="font-lock:70557">(message "marking dangerous characters")
</span><a href="#linum:1661"><span class="linum" id="linum:1661">1661</span></a><span class="fringe" id="point:70598"> </span>    (hfy-html-enkludge-buffer)
<a href="#linum:1662"><span class="linum" id="linum:1662">1662</span></a><span class="fringe" id="point:70629"> </span>    <span class="comment-delimiter" id="font-lock:70633">;; </span><span class="comment" id="font-lock:70636">trawl the position-based face-map, inserting span tags as we go
</span><a href="#linum:1663"><span class="linum" id="linum:1663">1663</span></a><span class="fringe" id="point:70700"> </span>    <span class="comment-delimiter" id="font-lock:70704">;; </span><span class="comment" id="font-lock:70707">note that we cannot change any character positions before this point
</span><a href="#linum:1664"><span class="linum" id="linum:1664">1664</span></a><span class="fringe" id="point:70776"> </span>    <span class="comment-delimiter" id="font-lock:70780">;; </span><span class="comment" id="font-lock:70783">or we will invalidate the map:
</span><a href="#linum:1665"><span class="linum" id="linum:1665">1665</span></a><span class="fringe" id="point:70814"> </span>    <span class="comment-delimiter" id="font-lock:70818">;; </span><span class="comment" id="font-lock:70821">NB: This also means we have to trawl the map in descending file-offset
</span><a href="#linum:1666"><span class="linum" id="linum:1666">1666</span></a><span class="fringe" id="point:70892"> </span>    <span class="comment-delimiter" id="font-lock:70896">;; </span><span class="comment" id="font-lock:70899">order, obviously.
</span><a href="#linum:1667"><span class="linum" id="linum:1667">1667</span></a><span class="fringe" id="point:70917"> </span>    <span class="comment-delimiter" id="font-lock:70921">;; </span><span class="comment" id="font-lock:70924">---------------------------------------------------------------------
</span><a href="#linum:1668"><span class="linum" id="linum:1668">1668</span></a><span class="fringe" id="point:70994"> </span>    <span class="comment-delimiter" id="font-lock:70998">;; </span><span class="comment" id="font-lock:71001">Remember, inserting pushes properties to the right, which we don't
</span><a href="#linum:1669"><span class="linum" id="linum:1669">1669</span></a><span class="fringe" id="point:71068"> </span>    <span class="comment-delimiter" id="font-lock:71072">;; </span><span class="comment" id="font-lock:71075">actually want to happen for link properties, so we have to flag
</span><a href="#linum:1670"><span class="linum" id="linum:1670">1670</span></a><span class="fringe" id="point:71139"> </span>    <span class="comment-delimiter" id="font-lock:71143">;; </span><span class="comment" id="font-lock:71146">them and move them by hand - if you don't, you end up with
</span><a href="#linum:1671"><span class="linum" id="linum:1671">1671</span></a><span class="fringe" id="point:71205"> </span>    <span class="comment-delimiter" id="font-lock:71209">;;</span><span class="comment" id="font-lock:71211">
</span><a href="#linum:1672"><span class="linum" id="linum:1672">1672</span></a><span class="fringe" id="point:71212"> </span>    <span class="comment-delimiter" id="font-lock:71216">;; </span><span class="comment" id="font-lock:71219">&lt;span class="foo"&gt;&lt;a href="bar"&gt;texta&lt;/span&gt;&lt;span class="bletch"&gt;&lt;/a&gt;...
</span><a href="#linum:1673"><span class="linum" id="linum:1673">1673</span></a><span class="fringe" id="point:71292"> </span>    <span class="comment-delimiter" id="font-lock:71296">;;</span><span class="comment" id="font-lock:71298">
</span><a href="#linum:1674"><span class="linum" id="linum:1674">1674</span></a><span class="fringe" id="point:71299"> </span>    <span class="comment-delimiter" id="font-lock:71303">;; </span><span class="comment" id="font-lock:71306">instead of:
</span><a href="#linum:1675"><span class="linum" id="linum:1675">1675</span></a><span class="fringe" id="point:71318"> </span>    <span class="comment-delimiter" id="font-lock:71322">;;</span><span class="comment" id="font-lock:71324">
</span><a href="#linum:1676"><span class="linum" id="linum:1676">1676</span></a><span class="fringe" id="point:71325"> </span>    <span class="comment-delimiter" id="font-lock:71329">;; </span><span class="comment" id="font-lock:71332">&lt;span class="foo"&gt;&lt;a href="bar"&gt;texta&lt;/a&gt;&lt;/span&gt;&lt;span class="bletch"&gt;...
</span><a href="#linum:1677"><span class="linum" id="linum:1677">1677</span></a><span class="fringe" id="point:71405"> </span>    <span class="comment-delimiter" id="font-lock:71409">;;</span><span class="comment" id="font-lock:71411">
</span><a href="#linum:1678"><span class="linum" id="linum:1678">1678</span></a><span class="fringe" id="point:71412"> </span>    <span class="comment-delimiter" id="font-lock:71416">;; </span><span class="comment" id="font-lock:71419">If my analysis of the problem is correct, we can detect link-ness by
</span><a href="#linum:1679"><span class="linum" id="linum:1679">1679</span></a><span class="fringe" id="point:71488"> </span>    <span class="comment-delimiter" id="font-lock:71492">;; </span><span class="comment" id="font-lock:71495">either hfy-linkp or hfy-endl properties at the insertion point, but I
</span><a href="#linum:1680"><span class="linum" id="linum:1680">1680</span></a><span class="fringe" id="point:71565"> </span>    <span class="comment-delimiter" id="font-lock:71569">;; </span><span class="comment" id="font-lock:71572">think we only need to relocate the hfy-endl property, as the hfy-linkp
</span><a href="#linum:1681"><span class="linum" id="linum:1681">1681</span></a><span class="fringe" id="point:71643"> </span>    <span class="comment-delimiter" id="font-lock:71647">;; </span><span class="comment" id="font-lock:71650">property has already served its main purpose by this point.
</span><a href="#linum:1682"><span class="linum" id="linum:1682">1682</span></a><span class="fringe" id="point:71710"> </span>    <span class="comment-delimiter" id="font-lock:71714">;;</span><span class="comment" id="font-lock:71716">(message "mapcar over the CSS-MAP")
</span><a href="#linum:1683"><span class="linum" id="linum:1683">1683</span></a><span class="fringe" id="point:71752"> </span>    (message <span class="string" id="font-lock:71765">"invis-ranges:\n%S"</span> invis-ranges)
<a href="#linum:1684"><span class="linum" id="linum:1684">1684</span></a><span class="fringe" id="point:71799"> </span>    (<span class="keyword" id="font-lock:71804">dolist</span> (point-face css-map)
<a href="#linum:1685"><span class="linum" id="linum:1685">1685</span></a><span class="fringe" id="point:71832"> </span>      (<span class="keyword" id="font-lock:71839">let</span> ((pt (car point-face))
<a href="#linum:1686"><span class="linum" id="linum:1686">1686</span></a><span class="fringe" id="point:71866"> </span>            (fn (cdr point-face))
<a href="#linum:1687"><span class="linum" id="linum:1687">1687</span></a><span class="fringe" id="point:71900"> </span>            (move-link       nil))
<a href="#linum:1688"><span class="linum" id="linum:1688">1688</span></a><span class="fringe" id="point:71935"> </span>        (goto-char pt)
<a href="#linum:1689"><span class="linum" id="linum:1689">1689</span></a><span class="fringe" id="point:71958"> </span>        (setq move-link
<a href="#linum:1690"><span class="linum" id="linum:1690">1690</span></a><span class="fringe" id="point:71982"> </span>              (or (get-text-property pt 'hfy-linkp)
<a href="#linum:1691"><span class="linum" id="linum:1691">1691</span></a><span class="fringe" id="point:72034"> </span>                  (get-text-property pt 'hfy-endl )))
<a href="#linum:1692"><span class="linum" id="linum:1692">1692</span></a><span class="fringe" id="point:72088"> </span>        (<span class="keyword" id="font-lock:72097">if</span> (eq 'end fn)
<a href="#linum:1693"><span class="linum" id="linum:1693">1693</span></a><span class="fringe" id="point:72113"> </span>            (insert <span class="string" id="font-lock:72133">"&lt;/span&gt;"</span>)
<a href="#linum:1694"><span class="linum" id="linum:1694">1694</span></a><span class="fringe" id="point:72144"> </span>          (<span class="keyword" id="font-lock:72155">if</span> (not (and srcdir file))
<a href="#linum:1695"><span class="linum" id="linum:1695">1695</span></a><span class="fringe" id="point:72182"> </span>              nil
<a href="#linum:1696"><span class="linum" id="linum:1696">1696</span></a><span class="fringe" id="point:72200"> </span>            (<span class="keyword" id="font-lock:72213">when</span> move-link
<a href="#linum:1697"><span class="linum" id="linum:1697">1697</span></a><span class="fringe" id="point:72228"> </span>              (remove-text-properties (point) (1+ (point)) '(hfy-endl nil))
<a href="#linum:1698"><span class="linum" id="linum:1698">1698</span></a><span class="fringe" id="point:72304"> </span>              (put-text-property pt (1+ pt) 'hfy-endl t) ))
<a href="#linum:1699"><span class="linum" id="linum:1699">1699</span></a><span class="fringe" id="point:72364"> </span>          <span class="comment-delimiter" id="font-lock:72374">;; </span><span class="comment" id="font-lock:72377">if we have invisible blocks, we need to do some extra magic:
</span><a href="#linum:1700"><span class="linum" id="linum:1700">1700</span></a><span class="fringe" id="point:72438"> </span>          (<span class="keyword" id="font-lock:72449">if</span> invis-ranges
<a href="#linum:1701"><span class="linum" id="linum:1701">1701</span></a><span class="fringe" id="point:72465"> </span>              (<span class="keyword" id="font-lock:72480">let</span> ((iname (hfy-invisible-name pt invis-ranges))
<a href="#linum:1702"><span class="linum" id="linum:1702">1702</span></a><span class="fringe" id="point:72530"> </span>                    (fname (hfy-lookup         fn css-sheet   )))
<a href="#linum:1703"><span class="linum" id="linum:1703">1703</span></a><span class="fringe" id="point:72596"> </span>                (<span class="keyword" id="font-lock:72613">when</span> (assq pt invis-ranges)
<a href="#linum:1704"><span class="linum" id="linum:1704">1704</span></a><span class="fringe" id="point:72641"> </span>                  (insert
<a href="#linum:1705"><span class="linum" id="linum:1705">1705</span></a><span class="fringe" id="point:72667"> </span>                   (format <span class="string" id="font-lock:72694">"&lt;span onclick=\"toggle_invis('%s');\"&gt;"</span> iname))
<a href="#linum:1706"><span class="linum" id="linum:1706">1706</span></a><span class="fringe" id="point:72743"> </span>                  (insert <span class="string" id="font-lock:72769">"&#8230;&lt;/span&gt;"</span>))
<a href="#linum:1707"><span class="linum" id="linum:1707">1707</span></a><span class="fringe" id="point:72782"> </span>                (insert
<a href="#linum:1708"><span class="linum" id="linum:1708">1708</span></a><span class="fringe" id="point:72806"> </span>                 (format <span class="string" id="font-lock:72831">"&lt;span class=\"%s\" id=\"%s-%d\"&gt;"</span> fname iname pt)))
<a href="#linum:1709"><span class="linum" id="linum:1709">1709</span></a><span class="fringe" id="point:72884"> </span>            (insert (format <span class="string" id="font-lock:72912">"&lt;span class=\"%s\"&gt;"</span> (hfy-lookup fn css-sheet))))
<a href="#linum:1710"><span class="linum" id="linum:1710">1710</span></a><span class="fringe" id="point:72963"> </span>          (<span class="keyword" id="font-lock:72974">if</span> (not move-link) nil
<a href="#linum:1711"><span class="linum" id="linum:1711">1711</span></a><span class="fringe" id="point:72997"> </span>            <span class="comment-delimiter" id="font-lock:73009">;;</span><span class="comment" id="font-lock:73011">(message "removing prop2 @ %d" (point))
</span><a href="#linum:1712"><span class="linum" id="linum:1712">1712</span></a><span class="fringe" id="point:73051"> </span>            (<span class="keyword" id="font-lock:73064">if</span> (remove-text-properties (point) (1+ (point)) '(hfy-endl nil))
<a href="#linum:1713"><span class="linum" id="linum:1713">1713</span></a><span class="fringe" id="point:73129"> </span>                (put-text-property pt (1+ pt) 'hfy-endl t))))))
<a href="#linum:1714"><span class="linum" id="linum:1714">1714</span></a><span class="fringe" id="point:73193"> </span>    <span class="comment-delimiter" id="font-lock:73197">;; </span><span class="comment" id="font-lock:73200">#####################################################################
</span><a href="#linum:1715"><span class="linum" id="linum:1715">1715</span></a><span class="fringe" id="point:73270"> </span>    <span class="comment-delimiter" id="font-lock:73274">;; </span><span class="comment" id="font-lock:73277">Invisibility
</span><a href="#linum:1716"><span class="linum" id="linum:1716">1716</span></a><span class="fringe" id="point:73290"> </span>    <span class="comment-delimiter" id="font-lock:73294">;; </span><span class="comment" id="font-lock:73297">Maybe just make the text invisible in XHTML?
</span><a href="#linum:1717"><span class="linum" id="linum:1717">1717</span></a><span class="fringe" id="point:73342"> </span>    <span class="comment-delimiter" id="font-lock:73346">;; </span><span class="comment" id="font-lock:73349">DONE -- big block of obsolete invisibility code elided here -- v
</span><a href="#linum:1718"><span class="linum" id="linum:1718">1718</span></a><span class="fringe" id="point:73414"> </span>    <span class="comment-delimiter" id="font-lock:73418">;; </span><span class="comment" id="font-lock:73421">#####################################################################
</span><a href="#linum:1719"><span class="linum" id="linum:1719">1719</span></a><span class="fringe" id="point:73491"> </span>    <span class="comment-delimiter" id="font-lock:73495">;; </span><span class="comment" id="font-lock:73498">(message "checking to see whether we should link...")
</span><a href="#linum:1720"><span class="linum" id="linum:1720">1720</span></a><span class="fringe" id="point:73552"> </span>    (<span class="keyword" id="font-lock:73557">if</span> (and srcdir file)
<a href="#linum:1721"><span class="linum" id="linum:1721">1721</span></a><span class="fringe" id="point:73578"> </span>        (<span class="keyword" id="font-lock:73587">let</span> ((lp 'hfy-link)
<a href="#linum:1722"><span class="linum" id="linum:1722">1722</span></a><span class="fringe" id="point:73607"> </span>              (pt  nil)
<a href="#linum:1723"><span class="linum" id="linum:1723">1723</span></a><span class="fringe" id="point:73631"> </span>              (pr  nil)
<a href="#linum:1724"><span class="linum" id="linum:1724">1724</span></a><span class="fringe" id="point:73655"> </span>              (rr  nil))
<a href="#linum:1725"><span class="linum" id="linum:1725">1725</span></a><span class="fringe" id="point:73680"> </span>          <span class="comment-delimiter" id="font-lock:73690">;; </span><span class="comment" id="font-lock:73693">(message "  yes we should.")
</span><a href="#linum:1726"><span class="linum" id="linum:1726">1726</span></a><span class="fringe" id="point:73722"> </span>            <span class="comment-delimiter" id="font-lock:73734">;; </span><span class="comment" id="font-lock:73737">translate 'hfy-anchor properties to anchors
</span><a href="#linum:1727"><span class="linum" id="linum:1727">1727</span></a><span class="fringe" id="point:73781"> </span>            (setq pt (point-min))
<a href="#linum:1728"><span class="linum" id="linum:1728">1728</span></a><span class="fringe" id="point:73815"> </span>            (<span class="keyword" id="font-lock:73828">while</span> (setq pt (next-single-property-change pt 'hfy-anchor))
<a href="#linum:1729"><span class="linum" id="linum:1729">1729</span></a><span class="fringe" id="point:73889"> </span>              (<span class="keyword" id="font-lock:73904">if</span> (setq pr (get-text-property pt 'hfy-anchor))
<a href="#linum:1730"><span class="linum" id="linum:1730">1730</span></a><span class="fringe" id="point:73952"> </span>                  (<span class="keyword" id="font-lock:73971">progn</span> (goto-char pt)
<a href="#linum:1731"><span class="linum" id="linum:1731">1731</span></a><span class="fringe" id="point:73992"> </span>                         (remove-text-properties pt (1+ pt) '(hfy-anchor nil))
<a href="#linum:1732"><span class="linum" id="linum:1732">1732</span></a><span class="fringe" id="point:74071"> </span>                         (insert (concat <span class="string" id="font-lock:74112">"&lt;a name=\""</span> pr <span class="string" id="font-lock:74128">"\"&gt;&lt;/a&gt;"</span>)))))
<a href="#linum:1733"><span class="linum" id="linum:1733">1733</span></a><span class="fringe" id="point:74143"> </span>            <span class="comment-delimiter" id="font-lock:74155">;; </span><span class="comment" id="font-lock:74158">translate alternate 'hfy-link and 'hfy-endl props to opening
</span><a href="#linum:1734"><span class="linum" id="linum:1734">1734</span></a><span class="fringe" id="point:74219"> </span>            <span class="comment-delimiter" id="font-lock:74231">;; </span><span class="comment" id="font-lock:74234">and closing links. (this should avoid those spurious closes
</span><a href="#linum:1735"><span class="linum" id="linum:1735">1735</span></a><span class="fringe" id="point:74294"> </span>            <span class="comment-delimiter" id="font-lock:74306">;; </span><span class="comment" id="font-lock:74309">we sometimes get by generating only paired tags)
</span><a href="#linum:1736"><span class="linum" id="linum:1736">1736</span></a><span class="fringe" id="point:74358"> </span>            (setq pt (point-min))
<a href="#linum:1737"><span class="linum" id="linum:1737">1737</span></a><span class="fringe" id="point:74392"> </span>            (<span class="keyword" id="font-lock:74405">while</span> (setq pt (next-single-property-change pt lp))
<a href="#linum:1738"><span class="linum" id="linum:1738">1738</span></a><span class="fringe" id="point:74457"> </span>              (<span class="keyword" id="font-lock:74472">if</span> (not (setq pr (get-text-property pt lp))) nil
<a href="#linum:1739"><span class="linum" id="linum:1739">1739</span></a><span class="fringe" id="point:74521"> </span>                (goto-char pt)
<a href="#linum:1740"><span class="linum" id="linum:1740">1740</span></a><span class="fringe" id="point:74552"> </span>                (remove-text-properties pt (1+ pt) (list lp nil))
<a href="#linum:1741"><span class="linum" id="linum:1741">1741</span></a><span class="fringe" id="point:74618"> </span>                (<span class="keyword" id="font-lock:74635">case</span> lp
<a href="#linum:1742"><span class="linum" id="linum:1742">1742</span></a><span class="fringe" id="point:74643"> </span>                 (hfy-link
<a href="#linum:1743"><span class="linum" id="linum:1743">1743</span></a><span class="fringe" id="point:74670"> </span>                  (<span class="keyword" id="font-lock:74689">if</span> (setq rr (get-text-property pt 'hfy-inst))
<a href="#linum:1744"><span class="linum" id="linum:1744">1744</span></a><span class="fringe" id="point:74735"> </span>                      (insert (format <span class="string" id="font-lock:74773">"&lt;a name=\"%s\"&gt;&lt;/a&gt;"</span> rr)))
<a href="#linum:1745"><span class="linum" id="linum:1745">1745</span></a><span class="fringe" id="point:74801"> </span>                  (insert (format <span class="string" id="font-lock:74835">"&lt;a href=\"%s\"&gt;"</span> pr))
<a href="#linum:1746"><span class="linum" id="linum:1746">1746</span></a><span class="fringe" id="point:74858"> </span>                  (setq lp 'hfy-endl))
<a href="#linum:1747"><span class="linum" id="linum:1747">1747</span></a><span class="fringe" id="point:74897"> </span>                 (hfy-endl
<a href="#linum:1748"><span class="linum" id="linum:1748">1748</span></a><span class="fringe" id="point:74924"> </span>                  (insert <span class="string" id="font-lock:74950">"&lt;/a&gt;"</span>) (setq lp 'hfy-link)) ))) ))
<a href="#linum:1749"><span class="linum" id="linum:1749">1749</span></a><span class="fringe" id="point:74986"> </span>
<a href="#linum:1750"><span class="linum" id="linum:1750">1750</span></a><span class="fringe" id="point:74987"> </span>    <span class="comment-delimiter" id="font-lock:74991">;; </span><span class="comment" id="font-lock:74994">#####################################################################
</span><a href="#linum:1751"><span class="linum" id="linum:1751">1751</span></a><span class="fringe" id="point:75064"> </span>    <span class="comment-delimiter" id="font-lock:75068">;; </span><span class="comment" id="font-lock:75071">transform the dangerous chars. This changes character positions
</span><a href="#linum:1752"><span class="linum" id="linum:1752">1752</span></a><span class="fringe" id="point:75135"> </span>    <span class="comment-delimiter" id="font-lock:75139">;; </span><span class="comment" id="font-lock:75142">since entities have &gt; char length.
</span><a href="#linum:1753"><span class="linum" id="linum:1753">1753</span></a><span class="fringe" id="point:75177"> </span>    <span class="comment-delimiter" id="font-lock:75181">;; </span><span class="comment" id="font-lock:75184">note that this deletes the dangerous characters, and therefore
</span><a href="#linum:1754"><span class="linum" id="linum:1754">1754</span></a><span class="fringe" id="point:75247"> </span>    <span class="comment-delimiter" id="font-lock:75251">;; </span><span class="comment" id="font-lock:75254">destroys any properties they may contain (such as 'hfy-endl),
</span><a href="#linum:1755"><span class="linum" id="linum:1755">1755</span></a><span class="fringe" id="point:75316"> </span>    <span class="comment-delimiter" id="font-lock:75320">;; </span><span class="comment" id="font-lock:75323">so we have to do this after we use said properties:
</span><a href="#linum:1756"><span class="linum" id="linum:1756">1756</span></a><span class="fringe" id="point:75375"> </span>    <span class="comment-delimiter" id="font-lock:75379">;; </span><span class="comment" id="font-lock:75382">(message "munging dangerous characters")
</span><a href="#linum:1757"><span class="linum" id="linum:1757">1757</span></a><span class="fringe" id="point:75423"> </span>    (hfy-html-dekludge-buffer)
<a href="#linum:1758"><span class="linum" id="linum:1758">1758</span></a><span class="fringe" id="point:75454"> </span>    <span class="comment-delimiter" id="font-lock:75458">;; </span><span class="comment" id="font-lock:75461">insert the stylesheet at the top:
</span><a href="#linum:1759"><span class="linum" id="linum:1759">1759</span></a><span class="fringe" id="point:75495"> </span>    (goto-char (point-min))
<a href="#linum:1760"><span class="linum" id="linum:1760">1760</span></a><span class="fringe" id="point:75523"> </span>    <span class="comment-delimiter" id="font-lock:75527">;;</span><span class="comment" id="font-lock:75529">(message "inserting stylesheet")
</span><a href="#linum:1761"><span class="linum" id="linum:1761">1761</span></a><span class="fringe" id="point:75562"> </span>    (insert (hfy-sprintf-stylesheet css-sheet file))
<a href="#linum:1762"><span class="linum" id="linum:1762">1762</span></a><span class="fringe" id="point:75615"> </span>    (<span class="keyword" id="font-lock:75620">if</span> (hfy-opt 'div-wrapper) (insert <span class="string" id="font-lock:75654">"&lt;div class=\"default\"&gt;"</span>))
<a href="#linum:1763"><span class="linum" id="linum:1763">1763</span></a><span class="fringe" id="point:75682"> </span>    (insert <span class="string" id="font-lock:75694">"\n&lt;pre&gt;"</span>)
<a href="#linum:1764"><span class="linum" id="linum:1764">1764</span></a><span class="fringe" id="point:75705"> </span>    (goto-char (point-max))
<a href="#linum:1765"><span class="linum" id="linum:1765">1765</span></a><span class="fringe" id="point:75733"> </span>    (insert <span class="string" id="font-lock:75745">"&lt;/pre&gt;\n"</span>)
<a href="#linum:1766"><span class="linum" id="linum:1766">1766</span></a><span class="fringe" id="point:75757"> </span>    (<span class="keyword" id="font-lock:75762">if</span> (hfy-opt 'div-wrapper) (insert <span class="string" id="font-lock:75796">"&lt;/div&gt;"</span>))
<a href="#linum:1767"><span class="linum" id="linum:1767">1767</span></a><span class="fringe" id="point:75807"> </span>    <span class="comment-delimiter" id="font-lock:75811">;;</span><span class="comment" id="font-lock:75813">(message "inserting footer")
</span><a href="#linum:1768"><span class="linum" id="linum:1768">1768</span></a><span class="fringe" id="point:75842"> </span>    (insert (funcall hfy-page-footer file))
<a href="#linum:1769"><span class="linum" id="linum:1769">1769</span></a><span class="fringe" id="point:75886"> </span>    <span class="comment-delimiter" id="font-lock:75890">;; </span><span class="comment" id="font-lock:75893">call any post html-generation hooks:
</span><a href="#linum:1770"><span class="linum" id="linum:1770">1770</span></a><span class="fringe" id="point:75930"> </span>    (run-hooks 'hfy-post-html-hooks)
<a href="#linum:1771"><span class="linum" id="linum:1771">1771</span></a><span class="fringe" id="point:75967"> </span>    <span class="comment-delimiter" id="font-lock:75971">;; </span><span class="comment" id="font-lock:75974">return the html buffer
</span><a href="#linum:1772"><span class="linum" id="linum:1772">1772</span></a><span class="fringe" id="point:75997"> </span>    (set-buffer-modified-p nil)
<a href="#linum:1773"><span class="linum" id="linum:1773">1773</span></a><span class="fringe" id="point:76029"> </span>    html-buffer))
<a href="#linum:1774"><span class="linum" id="linum:1774">1774</span></a><span class="fringe" id="point:76047"> </span>
<a href="#linum:1775"><span class="linum" id="linum:1775">1775</span></a><span class="fringe" id="point:76048"> </span>(<span class="keyword" id="font-lock:76049">defun</span> <span class="function-name" id="font-lock:76055">hfy-force-fontification</span> ()
<a href="#linum:1776"><span class="linum" id="linum:1776">1776</span></a><span class="fringe" id="point:76082"> </span>  <span class="doc" id="font-lock:76084">"Try to force font-locking even when it is optimized away."</span>
<a href="#linum:1777"><span class="linum" id="linum:1777">1777</span></a><span class="fringe" id="point:76144"> </span>  (run-hooks 'hfy-init-kludge-hook)
<a href="#linum:1778"><span class="linum" id="linum:1778">1778</span></a><span class="fringe" id="point:76180"> </span>  (<span class="keyword" id="font-lock:76183">eval-and-compile</span> (<span class="keyword" id="font-lock:76201">require</span> '<span class="constant" id="font-lock:76210">font-lock</span>))
<a href="#linum:1779"><span class="linum" id="linum:1779">1779</span></a><span class="fringe" id="point:76222"> </span>  (<span class="keyword" id="font-lock:76225">if</span> (boundp 'font-lock-cache-position)
<a href="#linum:1780"><span class="linum" id="linum:1780">1780</span></a><span class="fringe" id="point:76263"> </span>      (or font-lock-cache-position
<a href="#linum:1781"><span class="linum" id="linum:1781">1781</span></a><span class="fringe" id="point:76298"> </span>          (set 'font-lock-cache-position (make-marker))))
<a href="#linum:1782"><span class="linum" id="linum:1782">1782</span></a><span class="fringe" id="point:76356"> </span>  (<span class="keyword" id="font-lock:76359">if</span> (not noninteractive)
<a href="#linum:1783"><span class="linum" id="linum:1783">1783</span></a><span class="fringe" id="point:76383"> </span>      (<span class="keyword" id="font-lock:76390">progn</span>
<a href="#linum:1784"><span class="linum" id="linum:1784">1784</span></a><span class="fringe" id="point:76396"> </span>        (message <span class="string" id="font-lock:76413">"hfy interactive mode (%S %S)"</span> window-system major-mode)
<a href="#linum:1785"><span class="linum" id="linum:1785">1785</span></a><span class="fringe" id="point:76470"> </span>        (<span class="keyword" id="font-lock:76479">when</span> (and font-lock-defaults
<a href="#linum:1786"><span class="linum" id="linum:1786">1786</span></a><span class="fringe" id="point:76508"> </span>                   font-lock-mode)
<a href="#linum:1787"><span class="linum" id="linum:1787">1787</span></a><span class="fringe" id="point:76543"> </span>          (font-lock-fontify-region (point-min) (point-max) nil)))
<a href="#linum:1788"><span class="linum" id="linum:1788">1788</span></a><span class="fringe" id="point:76610"> </span>    (message <span class="string" id="font-lock:76623">"hfy batch mode (%s:%S)"</span>
<a href="#linum:1789"><span class="linum" id="linum:1789">1789</span></a><span class="fringe" id="point:76648"> </span>             (or (buffer-file-name) (buffer-name)) major-mode)
<a href="#linum:1790"><span class="linum" id="linum:1790">1790</span></a><span class="fringe" id="point:76711"> </span>    (<span class="keyword" id="font-lock:76716">when</span> font-lock-defaults
<a href="#linum:1791"><span class="linum" id="linum:1791">1791</span></a><span class="fringe" id="point:76740"> </span>      (font-lock-fontify-buffer)) ))
<a href="#linum:1792"><span class="linum" id="linum:1792">1792</span></a><span class="fringe" id="point:76777"> </span>
<a href="#linum:1793"><span class="linum" id="linum:1793">1793</span></a><span class="fringe" id="point:76778"> </span><span class="comment-delimiter" id="font-lock:76778">;;;</span><span class="comment" id="font-lock:76781">###</span><span class="comment" id="font-lock:76784"><span class="warning" id="font-lock:76784">autoload</span></span><span class="comment" id="font-lock:76792">
</span><a href="#linum:1794"><span class="linum" id="linum:1794">1794</span></a><span class="fringe" id="point:76793"> </span>(<span class="keyword" id="font-lock:76794">defun</span> <span class="function-name" id="font-lock:76800">htmlfontify-buffer</span> (<span class="type" id="font-lock:76820">&amp;optional</span> srcdir file)
<a href="#linum:1795"><span class="linum" id="linum:1795">1795</span></a><span class="fringe" id="point:76843"> </span>  <span class="doc" id="font-lock:76845">"Create a new buffer, named for the current buffer + a .html extension,
</span><a href="#linum:1796"><span class="linum" id="linum:1796">1796</span></a><span class="fringe" id="point:76917"> </span><span class="doc" id="font-lock:76917">containing an inline CSS-stylesheet and formatted CSS-markup HTML
</span><a href="#linum:1797"><span class="linum" id="linum:1797">1797</span></a><span class="fringe" id="point:76983"> </span><span class="doc" id="font-lock:76983">that reproduces the look of the current Emacs buffer as closely
</span><a href="#linum:1798"><span class="linum" id="linum:1798">1798</span></a><span class="fringe" id="point:77047"> </span><span class="doc" id="font-lock:77047">as possible.
</span><a href="#linum:1799"><span class="linum" id="linum:1799">1799</span></a><span class="fringe" id="point:77060"> </span><span class="doc" id="font-lock:77060">
</span><a href="#linum:1800"><span class="linum" id="linum:1800">1800</span></a><span class="fringe" id="point:77061"> </span><span class="doc" id="font-lock:77061">Dangerous characters in the existing buffer are turned into HTML
</span><a href="#linum:1801"><span class="linum" id="linum:1801">1801</span></a><span class="fringe" id="point:77126"> </span><span class="doc" id="font-lock:77126">entities, so you should even be able to do HTML-within-HTML
</span><a href="#linum:1802"><span class="linum" id="linum:1802">1802</span></a><span class="fringe" id="point:77186"> </span><span class="doc" id="font-lock:77186">fontified display.
</span><a href="#linum:1803"><span class="linum" id="linum:1803">1803</span></a><span class="fringe" id="point:77205"> </span><span class="doc" id="font-lock:77205">
</span><a href="#linum:1804"><span class="linum" id="linum:1804">1804</span></a><span class="fringe" id="point:77206"> </span><span class="doc" id="font-lock:77206">You should, however, note that random control or eight-bit
</span><a href="#linum:1805"><span class="linum" id="linum:1805">1805</span></a><span class="fringe" id="point:77265"> </span><span class="doc" id="font-lock:77265">characters such as ^L (\x0c) or &#164; (\xa4) won't get mapped yet.
</span><a href="#linum:1806"><span class="linum" id="linum:1806">1806</span></a><span class="fringe" id="point:77328"> </span><span class="doc" id="font-lock:77328">
</span><a href="#linum:1807"><span class="linum" id="linum:1807">1807</span></a><span class="fringe" id="point:77329"> </span><span class="doc" id="font-lock:77329">If the SRCDIR and FILE arguments are set, lookup etags derived
</span><a href="#linum:1808"><span class="linum" id="linum:1808">1808</span></a><span class="fringe" id="point:77392"> </span><span class="doc" id="font-lock:77392">entries in the `</span><span class="doc" id="font-lock:77408"><span class="constant" id="font-lock:77408">hfy-tags-cache</span></span><span class="doc" id="font-lock:77422">' and add HTML anchors and
</span><a href="#linum:1809"><span class="linum" id="linum:1809">1809</span></a><span class="fringe" id="point:77449"> </span><span class="doc" id="font-lock:77449">hyperlinks as appropriate."</span>
<a href="#linum:1810"><span class="linum" id="linum:1810">1810</span></a><span class="fringe" id="point:77477"> </span>  (interactive)
<a href="#linum:1811"><span class="linum" id="linum:1811">1811</span></a><span class="fringe" id="point:77493"> </span>  <span class="comment-delimiter" id="font-lock:77495">;; </span><span class="comment" id="font-lock:77498">pick up the file name in case we didn't receive it
</span><a href="#linum:1812"><span class="linum" id="linum:1812">1812</span></a><span class="fringe" id="point:77549"> </span>  (<span class="keyword" id="font-lock:77552">if</span> (not file)
<a href="#linum:1813"><span class="linum" id="linum:1813">1813</span></a><span class="fringe" id="point:77566"> </span>      (<span class="keyword" id="font-lock:77573">progn</span> (setq file (or (buffer-file-name) (buffer-name)))
<a href="#linum:1814"><span class="linum" id="linum:1814">1814</span></a><span class="fringe" id="point:77629"> </span>             (<span class="keyword" id="font-lock:77643">if</span> (string-match <span class="string" id="font-lock:77660">"/</span><span class="string" id="font-lock:77662"><span class="regexp-grouping-backslash" id="font-lock:77662">\\</span></span><span class="string" id="font-lock:77664"><span class="regexp-grouping-construct" id="font-lock:77664">(</span></span><span class="string" id="font-lock:77665">[</span><span class="string" id="font-lock:77666"><span class="negation-char" id="font-lock:77666">^</span></span><span class="string" id="font-lock:77667">/]*</span><span class="string" id="font-lock:77670"><span class="regexp-grouping-backslash" id="font-lock:77670">\\</span></span><span class="string" id="font-lock:77672"><span class="regexp-grouping-construct" id="font-lock:77672">)</span></span><span class="string" id="font-lock:77673">$"</span> file)
<a href="#linum:1815"><span class="linum" id="linum:1815">1815</span></a><span class="fringe" id="point:77682"> </span>                 (setq file (match-string 1 file)))) )
<a href="#linum:1816"><span class="linum" id="linum:1816">1816</span></a><span class="fringe" id="point:77737"> </span>
<a href="#linum:1817"><span class="linum" id="linum:1817">1817</span></a><span class="fringe" id="point:77738"> </span>  (<span class="keyword" id="font-lock:77741">if</span> (not (hfy-opt 'skip-refontification))
<a href="#linum:1818"><span class="linum" id="linum:1818">1818</span></a><span class="fringe" id="point:77782"> </span>      (<span class="keyword" id="font-lock:77789">save-excursion</span> <span class="comment-delimiter" id="font-lock:77804">;; </span><span class="comment" id="font-lock:77807">Keep region
</span><a href="#linum:1819"><span class="linum" id="linum:1819">1819</span></a><span class="fringe" id="point:77819"> </span>        (hfy-force-fontification)))
<a href="#linum:1820"><span class="linum" id="linum:1820">1820</span></a><span class="fringe" id="point:77855"> </span>  (<span class="keyword" id="font-lock:77858">if</span> (interactive-p) <span class="comment-delimiter" id="font-lock:77877">;; </span><span class="comment" id="font-lock:77880">display the buffer in interactive mode:
</span><a href="#linum:1821"><span class="linum" id="linum:1821">1821</span></a><span class="fringe" id="point:77920"> </span>      (switch-to-buffer (hfy-fontify-buffer srcdir file))
<a href="#linum:1822"><span class="linum" id="linum:1822">1822</span></a><span class="fringe" id="point:77978"> </span>    (hfy-fontify-buffer srcdir file)))
<a href="#linum:1823"><span class="linum" id="linum:1823">1823</span></a><span class="fringe" id="point:78017"> </span>
<a href="#linum:1824"><span class="linum" id="linum:1824">1824</span></a><span class="fringe" id="point:78018"> </span><span class="comment-delimiter" id="font-lock:78018">;; </span><span class="comment" id="font-lock:78021">recursive file listing
</span><a href="#linum:1825"><span class="linum" id="linum:1825">1825</span></a><span class="fringe" id="point:78044"> </span>(<span class="keyword" id="font-lock:78045">defun</span> <span class="function-name" id="font-lock:78051">hfy-list-files</span> (directory)
<a href="#linum:1826"><span class="linum" id="linum:1826">1826</span></a><span class="fringe" id="point:78078"> </span>  <span class="doc" id="font-lock:78080">"Return a list of files under DIRECTORY.
</span><a href="#linum:1827"><span class="linum" id="linum:1827">1827</span></a><span class="fringe" id="point:78121"> </span><span class="doc" id="font-lock:78121">Strips any leading \"./\" from each filename."</span>
<a href="#linum:1828"><span class="linum" id="linum:1828">1828</span></a><span class="fringe" id="point:78168"> </span>  <span class="comment-delimiter" id="font-lock:78170">;;</span><span class="comment" id="font-lock:78172">(message "hfy-list-files");;DBUG
</span><a href="#linum:1829"><span class="linum" id="linum:1829">1829</span></a><span class="fringe" id="point:78205"> </span>  <span class="comment-delimiter" id="font-lock:78207">;; </span><span class="comment" id="font-lock:78210">FIXME: this changes the dir of the currrent buffer.  Is that right??
</span><a href="#linum:1830"><span class="linum" id="linum:1830">1830</span></a><span class="fringe" id="point:78279"> </span>  (cd directory)
<a href="#linum:1831"><span class="linum" id="linum:1831">1831</span></a><span class="fringe" id="point:78296"> </span>  (mapcar (<span class="keyword" id="font-lock:78307">lambda</span> (F) (<span class="keyword" id="font-lock:78319">if</span> (string-match <span class="string" id="font-lock:78336">"^./</span><span class="string" id="font-lock:78340"><span class="regexp-grouping-backslash" id="font-lock:78340">\\</span></span><span class="string" id="font-lock:78342"><span class="regexp-grouping-construct" id="font-lock:78342">(</span></span><span class="string" id="font-lock:78343">.*</span><span class="string" id="font-lock:78345"><span class="regexp-grouping-backslash" id="font-lock:78345">\\</span></span><span class="string" id="font-lock:78347"><span class="regexp-grouping-construct" id="font-lock:78347">)</span></span><span class="string" id="font-lock:78348">"</span> F) (match-string 1 F) F))
<a href="#linum:1832"><span class="linum" id="linum:1832">1832</span></a><span class="fringe" id="point:78376"> </span>          (split-string (shell-command-to-string hfy-find-cmd))) )
<a href="#linum:1833"><span class="linum" id="linum:1833">1833</span></a><span class="fringe" id="point:78443"> </span>
<a href="#linum:1834"><span class="linum" id="linum:1834">1834</span></a><span class="fringe" id="point:78444"> </span><span class="comment-delimiter" id="font-lock:78444">;; </span><span class="comment" id="font-lock:78447">strip the filename off, return a directiry name
</span><a href="#linum:1835"><span class="linum" id="linum:1835">1835</span></a><span class="fringe" id="point:78495"> </span><span class="comment-delimiter" id="font-lock:78495">;; </span><span class="comment" id="font-lock:78498">not a particularly thorough implementaion, but it will be
</span><a href="#linum:1836"><span class="linum" id="linum:1836">1836</span></a><span class="fringe" id="point:78556"> </span><span class="comment-delimiter" id="font-lock:78556">;; </span><span class="comment" id="font-lock:78559">fed pretty carefully, so it should be Ok:
</span><a href="#linum:1837"><span class="linum" id="linum:1837">1837</span></a><span class="fringe" id="point:78601"> </span>(<span class="keyword" id="font-lock:78602">defun</span> <span class="function-name" id="font-lock:78608">hfy-dirname</span> (file)
<a href="#linum:1838"><span class="linum" id="linum:1838">1838</span></a><span class="fringe" id="point:78627"> </span>  <span class="doc" id="font-lock:78629">"Return everything preceding the last \"/\" from a relative filename FILE,
</span><a href="#linum:1839"><span class="linum" id="linum:1839">1839</span></a><span class="fringe" id="point:78704"> </span><span class="doc" id="font-lock:78704">on the assumption that this will produce a relative directory name.
</span><a href="#linum:1840"><span class="linum" id="linum:1840">1840</span></a><span class="fringe" id="point:78772"> </span><span class="doc" id="font-lock:78772">Hardly bombproof, but good enough in the context in which it is being used."</span>
<a href="#linum:1841"><span class="linum" id="linum:1841">1841</span></a><span class="fringe" id="point:78849"> </span>  <span class="comment-delimiter" id="font-lock:78851">;;</span><span class="comment" id="font-lock:78853">(message "hfy-dirname");;DBUG
</span><a href="#linum:1842"><span class="linum" id="linum:1842">1842</span></a><span class="fringe" id="point:78883"> </span>  (<span class="keyword" id="font-lock:78886">let</span> ((f (directory-file-name file)))
<a href="#linum:1843"><span class="linum" id="linum:1843">1843</span></a><span class="fringe" id="point:78923"> </span>    (and (string-match <span class="string" id="font-lock:78946">"^</span><span class="string" id="font-lock:78948"><span class="regexp-grouping-backslash" id="font-lock:78948">\\</span></span><span class="string" id="font-lock:78950"><span class="regexp-grouping-construct" id="font-lock:78950">(</span></span><span class="string" id="font-lock:78951">.*</span><span class="string" id="font-lock:78953"><span class="regexp-grouping-backslash" id="font-lock:78953">\\</span></span><span class="string" id="font-lock:78955"><span class="regexp-grouping-construct" id="font-lock:78955">)</span></span><span class="string" id="font-lock:78956">/"</span> f) (match-string 1 f))))
<a href="#linum:1844"><span class="linum" id="linum:1844">1844</span></a><span class="fringe" id="point:78984"> </span>
<a href="#linum:1845"><span class="linum" id="linum:1845">1845</span></a><span class="fringe" id="point:78985"> </span><span class="comment-delimiter" id="font-lock:78985">;; </span><span class="comment" id="font-lock:78988">create a directory, cf mkdir -p
</span><a href="#linum:1846"><span class="linum" id="linum:1846">1846</span></a><span class="fringe" id="point:79020"> </span>(<span class="keyword" id="font-lock:79021">defun</span> <span class="function-name" id="font-lock:79027">hfy-make-directory</span> (dir)
<a href="#linum:1847"><span class="linum" id="linum:1847">1847</span></a><span class="fringe" id="point:79052"> </span>  <span class="doc" id="font-lock:79054">"Approx. equivalent of mkdir -p DIR."</span>
<a href="#linum:1848"><span class="linum" id="linum:1848">1848</span></a><span class="fringe" id="point:79092"> </span>  <span class="comment-delimiter" id="font-lock:79094">;;</span><span class="comment" id="font-lock:79096">(message "hfy-make-directory");;DBUG
</span><a href="#linum:1849"><span class="linum" id="linum:1849">1849</span></a><span class="fringe" id="point:79133"> </span>  (<span class="keyword" id="font-lock:79136">if</span> (file-exists-p dir)
<a href="#linum:1850"><span class="linum" id="linum:1850">1850</span></a><span class="fringe" id="point:79159"> </span>      (<span class="keyword" id="font-lock:79166">if</span> (file-directory-p dir) t)
<a href="#linum:1851"><span class="linum" id="linum:1851">1851</span></a><span class="fringe" id="point:79195"> </span>    (make-directory dir t)))
<a href="#linum:1852"><span class="linum" id="linum:1852">1852</span></a><span class="fringe" id="point:79224"> </span>
<a href="#linum:1853"><span class="linum" id="linum:1853">1853</span></a><span class="fringe" id="point:79225"> </span>(<span class="keyword" id="font-lock:79226">defun</span> <span class="function-name" id="font-lock:79232">hfy-text-p</span> (srcdir file)
<a href="#linum:1854"><span class="linum" id="linum:1854">1854</span></a><span class="fringe" id="point:79257"> </span>  <span class="doc" id="font-lock:79259">"Is SRCDIR/FILE text?  Uses `</span><span class="doc" id="font-lock:79288"><span class="constant" id="font-lock:79288">hfy-istext-command</span></span><span class="doc" id="font-lock:79306">' to determine this."</span>
<a href="#linum:1855"><span class="linum" id="linum:1855">1855</span></a><span class="fringe" id="point:79328"> </span>  (<span class="keyword" id="font-lock:79331">let*</span> ((cmd (format hfy-istext-command (expand-file-name file srcdir)))
<a href="#linum:1856"><span class="linum" id="linum:1856">1856</span></a><span class="fringe" id="point:79402"> </span>         (rsp (shell-command-to-string    cmd)))
<a href="#linum:1857"><span class="linum" id="linum:1857">1857</span></a><span class="fringe" id="point:79451"> </span>    (<span class="keyword" id="font-lock:79456">if</span> (string-match <span class="string" id="font-lock:79473">"text"</span> rsp) t nil)))
<a href="#linum:1858"><span class="linum" id="linum:1858">1858</span></a><span class="fringe" id="point:79494"> </span>
<a href="#linum:1859"><span class="linum" id="linum:1859">1859</span></a><span class="fringe" id="point:79495"> </span><span class="comment-delimiter" id="font-lock:79495">;; </span><span class="comment" id="font-lock:79498">open a file, check fontification, if fontified, write a fontified copy
</span><a href="#linum:1860"><span class="linum" id="linum:1860">1860</span></a><span class="fringe" id="point:79569"> </span><span class="comment-delimiter" id="font-lock:79569">;; </span><span class="comment" id="font-lock:79572">to the destination directory, otherwise just copy the file:
</span><a href="#linum:1861"><span class="linum" id="linum:1861">1861</span></a><span class="fringe" id="point:79632"> </span>(<span class="keyword" id="font-lock:79633">defun</span> <span class="function-name" id="font-lock:79639">hfy-copy-and-fontify-file</span> (srcdir dstdir file)
<a href="#linum:1862"><span class="linum" id="linum:1862">1862</span></a><span class="fringe" id="point:79686"> </span>  <span class="doc" id="font-lock:79688">"Open FILE in SRCDIR - if fontified, write a fontified copy to DSTDIR
</span><a href="#linum:1863"><span class="linum" id="linum:1863">1863</span></a><span class="fringe" id="point:79758"> </span><span class="doc" id="font-lock:79758">adding an extension of `</span><span class="doc" id="font-lock:79782"><span class="constant" id="font-lock:79782">hfy-extn</span></span><span class="doc" id="font-lock:79790">'.  Fontification is actually done by
</span><a href="#linum:1864"><span class="linum" id="linum:1864">1864</span></a><span class="fringe" id="point:79828"> </span><span class="doc" id="font-lock:79828">`</span><span class="doc" id="font-lock:79829"><span class="constant" id="font-lock:79829">htmlfontify-buffer</span></span><span class="doc" id="font-lock:79847">'.  If the buffer is not fontified, just copy it."</span>
<a href="#linum:1865"><span class="linum" id="linum:1865">1865</span></a><span class="fringe" id="point:79898"> </span>  <span class="comment-delimiter" id="font-lock:79900">;;</span><span class="comment" id="font-lock:79902">(message "hfy-copy-and-fontify-file");;DBUG
</span><a href="#linum:1866"><span class="linum" id="linum:1866">1866</span></a><span class="fringe" id="point:79946"> </span>  (<span class="keyword" id="font-lock:79949">let</span> (<span class="comment-delimiter" id="font-lock:79954">;;</span><span class="comment" id="font-lock:79956">(fast-lock-minimum-size      hfy-fast-lock-save)
</span><a href="#linum:1867"><span class="linum" id="linum:1867">1867</span></a><span class="fringe" id="point:80005"> </span>        <span class="comment-delimiter" id="font-lock:80013">;;</span><span class="comment" id="font-lock:80015">(font-lock-support-mode         'fast-lock-mode)
</span><a href="#linum:1868"><span class="linum" id="linum:1868">1868</span></a><span class="fringe" id="point:80064"> </span>        <span class="comment-delimiter" id="font-lock:80072">;;</span><span class="comment" id="font-lock:80074">(window-system  (or window-system 'htmlfontify))
</span><a href="#linum:1869"><span class="linum" id="linum:1869">1869</span></a><span class="fringe" id="point:80123"> </span>        (target nil)
<a href="#linum:1870"><span class="linum" id="linum:1870">1870</span></a><span class="fringe" id="point:80144"> </span>        (source nil)
<a href="#linum:1871"><span class="linum" id="linum:1871">1871</span></a><span class="fringe" id="point:80165"> </span>        (html   nil))
<a href="#linum:1872"><span class="linum" id="linum:1872">1872</span></a><span class="fringe" id="point:80187"> </span>    (cd srcdir)
<a href="#linum:1873"><span class="linum" id="linum:1873">1873</span></a><span class="fringe" id="point:80203"> </span>    (<span class="keyword" id="font-lock:80208">with-current-buffer</span> (setq source (find-file-noselect file))
<a href="#linum:1874"><span class="linum" id="linum:1874">1874</span></a><span class="fringe" id="point:80268"> </span>      <span class="comment-delimiter" id="font-lock:80274">;; </span><span class="comment" id="font-lock:80277">FIXME: Shouldn't this use expand-file-name?  --Stef
</span><a href="#linum:1875"><span class="linum" id="linum:1875">1875</span></a><span class="fringe" id="point:80329"> </span>      (setq target (concat dstdir <span class="string" id="font-lock:80363">"/"</span> file))
<a href="#linum:1876"><span class="linum" id="linum:1876">1876</span></a><span class="fringe" id="point:80374"> </span>      (hfy-make-directory (hfy-dirname target))
<a href="#linum:1877"><span class="linum" id="linum:1877">1877</span></a><span class="fringe" id="point:80422"> </span>      (<span class="keyword" id="font-lock:80429">if</span> (not (hfy-opt 'skip-refontification)) (hfy-force-fontification))
<a href="#linum:1878"><span class="linum" id="linum:1878">1878</span></a><span class="fringe" id="point:80497"> </span>      (<span class="keyword" id="font-lock:80504">if</span> (or (hfy-fontified-p) (hfy-text-p srcdir file))
<a href="#linum:1879"><span class="linum" id="linum:1879">1879</span></a><span class="fringe" id="point:80555"> </span>          (<span class="keyword" id="font-lock:80566">progn</span> (setq html  (hfy-fontify-buffer srcdir file))
<a href="#linum:1880"><span class="linum" id="linum:1880">1880</span></a><span class="fringe" id="point:80618"> </span>                 (set-buffer  html)
<a href="#linum:1881"><span class="linum" id="linum:1881">1881</span></a><span class="fringe" id="point:80654"> </span>                 (write-file (concat target hfy-extn))
<a href="#linum:1882"><span class="linum" id="linum:1882">1882</span></a><span class="fringe" id="point:80709"> </span>                 (kill-buffer html))
<a href="#linum:1883"><span class="linum" id="linum:1883">1883</span></a><span class="fringe" id="point:80746"> </span>        <span class="comment-delimiter" id="font-lock:80754">;; </span><span class="comment" id="font-lock:80757">#o0200 == 128, but emacs20 doesn't know that
</span><a href="#linum:1884"><span class="linum" id="linum:1884">1884</span></a><span class="fringe" id="point:80802"> </span>        (<span class="keyword" id="font-lock:80811">if</span> (and (file-exists-p target) (not (file-writable-p target)))
<a href="#linum:1885"><span class="linum" id="linum:1885">1885</span></a><span class="fringe" id="point:80874"> </span>            (set-file-modes target (logior (file-modes target) 128)))
<a href="#linum:1886"><span class="linum" id="linum:1886">1886</span></a><span class="fringe" id="point:80944"> </span>        (copy-file (buffer-file-name source) target 'overwrite))
<a href="#linum:1887"><span class="linum" id="linum:1887">1887</span></a><span class="fringe" id="point:81009"> </span>      (kill-buffer source)) ))
<a href="#linum:1888"><span class="linum" id="linum:1888">1888</span></a><span class="fringe" id="point:81040"> </span>
<a href="#linum:1889"><span class="linum" id="linum:1889">1889</span></a><span class="fringe" id="point:81041"> </span><span class="comment-delimiter" id="font-lock:81041">;; </span><span class="comment" id="font-lock:81044">list of tags in file in srcdir
</span><a href="#linum:1890"><span class="linum" id="linum:1890">1890</span></a><span class="fringe" id="point:81075"> </span>(<span class="keyword" id="font-lock:81076">defun</span> <span class="function-name" id="font-lock:81082">hfy-tags-for-file</span> (srcdir file)
<a href="#linum:1891"><span class="linum" id="linum:1891">1891</span></a><span class="fringe" id="point:81114"> </span>  <span class="doc" id="font-lock:81116">"List of etags tags that have definitions in this FILE.
</span><a href="#linum:1892"><span class="linum" id="linum:1892">1892</span></a><span class="fringe" id="point:81172"> </span><span class="doc" id="font-lock:81172">Looks up the tags cache in `</span><span class="doc" id="font-lock:81200"><span class="constant" id="font-lock:81200">hfy-tags-cache</span></span><span class="doc" id="font-lock:81214">' using SRCDIR as the key."</span>
<a href="#linum:1893"><span class="linum" id="linum:1893">1893</span></a><span class="fringe" id="point:81242"> </span>  <span class="comment-delimiter" id="font-lock:81244">;;</span><span class="comment" id="font-lock:81246">(message "hfy-tags-for-file");;DBUG
</span><a href="#linum:1894"><span class="linum" id="linum:1894">1894</span></a><span class="fringe" id="point:81282"> </span>  (<span class="keyword" id="font-lock:81285">let</span> ((cache-entry (assoc srcdir hfy-tags-cache))
<a href="#linum:1895"><span class="linum" id="linum:1895">1895</span></a><span class="fringe" id="point:81334"> </span>        (cache-hash   nil)
<a href="#linum:1896"><span class="linum" id="linum:1896">1896</span></a><span class="fringe" id="point:81361"> </span>        (tag-list     nil))
<a href="#linum:1897"><span class="linum" id="linum:1897">1897</span></a><span class="fringe" id="point:81389"> </span>    (<span class="keyword" id="font-lock:81394">if</span> (setq cache-hash (cadr cache-entry))
<a href="#linum:1898"><span class="linum" id="linum:1898">1898</span></a><span class="fringe" id="point:81434"> </span>        (maphash
<a href="#linum:1899"><span class="linum" id="linum:1899">1899</span></a><span class="fringe" id="point:81451"> </span>         (<span class="keyword" id="font-lock:81461">lambda</span> (K V)
<a href="#linum:1900"><span class="linum" id="linum:1900">1900</span></a><span class="fringe" id="point:81474"> </span>           (<span class="keyword" id="font-lock:81486">if</span> (assoc file V)
<a href="#linum:1901"><span class="linum" id="linum:1901">1901</span></a><span class="fringe" id="point:81504"> </span>               (setq tag-list (cons K tag-list)))) cache-hash))
<a href="#linum:1902"><span class="linum" id="linum:1902">1902</span></a><span class="fringe" id="point:81568"> </span>    tag-list))
<a href="#linum:1903"><span class="linum" id="linum:1903">1903</span></a><span class="fringe" id="point:81583"> </span>
<a href="#linum:1904"><span class="linum" id="linum:1904">1904</span></a><span class="fringe" id="point:81584"> </span><span class="comment-delimiter" id="font-lock:81584">;; </span><span class="comment" id="font-lock:81587">mark the tags native to this file for anchors
</span><a href="#linum:1905"><span class="linum" id="linum:1905">1905</span></a><span class="fringe" id="point:81633"> </span>(<span class="keyword" id="font-lock:81634">defun</span> <span class="function-name" id="font-lock:81640">hfy-mark-tag-names</span> (srcdir file)
<a href="#linum:1906"><span class="linum" id="linum:1906">1906</span></a><span class="fringe" id="point:81673"> </span>  <span class="doc" id="font-lock:81675">"Mark tags in FILE (lookup SRCDIR in `</span><span class="doc" id="font-lock:81713"><span class="constant" id="font-lock:81713">hfy-tags-cache</span></span><span class="doc" id="font-lock:81727">') with the `</span><span class="doc" id="font-lock:81740"><span class="constant" id="font-lock:81740">hfy-anchor</span></span><span class="doc" id="font-lock:81750">'
</span><a href="#linum:1907"><span class="linum" id="linum:1907">1907</span></a><span class="fringe" id="point:81752"> </span><span class="doc" id="font-lock:81752">property, with a value of \"tag.line-number\"."</span>
<a href="#linum:1908"><span class="linum" id="linum:1908">1908</span></a><span class="fringe" id="point:81800"> </span>  <span class="comment-delimiter" id="font-lock:81802">;;</span><span class="comment" id="font-lock:81804">(message "(hfy-mark-tag-names %s %s)" srcdir file);;DBUG
</span><a href="#linum:1909"><span class="linum" id="linum:1909">1909</span></a><span class="fringe" id="point:81861"> </span>  (<span class="keyword" id="font-lock:81864">let</span> ((cache-entry (assoc srcdir hfy-tags-cache))
<a href="#linum:1910"><span class="linum" id="linum:1910">1910</span></a><span class="fringe" id="point:81913"> </span>        (cache-hash   nil))
<a href="#linum:1911"><span class="linum" id="linum:1911">1911</span></a><span class="fringe" id="point:81941"> </span>    (<span class="keyword" id="font-lock:81946">if</span> (setq cache-hash (cadr cache-entry))
<a href="#linum:1912"><span class="linum" id="linum:1912">1912</span></a><span class="fringe" id="point:81986"> </span>        (mapcar
<a href="#linum:1913"><span class="linum" id="linum:1913">1913</span></a><span class="fringe" id="point:82002"> </span>         (<span class="keyword" id="font-lock:82012">lambda</span> (TAG)
<a href="#linum:1914"><span class="linum" id="linum:1914">1914</span></a><span class="fringe" id="point:82025"> </span>           (mapcar
<a href="#linum:1915"><span class="linum" id="linum:1915">1915</span></a><span class="fringe" id="point:82044"> </span>            (<span class="keyword" id="font-lock:82057">lambda</span> (TLIST)
<a href="#linum:1916"><span class="linum" id="linum:1916">1916</span></a><span class="fringe" id="point:82072"> </span>              (<span class="keyword" id="font-lock:82087">if</span> (string= file (car TLIST))
<a href="#linum:1917"><span class="linum" id="linum:1917">1917</span></a><span class="fringe" id="point:82117"> </span>                  (<span class="keyword" id="font-lock:82136">let*</span> ((line              (cadr TLIST) )
<a href="#linum:1918"><span class="linum" id="linum:1918">1918</span></a><span class="fringe" id="point:82176"> </span>                         (chr              (caddr TLIST) )
<a href="#linum:1919"><span class="linum" id="linum:1919">1919</span></a><span class="fringe" id="point:82235"> </span>                         (link (format <span class="string" id="font-lock:82274">"%s.%d"</span> TAG line) ))
<a href="#linum:1920"><span class="linum" id="linum:1920">1920</span></a><span class="fringe" id="point:82295"> </span>                    (put-text-property (+ 1 chr)
<a href="#linum:1921"><span class="linum" id="linum:1921">1921</span></a><span class="fringe" id="point:82344"> </span>                                       (+ 2 chr)
<a href="#linum:1922"><span class="linum" id="linum:1922">1922</span></a><span class="fringe" id="point:82393"> </span>                                       'hfy-anchor link))))
<a href="#linum:1923"><span class="linum" id="linum:1923">1923</span></a><span class="fringe" id="point:82453"> </span>            (gethash TAG cache-hash)))
<a href="#linum:1924"><span class="linum" id="linum:1924">1924</span></a><span class="fringe" id="point:82492"> </span>         (hfy-tags-for-file srcdir file)))))
<a href="#linum:1925"><span class="linum" id="linum:1925">1925</span></a><span class="fringe" id="point:82537"> </span>
<a href="#linum:1926"><span class="linum" id="linum:1926">1926</span></a><span class="fringe" id="point:82538"> </span>(<span class="keyword" id="font-lock:82539">defun</span> <span class="function-name" id="font-lock:82545">hfy-relstub</span> (file <span class="type" id="font-lock:82563">&amp;optional</span> start)
<a href="#linum:1927"><span class="linum" id="linum:1927">1927</span></a><span class="fringe" id="point:82580"> </span>  <span class="doc" id="font-lock:82582">"Return a \"../\" stub of the appropriate length for the current source
</span><a href="#linum:1928"><span class="linum" id="linum:1928">1928</span></a><span class="fringe" id="point:82654"> </span><span class="doc" id="font-lock:82654">tree depth, as determined from FILE (a filename).
</span><a href="#linum:1929"><span class="linum" id="linum:1929">1929</span></a><span class="fringe" id="point:82704"> </span><span class="doc" id="font-lock:82704">START is the offset at which to start looking for the / character in FILE."</span>
<a href="#linum:1930"><span class="linum" id="linum:1930">1930</span></a><span class="fringe" id="point:82780"> </span>  <span class="comment-delimiter" id="font-lock:82782">;;</span><span class="comment" id="font-lock:82784">(message "hfy-relstub");;DBUG
</span><a href="#linum:1931"><span class="linum" id="linum:1931">1931</span></a><span class="fringe" id="point:82814"> </span>  (<span class="keyword" id="font-lock:82817">let</span> ((c <span class="string" id="font-lock:82825">""</span>))
<a href="#linum:1932"><span class="linum" id="linum:1932">1932</span></a><span class="fringe" id="point:82830"> </span>    (<span class="keyword" id="font-lock:82835">while</span> (setq start (string-match <span class="string" id="font-lock:82867">"/"</span> file start))
<a href="#linum:1933"><span class="linum" id="linum:1933">1933</span></a><span class="fringe" id="point:82884"> </span>      (setq start (1+ start)) (setq c (concat c <span class="string" id="font-lock:82932">"../"</span>))) c))
<a href="#linum:1934"><span class="linum" id="linum:1934">1934</span></a><span class="fringe" id="point:82945"> </span>
<a href="#linum:1935"><span class="linum" id="linum:1935">1935</span></a><span class="fringe" id="point:82946"> </span>(<span class="keyword" id="font-lock:82947">defun</span> <span class="function-name" id="font-lock:82953">hfy-href-stub</span> (this-file def-files tag)
<a href="#linum:1936"><span class="linum" id="linum:1936">1936</span></a><span class="fringe" id="point:82993"> </span>  <span class="doc" id="font-lock:82995">"Return an href stub for a tag href in THIS-FILE.
</span><a href="#linum:1937"><span class="linum" id="linum:1937">1937</span></a><span class="fringe" id="point:83045"> </span><span class="doc" id="font-lock:83045">If DEF-FILES (list of files containing definitions for the tag in question)
</span><a href="#linum:1938"><span class="linum" id="linum:1938">1938</span></a><span class="fringe" id="point:83121"> </span><span class="doc" id="font-lock:83121">contains only one entry, the href should link straight to that file.
</span><a href="#linum:1939"><span class="linum" id="linum:1939">1939</span></a><span class="fringe" id="point:83190"> </span><span class="doc" id="font-lock:83190">Otherwise, the link should be to the index file.\n
</span><a href="#linum:1940"><span class="linum" id="linum:1940">1940</span></a><span class="fringe" id="point:83241"> </span><span class="doc" id="font-lock:83241">We are not yet concerned with the file extensions/tag line number and so on at
</span><a href="#linum:1941"><span class="linum" id="linum:1941">1941</span></a><span class="fringe" id="point:83320"> </span><span class="doc" id="font-lock:83320">this point.\n
</span><a href="#linum:1942"><span class="linum" id="linum:1942">1942</span></a><span class="fringe" id="point:83334"> </span><span class="doc" id="font-lock:83334">If `</span><span class="doc" id="font-lock:83338"><span class="constant" id="font-lock:83338">hfy-split-index</span></span><span class="doc" id="font-lock:83353">' is set, and the href wil be to an index file rather than
</span><a href="#linum:1943"><span class="linum" id="linum:1943">1943</span></a><span class="fringe" id="point:83412"> </span><span class="doc" id="font-lock:83412">a source file, append a .X to `</span><span class="doc" id="font-lock:83443"><span class="constant" id="font-lock:83443">hfy-index-file</span></span><span class="doc" id="font-lock:83457">', where X is the uppercased
</span><a href="#linum:1944"><span class="linum" id="linum:1944">1944</span></a><span class="fringe" id="point:83486"> </span><span class="doc" id="font-lock:83486">first character of TAG.\n
</span><a href="#linum:1945"><span class="linum" id="linum:1945">1945</span></a><span class="fringe" id="point:83512"> </span><span class="doc" id="font-lock:83512">See also `</span><span class="doc" id="font-lock:83522"><span class="constant" id="font-lock:83522">hfy-relstub</span></span><span class="doc" id="font-lock:83533">', `</span><span class="doc" id="font-lock:83537"><span class="constant" id="font-lock:83537">hfy-index-file</span></span><span class="doc" id="font-lock:83551">'."</span>
<a href="#linum:1946"><span class="linum" id="linum:1946">1946</span></a><span class="fringe" id="point:83555"> </span>  <span class="comment-delimiter" id="font-lock:83557">;;</span><span class="comment" id="font-lock:83559">(message "hfy-href-stub");;DBUG
</span><a href="#linum:1947"><span class="linum" id="linum:1947">1947</span></a><span class="fringe" id="point:83591"> </span>  <span class="comment-delimiter" id="font-lock:83593">;; </span><span class="comment" id="font-lock:83596">FIXME: Why not use something like
</span><a href="#linum:1948"><span class="linum" id="linum:1948">1948</span></a><span class="fringe" id="point:83630"> </span>  <span class="comment-delimiter" id="font-lock:83632">;; </span><span class="comment" id="font-lock:83635">(file-relative-name (if ...) (file-name-directory this-file)) ?  --Stef
</span><a href="#linum:1949"><span class="linum" id="linum:1949">1949</span></a><span class="fringe" id="point:83707"> </span>  (concat
<a href="#linum:1950"><span class="linum" id="linum:1950">1950</span></a><span class="fringe" id="point:83717"> </span>   (hfy-relstub this-file)
<a href="#linum:1951"><span class="linum" id="linum:1951">1951</span></a><span class="fringe" id="point:83744"> </span>   (<span class="keyword" id="font-lock:83748">if</span> (= 1 (length def-files)) (car def-files)
<a href="#linum:1952"><span class="linum" id="linum:1952">1952</span></a><span class="fringe" id="point:83792"> </span>     (<span class="keyword" id="font-lock:83798">if</span> (not hfy-split-index) hfy-index-file
<a href="#linum:1953"><span class="linum" id="linum:1953">1953</span></a><span class="fringe" id="point:83838"> </span>       (concat hfy-index-file <span class="string" id="font-lock:83868">"."</span> (upcase (substring tag 0 1)))))) )
<a href="#linum:1954"><span class="linum" id="linum:1954">1954</span></a><span class="fringe" id="point:83907"> </span>
<a href="#linum:1955"><span class="linum" id="linum:1955">1955</span></a><span class="fringe" id="point:83908"> </span>(<span class="keyword" id="font-lock:83909">defun</span> <span class="function-name" id="font-lock:83915">hfy-href</span> (this-file def-files tag tag-map)
<a href="#linum:1956"><span class="linum" id="linum:1956">1956</span></a><span class="fringe" id="point:83958"> </span>  <span class="doc" id="font-lock:83960">"Return a relative href to the tag in question, based on\n
</span><a href="#linum:1957"><span class="linum" id="linum:1957">1957</span></a><span class="fringe" id="point:84019"> </span><span class="doc" id="font-lock:84019">THIS-FILE `</span><span class="doc" id="font-lock:84030"><span class="constant" id="font-lock:84030">hfy-link-extn</span></span><span class="doc" id="font-lock:84043">' `</span><span class="doc" id="font-lock:84046"><span class="constant" id="font-lock:84046">hfy-extn</span></span><span class="doc" id="font-lock:84054">' DEF-FILES TAG and TAG-MAP\n
</span><a href="#linum:1958"><span class="linum" id="linum:1958">1958</span></a><span class="fringe" id="point:84084"> </span><span class="doc" id="font-lock:84084">THIS-FILE is the current source file
</span><a href="#linum:1959"><span class="linum" id="linum:1959">1959</span></a><span class="fringe" id="point:84121"> </span><span class="doc" id="font-lock:84121">DEF-FILES is a list of file containing possible link endpoints for TAG
</span><a href="#linum:1960"><span class="linum" id="linum:1960">1960</span></a><span class="fringe" id="point:84192"> </span><span class="doc" id="font-lock:84192">TAG is the tag in question
</span><a href="#linum:1961"><span class="linum" id="linum:1961">1961</span></a><span class="fringe" id="point:84219"> </span><span class="doc" id="font-lock:84219">TAG-MAP is the entry in `</span><span class="doc" id="font-lock:84244"><span class="constant" id="font-lock:84244">hfy-tags-cache</span></span><span class="doc" id="font-lock:84258">'."</span>
<a href="#linum:1962"><span class="linum" id="linum:1962">1962</span></a><span class="fringe" id="point:84262"> </span>  <span class="comment-delimiter" id="font-lock:84264">;;</span><span class="comment" id="font-lock:84266">(message "hfy-href");;DBUG
</span><a href="#linum:1963"><span class="linum" id="linum:1963">1963</span></a><span class="fringe" id="point:84293"> </span>  (concat
<a href="#linum:1964"><span class="linum" id="linum:1964">1964</span></a><span class="fringe" id="point:84303"> </span>   (hfy-href-stub this-file def-files tag)
<a href="#linum:1965"><span class="linum" id="linum:1965">1965</span></a><span class="fringe" id="point:84346"> </span>   (or hfy-link-extn hfy-extn) <span class="string" id="font-lock:84377">"#"</span> tag <span class="comment-delimiter" id="font-lock:84385">;;</span><span class="comment" id="font-lock:84387">(.src -&gt; .html)
</span><a href="#linum:1966"><span class="linum" id="linum:1966">1966</span></a><span class="fringe" id="point:84403"> </span>   (<span class="keyword" id="font-lock:84407">if</span> (= 1 (length def-files))
<a href="#linum:1967"><span class="linum" id="linum:1967">1967</span></a><span class="fringe" id="point:84435"> </span>       (concat <span class="string" id="font-lock:84450">"."</span> (format <span class="string" id="font-lock:84462">"%d"</span> (cadr (assoc (car def-files) tag-map)))))) )
<a href="#linum:1968"><span class="linum" id="linum:1968">1968</span></a><span class="fringe" id="point:84512"> </span>
<a href="#linum:1969"><span class="linum" id="linum:1969">1969</span></a><span class="fringe" id="point:84513"> </span>(<span class="keyword" id="font-lock:84514">defun</span> <span class="function-name" id="font-lock:84520">hfy-word-regex</span> (string)
<a href="#linum:1970"><span class="linum" id="linum:1970">1970</span></a><span class="fringe" id="point:84544"> </span>  <span class="doc" id="font-lock:84546">"Return a regex that matches STRING as the first `</span><span class="doc" id="font-lock:84596"><span class="constant" id="font-lock:84596">match-string</span></span><span class="doc" id="font-lock:84608">', with non
</span><a href="#linum:1971"><span class="linum" id="linum:1971">1971</span></a><span class="fringe" id="point:84620"> </span><span class="doc" id="font-lock:84620">word characters on either side."</span>
<a href="#linum:1972"><span class="linum" id="linum:1972">1972</span></a><span class="fringe" id="point:84653"> </span>  <span class="comment-delimiter" id="font-lock:84655">;; </span><span class="comment" id="font-lock:84658">FIXME: Should this use [</span><span class="comment" id="font-lock:84682"><span class="negation-char" id="font-lock:84682">^</span></span><span class="comment" id="font-lock:84683">$[:alnum:]_] instead?  --Stef
</span><a href="#linum:1973"><span class="linum" id="linum:1973">1973</span></a><span class="fringe" id="point:84713"> </span>  (concat <span class="string" id="font-lock:84723">"[</span><span class="string" id="font-lock:84725"><span class="negation-char" id="font-lock:84725">^</span></span><span class="string" id="font-lock:84726">$A-Za-z_0-9]</span><span class="string" id="font-lock:84738"><span class="regexp-grouping-backslash" id="font-lock:84738">\\</span></span><span class="string" id="font-lock:84740"><span class="regexp-grouping-construct" id="font-lock:84740">(</span></span><span class="string" id="font-lock:84741">"</span> (regexp-quote string) <span class="string" id="font-lock:84765">"</span><span class="string" id="font-lock:84766"><span class="regexp-grouping-backslash" id="font-lock:84766">\\</span></span><span class="string" id="font-lock:84768"><span class="regexp-grouping-construct" id="font-lock:84768">)</span></span><span class="string" id="font-lock:84769">[</span><span class="string" id="font-lock:84770"><span class="negation-char" id="font-lock:84770">^</span></span><span class="string" id="font-lock:84771">A-Za-z_0-9]"</span>))
<a href="#linum:1974"><span class="linum" id="linum:1974">1974</span></a><span class="fringe" id="point:84786"> </span>
<a href="#linum:1975"><span class="linum" id="linum:1975">1975</span></a><span class="fringe" id="point:84787"> </span><span class="comment-delimiter" id="font-lock:84787">;; </span><span class="comment" id="font-lock:84790">mark all tags for hyperlinking, except the tags at
</span><a href="#linum:1976"><span class="linum" id="linum:1976">1976</span></a><span class="fringe" id="point:84841"> </span><span class="comment-delimiter" id="font-lock:84841">;; </span><span class="comment" id="font-lock:84844">their own points of definition, iyswim:
</span><a href="#linum:1977"><span class="linum" id="linum:1977">1977</span></a><span class="fringe" id="point:84884"> </span>(<span class="keyword" id="font-lock:84885">defun</span> <span class="function-name" id="font-lock:84891">hfy-mark-tag-hrefs</span> (srcdir file)
<a href="#linum:1978"><span class="linum" id="linum:1978">1978</span></a><span class="fringe" id="point:84924"> </span>  <span class="doc" id="font-lock:84926">"Mark href start points with the `</span><span class="doc" id="font-lock:84960"><span class="constant" id="font-lock:84960">hfy-link</span></span><span class="doc" id="font-lock:84968">' prop (value: href string).\n
</span><a href="#linum:1979"><span class="linum" id="linum:1979">1979</span></a><span class="fringe" id="point:84999"> </span><span class="doc" id="font-lock:84999">Mark href end points with the `</span><span class="doc" id="font-lock:85030"><span class="constant" id="font-lock:85030">hfy-endl</span></span><span class="doc" id="font-lock:85038">' prop (value t).\n
</span><a href="#linum:1980"><span class="linum" id="linum:1980">1980</span></a><span class="fringe" id="point:85058"> </span><span class="doc" id="font-lock:85058">Avoid overlapping links, and mark links in descending length of
</span><a href="#linum:1981"><span class="linum" id="linum:1981">1981</span></a><span class="fringe" id="point:85122"> </span><span class="doc" id="font-lock:85122">tag name in order to prevent subtags from usurping supertags,
</span><a href="#linum:1982"><span class="linum" id="linum:1982">1982</span></a><span class="fringe" id="point:85184"> </span><span class="doc" id="font-lock:85184">\(eg \"term\" for \"terminal\").
</span><a href="#linum:1983"><span class="linum" id="linum:1983">1983</span></a><span class="fringe" id="point:85217"> </span><span class="doc" id="font-lock:85217">SRCDIR is the directory being \"published\".
</span><a href="#linum:1984"><span class="linum" id="linum:1984">1984</span></a><span class="fringe" id="point:85262"> </span><span class="doc" id="font-lock:85262">FILE is the specific file we are rendering."</span>
<a href="#linum:1985"><span class="linum" id="linum:1985">1985</span></a><span class="fringe" id="point:85307"> </span>  <span class="comment-delimiter" id="font-lock:85309">;;</span><span class="comment" id="font-lock:85311">(message "hfy-mark-tag-hrefs");;DBUG
</span><a href="#linum:1986"><span class="linum" id="linum:1986">1986</span></a><span class="fringe" id="point:85348"> </span>  (<span class="keyword" id="font-lock:85351">let</span> ((cache-entry (assoc srcdir hfy-tags-cache))
<a href="#linum:1987"><span class="linum" id="linum:1987">1987</span></a><span class="fringe" id="point:85400"> </span>        (list-cache  (assoc srcdir hfy-tags-sortl))
<a href="#linum:1988"><span class="linum" id="linum:1988">1988</span></a><span class="fringe" id="point:85452"> </span>        (rmap-cache  (assoc srcdir hfy-tags-rmap ))
<a href="#linum:1989"><span class="linum" id="linum:1989">1989</span></a><span class="fringe" id="point:85504"> </span>        (no-comment  (hfy-opt  'zap-comment-links))
<a href="#linum:1990"><span class="linum" id="linum:1990">1990</span></a><span class="fringe" id="point:85556"> </span>        (no-strings  (hfy-opt  'zap-string-links ))
<a href="#linum:1991"><span class="linum" id="linum:1991">1991</span></a><span class="fringe" id="point:85608"> </span>        (cache-hash                            nil)
<a href="#linum:1992"><span class="linum" id="linum:1992">1992</span></a><span class="fringe" id="point:85660"> </span>        (tags-list                             nil)
<a href="#linum:1993"><span class="linum" id="linum:1993">1993</span></a><span class="fringe" id="point:85712"> </span>        (tags-rmap                             nil)
<a href="#linum:1994"><span class="linum" id="linum:1994">1994</span></a><span class="fringe" id="point:85764"> </span>        (case-fold-search                      nil))
<a href="#linum:1995"><span class="linum" id="linum:1995">1995</span></a><span class="fringe" id="point:85817"> </span>    <span class="comment-delimiter" id="font-lock:85821">;; </span><span class="comment" id="font-lock:85824">extract the tag mapping hashes (fwd and rev) and the tag list:
</span><a href="#linum:1996"><span class="linum" id="linum:1996">1996</span></a><span class="fringe" id="point:85887"> </span>    (<span class="keyword" id="font-lock:85892">if</span> (and (setq cache-hash (cadr cache-entry))
<a href="#linum:1997"><span class="linum" id="linum:1997">1997</span></a><span class="fringe" id="point:85937"> </span>             (setq tags-rmap  (cadr rmap-cache ))
<a href="#linum:1998"><span class="linum" id="linum:1998">1998</span></a><span class="fringe" id="point:85987"> </span>             (setq tags-list  (cadr list-cache )))
<a href="#linum:1999"><span class="linum" id="linum:1999">1999</span></a><span class="fringe" id="point:86038"> </span>        (mapcar
<a href="#linum:2000"><span class="linum" id="linum:2000">2000</span></a><span class="fringe" id="point:86054"> </span>         (<span class="keyword" id="font-lock:86064">lambda</span> (TAG)
<a href="#linum:2001"><span class="linum" id="linum:2001">2001</span></a><span class="fringe" id="point:86077"> </span>           (<span class="keyword" id="font-lock:86089">let*</span> ((start            nil)
<a href="#linum:2002"><span class="linum" id="linum:2002">2002</span></a><span class="fringe" id="point:86118"> </span>                  (stop             nil)
<a href="#linum:2003"><span class="linum" id="linum:2003">2003</span></a><span class="fringe" id="point:86159"> </span>                  (href             nil)
<a href="#linum:2004"><span class="linum" id="linum:2004">2004</span></a><span class="fringe" id="point:86200"> </span>                  (name             nil)
<a href="#linum:2005"><span class="linum" id="linum:2005">2005</span></a><span class="fringe" id="point:86241"> </span>                  (case-fold-search nil)
<a href="#linum:2006"><span class="linum" id="linum:2006">2006</span></a><span class="fringe" id="point:86282"> </span>                  (tmp-point        nil)
<a href="#linum:2007"><span class="linum" id="linum:2007">2007</span></a><span class="fringe" id="point:86323"> </span>                  (maybe-start      nil)
<a href="#linum:2008"><span class="linum" id="linum:2008">2008</span></a><span class="fringe" id="point:86364"> </span>                  (face-at          nil)
<a href="#linum:2009"><span class="linum" id="linum:2009">2009</span></a><span class="fringe" id="point:86405"> </span>                  (rmap-entry       nil)
<a href="#linum:2010"><span class="linum" id="linum:2010">2010</span></a><span class="fringe" id="point:86446"> </span>                  (rnew-elt         nil)
<a href="#linum:2011"><span class="linum" id="linum:2011">2011</span></a><span class="fringe" id="point:86487"> </span>                  (rmap-line        nil)
<a href="#linum:2012"><span class="linum" id="linum:2012">2012</span></a><span class="fringe" id="point:86528"> </span>                  (tag-regex       (hfy-word-regex TAG))
<a href="#linum:2013"><span class="linum" id="linum:2013">2013</span></a><span class="fringe" id="point:86585"> </span>                  (tag-map         (gethash TAG cache-hash))
<a href="#linum:2014"><span class="linum" id="linum:2014">2014</span></a><span class="fringe" id="point:86646"> </span>                  (tag-files       (mapcar #'car tag-map)))
<a href="#linum:2015"><span class="linum" id="linum:2015">2015</span></a><span class="fringe" id="point:86706"> </span>             <span class="comment-delimiter" id="font-lock:86719">;; </span><span class="comment" id="font-lock:86722">find instances of TAG and do what needs to be done:
</span><a href="#linum:2016"><span class="linum" id="linum:2016">2016</span></a><span class="fringe" id="point:86774"> </span>             (goto-char (point-min))
<a href="#linum:2017"><span class="linum" id="linum:2017">2017</span></a><span class="fringe" id="point:86811"> </span>             (<span class="keyword" id="font-lock:86825">while</span> (search-forward TAG nil 'NOERROR)
<a href="#linum:2018"><span class="linum" id="linum:2018">2018</span></a><span class="fringe" id="point:86865"> </span>               (setq tmp-point   (point)
<a href="#linum:2019"><span class="linum" id="linum:2019">2019</span></a><span class="fringe" id="point:86906"> </span>                     maybe-start (- (match-beginning 0) 1))
<a href="#linum:2020"><span class="linum" id="linum:2020">2020</span></a><span class="fringe" id="point:86966"> </span>               (goto-char maybe-start)
<a href="#linum:2021"><span class="linum" id="linum:2021">2021</span></a><span class="fringe" id="point:87005"> </span>               (<span class="keyword" id="font-lock:87021">if</span> (not (looking-at tag-regex))
<a href="#linum:2022"><span class="linum" id="linum:2022">2022</span></a><span class="fringe" id="point:87053"> </span>                   nil
<a href="#linum:2023"><span class="linum" id="linum:2023">2023</span></a><span class="fringe" id="point:87076"> </span>                 (setq start   (match-beginning 1))
<a href="#linum:2024"><span class="linum" id="linum:2024">2024</span></a><span class="fringe" id="point:87128"> </span>                 (setq stop    (match-end 1))
<a href="#linum:2025"><span class="linum" id="linum:2025">2025</span></a><span class="fringe" id="point:87174"> </span>                 (setq face-at
<a href="#linum:2026"><span class="linum" id="linum:2026">2026</span></a><span class="fringe" id="point:87205"> </span>                       (and (or no-comment no-strings) (hfy-face-at start)))
<a href="#linum:2027"><span class="linum" id="linum:2027">2027</span></a><span class="fringe" id="point:87282"> </span>                 (<span class="keyword" id="font-lock:87300">if</span> (listp face-at)
<a href="#linum:2028"><span class="linum" id="linum:2028">2028</span></a><span class="fringe" id="point:87319"> </span>                     (setq face-at (cadr (memq <span class="builtin" id="font-lock:87366">:inherit</span> face-at))))
<a href="#linum:2029"><span class="linum" id="linum:2029">2029</span></a><span class="fringe" id="point:87387"> </span>                 (<span class="keyword" id="font-lock:87405">if</span> (or (text-property-any   start  (1+ stop)  'hfy-linkp  t)
<a href="#linum:2030"><span class="linum" id="linum:2030">2030</span></a><span class="fringe" id="point:87466"> </span>                         (and no-comment (eq 'font-lock-comment-face face-at))
<a href="#linum:2031"><span class="linum" id="linum:2031">2031</span></a><span class="fringe" id="point:87545"> </span>                         (and no-strings (eq 'font-lock-string-face  face-at)))
<a href="#linum:2032"><span class="linum" id="linum:2032">2032</span></a><span class="fringe" id="point:87625"> </span>                     nil <span class="comment-delimiter" id="font-lock:87650">;; </span><span class="comment" id="font-lock:87653">already a link, NOOP
</span><a href="#linum:2033"><span class="linum" id="linum:2033">2033</span></a><span class="fringe" id="point:87674"> </span>
<a href="#linum:2034"><span class="linum" id="linum:2034">2034</span></a><span class="fringe" id="point:87675"> </span>                   <span class="comment-delimiter" id="font-lock:87694">;; </span><span class="comment" id="font-lock:87697">set a reverse map entry:
</span><a href="#linum:2035"><span class="linum" id="linum:2035">2035</span></a><span class="fringe" id="point:87722"> </span>                   (setq rmap-line  (line-number-at-pos)
<a href="#linum:2036"><span class="linum" id="linum:2036">2036</span></a><span class="fringe" id="point:87779"> </span>                         rmap-entry (gethash    TAG     tags-rmap)
<a href="#linum:2037"><span class="linum" id="linum:2037">2037</span></a><span class="fringe" id="point:87846"> </span>                         rnew-elt   (list  file  rmap-line  start)
<a href="#linum:2038"><span class="linum" id="linum:2038">2038</span></a><span class="fringe" id="point:87913"> </span>                         rmap-entry (cons   rnew-elt   rmap-entry)
<a href="#linum:2039"><span class="linum" id="linum:2039">2039</span></a><span class="fringe" id="point:87980"> </span>                         name       (format <span class="string" id="font-lock:88024">"%s.%d"</span> TAG rmap-line))
<a href="#linum:2040"><span class="linum" id="linum:2040">2040</span></a><span class="fringe" id="point:88048"> </span>                   (put-text-property start (1+ start) 'hfy-inst name)
<a href="#linum:2041"><span class="linum" id="linum:2041">2041</span></a><span class="fringe" id="point:88119"> </span>                   (puthash TAG rmap-entry tags-rmap)
<a href="#linum:2042"><span class="linum" id="linum:2042">2042</span></a><span class="fringe" id="point:88173"> </span>
<a href="#linum:2043"><span class="linum" id="linum:2043">2043</span></a><span class="fringe" id="point:88174"> </span>                   <span class="comment-delimiter" id="font-lock:88193">;; </span><span class="comment" id="font-lock:88196">mark the link. link to index if the tag has &gt; 1 def
</span><a href="#linum:2044"><span class="linum" id="linum:2044">2044</span></a><span class="fringe" id="point:88248"> </span>                   <span class="comment-delimiter" id="font-lock:88267">;; </span><span class="comment" id="font-lock:88270">add the line number to the #name if it does not:
</span><a href="#linum:2045"><span class="linum" id="linum:2045">2045</span></a><span class="fringe" id="point:88319"> </span>                   (setq href (hfy-href file tag-files TAG tag-map))
<a href="#linum:2046"><span class="linum" id="linum:2046">2046</span></a><span class="fringe" id="point:88388"> </span>                   (put-text-property start (1+ start) 'hfy-link  href)
<a href="#linum:2047"><span class="linum" id="linum:2047">2047</span></a><span class="fringe" id="point:88460"> </span>                   (put-text-property stop  (1+ stop ) 'hfy-endl  t   )
<a href="#linum:2048"><span class="linum" id="linum:2048">2048</span></a><span class="fringe" id="point:88532"> </span>                   (put-text-property start (1+ stop ) 'hfy-linkp t   )))
<a href="#linum:2049"><span class="linum" id="linum:2049">2049</span></a><span class="fringe" id="point:88606"> </span>               (goto-char tmp-point)) ))
<a href="#linum:2050"><span class="linum" id="linum:2050">2050</span></a><span class="fringe" id="point:88647"> </span>         tags-list) )))
<a href="#linum:2051"><span class="linum" id="linum:2051">2051</span></a><span class="fringe" id="point:88671"> </span>
<a href="#linum:2052"><span class="linum" id="linum:2052">2052</span></a><span class="fringe" id="point:88672"> </span>(<span class="keyword" id="font-lock:88673">defun</span> <span class="function-name" id="font-lock:88679">hfy-shell</span> ()
<a href="#linum:2053"><span class="linum" id="linum:2053">2053</span></a><span class="fringe" id="point:88692"> </span>  <span class="doc" id="font-lock:88694">"Return `</span><span class="doc" id="font-lock:88703"><span class="constant" id="font-lock:88703">shell-file-name</span></span><span class="doc" id="font-lock:88718">', or \"/bin/sh\" if it is a non-bourne shell."</span>
<a href="#linum:2054"><span class="linum" id="linum:2054">2054</span></a><span class="fringe" id="point:88766"> </span>  (<span class="keyword" id="font-lock:88769">if</span> (string-match <span class="string" id="font-lock:88786">"\\&lt;bash\\&gt;</span><span class="string" id="font-lock:88797"><span class="regexp-grouping-backslash" id="font-lock:88797">\\</span></span><span class="string" id="font-lock:88799"><span class="regexp-grouping-construct" id="font-lock:88799">|</span></span><span class="string" id="font-lock:88800">\\&lt;sh\\&gt;</span><span class="string" id="font-lock:88808"><span class="regexp-grouping-backslash" id="font-lock:88808">\\</span></span><span class="string" id="font-lock:88810"><span class="regexp-grouping-construct" id="font-lock:88810">|</span></span><span class="string" id="font-lock:88811">\\&lt;dash\\&gt;"</span> shell-file-name)
<a href="#linum:2055"><span class="linum" id="linum:2055">2055</span></a><span class="fringe" id="point:88840"> </span>      shell-file-name
<a href="#linum:2056"><span class="linum" id="linum:2056">2056</span></a><span class="fringe" id="point:88862"> </span>    (or hfy-shell-file-name <span class="string" id="font-lock:88890">"/bin/sh"</span>)))
<a href="#linum:2057"><span class="linum" id="linum:2057">2057</span></a><span class="fringe" id="point:88903"> </span>
<a href="#linum:2058"><span class="linum" id="linum:2058">2058</span></a><span class="fringe" id="point:88904"> </span><span class="comment-delimiter" id="font-lock:88904">;; </span><span class="comment" id="font-lock:88907">cache the #(tag =&gt; file line point) entries for files under srcdir
</span><a href="#linum:2059"><span class="linum" id="linum:2059">2059</span></a><span class="fringe" id="point:88974"> </span><span class="comment-delimiter" id="font-lock:88974">;; </span><span class="comment" id="font-lock:88977">and cache the descending sorted list of tags in the relevant alist,
</span><a href="#linum:2060"><span class="linum" id="linum:2060">2060</span></a><span class="fringe" id="point:89045"> </span><span class="comment-delimiter" id="font-lock:89045">;; </span><span class="comment" id="font-lock:89048">also keyed by srcdir:
</span><a href="#linum:2061"><span class="linum" id="linum:2061">2061</span></a><span class="fringe" id="point:89070"> </span>(<span class="keyword" id="font-lock:89071">defun</span> <span class="function-name" id="font-lock:89077">hfy-load-tags-cache</span> (srcdir)
<a href="#linum:2062"><span class="linum" id="linum:2062">2062</span></a><span class="fringe" id="point:89106"> </span>  <span class="doc" id="font-lock:89108">"Run `</span><span class="doc" id="font-lock:89114"><span class="constant" id="font-lock:89114">hfy-etags-cmd</span></span><span class="doc" id="font-lock:89127">' on SRCDIR, then call `</span><span class="doc" id="font-lock:89151"><span class="constant" id="font-lock:89151">hfy-parse-tags-buffer</span></span><span class="doc" id="font-lock:89172">'."</span>
<a href="#linum:2063"><span class="linum" id="linum:2063">2063</span></a><span class="fringe" id="point:89176"> </span>  <span class="comment-delimiter" id="font-lock:89178">;;</span><span class="comment" id="font-lock:89180">(message "hfy-load-tags-cache");;DBUG
</span><a href="#linum:2064"><span class="linum" id="linum:2064">2064</span></a><span class="fringe" id="point:89218"> </span>  (<span class="keyword" id="font-lock:89221">let</span> ((etags-buffer  (get-buffer-create     <span class="string" id="font-lock:89264">"*hfy-tags*"</span>))
<a href="#linum:2065"><span class="linum" id="linum:2065">2065</span></a><span class="fringe" id="point:89279"> </span>        (etags-command (format hfy-etags-cmd hfy-etags-bin))
<a href="#linum:2066"><span class="linum" id="linum:2066">2066</span></a><span class="fringe" id="point:89340"> </span>        (shell-file-name                        (hfy-shell)))
<a href="#linum:2067"><span class="linum" id="linum:2067">2067</span></a><span class="fringe" id="point:89402"> </span>    (cd srcdir)
<a href="#linum:2068"><span class="linum" id="linum:2068">2068</span></a><span class="fringe" id="point:89418"> </span>    (shell-command  etags-command etags-buffer)
<a href="#linum:2069"><span class="linum" id="linum:2069">2069</span></a><span class="fringe" id="point:89466"> </span>    (hfy-parse-tags-buffer srcdir etags-buffer)) )
<a href="#linum:2070"><span class="linum" id="linum:2070">2070</span></a><span class="fringe" id="point:89517"> </span>
<a href="#linum:2071"><span class="linum" id="linum:2071">2071</span></a><span class="fringe" id="point:89518"> </span><span class="comment-delimiter" id="font-lock:89518">;; </span><span class="comment" id="font-lock:89521">break this out from `</span><span class="comment" id="font-lock:89542"><span class="constant" id="font-lock:89542">hfy-load-tags-cache</span></span><span class="comment" id="font-lock:89561">' to make the tar file
</span><a href="#linum:2072"><span class="linum" id="linum:2072">2072</span></a><span class="fringe" id="point:89584"> </span><span class="comment-delimiter" id="font-lock:89584">;; </span><span class="comment" id="font-lock:89587">functionality easier to implement.
</span><a href="#linum:2073"><span class="linum" id="linum:2073">2073</span></a><span class="fringe" id="point:89622"> </span><span class="comment-delimiter" id="font-lock:89622">;; </span><span class="comment" id="font-lock:89625">( tar file functionality not merged here because it requires a
</span><a href="#linum:2074"><span class="linum" id="linum:2074">2074</span></a><span class="fringe" id="point:89688"> </span><span class="comment-delimiter" id="font-lock:89688">;;   </span><span class="comment" id="font-lock:89693">hacked copy of etags capable of tagging stdin: if Francesco
</span><a href="#linum:2075"><span class="linum" id="linum:2075">2075</span></a><span class="fringe" id="point:89753"> </span><span class="comment-delimiter" id="font-lock:89753">;;   </span><span class="comment" id="font-lock:89758">Potorti accepts a patch, or otherwise implements stdin tagging,
</span><a href="#linum:2076"><span class="linum" id="linum:2076">2076</span></a><span class="fringe" id="point:89822"> </span><span class="comment-delimiter" id="font-lock:89822">;;   </span><span class="comment" id="font-lock:89827">then I will provide a `</span><span class="comment" id="font-lock:89850"><span class="constant" id="font-lock:89850">htmlfontify-tar-file</span></span><span class="comment" id="font-lock:89870">' defun )
</span><a href="#linum:2077"><span class="linum" id="linum:2077">2077</span></a><span class="fringe" id="point:89880"> </span>(<span class="keyword" id="font-lock:89881">defun</span> <span class="function-name" id="font-lock:89887">hfy-parse-tags-buffer</span> (srcdir buffer)
<a href="#linum:2078"><span class="linum" id="linum:2078">2078</span></a><span class="fringe" id="point:89925"> </span>  <span class="doc" id="font-lock:89927">"Parse a BUFFER containing etags formatted output, loading the
</span><a href="#linum:2079"><span class="linum" id="linum:2079">2079</span></a><span class="fringe" id="point:89990"> </span><span class="doc" id="font-lock:89990">`</span><span class="doc" id="font-lock:89991"><span class="constant" id="font-lock:89991">hfy-tags-cache</span></span><span class="doc" id="font-lock:90005">' and `</span><span class="doc" id="font-lock:90012"><span class="constant" id="font-lock:90012">hfy-tags-sortl</span></span><span class="doc" id="font-lock:90026">' entries for SRCDIR."</span>
<a href="#linum:2080"><span class="linum" id="linum:2080">2080</span></a><span class="fringe" id="point:90049"> </span>  (<span class="keyword" id="font-lock:90052">let</span> ((cache-entry     (assoc srcdir    hfy-tags-cache))
<a href="#linum:2081"><span class="linum" id="linum:2081">2081</span></a><span class="fringe" id="point:90108"> </span>        (tlist-cache     (assoc srcdir    hfy-tags-sortl))
<a href="#linum:2082"><span class="linum" id="linum:2082">2082</span></a><span class="fringe" id="point:90167"> </span>        (trmap-cache     (assoc srcdir    hfy-tags-rmap ))
<a href="#linum:2083"><span class="linum" id="linum:2083">2083</span></a><span class="fringe" id="point:90226"> </span>        (cache-hash nil) (trmap-hash nil) (tags-list  nil)
<a href="#linum:2084"><span class="linum" id="linum:2084">2084</span></a><span class="fringe" id="point:90285"> </span>        (hash-entry nil) (tag-string nil) (tag-line   nil)
<a href="#linum:2085"><span class="linum" id="linum:2085">2085</span></a><span class="fringe" id="point:90344"> </span>        (tag-point  nil) (new-entry  nil) (etags-file nil))
<a href="#linum:2086"><span class="linum" id="linum:2086">2086</span></a><span class="fringe" id="point:90404"> </span>
<a href="#linum:2087"><span class="linum" id="linum:2087">2087</span></a><span class="fringe" id="point:90405"> </span>    <span class="comment-delimiter" id="font-lock:90409">;; </span><span class="comment" id="font-lock:90412">(re)initialise the tag reverse map:
</span><a href="#linum:2088"><span class="linum" id="linum:2088">2088</span></a><span class="fringe" id="point:90448"> </span>    (<span class="keyword" id="font-lock:90453">if</span> trmap-cache (setq trmap-hash (cadr trmap-cache))
<a href="#linum:2089"><span class="linum" id="linum:2089">2089</span></a><span class="fringe" id="point:90505"> </span>      (setq trmap-hash (make-hash-table <span class="builtin" id="font-lock:90545">:test</span> 'equal))
<a href="#linum:2090"><span class="linum" id="linum:2090">2090</span></a><span class="fringe" id="point:90560"> </span>      (setq hfy-tags-rmap (list (list srcdir trmap-hash) hfy-tags-rmap)))
<a href="#linum:2091"><span class="linum" id="linum:2091">2091</span></a><span class="fringe" id="point:90634"> </span>    (clrhash trmap-hash)
<a href="#linum:2092"><span class="linum" id="linum:2092">2092</span></a><span class="fringe" id="point:90659"> </span>
<a href="#linum:2093"><span class="linum" id="linum:2093">2093</span></a><span class="fringe" id="point:90660"> </span>    <span class="comment-delimiter" id="font-lock:90664">;; </span><span class="comment" id="font-lock:90667">(re)initialise the tag cache:
</span><a href="#linum:2094"><span class="linum" id="linum:2094">2094</span></a><span class="fringe" id="point:90697"> </span>    (<span class="keyword" id="font-lock:90702">if</span> cache-entry (setq cache-hash (cadr cache-entry))
<a href="#linum:2095"><span class="linum" id="linum:2095">2095</span></a><span class="fringe" id="point:90754"> </span>      (setq cache-hash (make-hash-table <span class="builtin" id="font-lock:90794">:test</span> 'equal))
<a href="#linum:2096"><span class="linum" id="linum:2096">2096</span></a><span class="fringe" id="point:90809"> </span>      (setq hfy-tags-cache (list (list srcdir cache-hash) hfy-tags-cache)))
<a href="#linum:2097"><span class="linum" id="linum:2097">2097</span></a><span class="fringe" id="point:90885"> </span>    (clrhash cache-hash)
<a href="#linum:2098"><span class="linum" id="linum:2098">2098</span></a><span class="fringe" id="point:90910"> </span>
<a href="#linum:2099"><span class="linum" id="linum:2099">2099</span></a><span class="fringe" id="point:90911"> </span>    <span class="comment-delimiter" id="font-lock:90915">;; </span><span class="comment" id="font-lock:90918">cache the TAG =&gt; ((file line point) (file line point) ... ) entries:
</span><a href="#linum:2100"><span class="linum" id="linum:2100">2100</span></a><span class="fringe" id="point:90987"> </span>    (<span class="keyword" id="font-lock:90992">with-current-buffer</span> buffer
<a href="#linum:2101"><span class="linum" id="linum:2101">2101</span></a><span class="fringe" id="point:91019"> </span>      (goto-char (point-min))
<a href="#linum:2102"><span class="linum" id="linum:2102">2102</span></a><span class="fringe" id="point:91049"> </span>
<a href="#linum:2103"><span class="linum" id="linum:2103">2103</span></a><span class="fringe" id="point:91050"> </span>      (<span class="keyword" id="font-lock:91057">while</span> (and (looking-at <span class="string" id="font-lock:91080">"^\x0c"</span>) (= 0 (forward-line 1)))
<a href="#linum:2104"><span class="linum" id="linum:2104">2104</span></a><span class="fringe" id="point:91113"> </span>        <span class="comment-delimiter" id="font-lock:91121">;;</span><span class="comment" id="font-lock:91123">(message "^L boundary")
</span><a href="#linum:2105"><span class="linum" id="linum:2105">2105</span></a><span class="fringe" id="point:91147"> </span>        (<span class="keyword" id="font-lock:91156">if</span> (and (looking-at <span class="string" id="font-lock:91176">"^</span><span class="string" id="font-lock:91178"><span class="regexp-grouping-backslash" id="font-lock:91178">\\</span></span><span class="string" id="font-lock:91180"><span class="regexp-grouping-construct" id="font-lock:91180">(</span></span><span class="string" id="font-lock:91181">.+</span><span class="string" id="font-lock:91183"><span class="regexp-grouping-backslash" id="font-lock:91183">\\</span></span><span class="string" id="font-lock:91185"><span class="regexp-grouping-construct" id="font-lock:91185">)</span></span><span class="string" id="font-lock:91186">,</span><span class="string" id="font-lock:91187"><span class="regexp-grouping-backslash" id="font-lock:91187">\\</span></span><span class="string" id="font-lock:91189"><span class="regexp-grouping-construct" id="font-lock:91189">(</span></span><span class="string" id="font-lock:91190">[0-9]+</span><span class="string" id="font-lock:91196"><span class="regexp-grouping-backslash" id="font-lock:91196">\\</span></span><span class="string" id="font-lock:91198"><span class="regexp-grouping-construct" id="font-lock:91198">)</span></span><span class="string" id="font-lock:91199">$"</span>)
<a href="#linum:2106"><span class="linum" id="linum:2106">2106</span></a><span class="fringe" id="point:91203"> </span>                 (= 0 (forward-line 1)))
<a href="#linum:2107"><span class="linum" id="linum:2107">2107</span></a><span class="fringe" id="point:91244"> </span>            (<span class="keyword" id="font-lock:91257">progn</span>
<a href="#linum:2108"><span class="linum" id="linum:2108">2108</span></a><span class="fringe" id="point:91263"> </span>              (setq etags-file (match-string 1))
<a href="#linum:2109"><span class="linum" id="linum:2109">2109</span></a><span class="fringe" id="point:91312"> </span>              <span class="comment-delimiter" id="font-lock:91326">;;</span><span class="comment" id="font-lock:91328">(message "TAGS for file: %s" etags-file)
</span><a href="#linum:2110"><span class="linum" id="linum:2110">2110</span></a><span class="fringe" id="point:91369"> </span>              (<span class="keyword" id="font-lock:91384">while</span> (and (looking-at hfy-etag-regex) (= 0 (forward-line 1)))
<a href="#linum:2111"><span class="linum" id="linum:2111">2111</span></a><span class="fringe" id="point:91447"> </span>                (setq tag-string (match-string 1))
<a href="#linum:2112"><span class="linum" id="linum:2112">2112</span></a><span class="fringe" id="point:91498"> </span>                (<span class="keyword" id="font-lock:91515">if</span> (= 0 (length tag-string)) nil <span class="comment-delimiter" id="font-lock:91548">;; </span><span class="comment" id="font-lock:91551">noop
</span><a href="#linum:2113"><span class="linum" id="linum:2113">2113</span></a><span class="fringe" id="point:91556"> </span>                  (setq tag-line   (round (string-to-number (match-string 2))))
<a href="#linum:2114"><span class="linum" id="linum:2114">2114</span></a><span class="fringe" id="point:91636"> </span>                  (setq tag-point  (round (string-to-number (match-string 3))))
<a href="#linum:2115"><span class="linum" id="linum:2115">2115</span></a><span class="fringe" id="point:91716"> </span>                  (setq hash-entry (gethash tag-string  cache-hash))
<a href="#linum:2116"><span class="linum" id="linum:2116">2116</span></a><span class="fringe" id="point:91785"> </span>                  (setq new-entry  (list etags-file tag-line tag-point))
<a href="#linum:2117"><span class="linum" id="linum:2117">2117</span></a><span class="fringe" id="point:91858"> </span>                  (push new-entry hash-entry)
<a href="#linum:2118"><span class="linum" id="linum:2118">2118</span></a><span class="fringe" id="point:91904"> </span>                  <span class="comment-delimiter" id="font-lock:91922">;;</span><span class="comment" id="font-lock:91924">(message "HASH-ENTRY %s %S" tag-string new-entry)
</span><a href="#linum:2119"><span class="linum" id="linum:2119">2119</span></a><span class="fringe" id="point:91974"> </span>                  (puthash tag-string hash-entry cache-hash)))) )))
<a href="#linum:2120"><span class="linum" id="linum:2120">2120</span></a><span class="fringe" id="point:92042"> </span>
<a href="#linum:2121"><span class="linum" id="linum:2121">2121</span></a><span class="fringe" id="point:92043"> </span>    <span class="comment-delimiter" id="font-lock:92047">;; </span><span class="comment" id="font-lock:92050">cache a list of tags in descending length order:
</span><a href="#linum:2122"><span class="linum" id="linum:2122">2122</span></a><span class="fringe" id="point:92099"> </span>    (maphash (<span class="keyword" id="font-lock:92113">lambda</span> (K V) (push K tags-list)) cache-hash)
<a href="#linum:2123"><span class="linum" id="linum:2123">2123</span></a><span class="fringe" id="point:92158"> </span>    (setq tags-list (sort tags-list (<span class="keyword" id="font-lock:92195">lambda</span> (A B) (&lt; (length B) (length A)))))
<a href="#linum:2124"><span class="linum" id="linum:2124">2124</span></a><span class="fringe" id="point:92237"> </span>
<a href="#linum:2125"><span class="linum" id="linum:2125">2125</span></a><span class="fringe" id="point:92238"> </span>    <span class="comment-delimiter" id="font-lock:92242">;; </span><span class="comment" id="font-lock:92245">put the tag list into the cache:
</span><a href="#linum:2126"><span class="linum" id="linum:2126">2126</span></a><span class="fringe" id="point:92278"> </span>    (<span class="keyword" id="font-lock:92283">if</span> tlist-cache (setcar (cdr tlist-cache) tags-list)
<a href="#linum:2127"><span class="linum" id="linum:2127">2127</span></a><span class="fringe" id="point:92335"> </span>      (push (list srcdir tags-list) hfy-tags-sortl))
<a href="#linum:2128"><span class="linum" id="linum:2128">2128</span></a><span class="fringe" id="point:92388"> </span>
<a href="#linum:2129"><span class="linum" id="linum:2129">2129</span></a><span class="fringe" id="point:92389"> </span>    <span class="comment-delimiter" id="font-lock:92393">;; </span><span class="comment" id="font-lock:92396">return the number of tags found:
</span><a href="#linum:2130"><span class="linum" id="linum:2130">2130</span></a><span class="fringe" id="point:92429"> </span>    (length tags-list) ))
<a href="#linum:2131"><span class="linum" id="linum:2131">2131</span></a><span class="fringe" id="point:92455"> </span>
<a href="#linum:2132"><span class="linum" id="linum:2132">2132</span></a><span class="fringe" id="point:92456"> </span>(<span class="keyword" id="font-lock:92457">defun</span> <span class="function-name" id="font-lock:92463">hfy-prepare-index-i</span> (srcdir dstdir filename <span class="type" id="font-lock:92507">&amp;optional</span> stub map)
<a href="#linum:2133"><span class="linum" id="linum:2133">2133</span></a><span class="fringe" id="point:92527"> </span>  <span class="doc" id="font-lock:92529">"Prepare a tags index buffer for SRCDIR.
</span><a href="#linum:2134"><span class="linum" id="linum:2134">2134</span></a><span class="fringe" id="point:92570"> </span><span class="doc" id="font-lock:92570">`</span><span class="doc" id="font-lock:92571"><span class="constant" id="font-lock:92571">hfy-tags-cache</span></span><span class="doc" id="font-lock:92585">' must already have an entry for SRCDIR for this to work.
</span><a href="#linum:2135"><span class="linum" id="linum:2135">2135</span></a><span class="fringe" id="point:92643"> </span><span class="doc" id="font-lock:92643">`</span><span class="doc" id="font-lock:92644"><span class="constant" id="font-lock:92644">hfy-page-header</span></span><span class="doc" id="font-lock:92659">', `</span><span class="doc" id="font-lock:92663"><span class="constant" id="font-lock:92663">hfy-page-footer</span></span><span class="doc" id="font-lock:92678">', `</span><span class="doc" id="font-lock:92682"><span class="constant" id="font-lock:92682">hfy-link-extn</span></span><span class="doc" id="font-lock:92695">' and `</span><span class="doc" id="font-lock:92702"><span class="constant" id="font-lock:92702">hfy-extn</span></span><span class="doc" id="font-lock:92710">'
</span><a href="#linum:2136"><span class="linum" id="linum:2136">2136</span></a><span class="fringe" id="point:92712"> </span><span class="doc" id="font-lock:92712">all play a part here.\n
</span><a href="#linum:2137"><span class="linum" id="linum:2137">2137</span></a><span class="fringe" id="point:92736"> </span><span class="doc" id="font-lock:92736">If STUB is set, prepare an (appropriately named) index buffer
</span><a href="#linum:2138"><span class="linum" id="linum:2138">2138</span></a><span class="fringe" id="point:92798"> </span><span class="doc" id="font-lock:92798">specifically for entries beginning with STUB.\n
</span><a href="#linum:2139"><span class="linum" id="linum:2139">2139</span></a><span class="fringe" id="point:92846"> </span><span class="doc" id="font-lock:92846">If MAP is set, use that instead of `</span><span class="doc" id="font-lock:92882"><span class="constant" id="font-lock:92882">hfy-tags-cache</span></span><span class="doc" id="font-lock:92896">'.
</span><a href="#linum:2140"><span class="linum" id="linum:2140">2140</span></a><span class="fringe" id="point:92899"> </span><span class="doc" id="font-lock:92899">FILENAME is the name of the file being indexed.
</span><a href="#linum:2141"><span class="linum" id="linum:2141">2141</span></a><span class="fringe" id="point:92947"> </span><span class="doc" id="font-lock:92947">DSTDIR is the output directory, where files will be written."</span>
<a href="#linum:2142"><span class="linum" id="linum:2142">2142</span></a><span class="fringe" id="point:93009"> </span>  <span class="comment-delimiter" id="font-lock:93011">;;</span><span class="comment" id="font-lock:93013">(message "hfy-write-index");;DBUG
</span><a href="#linum:2143"><span class="linum" id="linum:2143">2143</span></a><span class="fringe" id="point:93047"> </span>  (<span class="keyword" id="font-lock:93050">let</span> ((cache-entry  (assoc srcdir (or map hfy-tags-cache)))
<a href="#linum:2144"><span class="linum" id="linum:2144">2144</span></a><span class="fringe" id="point:93109"> </span>        (cache-hash    nil)
<a href="#linum:2145"><span class="linum" id="linum:2145">2145</span></a><span class="fringe" id="point:93137"> </span>        (tag-list      nil)
<a href="#linum:2146"><span class="linum" id="linum:2146">2146</span></a><span class="fringe" id="point:93165"> </span>        (index-file
<a href="#linum:2147"><span class="linum" id="linum:2147">2147</span></a><span class="fringe" id="point:93185"> </span>         (concat filename (<span class="keyword" id="font-lock:93212">if</span> stub (concat <span class="string" id="font-lock:93228">"."</span> stub) <span class="string" id="font-lock:93238">""</span>) hfy-extn))
<a href="#linum:2148"><span class="linum" id="linum:2148">2148</span></a><span class="fringe" id="point:93253"> </span>        (index-buf     nil))
<a href="#linum:2149"><span class="linum" id="linum:2149">2149</span></a><span class="fringe" id="point:93282"> </span>    (<span class="keyword" id="font-lock:93287">if</span> (not (and cache-entry
<a href="#linum:2150"><span class="linum" id="linum:2150">2150</span></a><span class="fringe" id="point:93312"> </span>                  (setq cache-hash (cadr cache-entry))
<a href="#linum:2151"><span class="linum" id="linum:2151">2151</span></a><span class="fringe" id="point:93367"> </span>                  (setq index-buf  (get-buffer-create index-file))))
<a href="#linum:2152"><span class="linum" id="linum:2152">2152</span></a><span class="fringe" id="point:93436"> </span>        nil <span class="comment-delimiter" id="font-lock:93448">;; </span><span class="comment" id="font-lock:93451">noop
</span><a href="#linum:2153"><span class="linum" id="linum:2153">2153</span></a><span class="fringe" id="point:93456"> </span>      (maphash (<span class="keyword" id="font-lock:93472">lambda</span> (K V) (push K tag-list)) cache-hash)
<a href="#linum:2154"><span class="linum" id="linum:2154">2154</span></a><span class="fringe" id="point:93516"> </span>      (setq tag-list (sort tag-list 'string&lt;))
<a href="#linum:2155"><span class="linum" id="linum:2155">2155</span></a><span class="fringe" id="point:93563"> </span>      (set-buffer index-buf)
<a href="#linum:2156"><span class="linum" id="linum:2156">2156</span></a><span class="fringe" id="point:93592"> </span>      (erase-buffer)
<a href="#linum:2157"><span class="linum" id="linum:2157">2157</span></a><span class="fringe" id="point:93613"> </span>      (insert (funcall hfy-page-header filename <span class="string" id="font-lock:93661">"&lt;!-- CSS --&gt;"</span>))
<a href="#linum:2158"><span class="linum" id="linum:2158">2158</span></a><span class="fringe" id="point:93678"> </span>      (insert <span class="string" id="font-lock:93692">"&lt;table class=\"index\"&gt;\n"</span>)
<a href="#linum:2159"><span class="linum" id="linum:2159">2159</span></a><span class="fringe" id="point:93721"> </span>
<a href="#linum:2160"><span class="linum" id="linum:2160">2160</span></a><span class="fringe" id="point:93722"> </span>      (<span class="keyword" id="font-lock:93729">dolist</span> (TAG tag-list)
<a href="#linum:2161"><span class="linum" id="linum:2161">2161</span></a><span class="fringe" id="point:93751"> </span>        (<span class="keyword" id="font-lock:93760">let</span> ((tag-started nil))
<a href="#linum:2162"><span class="linum" id="linum:2162">2162</span></a><span class="fringe" id="point:93784"> </span>          (<span class="keyword" id="font-lock:93795">dolist</span> (DEF (gethash TAG cache-hash))
<a href="#linum:2163"><span class="linum" id="linum:2163">2163</span></a><span class="fringe" id="point:93833"> </span>            (<span class="keyword" id="font-lock:93846">if</span> (and stub (not (string-match (concat <span class="string" id="font-lock:93886">"^"</span> stub) TAG)))
<a href="#linum:2164"><span class="linum" id="linum:2164">2164</span></a><span class="fringe" id="point:93903"> </span>                nil <span class="comment-delimiter" id="font-lock:93923">;; </span><span class="comment" id="font-lock:93926">we have a stub and it didn't match: NOOP
</span><a href="#linum:2165"><span class="linum" id="linum:2165">2165</span></a><span class="fringe" id="point:93967"> </span>              (<span class="keyword" id="font-lock:93982">let</span> ((file (car  DEF))
<a href="#linum:2166"><span class="linum" id="linum:2166">2166</span></a><span class="fringe" id="point:94005"> </span>                    (line (cadr DEF)))
<a href="#linum:2167"><span class="linum" id="linum:2167">2167</span></a><span class="fringe" id="point:94044"> </span>                (insert
<a href="#linum:2168"><span class="linum" id="linum:2168">2168</span></a><span class="fringe" id="point:94068"> </span>                 (format
<a href="#linum:2169"><span class="linum" id="linum:2169">2169</span></a><span class="fringe" id="point:94093"> </span>                  (concat
<a href="#linum:2170"><span class="linum" id="linum:2170">2170</span></a><span class="fringe" id="point:94119"> </span>                   <span class="string" id="font-lock:94138">"  &lt;tr&gt;                                   \n"</span>
<a href="#linum:2171"><span class="linum" id="linum:2171">2171</span></a><span class="fringe" id="point:94184"> </span>                   <span class="string" id="font-lock:94203">"   &lt;td&gt;%s&lt;/td&gt;                           \n"</span>
<a href="#linum:2172"><span class="linum" id="linum:2172">2172</span></a><span class="fringe" id="point:94249"> </span>                   <span class="string" id="font-lock:94268">"   &lt;td&gt;&lt;a href=\"%s%s\"&gt;%s&lt;/a&gt;&lt;/td&gt;      \n"</span>
<a href="#linum:2173"><span class="linum" id="linum:2173">2173</span></a><span class="fringe" id="point:94314"> </span>                   <span class="string" id="font-lock:94333">"   &lt;td&gt;&lt;a href=\"%s%s#%s.%d\"&gt;%d&lt;/a&gt;&lt;/td&gt;\n"</span>
<a href="#linum:2174"><span class="linum" id="linum:2174">2174</span></a><span class="fringe" id="point:94379"> </span>                   <span class="string" id="font-lock:94398">"  &lt;/tr&gt;                                  \n"</span>)
<a href="#linum:2175"><span class="linum" id="linum:2175">2175</span></a><span class="fringe" id="point:94445"> </span>                  (<span class="keyword" id="font-lock:94464">if</span> (string= TAG tag-started) <span class="string" id="font-lock:94493">"&amp;nbsp;"</span>
<a href="#linum:2176"><span class="linum" id="linum:2176">2176</span></a><span class="fringe" id="point:94502"> </span>                    (format <span class="string" id="font-lock:94530">"&lt;a name=\"%s\"&gt;%s&lt;/a&gt;"</span> TAG TAG))
<a href="#linum:2177"><span class="linum" id="linum:2177">2177</span></a><span class="fringe" id="point:94564"> </span>                  file (or hfy-link-extn hfy-extn) file
<a href="#linum:2178"><span class="linum" id="linum:2178">2178</span></a><span class="fringe" id="point:94620"> </span>                  file (or hfy-link-extn hfy-extn) TAG line line))
<a href="#linum:2179"><span class="linum" id="linum:2179">2179</span></a><span class="fringe" id="point:94687"> </span>                (setq tag-started TAG))))))
<a href="#linum:2180"><span class="linum" id="linum:2180">2180</span></a><span class="fringe" id="point:94731"> </span>      (insert <span class="string" id="font-lock:94745">"&lt;/table&gt;\n"</span>)
<a href="#linum:2181"><span class="linum" id="linum:2181">2181</span></a><span class="fringe" id="point:94759"> </span>      (insert (funcall hfy-page-footer filename))
<a href="#linum:2182"><span class="linum" id="linum:2182">2182</span></a><span class="fringe" id="point:94809"> </span>      (and dstdir (cd dstdir))
<a href="#linum:2183"><span class="linum" id="linum:2183">2183</span></a><span class="fringe" id="point:94840"> </span>      (set-visited-file-name index-file)
<a href="#linum:2184"><span class="linum" id="linum:2184">2184</span></a><span class="fringe" id="point:94881"> </span>      index-buf) ))
<a href="#linum:2185"><span class="linum" id="linum:2185">2185</span></a><span class="fringe" id="point:94901"> </span>
<a href="#linum:2186"><span class="linum" id="linum:2186">2186</span></a><span class="fringe" id="point:94902"> </span>(<span class="keyword" id="font-lock:94903">defun</span> <span class="function-name" id="font-lock:94909">hfy-prepare-index</span> (srcdir dstdir)
<a href="#linum:2187"><span class="linum" id="linum:2187">2187</span></a><span class="fringe" id="point:94943"> </span>  <span class="doc" id="font-lock:94945">"Return a list of index buffer(s), as determined by `</span><span class="doc" id="font-lock:94998"><span class="constant" id="font-lock:94998">hfy-split-index</span></span><span class="doc" id="font-lock:95013">'.
</span><a href="#linum:2188"><span class="linum" id="linum:2188">2188</span></a><span class="fringe" id="point:95016"> </span><span class="doc" id="font-lock:95016">SRCDIR and DSTDIR are the source and output directories respectively."</span>
<a href="#linum:2189"><span class="linum" id="linum:2189">2189</span></a><span class="fringe" id="point:95087"> </span>  (<span class="keyword" id="font-lock:95090">if</span> (not hfy-split-index)
<a href="#linum:2190"><span class="linum" id="linum:2190">2190</span></a><span class="fringe" id="point:95115"> </span>      (list (hfy-prepare-index-i srcdir dstdir hfy-index-file nil))
<a href="#linum:2191"><span class="linum" id="linum:2191">2191</span></a><span class="fringe" id="point:95183"> </span>    (<span class="keyword" id="font-lock:95188">let</span> ((stub-list     nil)
<a href="#linum:2192"><span class="linum" id="linum:2192">2192</span></a><span class="fringe" id="point:95213"> </span>          (cache-hash    nil)
<a href="#linum:2193"><span class="linum" id="linum:2193">2193</span></a><span class="fringe" id="point:95243"> </span>          (index-list    nil)
<a href="#linum:2194"><span class="linum" id="linum:2194">2194</span></a><span class="fringe" id="point:95273"> </span>          (cache-entry  (assoc srcdir hfy-tags-cache)))
<a href="#linum:2195"><span class="linum" id="linum:2195">2195</span></a><span class="fringe" id="point:95329"> </span>      (<span class="keyword" id="font-lock:95336">if</span> (and cache-entry (setq cache-hash (cadr cache-entry)))
<a href="#linum:2196"><span class="linum" id="linum:2196">2196</span></a><span class="fringe" id="point:95394"> </span>          (maphash
<a href="#linum:2197"><span class="linum" id="linum:2197">2197</span></a><span class="fringe" id="point:95413"> </span>           (<span class="keyword" id="font-lock:95425">lambda</span> (K V)
<a href="#linum:2198"><span class="linum" id="linum:2198">2198</span></a><span class="fringe" id="point:95438"> </span>             (<span class="keyword" id="font-lock:95452">let</span> ((stub (upcase (substring K 0 1))))
<a href="#linum:2199"><span class="linum" id="linum:2199">2199</span></a><span class="fringe" id="point:95492"> </span>               (<span class="keyword" id="font-lock:95508">if</span> (member stub stub-list)
<a href="#linum:2200"><span class="linum" id="linum:2200">2200</span></a><span class="fringe" id="point:95535"> </span>                   nil <span class="comment-delimiter" id="font-lock:95558">;; </span><span class="comment" id="font-lock:95561">seen this already: NOOP
</span><a href="#linum:2201"><span class="linum" id="linum:2201">2201</span></a><span class="fringe" id="point:95585"> </span>                 (setq
<a href="#linum:2202"><span class="linum" id="linum:2202">2202</span></a><span class="fringe" id="point:95608"> </span>                  stub-list  (cons stub stub-list)
<a href="#linum:2203"><span class="linum" id="linum:2203">2203</span></a><span class="fringe" id="point:95659"> </span>                  index-list (cons (hfy-prepare-index-i srcdir
<a href="#linum:2204"><span class="linum" id="linum:2204">2204</span></a><span class="fringe" id="point:95722"> </span>                                                        dstdir
<a href="#linum:2205"><span class="linum" id="linum:2205">2205</span></a><span class="fringe" id="point:95785"> </span>                                                        hfy-index-file
<a href="#linum:2206"><span class="linum" id="linum:2206">2206</span></a><span class="fringe" id="point:95856"> </span>                                                        stub)
<a href="#linum:2207"><span class="linum" id="linum:2207">2207</span></a><span class="fringe" id="point:95918"> </span>                                   index-list)) ))) cache-hash) ) index-list)))
<a href="#linum:2208"><span class="linum" id="linum:2208">2208</span></a><span class="fringe" id="point:95998"> </span>
<a href="#linum:2209"><span class="linum" id="linum:2209">2209</span></a><span class="fringe" id="point:95999"> </span>(<span class="keyword" id="font-lock:96000">defun</span> <span class="function-name" id="font-lock:96006">hfy-prepare-tag-map</span> (srcdir dstdir)
<a href="#linum:2210"><span class="linum" id="linum:2210">2210</span></a><span class="fringe" id="point:96042"> </span>  <span class="doc" id="font-lock:96044">"Prepare the counterpart(s) to the index buffer(s) - a list of buffers
</span><a href="#linum:2211"><span class="linum" id="linum:2211">2211</span></a><span class="fringe" id="point:96115"> </span><span class="doc" id="font-lock:96115">with the same structure, but listing (and linking to) instances of tags
</span><a href="#linum:2212"><span class="linum" id="linum:2212">2212</span></a><span class="fringe" id="point:96187"> </span><span class="doc" id="font-lock:96187">\(as opposed to their definitions).\n
</span><a href="#linum:2213"><span class="linum" id="linum:2213">2213</span></a><span class="fringe" id="point:96225"> </span><span class="doc" id="font-lock:96225">SRCDIR and DSTDIR are the source and output directories respectively.
</span><a href="#linum:2214"><span class="linum" id="linum:2214">2214</span></a><span class="fringe" id="point:96295"> </span><span class="doc" id="font-lock:96295">See also `</span><span class="doc" id="font-lock:96305"><span class="constant" id="font-lock:96305">hfy-prepare-index</span></span><span class="doc" id="font-lock:96322">', `</span><span class="doc" id="font-lock:96326"><span class="constant" id="font-lock:96326">hfy-split-index</span></span><span class="doc" id="font-lock:96341">'."</span>
<a href="#linum:2215"><span class="linum" id="linum:2215">2215</span></a><span class="fringe" id="point:96345"> </span>  (<span class="keyword" id="font-lock:96348">if</span> (not hfy-split-index)
<a href="#linum:2216"><span class="linum" id="linum:2216">2216</span></a><span class="fringe" id="point:96373"> </span>      (list (hfy-prepare-index-i srcdir
<a href="#linum:2217"><span class="linum" id="linum:2217">2217</span></a><span class="fringe" id="point:96413"> </span>                                 dstdir
<a href="#linum:2218"><span class="linum" id="linum:2218">2218</span></a><span class="fringe" id="point:96453"> </span>                                 hfy-instance-file
<a href="#linum:2219"><span class="linum" id="linum:2219">2219</span></a><span class="fringe" id="point:96504"> </span>                                 nil
<a href="#linum:2220"><span class="linum" id="linum:2220">2220</span></a><span class="fringe" id="point:96541"> </span>                                 hfy-tags-rmap))
<a href="#linum:2221"><span class="linum" id="linum:2221">2221</span></a><span class="fringe" id="point:96590"> </span>    (<span class="keyword" id="font-lock:96595">let</span> ((stub-list     nil)
<a href="#linum:2222"><span class="linum" id="linum:2222">2222</span></a><span class="fringe" id="point:96620"> </span>          (cache-hash    nil)
<a href="#linum:2223"><span class="linum" id="linum:2223">2223</span></a><span class="fringe" id="point:96650"> </span>          (index-list    nil)
<a href="#linum:2224"><span class="linum" id="linum:2224">2224</span></a><span class="fringe" id="point:96680"> </span>          (cache-entry  (assoc srcdir hfy-tags-rmap)))
<a href="#linum:2225"><span class="linum" id="linum:2225">2225</span></a><span class="fringe" id="point:96735"> </span>
<a href="#linum:2226"><span class="linum" id="linum:2226">2226</span></a><span class="fringe" id="point:96736"> </span>      (<span class="keyword" id="font-lock:96743">if</span> (and cache-entry (setq cache-hash (cadr cache-entry)))
<a href="#linum:2227"><span class="linum" id="linum:2227">2227</span></a><span class="fringe" id="point:96801"> </span>          (maphash
<a href="#linum:2228"><span class="linum" id="linum:2228">2228</span></a><span class="fringe" id="point:96820"> </span>           (<span class="keyword" id="font-lock:96832">lambda</span> (K V)
<a href="#linum:2229"><span class="linum" id="linum:2229">2229</span></a><span class="fringe" id="point:96845"> </span>             (<span class="keyword" id="font-lock:96859">let</span> ((stub (upcase (substring K 0 1))))
<a href="#linum:2230"><span class="linum" id="linum:2230">2230</span></a><span class="fringe" id="point:96899"> </span>               (<span class="keyword" id="font-lock:96915">if</span> (member stub stub-list)
<a href="#linum:2231"><span class="linum" id="linum:2231">2231</span></a><span class="fringe" id="point:96942"> </span>                   nil <span class="comment-delimiter" id="font-lock:96965">;; </span><span class="comment" id="font-lock:96968">seen this already: NOOP
</span><a href="#linum:2232"><span class="linum" id="linum:2232">2232</span></a><span class="fringe" id="point:96992"> </span>                 (setq
<a href="#linum:2233"><span class="linum" id="linum:2233">2233</span></a><span class="fringe" id="point:97015"> </span>                  stub-list  (cons stub stub-list)
<a href="#linum:2234"><span class="linum" id="linum:2234">2234</span></a><span class="fringe" id="point:97066"> </span>                  index-list (cons (hfy-prepare-index-i srcdir
<a href="#linum:2235"><span class="linum" id="linum:2235">2235</span></a><span class="fringe" id="point:97129"> </span>                                                        dstdir
<a href="#linum:2236"><span class="linum" id="linum:2236">2236</span></a><span class="fringe" id="point:97192"> </span>                                                        hfy-instance-file
<a href="#linum:2237"><span class="linum" id="linum:2237">2237</span></a><span class="fringe" id="point:97266"> </span>                                                        stub
<a href="#linum:2238"><span class="linum" id="linum:2238">2238</span></a><span class="fringe" id="point:97327"> </span>                                                        hfy-tags-rmap)
<a href="#linum:2239"><span class="linum" id="linum:2239">2239</span></a><span class="fringe" id="point:97398"> </span>                                   index-list)) ))) cache-hash) ) index-list)))
<a href="#linum:2240"><span class="linum" id="linum:2240">2240</span></a><span class="fringe" id="point:97478"> </span>
<a href="#linum:2241"><span class="linum" id="linum:2241">2241</span></a><span class="fringe" id="point:97479"> </span>(<span class="keyword" id="font-lock:97480">defun</span> <span class="function-name" id="font-lock:97486">hfy-subtract-maps</span> (srcdir)
<a href="#linum:2242"><span class="linum" id="linum:2242">2242</span></a><span class="fringe" id="point:97513"> </span>  <span class="doc" id="font-lock:97515">"Internal function - strips definitions of tags from the instance map.
</span><a href="#linum:2243"><span class="linum" id="linum:2243">2243</span></a><span class="fringe" id="point:97586"> </span><span class="doc" id="font-lock:97586">SRCDIR is the directory being \"published\".
</span><a href="#linum:2244"><span class="linum" id="linum:2244">2244</span></a><span class="fringe" id="point:97631"> </span><span class="doc" id="font-lock:97631">See also `</span><span class="doc" id="font-lock:97641"><span class="constant" id="font-lock:97641">hfy-tags-cache</span></span><span class="doc" id="font-lock:97655">', `</span><span class="doc" id="font-lock:97659"><span class="constant" id="font-lock:97659">hfy-tags-rmap</span></span><span class="doc" id="font-lock:97672">'."</span>
<a href="#linum:2245"><span class="linum" id="linum:2245">2245</span></a><span class="fringe" id="point:97676"> </span>  (<span class="keyword" id="font-lock:97679">let</span> ((new-list nil)
<a href="#linum:2246"><span class="linum" id="linum:2246">2246</span></a><span class="fringe" id="point:97699"> </span>        (old-list nil)
<a href="#linum:2247"><span class="linum" id="linum:2247">2247</span></a><span class="fringe" id="point:97722"> </span>        (def-list nil)
<a href="#linum:2248"><span class="linum" id="linum:2248">2248</span></a><span class="fringe" id="point:97745"> </span>        (exc-list nil)
<a href="#linum:2249"><span class="linum" id="linum:2249">2249</span></a><span class="fringe" id="point:97768"> </span>        (fwd-map (cadr (assoc srcdir hfy-tags-cache)))
<a href="#linum:2250"><span class="linum" id="linum:2250">2250</span></a><span class="fringe" id="point:97823"> </span>        (rev-map (cadr (assoc srcdir hfy-tags-rmap )))
<a href="#linum:2251"><span class="linum" id="linum:2251">2251</span></a><span class="fringe" id="point:97878"> </span>        (taglist (cadr (assoc srcdir hfy-tags-sortl))))
<a href="#linum:2252"><span class="linum" id="linum:2252">2252</span></a><span class="fringe" id="point:97934"> </span>    (<span class="keyword" id="font-lock:97939">dolist</span> (TAG taglist)
<a href="#linum:2253"><span class="linum" id="linum:2253">2253</span></a><span class="fringe" id="point:97960"> </span>      (setq def-list (gethash TAG fwd-map)
<a href="#linum:2254"><span class="linum" id="linum:2254">2254</span></a><span class="fringe" id="point:98003"> </span>            old-list (gethash TAG rev-map)
<a href="#linum:2255"><span class="linum" id="linum:2255">2255</span></a><span class="fringe" id="point:98046"> </span>            exc-list (mapcar (<span class="keyword" id="font-lock:98076">lambda</span> (P) (list (car P) (cadr P))) def-list)
<a href="#linum:2256"><span class="linum" id="linum:2256">2256</span></a><span class="fringe" id="point:98122"> </span>            new-list  nil)
<a href="#linum:2257"><span class="linum" id="linum:2257">2257</span></a><span class="fringe" id="point:98149"> </span>      (<span class="keyword" id="font-lock:98156">dolist</span> (P old-list)
<a href="#linum:2258"><span class="linum" id="linum:2258">2258</span></a><span class="fringe" id="point:98176"> </span>        (or (member (list (car P) (cadr P)) exc-list)
<a href="#linum:2259"><span class="linum" id="linum:2259">2259</span></a><span class="fringe" id="point:98230"> </span>            (push P new-list)))
<a href="#linum:2260"><span class="linum" id="linum:2260">2260</span></a><span class="fringe" id="point:98262"> </span>      (puthash TAG new-list rev-map))))
<a href="#linum:2261"><span class="linum" id="linum:2261">2261</span></a><span class="fringe" id="point:98302"> </span>
<a href="#linum:2262"><span class="linum" id="linum:2262">2262</span></a><span class="fringe" id="point:98303"> </span>(<span class="keyword" id="font-lock:98304">defun</span> <span class="function-name" id="font-lock:98310">htmlfontify-run-etags</span> (srcdir)
<a href="#linum:2263"><span class="linum" id="linum:2263">2263</span></a><span class="fringe" id="point:98341"> </span>  <span class="doc" id="font-lock:98343">"Load the etags cache for SRCDIR.
</span><a href="#linum:2264"><span class="linum" id="linum:2264">2264</span></a><span class="fringe" id="point:98377"> </span><span class="doc" id="font-lock:98377">See also `</span><span class="doc" id="font-lock:98387"><span class="constant" id="font-lock:98387">hfy-load-tags-cache</span></span><span class="doc" id="font-lock:98406">'."</span>
<a href="#linum:2265"><span class="linum" id="linum:2265">2265</span></a><span class="fringe" id="point:98410"> </span>  (interactive <span class="string" id="font-lock:98425">"D source directory: "</span>)
<a href="#linum:2266"><span class="linum" id="linum:2266">2266</span></a><span class="fringe" id="point:98449"> </span>  (setq srcdir (directory-file-name srcdir))
<a href="#linum:2267"><span class="linum" id="linum:2267">2267</span></a><span class="fringe" id="point:98494"> </span>  (hfy-load-tags-cache srcdir))
<a href="#linum:2268"><span class="linum" id="linum:2268">2268</span></a><span class="fringe" id="point:98526"> </span>
<a href="#linum:2269"><span class="linum" id="linum:2269">2269</span></a><span class="fringe" id="point:98527"> </span><span class="comment-delimiter" id="font-lock:98527">;;</span><span class="comment" id="font-lock:98529">(defun hfy-test-read-args (foo bar)
</span><a href="#linum:2270"><span class="linum" id="linum:2270">2270</span></a><span class="fringe" id="point:98565"> </span><span class="comment-delimiter" id="font-lock:98565">;;  </span><span class="comment" id="font-lock:98569">(interactive "D source directory: \nD target directory: ")
</span><a href="#linum:2271"><span class="linum" id="linum:2271">2271</span></a><span class="fringe" id="point:98628"> </span><span class="comment-delimiter" id="font-lock:98628">;;  </span><span class="comment" id="font-lock:98632">(message "foo: %S\nbar: %S" foo bar))
</span><a href="#linum:2272"><span class="linum" id="linum:2272">2272</span></a><span class="fringe" id="point:98670"> </span>
<a href="#linum:2273"><span class="linum" id="linum:2273">2273</span></a><span class="fringe" id="point:98671"> </span>(<span class="keyword" id="font-lock:98672">defun</span> <span class="function-name" id="font-lock:98678">hfy-save-kill-buffers</span> (buffer-list <span class="type" id="font-lock:98713">&amp;optional</span> dstdir)
<a href="#linum:2274"><span class="linum" id="linum:2274">2274</span></a><span class="fringe" id="point:98731"> </span>  (<span class="keyword" id="font-lock:98734">dolist</span> (B buffer-list)
<a href="#linum:2275"><span class="linum" id="linum:2275">2275</span></a><span class="fringe" id="point:98757"> </span>    (set-buffer B)
<a href="#linum:2276"><span class="linum" id="linum:2276">2276</span></a><span class="fringe" id="point:98776"> </span>    (and dstdir (file-directory-p dstdir) (cd dstdir))
<a href="#linum:2277"><span class="linum" id="linum:2277">2277</span></a><span class="fringe" id="point:98831"> </span>    (save-buffer)
<a href="#linum:2278"><span class="linum" id="linum:2278">2278</span></a><span class="fringe" id="point:98849"> </span>    (kill-buffer B)))
<a href="#linum:2279"><span class="linum" id="linum:2279">2279</span></a><span class="fringe" id="point:98871"> </span>
<a href="#linum:2280"><span class="linum" id="linum:2280">2280</span></a><span class="fringe" id="point:98872"> </span><span class="comment-delimiter" id="font-lock:98872">;;;</span><span class="comment" id="font-lock:98875">###</span><span class="comment" id="font-lock:98878"><span class="warning" id="font-lock:98878">autoload</span></span><span class="comment" id="font-lock:98886">
</span><a href="#linum:2281"><span class="linum" id="linum:2281">2281</span></a><span class="fringe" id="point:98887"> </span>(<span class="keyword" id="font-lock:98888">defun</span> <span class="function-name" id="font-lock:98894">htmlfontify-copy-and-link-dir</span> (srcdir dstdir <span class="type" id="font-lock:98939">&amp;optional</span> f-ext l-ext)
<a href="#linum:2282"><span class="linum" id="linum:2282">2282</span></a><span class="fringe" id="point:98962"> </span>  <span class="doc" id="font-lock:98964">"Trawl SRCDIR and write fontified-and-hyperlinked output in DSTDIR.
</span><a href="#linum:2283"><span class="linum" id="linum:2283">2283</span></a><span class="fringe" id="point:99032"> </span><span class="doc" id="font-lock:99032">F-EXT and L-EXT specify values for `</span><span class="doc" id="font-lock:99068"><span class="constant" id="font-lock:99068">hfy-extn</span></span><span class="doc" id="font-lock:99076">' and `</span><span class="doc" id="font-lock:99083"><span class="constant" id="font-lock:99083">hfy-link-extn</span></span><span class="doc" id="font-lock:99096">'.\n
</span><a href="#linum:2284"><span class="linum" id="linum:2284">2284</span></a><span class="fringe" id="point:99101"> </span><span class="doc" id="font-lock:99101">You may also want to set `</span><span class="doc" id="font-lock:99127"><span class="constant" id="font-lock:99127">hfy-page-header</span></span><span class="doc" id="font-lock:99142">' and `</span><span class="doc" id="font-lock:99149"><span class="constant" id="font-lock:99149">hfy-page-footer</span></span><span class="doc" id="font-lock:99164">'."</span>
<a href="#linum:2285"><span class="linum" id="linum:2285">2285</span></a><span class="fringe" id="point:99168"> </span>  (interactive <span class="string" id="font-lock:99183">"D source directory: \nD output directory: "</span>)
<a href="#linum:2286"><span class="linum" id="linum:2286">2286</span></a><span class="fringe" id="point:99229"> </span>  <span class="comment-delimiter" id="font-lock:99231">;;</span><span class="comment" id="font-lock:99233">(message "htmlfontify-copy-and-link-dir")
</span><a href="#linum:2287"><span class="linum" id="linum:2287">2287</span></a><span class="fringe" id="point:99275"> </span>  (setq srcdir (directory-file-name srcdir))
<a href="#linum:2288"><span class="linum" id="linum:2288">2288</span></a><span class="fringe" id="point:99320"> </span>  (setq dstdir (directory-file-name dstdir))
<a href="#linum:2289"><span class="linum" id="linum:2289">2289</span></a><span class="fringe" id="point:99365"> </span>  (<span class="keyword" id="font-lock:99368">let</span> ((source-files <span class="string" id="font-lock:99387">"SETME: list of source files, relative to srcdir"</span>)
<a href="#linum:2290"><span class="linum" id="linum:2290">2290</span></a><span class="fringe" id="point:99438"> </span>        (tr-cache  (assoc srcdir hfy-tags-rmap))
<a href="#linum:2291"><span class="linum" id="linum:2291">2291</span></a><span class="fringe" id="point:99487"> </span>        (hfy-extn            (or f-ext <span class="string" id="font-lock:99526">".html"</span>))
<a href="#linum:2292"><span class="linum" id="linum:2292">2292</span></a><span class="fringe" id="point:99536"> </span>        (hfy-link-extn       (or l-ext <span class="string" id="font-lock:99575">".html"</span>)))
<a href="#linum:2293"><span class="linum" id="linum:2293">2293</span></a><span class="fringe" id="point:99586"> </span>    <span class="comment-delimiter" id="font-lock:99590">;; </span><span class="comment" id="font-lock:99593">oops, forgot to load etags for srcdir:
</span><a href="#linum:2294"><span class="linum" id="linum:2294">2294</span></a><span class="fringe" id="point:99632"> </span>    (<span class="keyword" id="font-lock:99637">if</span> tr-cache nil
<a href="#linum:2295"><span class="linum" id="linum:2295">2295</span></a><span class="fringe" id="point:99653"> </span>      (message <span class="string" id="font-lock:99668">"autoload of tags cache"</span>)
<a href="#linum:2296"><span class="linum" id="linum:2296">2296</span></a><span class="fringe" id="point:99694"> </span>      (hfy-load-tags-cache srcdir)
<a href="#linum:2297"><span class="linum" id="linum:2297">2297</span></a><span class="fringe" id="point:99729"> </span>      (setq tr-cache (assoc srcdir hfy-tags-rmap)))
<a href="#linum:2298"><span class="linum" id="linum:2298">2298</span></a><span class="fringe" id="point:99781"> </span>    <span class="comment-delimiter" id="font-lock:99785">;; </span><span class="comment" id="font-lock:99788">clear out the old cache:
</span><a href="#linum:2299"><span class="linum" id="linum:2299">2299</span></a><span class="fringe" id="point:99813"> </span>    (clrhash   (cadr tr-cache))
<a href="#linum:2300"><span class="linum" id="linum:2300">2300</span></a><span class="fringe" id="point:99845"> </span>    (hfy-make-directory dstdir)
<a href="#linum:2301"><span class="linum" id="linum:2301">2301</span></a><span class="fringe" id="point:99877"> </span>    (setq source-files (hfy-list-files srcdir))
<a href="#linum:2302"><span class="linum" id="linum:2302">2302</span></a><span class="fringe" id="point:99925"> </span>    (<span class="keyword" id="font-lock:99930">dolist</span> (file source-files)
<a href="#linum:2303"><span class="linum" id="linum:2303">2303</span></a><span class="fringe" id="point:99957"> </span>      (hfy-copy-and-fontify-file srcdir dstdir file))
<a href="#linum:2304"><span class="linum" id="linum:2304">2304</span></a><span class="fringe" id="point:100011"> </span>    (hfy-subtract-maps srcdir)
<a href="#linum:2305"><span class="linum" id="linum:2305">2305</span></a><span class="fringe" id="point:100042"> </span>    (hfy-save-kill-buffers (hfy-prepare-index   srcdir dstdir) dstdir)
<a href="#linum:2306"><span class="linum" id="linum:2306">2306</span></a><span class="fringe" id="point:100113"> </span>    (hfy-save-kill-buffers (hfy-prepare-tag-map srcdir dstdir) dstdir) ))
<a href="#linum:2307"><span class="linum" id="linum:2307">2307</span></a><span class="fringe" id="point:100187"> </span>
<a href="#linum:2308"><span class="linum" id="linum:2308">2308</span></a><span class="fringe" id="point:100188"> </span><span class="comment-delimiter" id="font-lock:100188">;; </span><span class="comment" id="font-lock:100191">name of the init file we want:
</span><a href="#linum:2309"><span class="linum" id="linum:2309">2309</span></a><span class="fringe" id="point:100222"> </span>(<span class="keyword" id="font-lock:100223">defun</span> <span class="function-name" id="font-lock:100229">hfy-initfile</span> ()
<a href="#linum:2310"><span class="linum" id="linum:2310">2310</span></a><span class="fringe" id="point:100245"> </span>  <span class="doc" id="font-lock:100247">"Return the expected location of the htmlfontify specific init/custom file."</span>
<a href="#linum:2311"><span class="linum" id="linum:2311">2311</span></a><span class="fringe" id="point:100324"> </span>  (<span class="keyword" id="font-lock:100327">let*</span> ((file (or (getenv <span class="string" id="font-lock:100351">"HFY_INITFILE"</span>) <span class="string" id="font-lock:100367">".hfy.el"</span>)))
<a href="#linum:2312"><span class="linum" id="linum:2312">2312</span></a><span class="fringe" id="point:100380"> </span>    (expand-file-name file <span class="string" id="font-lock:100407">"~"</span>) ))
<a href="#linum:2313"><span class="linum" id="linum:2313">2313</span></a><span class="fringe" id="point:100415"> </span>
<a href="#linum:2314"><span class="linum" id="linum:2314">2314</span></a><span class="fringe" id="point:100416"> </span>
<a href="#linum:2315"><span class="linum" id="linum:2315">2315</span></a><span class="fringe" id="point:100417"> </span><span class="comment-delimiter" id="font-lock:100417">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="comment" id="font-lock:100493">
</span><a href="#linum:2316"><span class="linum" id="linum:2316">2316</span></a><span class="fringe" id="point:100494"> </span><span class="comment-delimiter" id="font-lock:100494">;; </span><span class="comment" id="font-lock:100497">incomplete as yet : transfer hook settings to hfy init file:
</span><a href="#linum:2317"><span class="linum" id="linum:2317">2317</span></a><span class="fringe" id="point:100558"> </span><span class="comment-delimiter" id="font-lock:100558">;; </span><span class="comment" id="font-lock:100561">(defalias 'hfy-set-hooks 'custom-set-variables)
</span><a href="#linum:2318"><span class="linum" id="linum:2318">2318</span></a><span class="fringe" id="point:100609"> </span>
<a href="#linum:2319"><span class="linum" id="linum:2319">2319</span></a><span class="fringe" id="point:100610"> </span><span class="comment-delimiter" id="font-lock:100610">;; </span><span class="comment" id="font-lock:100613">(defun hfy-pp-hook (H)
</span><a href="#linum:2320"><span class="linum" id="linum:2320">2320</span></a><span class="fringe" id="point:100636"> </span><span class="comment-delimiter" id="font-lock:100636">;;   </span><span class="comment" id="font-lock:100641">(and (string-match "-hook$" (symbol-name H))
</span><a href="#linum:2321"><span class="linum" id="linum:2321">2321</span></a><span class="fringe" id="point:100686"> </span><span class="comment-delimiter" id="font-lock:100686">;;        </span><span class="comment" id="font-lock:100696">(boundp H)
</span><a href="#linum:2322"><span class="linum" id="linum:2322">2322</span></a><span class="fringe" id="point:100707"> </span><span class="comment-delimiter" id="font-lock:100707">;;        </span><span class="comment" id="font-lock:100717">(symbol-value H)
</span><a href="#linum:2323"><span class="linum" id="linum:2323">2323</span></a><span class="fringe" id="point:100734"> </span><span class="comment-delimiter" id="font-lock:100734">;;        </span><span class="comment" id="font-lock:100744">(insert (format "\n '(%S %S)" H (symbol-value H)))
</span><a href="#linum:2324"><span class="linum" id="linum:2324">2324</span></a><span class="fringe" id="point:100795"> </span><span class="comment-delimiter" id="font-lock:100795">;;        </span><span class="comment" id="font-lock:100805">)
</span><a href="#linum:2325"><span class="linum" id="linum:2325">2325</span></a><span class="fringe" id="point:100807"> </span><span class="comment-delimiter" id="font-lock:100807">;;   </span><span class="comment" id="font-lock:100812">)
</span><a href="#linum:2326"><span class="linum" id="linum:2326">2326</span></a><span class="fringe" id="point:100814"> </span>
<a href="#linum:2327"><span class="linum" id="linum:2327">2327</span></a><span class="fringe" id="point:100815"> </span><span class="comment-delimiter" id="font-lock:100815">;; </span><span class="comment" id="font-lock:100818">(defun hfy-save-hooks ()
</span><a href="#linum:2328"><span class="linum" id="linum:2328">2328</span></a><span class="fringe" id="point:100843"> </span><span class="comment-delimiter" id="font-lock:100843">;;   </span><span class="comment" id="font-lock:100848">(let ((custom-file (hfy-initfile)))
</span><a href="#linum:2329"><span class="linum" id="linum:2329">2329</span></a><span class="fringe" id="point:100884"> </span><span class="comment-delimiter" id="font-lock:100884">;;     </span><span class="comment" id="font-lock:100891">(custom-save-delete 'hfy-set-hooks)
</span><a href="#linum:2330"><span class="linum" id="linum:2330">2330</span></a><span class="fringe" id="point:100927"> </span><span class="comment-delimiter" id="font-lock:100927">;;     </span><span class="comment" id="font-lock:100934">(let ((standard-output (current-buffer)))
</span><a href="#linum:2331"><span class="linum" id="linum:2331">2331</span></a><span class="fringe" id="point:100976"> </span><span class="comment-delimiter" id="font-lock:100976">;;       </span><span class="comment" id="font-lock:100985">(princ "(hfy-set-hooks\n;;auto-generated, only one copy allowed\n")
</span><a href="#linum:2332"><span class="linum" id="linum:2332">2332</span></a><span class="fringe" id="point:101053"> </span><span class="comment-delimiter" id="font-lock:101053">;;       </span><span class="comment" id="font-lock:101062">(mapatoms 'hfy-pp-hook)
</span><a href="#linum:2333"><span class="linum" id="linum:2333">2333</span></a><span class="fringe" id="point:101086"> </span><span class="comment-delimiter" id="font-lock:101086">;;       </span><span class="comment" id="font-lock:101095">(insert "\n)")
</span><a href="#linum:2334"><span class="linum" id="linum:2334">2334</span></a><span class="fringe" id="point:101110"> </span><span class="comment-delimiter" id="font-lock:101110">;;       </span><span class="comment" id="font-lock:101119">)
</span><a href="#linum:2335"><span class="linum" id="linum:2335">2335</span></a><span class="fringe" id="point:101121"> </span><span class="comment-delimiter" id="font-lock:101121">;;     </span><span class="comment" id="font-lock:101128">)
</span><a href="#linum:2336"><span class="linum" id="linum:2336">2336</span></a><span class="fringe" id="point:101130"> </span><span class="comment-delimiter" id="font-lock:101130">;;   </span><span class="comment" id="font-lock:101135">)
</span><a href="#linum:2337"><span class="linum" id="linum:2337">2337</span></a><span class="fringe" id="point:101137"> </span><span class="comment-delimiter" id="font-lock:101137">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="comment" id="font-lock:101213">
</span><a href="#linum:2338"><span class="linum" id="linum:2338">2338</span></a><span class="fringe" id="point:101214"> </span>
<a href="#linum:2339"><span class="linum" id="linum:2339">2339</span></a><span class="fringe" id="point:101215"> </span>(<span class="keyword" id="font-lock:101216">defalias</span> '<span class="function-name" id="font-lock:101226">hfy-init-progn</span> 'progn)
<a href="#linum:2340"><span class="linum" id="linum:2340">2340</span></a><span class="fringe" id="point:101249"> </span>
<a href="#linum:2341"><span class="linum" id="linum:2341">2341</span></a><span class="fringe" id="point:101250"> </span>(<span class="keyword" id="font-lock:101251">defun</span> <span class="function-name" id="font-lock:101257">hfy-save-initvar</span> (sym)
<a href="#linum:2342"><span class="linum" id="linum:2342">2342</span></a><span class="fringe" id="point:101280"> </span>  (princ (format <span class="string" id="font-lock:101297">"(setq %s\n '"</span> sym))
<a href="#linum:2343"><span class="linum" id="linum:2343">2343</span></a><span class="fringe" id="point:101318"> </span>  (pp    (symbol-value sym))
<a href="#linum:2344"><span class="linum" id="linum:2344">2344</span></a><span class="fringe" id="point:101347"> </span>  (princ <span class="string" id="font-lock:101356">")\n"</span>))
<a href="#linum:2345"><span class="linum" id="linum:2345">2345</span></a><span class="fringe" id="point:101364"> </span>
<a href="#linum:2346"><span class="linum" id="linum:2346">2346</span></a><span class="fringe" id="point:101365"> </span>(<span class="keyword" id="font-lock:101366">defun</span> <span class="function-name" id="font-lock:101372">htmlfontify-save-initfile</span> ()
<a href="#linum:2347"><span class="linum" id="linum:2347">2347</span></a><span class="fringe" id="point:101401"> </span>  <span class="doc" id="font-lock:101403">"Save the htmlfontify settings to the htmlfontify init file."</span>
<a href="#linum:2348"><span class="linum" id="linum:2348">2348</span></a><span class="fringe" id="point:101465"> </span>  (interactive)
<a href="#linum:2349"><span class="linum" id="linum:2349">2349</span></a><span class="fringe" id="point:101481"> </span>  (<span class="keyword" id="font-lock:101484">let*</span> ((start-pos       nil)
<a href="#linum:2350"><span class="linum" id="linum:2350">2350</span></a><span class="fringe" id="point:101512"> </span>         (custom-file     (hfy-initfile))
<a href="#linum:2351"><span class="linum" id="linum:2351">2351</span></a><span class="fringe" id="point:101554"> </span>         (standard-output (find-file-noselect custom-file 'nowarn)))
<a href="#linum:2352"><span class="linum" id="linum:2352">2352</span></a><span class="fringe" id="point:101623"> </span>    (<span class="keyword" id="font-lock:101628">save-excursion</span>
<a href="#linum:2353"><span class="linum" id="linum:2353">2353</span></a><span class="fringe" id="point:101643"> </span>      (custom-save-delete 'hfy-init-progn)
<a href="#linum:2354"><span class="linum" id="linum:2354">2354</span></a><span class="fringe" id="point:101686"> </span>      (setq start-pos (point))
<a href="#linum:2355"><span class="linum" id="linum:2355">2355</span></a><span class="fringe" id="point:101717"> </span>      (princ <span class="string" id="font-lock:101730">"(hfy-init-progn\n;;auto-generated, only one copy allowed\n"</span>)
<a href="#linum:2356"><span class="linum" id="linum:2356">2356</span></a><span class="fringe" id="point:101792"> </span>      <span class="comment-delimiter" id="font-lock:101798">;; </span><span class="comment" id="font-lock:101801">FIXME: This saving&amp;restoring of global customization
</span><a href="#linum:2357"><span class="linum" id="linum:2357">2357</span></a><span class="fringe" id="point:101854"> </span>      <span class="comment-delimiter" id="font-lock:101860">;; </span><span class="comment" id="font-lock:101863">variables can interfere with other customization settings for
</span><a href="#linum:2358"><span class="linum" id="linum:2358">2358</span></a><span class="fringe" id="point:101925"> </span>      <span class="comment-delimiter" id="font-lock:101931">;; </span><span class="comment" id="font-lock:101934">those vars (in .emacs or in Customize).
</span><a href="#linum:2359"><span class="linum" id="linum:2359">2359</span></a><span class="fringe" id="point:101974"> </span>      (mapc 'hfy-save-initvar
<a href="#linum:2360"><span class="linum" id="linum:2360">2360</span></a><span class="fringe" id="point:102004"> </span>            '(auto-mode-alist interpreter-mode-alist))
<a href="#linum:2361"><span class="linum" id="linum:2361">2361</span></a><span class="fringe" id="point:102059"> </span>      (princ <span class="string" id="font-lock:102072">")\n"</span>)
<a href="#linum:2362"><span class="linum" id="linum:2362">2362</span></a><span class="fringe" id="point:102079"> </span>      (indent-region start-pos (point) nil))
<a href="#linum:2363"><span class="linum" id="linum:2363">2363</span></a><span class="fringe" id="point:102124"> </span>    (custom-save-all) ))
<a href="#linum:2364"><span class="linum" id="linum:2364">2364</span></a><span class="fringe" id="point:102149"> </span>
<a href="#linum:2365"><span class="linum" id="linum:2365">2365</span></a><span class="fringe" id="point:102150"> </span>(<span class="keyword" id="font-lock:102151">defun</span> <span class="function-name" id="font-lock:102157">htmlfontify-load-initfile</span> ()
<a href="#linum:2366"><span class="linum" id="linum:2366">2366</span></a><span class="fringe" id="point:102186"> </span>  <span class="doc" id="font-lock:102188">"Load the htmlfontify specific init/custom file."</span>
<a href="#linum:2367"><span class="linum" id="linum:2367">2367</span></a><span class="fringe" id="point:102238"> </span>  (interactive)
<a href="#linum:2368"><span class="linum" id="linum:2368">2368</span></a><span class="fringe" id="point:102254"> </span>  (<span class="keyword" id="font-lock:102257">let</span> ((file (hfy-initfile)))
<a href="#linum:2369"><span class="linum" id="linum:2369">2369</span></a><span class="fringe" id="point:102285"> </span>    (load file 'NOERROR nil nil) ))
<a href="#linum:2370"><span class="linum" id="linum:2370">2370</span></a><span class="fringe" id="point:102321"> </span>
<a href="#linum:2371"><span class="linum" id="linum:2371">2371</span></a><span class="fringe" id="point:102322"> </span>(<span class="keyword" id="font-lock:102323">provide</span> '<span class="constant" id="font-lock:102332">htmlfontify</span>)
<a href="#linum:2372"><span class="linum" id="linum:2372">2372</span></a><span class="fringe" id="point:102345"> </span><span class="comment-delimiter" id="font-lock:102345">;;; </span><span class="comment" id="font-lock:102349">htmlfontify.el ends here
</span><a href="#linum:2373"><span class="linum" id="linum:2373">2373</span></a><span class="fringe" id="point:102374"> </span>
<a href="#linum:2374"><span class="linum" id="linum:2374">2374</span></a><span class="fringe" id="point:102375"> </span><span class="comment-delimiter" id="font-lock:102375">;; </span><span class="comment" id="font-lock:102378">arch-tag: 944e5e63-c81d-4baa-a82a-0275f9c30e61
</span>
</div>
<div style="position: fixed; left: 0; width: 100%; foreground: #000000; background: #CCC;  bottom: 1em; height: 1em; margin: auto 0;">
-U:--- list.html	Top L32 (XHTML)-------------------------------------------------------------------------
</div>
<div style="position: fixed; left: 0; width: 100%; bottom: 0; height: 1em; margin: auto 0;">
<form><input type="text" style="position: relative; width: 100%;"></form>
</div>
  </body>
</html>

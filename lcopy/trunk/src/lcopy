#!/bin/bash

#
# bash is really needed.
#

ROOT_DIR=/var/lib/lcopy
SOURCES_DIR=${ROOT_DIR}/sources
SPECS_DIR=${ROOT_DIR}/specs
LOG_DIR=${ROOT_DIR}/log


PACKAGE=
PHASH=
BRANCH=trunk
REPO=
MODULE=
VCS=
RELEASE=0

NO_SPEC=
ONLY_SPEC=

SUPPORTED_VCSs="cvs git git-clone svn hg bzr"
function print_usage
{
    echo "Usage: "
    echo "lcopy [--release=RELEASE] [--branch=BRANCH] [--no-spec|--only-spec] vcs commands..."
    echo ""
    echo "lcopy [--help|-h]"
    echo ""
    echo "Expected commands line for each vcs:"
    for vcs in ${SUPPORTED_VCSs}; do

	echo ${vcs}:
	${vcs}_print_usage
	echo

    done
}

#
# plugin
# 
PREFIX=/usr/libexec
PLUGINDIR=${PREFIX}/lcopy/plugins

function lcopy_run_plugins
{
    LOG=$1;
    shift

    test -d $PLUGINDIR && \
	find $PLUGINDIR -perm +0100 -type f | sort |  while read plugin
    do
	es_print lcopy start-running-plugin "\"$plugin\"" | sudo -H -u lcopy tee -a $LOG > /dev/null
        sudo -H -u lcopy $plugin "$@"
	es_print lcopy end-running-plugin "\"$plugin\"" --status=$? | sudo -H -u lcopy tee -a $LOG > /dev/null
    done
}

function main
{
    local tstamp

    cd ${SOURCES_DIR}

    while [ $# -gt 0 ]; do
	case "$1" in
	    --help|-h)
		print_usage
		exit 0
		;;
	    --release=*)
		RELEASE=${1/--release=/}
		shift 1
		;;
	    --branch=*)
		BRANCH=${1/--branch=/}
		shift 1
		;;
	    --no-spec)
		NO_SPEC=1
		shift 1
		;;
	    --only-spec)
		ONLY_SPEC=1
		shift 1
		;;
	    *)
		break
		;;
	esac
    done

    if test -z "$1"; then
	echo "Too few arguments" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if ! lcopy_is_member "${1}" $SUPPORTED_VCSs; then
	echo "unknown vcs: ${1}" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if ! ${1}_parse "$@"; then
	echo "failed in the command line for ${1}" 2>&1
	print_usage 2>&1
	exit 1
    fi
    PHASH=$(lcopy_package_hash $PACKAGE)

    if test -z "$NO_SPEC"; then
	make_specs
    fi

    if test -z "$ONLY_SPEC"; then
	sudo -H -u lcopy mkdir -p ${PHASH}/${PACKAGE}
	cd ${PHASH}/${PACKAGE}
	if do_checkout; then
	    status=$?
	    tstamp=`LANG=C date`
	    es_print lcopy checkout \
		:cmdline \""$*"\"   \
		:status ${status}   \
		:date \""${tstamp}"\" | \
		sudo -H -u lcopy tee -a ${LOG_DIR}/lcopy-checkout.es > /dev/null
#	    if test -z "$NO_SPEC"; then
		:
		cd ${BRANCH}
# TODO: plugin directory
		if test "$?" = 0; then
		    lcopy_run_plugins ${LOG_DIR}/lcopy-refresh.es \
			"${VCS}" "$(pwd)" "${tstamp}"
#		fi
	    fi
	fi
    fi
}


#
# svn
#
function svn_parse
{
    VCS=$1
    CMD=$2
    REPO=$3
    PACKAGE=$4
    
    if test "x$VCS" != xsvn; then
	echo "Wrong vcs: $VCS" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test \( "x$CMD" != "xcheckout" \) -a \
	    \( "x$CMD" != "xco"    \); then
	echo "broken svn command line: $@" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test -z "$REPO"; then
	echo "no repository" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if echo "$REPO" | grep -E -e "^http[s]?://" > /dev/null 2>&1; then
	:
    else
	echo "unknown repository specification: $REPO" 2>&1
	print_usage 2>&1
	exit 1
    fi
    
    if test -z "$PACKAGE"; then
	echo "no packagedir" 2>&1
	print_usage 2>&1
	exit 1
    fi    

    return 0
}

function svn_print_usage
{
    echo "	" svn "checkout|co" REPOS PACKAGEDIR
    echo "	" "REPOS => http://... or https://..."
}

#
# git
#
function git-clone_parse
{
    shift 1
    git_parse git clone "$@"
}

function git-clone_print_usage
{
    echo "	" git-clone REPOS PACKAGEDIR
}

function git_parse
{
    VCS=$1
    CMD=$2
    REPO=$3
    PACKAGE=$4

    if test "x$VCS" != xgit; then
	echo "wrong vcs: $VCS" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test \( -z "$CMD"          \) -a    \
            \( "$CMD" != clone \) ; then
	echo "broken git command line: $@" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test -z "$REPO"; then
	echo "no repository" 2>&1
	print_usage 2>&1
	exit 1
    fi

 
# TODO
#    if test "x$(echo $REPO | sed -e 's/[^:]//g')" != "x::::"; then
#	echo "broken repo specification: $REPO" 2>&1
#	print_usage 2>&1
#	exit 1
#    fi

    if test -z "$PACKAGE"; then
	echo "no packagedir" 2>&1
	print_usage 2>&1
	exit 1
    fi

    return 0
}

function git_print_usage
{
    echo "	" git clone REPOS PACKAGEDIR
}

#
# hg
#
function hg_parse
{
    VCS=$1
    CMD=$2
    REPO=$3
    PACKAGE=$4

    if test "x$VCS" != xhg; then
	echo "wrong vcs: $VCS" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test \( -z "$CMD"          \) -a    \
            \( "$CMD" != clone \) ; then
	echo "broken hg command line: $@" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test -z "$REPO"; then
	echo "no repository" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if echo "$REPO" | grep -E -e "^http[s]?://" > /dev/null 2>&1; then
	:
    else
	echo "unknown repository specification: $REPO" 2>&1
	print_usage 2>&1
	exit 1
    fi
 
# TODO
#    if test "x$(echo $REPO | sed -e 's/[^:]//g')" != "x::::"; then
#	echo "broken repo specification: $REPO" 2>&1
#	print_usage 2>&1
#	exit 1
#    fi

    if test -z "$PACKAGE"; then
	echo "no packagedir" 2>&1
	print_usage 2>&1
	exit 1
    fi

    return 0
}

function hg_print_usage
{
    echo "	" hg clone REPOS PACKAGEDIR
}

#
# CVS
#
function cvs_parse
{
    local original=$@
    VCS=$1
    REPO=${2/-d/}
    CMD=$3
    shift 3

    if test "x$VCS" != xcvs; then
	echo "wrong vcs: $VCS" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test \( -z "$CMD"          \) -o       \
	    \(                                \
               \( "$CMD" != co       \) -a    \
               \( "$CMD" != checkout \)       \
            \) ; then
	echo "broken cvs command line about cvs comamnd(checkout: $CMD)): $original" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test -z "$REPO"; then
	echo "no repository" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test "x$(echo $REPO | sed -e 's/[^:]//g')" != "x::::"; then
	echo "broken repo specification: $REPO" 2>&1
	print_usage 2>&1
	exit 1
    fi


    if test "x$1" = "x-P"; then
	shift 1
    fi

    local dflags=$1
    PACKAGE=$2
    shift 2

    if test \( -n "${dflags}" \) -a \( "${dflags}" != "-d" \); then
	echo "broken cvs command line about directory specification(-d: ${dflags}): $original" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test -z "$PACKAGE"; then
	echo "no packagedir" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test "x$1" = "x-P"; then
	shift 1
    fi

    MODULE=$1
    if test -z "$MODULE"; then
	echo "no module" 2>&1
	print_usage 2>&1
	exit 1
    fi

    return 0
}

function cvs_print_usage
{
    echo "	" cvs -d:pserver:USER:PASSWD@HOST 'checkout|co' -d PACKAGEDIR MODULE 
    echo "	" '(adds -P automatically)'
}

#
# Bzr
# 
function bzr_parse
{
    VCS=$1
    CMD=$2
    REPO=$3
    PACKAGE=$4

    if test "x$VCS" != xbzr; then
	echo "wrong vcs: $VCS" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test \( -z "$CMD"          \) -a    \
            \( "$CMD" != branch \) ; then
	echo "broken bzr command line: $@" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if test -z "$REPO"; then
	echo "no repository" 2>&1
	print_usage 2>&1
	exit 1
    fi

    if echo "$REPO" | grep -E -e "^http[s]?://" > /dev/null 2>&1; then
	:
    else
	echo "unknown repository specification: $REPO" 2>&1
	print_usage 2>&1
	exit 1
    fi
 
    if test -z "$PACKAGE"; then
	echo "no packagedir" 2>&1
	print_usage 2>&1
	exit 1
    fi

    return 0
}

function bzr_print_udage
{
    echo "	" bar branch LOCATION PACKAGEDIR
}

function do_checkout
{
    sudo -H -u lcopy $(lcopy_checkout "$VCS" "$REPO" "$BRANCH" "$MODULE")
}

function make_specs
{
    sudo -H -u lcopy \
    lcopy-genspec --spec-type=subscription	\
        --package=$PACKAGE			\
        --branch=$BRANCH			\
        --repo=$REPO				\
        --module=$MODULE			\
        --vcs=$VCS				\
        --release=$RELEASE			\
        --output-dir=$SPECS_DIR			

    sudo -H -u lcopy \
    lcopy-genspec --spec-type=link		\
        --package=$PACKAGE			\
        --branch=$BRANCH			\
        --release=$RELEASE			\
        --output-dir=$SPECS_DIR
}

source liblcopy.sh
main "$@"
